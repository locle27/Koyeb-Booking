{% extends "base.html" %}

{% block title %}AI Assistant - L·ªÖ T√¢n Th√¥ng Minh{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center my-4">
        <h1 class="mb-0">
            <i class="fas fa-robot text-primary"></i> AI Assistant Hub
        </h1>
        <div class="badge bg-primary">L·ªÖ T√¢n Th√¥ng Minh 2.0</div>
    </div>
    
    <!-- Tab Navigation -->
    <ul class="nav nav-pills nav-fill mb-4" id="aiTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="chat-tab" data-bs-toggle="pill" data-bs-target="#chat-panel" type="button" role="tab">
                <i class="fas fa-comments me-2"></i>AI Chat Assistant
                <small class="d-block text-muted mt-1">Ph√¢n t√≠ch ƒëo·∫°n chat & t·∫°o ph·∫£n h·ªìi AI</small>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="voice-tab" data-bs-toggle="pill" data-bs-target="#voice-panel" type="button" role="tab">
                <i class="fas fa-microphone-alt me-2"></i>Voice Translator
                <small class="d-block text-muted mt-1">D·ªãch gi·ªçng n√≥i th√¥ng minh</small>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="aiTabsContent">
        <!-- AI Chat Assistant Panel -->
        <div class="tab-pane fade show active" id="chat-panel" role="tabpanel">
            <div class="row">
                <!-- Ph·∫ßn t·∫£i ·∫£nh -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-image"></i> T·∫£i ·∫¢nh ƒêo·∫°n Chat
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="imagePasteArea" class="image-paste-area" onclick="selectImageFile()">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>D√°n ·∫£nh, ch·ªçn file ho·∫∑c ch·ª•p ·∫£nh</h5>
                                <p class="text-muted mb-2">
                                    H·ªó tr·ª£: PNG, JPG, JPEG<br>
                                    <kbd>Ctrl+V</kbd> ƒë·ªÉ d√°n ·∫£nh t·ª´ clipboard
                                </p>
                                <div class="d-block d-md-none mt-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="selectImageFile()">
                                        <i class="fas fa-folder-open"></i> Ch·ªçn t·ª´ th∆∞ vi·ªán
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="capturePhoto()">
                                        <i class="fas fa-camera"></i> Ch·ª•p ·∫£nh
                                    </button>
                                </div>
                            </div>
                            
                            <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                            
                            <div id="imagePreviewContainer" class="mt-3" style="display: none;">
                                <img id="imagePreview" class="image-preview" alt="Xem tr∆∞·ªõc ·∫£nh">
                                <div class="mt-2">
                                    <button class="btn btn-danger btn-sm" onclick="removeImage()">
                                        <i class="fas fa-trash"></i> X√≥a ·∫£nh
                                    </button>
                                    <button class="btn btn-primary btn-sm ms-2" onclick="analyzeImage()">
                                        <i class="fas fa-magic"></i> Ph√¢n t√≠ch v·ªõi AI
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ph·∫ßn c·∫•u h√¨nh v√† k·∫øt qu·∫£ AI -->
                <div class="col-md-6">
                    <!-- AI Configuration Panel -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-cogs"></i> T√πy Ch·ªçn Ph·∫£n H·ªìi AI
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <label for="templateCategory" class="form-label small mb-1">M·∫´u tin nh·∫Øn:</label>
                                    <select id="templateCategory" class="form-select form-select-sm" onchange="loadSpecificTemplates()">
                                        <option value="">T·ª± ƒë·ªông ch·ªçn</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="specificTemplate" class="form-label small mb-1">M·∫´u c·ª• th·ªÉ:</label>
                                    <select id="specificTemplate" class="form-select form-select-sm" disabled onchange="previewSelectedTemplate()">
                                        <option value="">Ch·ªçn category tr∆∞·ªõc</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small mb-1">Phong c√°ch tr·∫£ l·ªùi:</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="responseMode" id="responseModeAuto" value="auto" checked>
                                        <label class="btn btn-outline-secondary btn-sm" for="responseModeAuto">Auto</label>
                                        
                                        <input type="radio" class="btn-check" name="responseMode" id="responseModeYes" value="yes">
                                        <label class="btn btn-outline-success btn-sm" for="responseModeYes">Yes</label>
                                        
                                        <input type="radio" class="btn-check" name="responseMode" id="responseModeNo" value="no">
                                        <label class="btn btn-outline-danger btn-sm" for="responseModeNo">No</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="templatePreview" class="mt-2" style="display: none;">
                                <div class="alert alert-light border-start border-4 border-primary py-2 px-3 mb-0">
                                    <small class="text-muted d-block mb-1">Preview m·∫´u ƒë√£ ch·ªçn:</small>
                                    <div id="templatePreviewContent" class="small"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Response Area -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-comments"></i> Ph·∫£n H·ªìi AI
                            </h5>
                            <div id="processingStatus" class="text-muted" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch...
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="responseArea" class="response-area">
                                <div class="text-center text-muted">
                                    <i class="fas fa-robot fa-2x mb-3 text-primary"></i>
                                    <h6 class="text-primary">üß† AI Chat Assistant - Context-Aware Intelligence</h6>
                                    <p class="mb-3">T·∫£i ·∫£nh ƒëo·∫°n chat l√™n, AI s·∫Ω ƒë·ªçc v√† hi·ªÉu <strong>to√†n b·ªô b·ªëi c·∫£nh</strong> ƒë·ªÉ ƒë∆∞a ra ph·∫£n h·ªìi th√¥ng minh!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Translator Panel -->
        <div class="tab-pane fade" id="voice-panel" role="tabpanel">
            <div class="card">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-microphone-alt me-2"></i>Voice Translator - D·ªãch Gi·ªçng N√≥i Th√¥ng Minh
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Language Selection -->
                    <div class="row mb-4">
                        <div class="col-md-5">
                            <label class="form-label fw-bold">
                                <i class="fas fa-flag"></i> Ng√¥n ng·ªØ ngu·ªìn:
                            </label>
                            <select id="sourceLanguage" class="form-select language-select">
                                <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                                <option value="en">üá∫üá∏ English</option>
                                <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                                <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                                <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                                <option value="fr">üá´üá∑ Fran√ßais</option>
                                <option value="de">üá©üá™ Deutsch</option>
                                <option value="es">üá™üá∏ Espa√±ol</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end justify-content-center">
                            <button class="btn btn-outline-secondary" onclick="swapLanguages()">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-bold">
                                <i class="fas fa-language"></i> Ng√¥n ng·ªØ ƒë√≠ch:
                            </label>
                            <select id="targetLanguage" class="form-select language-select">
                                <option value="en">üá∫üá∏ English</option>
                                <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                                <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                                <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                                <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                                <option value="fr">üá´üá∑ Fran√ßais</option>
                                <option value="de">üá©üá™ Deutsch</option>
                                <option value="es">üá™üá∏ Espa√±ol</option>
                            </select>
                        </div>
                    </div>

                    <!-- Voice Recording and Text Input Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <!-- Voice Recording -->
                            <div class="text-center p-4" style="border: 2px dashed #dee2e6; border-radius: 15px;">
                                <h5 class="mb-3">
                                    <span id="statusIndicator" class="status-indicator status-ready"></span>
                                    <span id="statusText">S·∫µn s√†ng ghi √¢m</span>
                                </h5>
                                <button id="recordButton" class="record-button mb-3" onclick="toggleRecording()">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <div>
                                    <small class="text-muted">Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu/d·ª´ng ghi √¢m</small>
                                </div>
                                
                                <div id="supportInfo" class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        <span id="supportText">ƒêang ki·ªÉm tra h·ªó tr·ª£ microphone...</span>
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Speech Recognition Result -->
                            <div class="mt-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-comment-dots"></i> VƒÉn b·∫£n nh·∫≠n di·ªán:
                                </label>
                                <textarea id="recognizedText" class="form-control text-area" 
                                    placeholder="VƒÉn b·∫£n t·ª´ gi·ªçng n√≥i s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."
                                    oninput="checkTranslateButton()" readonly></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Manual Text Input -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-keyboard"></i> Ho·∫∑c nh·∫≠p vƒÉn b·∫£n th·ªß c√¥ng:
                                </label>
                                <textarea id="manualText" class="form-control text-area" 
                                    placeholder="Nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch ·ªü ƒë√¢y..."
                                    oninput="syncTextAndCheck()"></textarea>
                            </div>
                            
                            <!-- Translate Button -->
                            <div class="text-center mb-3">
                                <button id="translateButton" class="btn translate-btn" onclick="translateText()">
                                    <i class="fas fa-language"></i> D·ªãch Ngay
                                </button>
                            </div>
                            
                            <!-- Translation Result -->
                            <div class="result-area position-relative" id="translationResult" style="display: none;">
                                <button class="copy-btn" onclick="copyTranslation()">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <h6 class="text-primary mb-2">
                                    <i class="fas fa-globe"></i> K·∫øt qu·∫£ d·ªãch:
                                </h6>
                                <div id="translatedText" class="fw-bold" style="font-size: 1.1rem; line-height: 1.6;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <button class="btn btn-info w-100 mb-2" onclick="viewTemplates()">
                                <i class="fas fa-list me-2"></i>Xem m·∫´u tin nh·∫Øn
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-success w-100 mb-2" onclick="clearAll()">
                                <i class="fas fa-refresh me-2"></i>L√†m m·ªõi t·∫•t c·∫£
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning w-100 mb-2" onclick="switchToVoice()">
                                <i class="fas fa-microphone-alt me-2"></i>Chuy·ªÉn sang Voice
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-secondary w-100 mb-2" onclick="switchToChat()">
                                <i class="fas fa-comments me-2"></i>Chuy·ªÉn sang Chat AI
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
{% endblock %}

{% block head_extra %}
<style>
    .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9998;}
    .image-paste-area{border:2px dashed #dee2e6;border-radius:8px;padding:40px;text-align:center;background:#f8f9fa;transition:all 0.3s;cursor:pointer;}
    .image-paste-area:hover{border-color:#0d6efd;background:#e7f3ff;}
    .image-paste-area.dragover{border-color:#0d6efd;background:#e7f3ff;transform:scale(1.02);}
    .image-preview{max-width:100%;max-height:400px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);}
    .response-area{background:#f8f9fa;border-radius:8px;padding:20px;margin-top:20px;min-height:150px;}
    .copy-button{position:absolute;top:10px;right:10px;}
    .ai-response{position:relative;background:white;border-radius:8px;padding:15px;border-left:4px solid #28a745;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .analysis-info{background:#e3f2fd;border-radius:6px;padding:12px;margin-bottom:15px;font-size:0.9em;}
    .template-match{background:#fff3cd;border-radius:6px;padding:10px;margin:10px 0;border-left:3px solid #ffc107;}

    /* Voice Translator Styles */
    .record-button {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        font-size: 2.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .record-button:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
    }
    .record-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }
    .record-button.recording {
        background: linear-gradient(135deg, #ff4757, #ff3838);
        animation: pulse 1.5s ease-in-out infinite alternate;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        100% { transform: scale(1.1); }
    }
    .language-select {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #e3f2fd;
        border-radius: 15px;
        padding: 10px 15px;
        font-weight: 500;
    }
    .text-area {
        background: rgba(248, 249, 250, 0.8);
        border: 2px solid #e9ecef;
        border-radius: 15px;
        min-height: 120px;
        resize: vertical;
        font-size: 16px;
    }
    .text-area:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .translate-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        border-radius: 50px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
        color: white;
    }
    .translate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        color: white;
    }
    .translate-btn:disabled {
        background: #6c757d;
        transform: none;
        box-shadow: none;
        color: white;
    }
    .result-area {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border-radius: 15px;
        padding: 20px;
        border-left: 5px solid #2196f3;
    }
    .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(33, 150, 243, 0.1);
        border: 1px solid #2196f3;
        border-radius: 8px;
        color: #2196f3;
        padding: 5px 10px;
        font-size: 0.85rem;
    }
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .status-ready { background-color: #28a745; }
    .status-listening { background-color: #ff6b6b; animation: blink 1s infinite; }
    .status-processing { background-color: #ffc107; }
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }

    /* Tab styles */
    .nav-pills .nav-link {
        border-radius: 15px;
        margin: 0 5px;
        transition: all 0.3s ease;
    }
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .nav-pills .nav-link:not(.active):hover {
        background: rgba(102, 126, 234, 0.1);
        transform: translateY(-1px);
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .record-button {
            width: 100px;
            height: 100px;
            font-size: 2rem;
        }
        .translate-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }
        .image-paste-area {
            padding: 25px 15px;
            font-size: 0.9rem;
        }
        .nav-pills .nav-link {
            font-size: 0.9rem;
            padding: 10px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Combined AI Assistant functionality
    let currentImageData = null;
    let allTemplates = [];
    let recognition = null;
    let isRecording = false;
    let finalTranscript = '';
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('AI Assistant Hub initializing...');
        
        // Initialize AI Chat Assistant
        setupImageHandling();
        loadTemplateCategories();
        
        // Initialize Voice Translator
        checkSpeechRecognitionSupport();
        checkTranslateButton();
        
        console.log('AI Assistant Hub loaded successfully');
    });
    
    // ==================== AI CHAT ASSISTANT FUNCTIONS ====================
    
    // Load template categories from API
    async function loadTemplateCategories() {
        try {
            const response = await fetch('/api/templates');
            if (response.ok) {
                allTemplates = await response.json();
                populateTemplateCategoryDropdown();
            }
        } catch (error) {
            console.error('Error loading templates:', error);
        }
    }
    
    // Populate template category dropdown
    function populateTemplateCategoryDropdown() {
        const categorySelect = document.getElementById('templateCategory');
        const categories = [...new Set(allTemplates.map(t => t.Category))].sort();
        
        categorySelect.innerHTML = '<option value="">T·ª± ƒë·ªông ch·ªçn</option>';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }
    
    // Load specific templates when category is selected
    function loadSpecificTemplates() {
        const categorySelect = document.getElementById('templateCategory');
        const specificSelect = document.getElementById('specificTemplate');
        const selectedCategory = categorySelect.value;
        
        specificSelect.innerHTML = '<option value="">Ch·ªçn m·∫´u c·ª• th·ªÉ</option>';
        specificSelect.disabled = !selectedCategory;
        hideTemplatePreview();
        
        if (selectedCategory) {
            const categoryTemplates = allTemplates.filter(t => t.Category === selectedCategory);
            
            categoryTemplates.forEach((template, index) => {
                const option = document.createElement('option');
                option.value = index.toString();
                option.textContent = template.Label;
                specificSelect.appendChild(option);
            });
            
            specificSelect.categoryTemplates = categoryTemplates;
            specificSelect.disabled = false;
        }
    }
    
    // Preview selected template
    function previewSelectedTemplate() {
        const specificSelect = document.getElementById('specificTemplate');
        const previewDiv = document.getElementById('templatePreview');
        const previewContent = document.getElementById('templatePreviewContent');
        
        if (specificSelect.value && specificSelect.categoryTemplates) {
            try {
                const templateIndex = parseInt(specificSelect.value);
                const template = specificSelect.categoryTemplates[templateIndex];
                
                if (template) {
                    previewContent.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="text-primary">${template.Category} - ${template.Label}:</strong>
                                <div class="mt-1">${template.Message}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyTemplatePreview()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    `;
                    previewDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error getting template:', error);
                hideTemplatePreview();
            }
        } else {
            hideTemplatePreview();
        }
    }
    
    function hideTemplatePreview() {
        document.getElementById('templatePreview').style.display = 'none';
    }
    
    function copyTemplatePreview() {
        const specificSelect = document.getElementById('specificTemplate');
        if (specificSelect.value && specificSelect.categoryTemplates) {
            try {
                const templateIndex = parseInt(specificSelect.value);
                const template = specificSelect.categoryTemplates[templateIndex];
                if (template && template.Message) {
                    copyToClipboard(template.Message);
                    showSuccess('ƒê√£ copy m·∫´u tin nh·∫Øn!');
                }
            } catch (error) {
                console.error('Error copying template:', error);
            }
        }
    }
    
    // Setup image upload and paste handling
    function setupImageHandling() {
        const pasteArea = document.getElementById('imagePasteArea');
        const fileInput = document.getElementById('imageFileInput');
        const cameraInput = document.getElementById('cameraInput');
        
        // Handle paste event
        document.addEventListener('paste', function(e) {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    handleImageFile(file);
                    break;
                }
            }
        });
        
        // Handle drag and drop
        pasteArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            pasteArea.classList.add('dragover');
        });
        
        pasteArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            pasteArea.classList.remove('dragover');
        });
        
        pasteArea.addEventListener('drop', function(e) {
            e.preventDefault();
            pasteArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                handleImageFile(files[0]);
            }
        });
        
        // Handle file inputs
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });
        
        cameraInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });
    }
    
    function selectImageFile() {
        document.getElementById('imageFileInput').click();
    }
    
    function capturePhoto() {
        document.getElementById('cameraInput').click();
    }
    
    function handleImageFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Vui l√≤ng ch·ªçn file ·∫£nh (PNG, JPG, JPEG)');
            return;
        }
        
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            alert('File qu√° l·ªõn. Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 10MB');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            currentImageData = e.target.result;
            showImagePreview(e.target.result);
        };
        reader.readAsDataURL(file);
    }
    
    function showImagePreview(imageSrc) {
        const previewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        
        imagePreview.src = imageSrc;
        previewContainer.style.display = 'block';
        document.getElementById('imagePasteArea').style.display = 'none';
    }
    
    function removeImage() {
        currentImageData = null;
        document.getElementById('imagePreviewContainer').style.display = 'none';
        document.getElementById('imagePasteArea').style.display = 'block';
        document.getElementById('imageFileInput').value = '';
        
        document.getElementById('responseArea').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-robot fa-2x mb-3 text-primary"></i>
                <h6 class="text-primary">üß† AI Chat Assistant - Context-Aware Intelligence</h6>
                <p class="mb-3">T·∫£i ·∫£nh ƒëo·∫°n chat l√™n, AI s·∫Ω ƒë·ªçc v√† hi·ªÉu <strong>to√†n b·ªô b·ªëi c·∫£nh</strong> ƒë·ªÉ ƒë∆∞a ra ph·∫£n h·ªìi th√¥ng minh!</p>
            </div>
        `;
    }
    
    async function analyzeImage() {
        if (!currentImageData) {
            alert('Vui l√≤ng t·∫£i ·∫£nh tr∆∞·ªõc!');
            return;
        }
        
        showLoading(true);
        document.getElementById('processingStatus').style.display = 'block';
        
        try {
            const aiConfig = getCurrentAIConfig();
            const requestData = {
                image_b64: currentImageData,
                ai_config: aiConfig
            };
            
            const response = await fetch('/api/ai_chat_analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            
            displayAIResponse(result, aiConfig);
            
        } catch (error) {
            console.error('AI Analysis error:', error);
            showError('L·ªói khi ph√¢n t√≠ch ·∫£nh: ' + error.message);
        } finally {
            showLoading(false);
            document.getElementById('processingStatus').style.display = 'none';
        }
    }
    
    function getCurrentAIConfig() {
        const categorySelect = document.getElementById('templateCategory');
        const specificSelect = document.getElementById('specificTemplate');
        const responseModeRadios = document.getElementsByName('responseMode');
        
        let selectedTemplate = null;
        if (specificSelect.value && specificSelect.categoryTemplates) {
            try {
                const templateIndex = parseInt(specificSelect.value);
                selectedTemplate = specificSelect.categoryTemplates[templateIndex];
            } catch (error) {
                console.error('Error getting selected template:', error);
            }
        }
        
        let responseMode = 'auto';
        for (const radio of responseModeRadios) {
            if (radio.checked) {
                responseMode = radio.value;
                break;
            }
        }
        
        return {
            selectedCategory: categorySelect.value,
            selectedTemplate: selectedTemplate,
            responseMode: responseMode
        };
    }
    
    function displayAIResponse(result, aiConfig) {
        const responseArea = document.getElementById('responseArea');
        
        let html = '';
        
        if (aiConfig) {
            html += `
                <div class="alert alert-info border-start border-4 border-info py-2 px-3 mb-3">
                    <h6 class="mb-2"><i class="fas fa-cogs"></i> C·∫•u h√¨nh AI ƒë√£ s·ª≠ d·ª•ng:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Template:</strong> ${aiConfig.selectedTemplate ? 
                                `${aiConfig.selectedTemplate.Category} - ${aiConfig.selectedTemplate.Label}` : 
                                'T·ª± ƒë·ªông ch·ªçn'}
                        </div>
                        <div class="col-md-6">
                            <strong>Phong c√°ch:</strong> 
                            <span class="badge ${aiConfig.responseMode === 'yes' ? 'bg-success' : 
                                aiConfig.responseMode === 'no' ? 'bg-danger' : 'bg-secondary'}">
                                ${aiConfig.responseMode === 'yes' ? 'T√≠ch c·ª±c (Yes)' : 
                                  aiConfig.responseMode === 'no' ? 'Ti√™u c·ª±c (No)' : 'T·ª± ƒë·ªông (Auto)'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (result.conversation_context) {
            html += `
                <div class="alert alert-primary border-start border-4 border-primary py-3 px-3 mb-3">
                    <h6><i class="fas fa-comments"></i> Ph√¢n t√≠ch B·ªëi c·∫£nh Cu·ªôc h·ªôi tho·∫°i:</h6>
                    <p class="mb-2" style="line-height: 1.6;">${result.conversation_context}</p>
                </div>
            `;
        }
        
        if (result.ai_response) {
            html += `
                <div class="ai-response">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6><i class="fas fa-robot text-success"></i> Ph·∫£n h·ªìi AI (C√≥ context):</h6>
                        <button class="btn btn-sm btn-outline-primary copy-button" onclick="copyToClipboard(\`${result.ai_response.replace(/`/g, '\\`')}\`)">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div style="white-space: pre-wrap; line-height: 1.6; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">${result.ai_response}</div>
                </div>
            `;
        }
        
        responseArea.innerHTML = html;
    }
    
    // ==================== VOICE TRANSLATOR FUNCTIONS ====================
    
    function checkSpeechRecognitionSupport() {
        const supportText = document.getElementById('supportText');
        const recordButton = document.getElementById('recordButton');
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            supportText.innerHTML = '‚úÖ H·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i';
            initializeSpeechRecognition();
        } else {
            supportText.innerHTML = '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i';
            recordButton.disabled = true;
            recordButton.innerHTML = '<i class="fas fa-times"></i>';
        }
    }
    
    function initializeSpeechRecognition() {
        try {
            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            recognition.lang = getLanguageCode(document.getElementById('sourceLanguage').value);
            
            recognition.onstart = function() {
                updateStatus('listening', 'ƒêang nghe...');
                document.getElementById('recordButton').innerHTML = '<i class="fas fa-stop"></i>';
                document.getElementById('recordButton').classList.add('recording');
                isRecording = true;
            };
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                let newFinalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        newFinalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (newFinalTranscript) {
                    finalTranscript += newFinalTranscript;
                }
                
                const fullText = finalTranscript + interimTranscript;
                document.getElementById('recognizedText').value = fullText;
                document.getElementById('manualText').value = fullText;
                checkTranslateButton();
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                updateStatus('ready', 'L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i');
                resetRecordButton();
            };
            
            recognition.onend = function() {
                isRecording = false;
                updateStatus('ready', 'S·∫µn s√†ng ghi √¢m');
                resetRecordButton();
            };
            
        } catch (error) {
            console.error('Failed to initialize speech recognition:', error);
            document.getElementById('supportText').innerHTML = '‚ùå L·ªói kh·ªüi t·∫°o nh·∫≠n di·ªán gi·ªçng n√≥i';
        }
    }
    
    function getLanguageCode(langCode) {
        const langMap = {
            'vi': 'vi-VN', 'en': 'en-US', 'zh': 'zh-CN', 'ja': 'ja-JP',
            'ko': 'ko-KR', 'fr': 'fr-FR', 'de': 'de-DE', 'es': 'es-ES'
        };
        return langMap[langCode] || langCode;
    }
    
    function toggleRecording() {
        if (!recognition) {
            alert('Speech recognition kh√¥ng kh·∫£ d·ª•ng!');
            return;
        }
        
        if (isRecording) {
            recognition.stop();
        } else {
            try {
                recognition.lang = getLanguageCode(document.getElementById('sourceLanguage').value);
                finalTranscript = '';
                document.getElementById('recognizedText').value = '';
                document.getElementById('manualText').value = '';
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                alert('L·ªói kh·ªüi ƒë·ªông ghi √¢m: ' + error.message);
            }
        }
    }
    
    function updateStatus(status, text) {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        indicator.className = 'status-indicator status-' + status;
        statusText.textContent = text;
    }
    
    function resetRecordButton() {
        document.getElementById('recordButton').innerHTML = '<i class="fas fa-microphone"></i>';
        document.getElementById('recordButton').classList.remove('recording');
    }
    
    function syncTextAndCheck() {
        const manualText = document.getElementById('manualText').value;
        document.getElementById('recognizedText').value = manualText;
        finalTranscript = manualText;
        checkTranslateButton();
    }
    
    function checkTranslateButton() {
        const recognizedText = document.getElementById('recognizedText').value.trim();
        const manualText = document.getElementById('manualText').value.trim();
        const translateButton = document.getElementById('translateButton');
        
        if (recognizedText || manualText) {
            translateButton.disabled = false;
            translateButton.classList.remove('btn-secondary');
            translateButton.classList.add('translate-btn');
        } else {
            translateButton.disabled = true;
            translateButton.classList.add('btn-secondary');
            translateButton.classList.remove('translate-btn');
        }
    }
    
    async function translateText() {
        const text = document.getElementById('recognizedText').value.trim() || 
                    document.getElementById('manualText').value.trim();
        
        if (!text) {
            alert('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch!');
            return;
        }
        
        const sourceLanguage = document.getElementById('sourceLanguage').value;
        const targetLanguage = document.getElementById('targetLanguage').value;
        
        if (sourceLanguage === targetLanguage) {
            alert('Ng√¥n ng·ªØ ngu·ªìn v√† ƒë√≠ch kh√¥ng th·ªÉ gi·ªëng nhau!');
            return;
        }
        
        updateStatus('processing', 'ƒêang d·ªãch...');
        const translateButton = document.getElementById('translateButton');
        const originalText = translateButton.innerHTML;
        translateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang d·ªãch...';
        translateButton.disabled = true;
        
        try {
            const response = await fetch('/api/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    source_lang: sourceLanguage,
                    target_lang: targetLanguage
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            
            document.getElementById('translatedText').textContent = result.translated_text;
            document.getElementById('translationResult').style.display = 'block';
            updateStatus('ready', 'D·ªãch th√†nh c√¥ng!');
            
        } catch (error) {
            console.error('Translation error:', error);
            alert('L·ªói khi d·ªãch: ' + error.message);
            updateStatus('ready', 'L·ªói d·ªãch thu·∫≠t');
        } finally {
            translateButton.innerHTML = originalText;
            checkTranslateButton();
        }
    }
    
    async function copyTranslation() {
        const translatedText = document.getElementById('translatedText').textContent;
        
        try {
            await navigator.clipboard.writeText(translatedText);
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            copyBtn.classList.add('btn-success');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('btn-success');
            }, 2000);
            
        } catch (error) {
            alert('ƒê√£ copy v√†o clipboard!');
        }
    }
    
    function swapLanguages() {
        const sourceSelect = document.getElementById('sourceLanguage');
        const targetSelect = document.getElementById('targetLanguage');
        
        const tempValue = sourceSelect.value;
        sourceSelect.value = targetSelect.value;
        targetSelect.value = tempValue;
        
        if (recognition) {
            recognition.lang = getLanguageCode(sourceSelect.value);
        }
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            showSuccess('ƒê√£ copy ph·∫£n h·ªìi!');
        } catch (error) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showSuccess('ƒê√£ copy ph·∫£n h·ªìi!');
        }
    }
    
    function showLoading(show) {
        document.querySelector('.loading-overlay').style.display = show ? 'flex' : 'none';
    }
    
    function showSuccess(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 m-3 alert alert-success alert-dismissible';
        toast.style.zIndex = '9999';
        toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    function showError(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 m-3 alert alert-danger alert-dismissible';
        toast.style.zIndex = '9999';
        toast.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }
    
    // Quick action functions
    function viewTemplates() { window.location.href = '/templates'; }
    function clearAll() { 
        removeImage(); 
        document.getElementById('manualText').value = '';
        document.getElementById('recognizedText').value = '';
        document.getElementById('translationResult').style.display = 'none';
    }
    function switchToVoice() {
        const voiceTab = new bootstrap.Tab(document.getElementById('voice-tab'));
        voiceTab.show();
    }
    function switchToChat() {
        const chatTab = new bootstrap.Tab(document.getElementById('chat-tab'));
        chatTab.show();
    }
</script>
{% endblock %}
