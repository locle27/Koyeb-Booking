{% extends "base.html" %}

{% block title %}AI Assistant - L·ªÖ T√¢n Th√¥ng Minh{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center my-4">
        <h1 class="mb-0">
            <i class="fas fa-robot text-primary"></i> AI Assistant Hub
        </h1>
        <div class="badge bg-primary">L·ªÖ T√¢n Th√¥ng Minh 2.0</div>
    </div>
    
    <!-- Tab Navigation -->
    <ul class="nav nav-pills nav-fill mb-4" id="aiTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active fw-bold" id="chat-tab" data-bs-toggle="pill" data-bs-target="#chat-panel" type="button" role="tab">
                <i class="fas fa-comments me-2"></i>AI Chat Assistant
                <small class="d-block text-muted mt-1">Ph√¢n t√≠ch ƒëo·∫°n chat & t·∫°o ph·∫£n h·ªìi AI</small>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="voice-tab" data-bs-toggle="pill" data-bs-target="#voice-panel" type="button" role="tab">
                <i class="fas fa-microphone-alt me-2"></i>Voice Translator
                <small class="d-block text-muted mt-1">D·ªãch gi·ªçng n√≥i th√¥ng minh</small>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link fw-bold" id="templates-tab" data-bs-toggle="pill" data-bs-target="#templates-panel" type="button" role="tab">
                <i class="fas fa-clipboard-list me-2"></i>M·∫´u Tin Nh·∫Øn
                <small class="d-block text-muted mt-1">Qu·∫£n l√Ω templates messages</small>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="aiTabsContent">
        <!-- AI Chat Assistant Panel -->
        <div class="tab-pane fade show active" id="chat-panel" role="tabpanel">
            
            <!-- üß† NEW: RAG Chat Interface -->
            <div class="card mb-4" style="border: 2px solid #667eea;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0 text-white fw-bold">
                        <i class="fas fa-brain me-2"></i>üß† RAG Chat Assistant - Smart Hotel Q&A
                    </h5>
                    <small class="text-white-50">Ask questions about hotel policies, Hanoi attractions, or guest services</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="input-group mb-3">
                                <input type="text" id="ragQueryInput" class="form-control" 
                                       placeholder="Ask me anything: check-in time, nearby restaurants, taxi prices..."
                                       onkeypress="if(event.key==='Enter') sendRAGQuery()">
                                <input type="text" id="ragGuestName" class="form-control" 
                                       placeholder="Guest name (optional)" style="max-width: 150px;">
                                <button class="btn btn-primary" onclick="sendRAGQuery()">
                                    <i class="fas fa-search"></i> Ask RAG
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-info btn-sm" onclick="ragQuickQuestion('check-in time')">
                                    <i class="fas fa-clock"></i> Check-in
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="ragQuickQuestion('taxi airport')">
                                    <i class="fas fa-taxi"></i> Taxi
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="ragQuickQuestion('food recommendations')">
                                    <i class="fas fa-utensils"></i> Food
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üöÄ NEW: Gemini Enhancement Toggle -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="geminiModeToggle" checked>
                                    <label class="form-check-label fw-bold" for="geminiModeToggle">
                                        üöÄ Gemini AI Enhancement
                                    </label>
                                    <small class="d-block text-muted">Advanced reasoning, multi-turn conversation, better understanding</small>
                                </div>
                                <div class="text-end">
                                    <span id="ragModeIndicator" class="badge bg-success">Gemini Mode</span>
                                    <div class="small text-muted" id="ragModeDescription">Natural language AI</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- RAG Response Area -->
                    <div id="ragResponseArea" class="mt-3" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="text-primary mb-0">
                                        <i class="fas fa-robot"></i> RAG Response
                                    </h6>
                                    <div class="d-flex align-items-center">
                                        <span id="ragConfidence" class="badge bg-success me-2">High Confidence</span>
                                        <span id="ragTimestamp" class="text-muted small"></span>
                                    </div>
                                </div>
                                <div id="ragAnswer" class="mb-3"></div>
                                
                                <!-- Guest Context (if available) -->
                                <div id="ragGuestContext" style="display: none;">
                                    <div class="alert alert-info py-2">
                                        <i class="fas fa-user"></i> <strong>Guest Context:</strong>
                                        <span id="ragGuestInfo"></span>
                                    </div>
                                </div>
                                
                                <!-- Sources -->
                                <div id="ragSources" class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-book"></i> <strong>Sources:</strong>
                                        <span id="ragSourcesList"></span>
                                    </small>
                                </div>
                                
                                <!-- Suggestions -->
                                <div id="ragSuggestions" class="mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb"></i> <strong>Suggestions:</strong>
                                        <div id="ragSuggestionsList"></div>
                                    </small>
                                </div>
                                
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="copyRAGResponse()">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="clearRAGResponse()">
                                        <i class="fas fa-refresh"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- Ph·∫ßn t·∫£i ·∫£nh -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-image"></i> T·∫£i ·∫¢nh ƒêo·∫°n Chat
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="imagePasteArea" class="image-paste-area">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>D√°n ·∫£nh, ch·ªçn file ho·∫∑c ch·ª•p ·∫£nh</h5>
                                <p class="text-muted mb-2">
                                    H·ªó tr·ª£: PNG, JPG, JPEG<br>
                                    <kbd>Ctrl+V</kbd> ƒë·ªÉ d√°n ·∫£nh t·ª´ clipboard
                                </p>
                                <div class="d-block d-md-none mt-2">
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="selectImageFile()">
                                                <i class="fas fa-folder-open"></i><br>
                                                <small>Ch·ªçn ·∫£nh</small>
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="capturePhoto()">
                                                <i class="fas fa-camera"></i><br>
                                                <small>Camera sau</small>
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="captureFrontPhoto()">
                                                <i class="fas fa-camera-retro"></i><br>
                                                <small>Camera tr∆∞·ªõc</small>
                                            </button>
                                        </div>
                                        <div class="col-6">
                                            <button type="button" class="btn btn-outline-warning btn-sm w-100" onclick="triggerSafariPicker()">
                                                <i class="fab fa-safari"></i><br>
                                                <small>Safari Fix</small>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-none d-md-block mt-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="selectImageFile()">
                                        <i class="fas fa-folder-open"></i> Ch·ªçn t·ª´ th∆∞ vi·ªán
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="capturePhoto()">
                                        <i class="fas fa-camera"></i> Ch·ª•p ·∫£nh
                                    </button>
                                </div>
                            </div>
                            
                            <input type="file" id="imageFileInput" 
                                   accept="image/*,image/png,image/jpeg,image/jpg,image/gif,image/webp" 
                                   style="display: none;">
                            <input type="file" id="cameraInput" 
                                   accept="image/*,image/png,image/jpeg,image/jpg" 
                                   capture="environment" 
                                   style="display: none;">
                            <input type="file" id="frontCameraInput" 
                                   accept="image/*,image/png,image/jpeg,image/jpg" 
                                   capture="user" 
                                   style="display: none;">
                            
                            <div id="imagePreviewContainer" class="mt-3" style="display: none;">
                                <img id="imagePreview" class="image-preview" alt="Xem tr∆∞·ªõc ·∫£nh">
                                <div class="mt-2">
                                    <button class="btn btn-danger btn-sm" onclick="removeImage()">
                                        <i class="fas fa-trash"></i> X√≥a ·∫£nh
                                    </button>
                                    <button class="btn btn-primary btn-sm ms-2" onclick="analyzeImage()">
                                        <i class="fas fa-magic"></i> Ph√¢n t√≠ch v·ªõi AI
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ph·∫ßn c·∫•u h√¨nh v√† k·∫øt qu·∫£ AI -->
                <div class="col-md-6">
                    <!-- AI Configuration Panel -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-cogs"></i> T√πy Ch·ªçn Ph·∫£n H·ªìi AI
                            </h6>
                        </div>
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <label for="templateCategory" class="form-label small mb-1">M·∫´u tin nh·∫Øn:</label>
                                    <select id="templateCategory" class="form-select form-select-sm" onchange="loadSpecificTemplates()">
                                        <option value="">T·ª± ƒë·ªông ch·ªçn</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="specificTemplate" class="form-label small mb-1">M·∫´u c·ª• th·ªÉ:</label>
                                    <select id="specificTemplate" class="form-select form-select-sm" disabled onchange="previewSelectedTemplate()">
                                        <option value="">Ch·ªçn category tr∆∞·ªõc</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small mb-1">Phong c√°ch tr·∫£ l·ªùi:</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="responseMode" id="responseModeAuto" value="auto" checked>
                                        <label class="btn btn-outline-secondary btn-sm" for="responseModeAuto">Auto</label>
                                        
                                        <input type="radio" class="btn-check" name="responseMode" id="responseModeYes" value="yes">
                                        <label class="btn btn-outline-success btn-sm" for="responseModeYes">Yes</label>
                                        
                                        <input type="radio" class="btn-check" name="responseMode" id="responseModeNo" value="no">
                                        <label class="btn btn-outline-danger btn-sm" for="responseModeNo">No</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Custom Instructions Section -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="card border-info bg-light">
                                        <div class="card-header py-2 custom-instructions-header">
                                            <small class="fw-bold">
                                                <i class="fas fa-magic me-1"></i>H∆∞·ªõng d·∫´n t√πy ch·ªânh (Custom Instructions)
                                            </small>
                                            <button class="btn btn-sm btn-outline-light ms-2" onclick="toggleCustomInstructions()" id="customToggleBtn">
                                                <i class="fas fa-chevron-down" id="customToggleIcon"></i>
                                            </button>
                                        </div>
                                        <div class="card-body py-2" id="customInstructionsSection" style="display: none;">
                                            <div class="mb-2">
                                                <label class="form-label small mb-1">
                                                    <strong>H∆∞·ªõng d·∫´n AI theo √Ω mu·ªën c·ªßa b·∫°n:</strong>
                                                    <span class="text-muted">(Text ho·∫∑c Voice)</span>
                                                </label>
                                                <div class="input-group">
                                                    <textarea id="customInstructions" class="form-control" rows="3" 
                                                        placeholder="VD: Tr·∫£ l·ªùi ng·∫Øn g·ªçn v√† th√¢n thi·ªán, s·ª≠ d·ª•ng emoji, ƒë·ªÅ c·∫≠p ƒë·∫øn t√™n kh√°ch h√†ng..."></textarea>
                                                    <button class="btn btn-outline-danger" type="button" onclick="startVoiceInstructions()" id="voiceInstructBtn">
                                                        <i class="fas fa-microphone"></i>
                                                    </button>
                                                </div>
                                                <div class="form-text">
                                                    <i class="fas fa-info-circle"></i> AI s·∫Ω ∆∞u ti√™n h∆∞·ªõng d·∫´n n√†y khi t·∫°o ph·∫£n h·ªìi. 
                                                    B·∫°n c√≥ th·ªÉ nh·∫≠p b·∫±ng text ho·∫∑c d√πng voice (n√∫t mic).
                                                </div>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-info" onclick="loadSampleInstructions()">
                                                    <i class="fas fa-lightbulb"></i> M·∫´u
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="clearCustomInstructions()">
                                                    <i class="fas fa-trash"></i> X√≥a
                                                </button>
                                                <button class="btn btn-sm btn-outline-success" onclick="saveCustomInstructions()">
                                                    <i class="fas fa-save"></i> L∆∞u
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="templatePreview" class="mt-2" style="display: none;">
                                <div class="alert alert-light border-start border-4 border-primary py-2 px-3 mb-0">
                                    <small class="text-muted d-block mb-1">Preview m·∫´u ƒë√£ ch·ªçn:</small>
                                    <div id="templatePreviewContent" class="small"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Response Area -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-comments"></i> Ph·∫£n H·ªìi AI
                            </h5>
                            <div id="processingStatus" class="text-muted" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch...
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="responseArea" class="response-area">
                                <div class="text-center text-muted">
                                    <i class="fas fa-robot fa-2x mb-3 text-primary"></i>
                                    <h6 class="text-primary">üß† AI Chat Assistant - Context-Aware Intelligence</h6>
                                    <p class="mb-3">T·∫£i ·∫£nh ƒëo·∫°n chat l√™n, AI s·∫Ω ƒë·ªçc v√† hi·ªÉu <strong>to√†n b·ªô b·ªëi c·∫£nh</strong> ƒë·ªÉ ƒë∆∞a ra ph·∫£n h·ªìi th√¥ng minh!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Voice Translator Panel -->
        <div class="tab-pane fade" id="voice-panel" role="tabpanel">
            <div class="card">
                <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0 text-dark fw-bold" style="text-shadow: 1px 1px 2px rgba(255,255,255,0.6);">
                        <i class="fas fa-microphone-alt me-2 text-dark"></i>Voice Translator - Smart Voice Translation
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Language Selection -->
                    <div class="row mb-4">
                        <div class="col-md-5">
                            <label class="form-label fw-bold">
                                <i class="fas fa-flag"></i> Ng√¥n ng·ªØ ngu·ªìn:
                            </label>
                            <select id="sourceLanguage" class="form-select language-select">
                                <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                                <option value="en">üá∫üá∏ English</option>
                                <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                                <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                                <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                                <option value="fr">üá´üá∑ Fran√ßais</option>
                                <option value="de">üá©üá™ Deutsch</option>
                                <option value="es">üá™üá∏ Espa√±ol</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end justify-content-center">
                            <button class="btn btn-outline-secondary" onclick="swapLanguages()">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-bold">
                                <i class="fas fa-language"></i> Ng√¥n ng·ªØ ƒë√≠ch:
                            </label>
                            <select id="targetLanguage" class="form-select language-select">
                                <option value="en">üá∫üá∏ English</option>
                                <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                                <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                                <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                                <option value="ko">üá∞üá∑ ÌïúÍµ≠Ïñ¥</option>
                                <option value="fr">üá´üá∑ Fran√ßais</option>
                                <option value="de">üá©üá™ Deutsch</option>
                                <option value="es">üá™üá∏ Espa√±ol</option>
                            </select>
                        </div>
                    </div>

                    <!-- Voice Recording and Text Input Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <!-- Voice Recording -->
                            <div class="text-center p-4" style="border: 2px dashed #dee2e6; border-radius: 15px;">
                                <h5 class="mb-3">
                                    <span id="statusIndicator" class="status-indicator status-ready"></span>
                                    <span id="statusText">S·∫µn s√†ng ghi √¢m</span>
                                </h5>
                                <button id="recordButton" class="record-button mb-3" onclick="toggleRecording()">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <div>
                                    <small class="text-muted">Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu/d·ª´ng ghi √¢m</small>
                                </div>
                                
                                <div id="supportInfo" class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        <span id="supportText">ƒêang ki·ªÉm tra h·ªó tr·ª£ microphone...</span>
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Speech Recognition Result -->
                            <div class="mt-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-comment-dots"></i> VƒÉn b·∫£n nh·∫≠n di·ªán:
                                </label>
                                <textarea id="recognizedText" class="form-control text-area" 
                                    placeholder="VƒÉn b·∫£n t·ª´ gi·ªçng n√≥i s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."
                                    oninput="checkTranslateButton()" readonly></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- Manual Text Input -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-keyboard"></i> Ho·∫∑c nh·∫≠p vƒÉn b·∫£n th·ªß c√¥ng:
                                </label>
                                <textarea id="manualText" class="form-control text-area" 
                                    placeholder="Nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch ·ªü ƒë√¢y..."
                                    oninput="syncTextAndCheck()"></textarea>
                            </div>
                            
                            <!-- Translate Button -->
                            <div class="text-center mb-3">
                                <button id="translateButton" class="btn translate-btn" onclick="translateText()">
                                    <i class="fas fa-language"></i> D·ªãch Ngay
                                </button>
                            </div>
                            
                            <!-- Translation Result -->
                            <div class="result-area position-relative" id="translationResult" style="display: none;">
                                <button class="copy-btn" onclick="copyTranslation()">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <h6 class="text-primary mb-2">
                                    <i class="fas fa-globe"></i> K·∫øt qu·∫£ d·ªãch:
                                </h6>
                                <div id="translatedText" class="fw-bold" style="font-size: 1.1rem; line-height: 1.6;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Templates Panel -->
        <div class="tab-pane fade" id="templates-panel" role="tabpanel">
            <div class="card">
                <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-white fw-bold" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                            <i class="fas fa-clipboard-list me-2 text-white"></i>Qu·∫£n l√Ω M·∫´u Tin Nh·∫Øn
                        </h5>
                        <div>
                            <button class="btn btn-warning btn-sm me-2 fw-bold" onclick="showAddTemplateModal()">
                                <i class="fas fa-plus text-dark"></i> Th√™m m·∫´u
                            </button>
                            <button class="btn btn-success btn-sm me-2 fw-bold" onclick="importFromSheets()">
                                <i class="fas fa-download text-white"></i> Import
                            </button>
                            <button class="btn btn-danger btn-sm fw-bold" onclick="exportToSheets()">
                                <i class="fas fa-upload text-white"></i> Export
                            </button>
                            <button class="btn btn-info btn-sm fw-bold" onclick="testSheetsConnection()" title="Test Google Sheets connection">
                                <i class="fas fa-link text-white"></i> Test
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="templatesContainer">
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                            </div>
                            <p class="mt-2">ƒêang t·∫£i danh s√°ch m·∫´u tin nh·∫Øn...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <button class="btn btn-info w-100 mb-2" onclick="viewTemplates()">
                                <i class="fas fa-list me-2"></i>Xem m·∫´u tin nh·∫Øn
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-success w-100 mb-2" onclick="clearAll()">
                                <i class="fas fa-refresh me-2"></i>L√†m m·ªõi t·∫•t c·∫£
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-warning w-100 mb-2" onclick="switchToVoice()">
                                <i class="fas fa-microphone-alt me-2"></i>Chuy·ªÉn sang Voice
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-secondary w-100 mb-2" onclick="switchToChat()">
                                <i class="fas fa-comments me-2"></i>Chuy·ªÉn sang Chat AI
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Modal th√™m m·∫´u tin nh·∫Øn -->
<div class="modal fade" id="addTemplateModal" tabindex="-1" aria-labelledby="addTemplateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="addTemplateModalLabel">
                    <i class="fas fa-plus"></i> Th√™m M·∫´u Tin Nh·∫Øn M·ªõi
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTemplateForm">
                    <div class="mb-3">
                        <label for="addTemplateCategory" class="form-label">Danh m·ª•c <span class="text-danger">*</span></label>
                        <select class="form-select" id="addTemplateCategory" required>
                            <option value="">-- Ch·ªçn danh m·ª•c --</option>
                            <option value="WELCOME">WELCOME</option>
                            <option value="ARRIVAL">ARRIVAL</option>
                            <option value="CHECK IN">CHECK IN</option>
                            <option value="EARLY CHECK IN">EARLY CHECK IN</option>
                            <option value="DON PHONG">DON PHONG</option>
                            <option value="HET PHONG">HET PHONG</option>
                            <option value="FEED BACK">FEED BACK</option>
                            <option value="TAXI">TAXI</option>
                            <option value="PARK">PARK</option>
                            <option value="LAUNDRY">LAUNDRY</option>
                            <option value="NOT BOOKING">NOT BOOKING</option>
                            <option value="OTHER">Kh√°c (nh·∫≠p th·ªß c√¥ng)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="customCategoryDiv" style="display: none;">
                        <label for="customCategory" class="form-label">Danh m·ª•c t√πy ch·ªânh <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customCategory" placeholder="Nh·∫≠p t√™n danh m·ª•c m·ªõi">
                    </div>
                    
                    <div class="mb-3">
                        <label for="templateLabel" class="form-label">Nh√£n <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="templateLabel" placeholder="VD: DEFAULT, 1, 2, v.v." required>
                        <div class="form-text">S·ª≠ d·ª•ng "DEFAULT" cho m·∫´u m·∫∑c ƒë·ªãnh ho·∫∑c s·ªë th·ª© t·ª± cho c√°c bi·∫øn th·ªÉ</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="templateMessage" class="form-label">N·ªôi dung tin nh·∫Øn <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="templateMessage" rows="6" placeholder="Nh·∫≠p n·ªôi dung tin nh·∫Øn..." required></textarea>
                        <div class="form-text">C√≥ th·ªÉ s·ª≠ d·ª•ng xu·ªëng d√≤ng b·∫±ng c√°ch nh·∫•n Enter</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="addNewTemplate()">
                    <i class="fas fa-save"></i> Th√™m & Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head_extra %}
<style>
    .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9998;}
    .image-paste-area{border:2px dashed #dee2e6;border-radius:8px;padding:40px;text-align:center;background:#f8f9fa;transition:all 0.3s;cursor:pointer;}
    .image-paste-area:hover{border-color:#0d6efd;background:#e7f3ff;}
    .image-paste-area.dragover{border-color:#0d6efd;background:#e7f3ff;transform:scale(1.02);}
    .image-preview{max-width:100%;max-height:400px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);}
    .response-area{background:#f8f9fa;border-radius:8px;padding:20px;margin-top:20px;min-height:150px;}
    .copy-button{position:absolute;top:10px;right:10px;}
    .ai-response{position:relative;background:white;border-radius:8px;padding:15px;border-left:4px solid #28a745;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
    .analysis-info{background:#e3f2fd;border-radius:6px;padding:12px;margin-bottom:15px;font-size:0.9em;}
    .template-match{background:#fff3cd;border-radius:6px;padding:10px;margin:10px 0;border-left:3px solid #ffc107;}

    /* Voice Translator Styles */
    .record-button {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        color: white;
        font-size: 2.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .record-button:hover {
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(255, 107, 107, 0.4);
    }
    .record-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }
    .record-button.recording {
        background: linear-gradient(135deg, #ff4757, #ff3838);
        animation: pulse 1.5s ease-in-out infinite alternate;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        100% { transform: scale(1.1); }
    }
    .language-select {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #e3f2fd;
        border-radius: 15px;
        padding: 10px 15px;
        font-weight: 500;
    }
    .text-area {
        background: rgba(248, 249, 250, 0.8);
        border: 2px solid #e9ecef;
        border-radius: 15px;
        min-height: 120px;
        resize: vertical;
        font-size: 16px;
    }
    .text-area:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .translate-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        border-radius: 50px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
        color: white;
    }
    .translate-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        color: white;
    }
    .translate-btn:disabled {
        background: #6c757d;
        transform: none;
        box-shadow: none;
        color: white;
    }
    .result-area {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border-radius: 15px;
        padding: 20px;
        border-left: 5px solid #2196f3;
    }
    .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(33, 150, 243, 0.1);
        border: 1px solid #2196f3;
        border-radius: 8px;
        color: #2196f3;
        padding: 5px 10px;
        font-size: 0.85rem;
    }
    .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
    }
    .status-ready { background-color: #28a745; }
    .status-listening { background-color: #ff6b6b; animation: blink 1s infinite; }
    .status-processing { background-color: #ffc107; }
    @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
    }

    /* Tab styles */
    .nav-pills .nav-link {
        border-radius: 15px;
        margin: 0 5px;
        transition: all 0.3s ease;
    }
    .nav-pills .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .nav-pills .nav-link:not(.active):hover {
        background: rgba(102, 126, 234, 0.1);
        transform: translateY(-1px);
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .record-button {
            width: 100px;
            height: 100px;
            font-size: 2rem;
        }
        .translate-btn {
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }
        .image-paste-area {
            padding: 25px 15px;
            font-size: 0.9rem;
        }
        .nav-pills .nav-link {
            font-size: 0.9rem;
            padding: 10px;
        }
        
        /* Safari mobile specific fixes */
        input[type="file"] {
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* Better touch targets for mobile */
        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            min-height: 40px; /* Better touch target */
        }
        
        /* Image preview improvements for mobile */
        .image-preview {
            max-height: 300px; /* Smaller on mobile */
        }
        
        /* Grid improvements for mobile buttons */
        .row.g-2 > .col-6 {
            padding: 0.25rem;
        }
        
        .row.g-2 .btn {
            padding: 0.75rem 0.5rem;
            font-size: 0.8rem;
            line-height: 1.2;
        }
    }
    
    /* iOS Safari specific fixes */
    @supports (-webkit-touch-callout: none) {
        .image-paste-area {
            /* Better touch handling on iOS */
            -webkit-touch-callout: default;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input[type="file"] {
            /* iOS file input fixes */
            opacity: 0;
            position: absolute;
            z-index: -1;
        }
    }

    /* ‚úÖ CUSTOM INSTRUCTIONS STYLING FIXES */
    .custom-instructions-header {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
        border: none !important;
    }
    
    .custom-instructions-header * {
        color: #ffffff !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    .custom-instructions-header .btn-outline-light {
        border-color: rgba(255,255,255,0.5) !important;
        color: #ffffff !important;
    }
    
    .custom-instructions-header .btn-outline-light:hover {
        background-color: rgba(255,255,255,0.2) !important;
        border-color: #ffffff !important;
        color: #ffffff !important;
    }
    
    /* Make sure labels in custom instructions are visible */
    #customInstructionsSection .form-label {
        color: #212529 !important;
        font-weight: 600;
    }
    
    #customInstructionsSection .form-text {
        color: #6c757d !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Emergency debugging - check if JavaScript loads at all
    console.log('üö® EMERGENCY DEBUG: JavaScript is loading...');
    console.log('üö® EMERGENCY DEBUG: Script execution started');
    
    // Test function that can be called from console
    window.testFunction = function() {
        alert('JavaScript is working!');
        console.log('‚úÖ JavaScript execution confirmed');
    };
    
    // Immediately test basic function definition
    console.log('üö® EMERGENCY DEBUG: About to define selectImageFile...');
    
    // Combined AI Assistant functionality
    let currentImageData = null;
    let allTemplates = [];
    let templates = []; // Templates for management tab
    let isTemplatesLoaded = false; // Template loading state
    let recognition = null;
    let isRecording = false;
    let finalTranscript = '';
    
    // Voice instruction variables
    let voiceInstructionRecognition = null;
    let isVoiceInstructionRecording = false;
    
    // ===== GLOBAL FUNCTIONS FOR ONCLICK HANDLERS =====
    // These functions need to be in global scope to work with onclick attributes
    
    // Image handling functions
    window.selectImageFile = function() {
        console.log('üö® GLOBAL: selectImageFile called');
        const input = document.getElementById('imageFileInput');
        if (input) input.click();
        else console.error('imageFileInput not found');
    };
    console.log('üö® EMERGENCY DEBUG: selectImageFile defined successfully');
    
    window.capturePhoto = function() {
        console.log('üö® GLOBAL: capturePhoto called');
        const input = document.getElementById('cameraInput');
        if (input) input.click();
        else console.error('cameraInput not found');
    };
    
    window.captureFrontPhoto = function() {
        console.log('üö® GLOBAL: captureFrontPhoto called');
        const input = document.getElementById('frontCameraInput');
        if (input) input.click();
        else console.error('frontCameraInput not found');
    };
    
    window.triggerSafariPicker = function() {
        console.log('üö® GLOBAL: triggerSafariPicker called');
        // Create a temporary input with different attributes for Safari
        const tempInput = document.createElement('input');
        tempInput.type = 'file';
        tempInput.accept = 'image/png,image/jpeg,image/jpg,image/gif,image/webp,image/*';
        tempInput.multiple = false;
        tempInput.style.display = 'none';
        
        // Add event listener
        tempInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
            document.body.removeChild(tempInput);
        });
        
        document.body.appendChild(tempInput);
        setTimeout(() => tempInput.click(), 100);
    };
    
    window.removeImage = function() {
        console.log('üö® GLOBAL: removeImage called');
        currentImageData = null;
        const previewContainer = document.getElementById('imagePreviewContainer');
        const pasteArea = document.getElementById('imagePasteArea');
        const fileInput = document.getElementById('imageFileInput');
        
        if (previewContainer) previewContainer.style.display = 'none';
        if (pasteArea) pasteArea.style.display = 'block';
        if (fileInput) fileInput.value = '';
        
        const responseArea = document.getElementById('responseArea');
        if (responseArea) {
            responseArea.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-robot fa-2x mb-3 text-primary"></i>
                    <h6 class="text-primary">üß† AI Chat Assistant - Context-Aware Intelligence</h6>
                    <p class="mb-3">T·∫£i ·∫£nh ƒëo·∫°n chat l√™n, AI s·∫Ω ƒë·ªçc v√† hi·ªÉu <strong>to√†n b·ªô b·ªëi c·∫£nh</strong> ƒë·ªÉ ƒë∆∞a ra ph·∫£n h·ªìi th√¥ng minh!</p>
                </div>
            `;
        }
    };
    
    window.analyzeImage = function() {
        console.log('üö® GLOBAL: analyzeImage called');
        if (!currentImageData) {
            alert('Vui l√≤ng t·∫£i ·∫£nh tr∆∞·ªõc!');
            return;
        }
        
        // Call analysis function directly without Async suffix
        try {
            if (!currentImageData) {
                alert('Vui l√≤ng t·∫£i ·∫£nh tr∆∞·ªõc!');
                return;
            }
            
            showLoading(true);
            document.getElementById('processingStatus').style.display = 'block';
            
            const aiConfig = getCurrentAIConfig();
            const requestData = {
                image_b64: currentImageData,
                ai_config: aiConfig
            };
            
            fetch('/api/ai_chat_analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.error) {
                    throw new Error(result.error);
                }
                displayAIResponse(result, aiConfig);
            })
            .catch(error => {
                console.error('AI Analysis error:', error);
                showError('L·ªói khi ph√¢n t√≠ch ·∫£nh: ' + error.message);
            })
            .finally(() => {
                showLoading(false);
                document.getElementById('processingStatus').style.display = 'none';
            });
            
        } catch (error) {
            console.error('Error in analyzeImage:', error);
            showError('L·ªói khi ph√¢n t√≠ch ·∫£nh: ' + error.message);
        }
    };
    
    // Voice functions
    window.toggleRecording = function() {
        console.log('üö® GLOBAL: toggleRecording called');
        
        // Call the internal function to avoid naming conflicts
        if (typeof toggleRecordingInternal === 'function') {
            toggleRecordingInternal();
        } else {
            alert('Ch·ª©c nƒÉng ghi √¢m ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.translateText = function() {
        console.log('üö® GLOBAL: translateText called');
        if (typeof translateTextAsync === 'function') {
            translateTextAsync();
        } else {
            alert('Ch·ª©c nƒÉng d·ªãch ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    // Template functions
    window.showAddTemplateModal = function() {
        console.log('üö® GLOBAL: showAddTemplateModal called');
        if (typeof showAddTemplateModalAsync === 'function') {
            showAddTemplateModalAsync();
        } else {
            alert('Ch·ª©c nƒÉng th√™m template ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.importFromSheets = function() {
        console.log('üö® GLOBAL: importFromSheets called');
        
        // Implement the actual import functionality
        try {
            if (confirm('Import templates t·ª´ Google Sheets?\n\nThao t√°c n√†y s·∫Ω thay th·∫ø to√†n b·ªô templates hi·ªán t·∫°i.')) {
                showLoading(true);
                
                fetch('/templates/import', {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        showSuccess('‚úÖ ƒê√£ import templates th√†nh c√¥ng t·ª´ Google Sheets!');
                        // Reload templates to show updated data
                        isTemplatesLoaded = false;
                        templates = [];
                        allTemplates = [];
                        setTimeout(() => {
                            loadTemplatesForTab();
                            loadTemplateCategories();
                        }, 1000);
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    console.error('Import error:', error);
                    showError('‚ùå L·ªói import templates: ' + error.message);
                })
                .finally(() => {
                    showLoading(false);
                });
            }
        } catch (error) {
            console.error('Error in importFromSheets:', error);
            showError('L·ªói khi import: ' + error.message);
        }
    };
    
    window.toggleCustomInstructions = function() {
        console.log('üö® GLOBAL: toggleCustomInstructions called');
        const section = document.getElementById('customInstructionsSection');
        const icon = document.getElementById('customToggleIcon');
        if (section && icon) {
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                section.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }
    };
    
    // Additional missing global functions
    window.exportToSheets = function() {
        console.log('üö® GLOBAL: exportToSheets called');
        if (typeof exportToSheetsAsync === 'function') {
            exportToSheetsAsync();
        } else {
            alert('Ch·ª©c nƒÉng export ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.swapLanguages = function() {
        console.log('üö® GLOBAL: swapLanguages called');
        if (typeof swapLanguagesAsync === 'function') {
            swapLanguagesAsync();
        } else {
            // Simple swap logic for immediate feedback
            const fromLang = document.getElementById('fromLanguage');
            const toLang = document.getElementById('toLanguage');
            if (fromLang && toLang) {
                const temp = fromLang.value;
                fromLang.value = toLang.value;
                toLang.value = temp;
            }
        }
    };
    
    window.copyTranslation = function() {
        console.log('üö® GLOBAL: copyTranslation called');
        const outputText = document.getElementById('outputText');
        if (outputText && outputText.value) {
            navigator.clipboard.writeText(outputText.value).then(() => {
                alert('ƒê√£ copy!');
            }).catch(() => {
                alert('Kh√¥ng th·ªÉ copy');
            });
        }
    };
    
    window.startVoiceInstructions = function() {
        console.log('üö® GLOBAL: startVoiceInstructions called');
        if (typeof startVoiceInstructionsAsync === 'function') {
            startVoiceInstructionsAsync();
        } else {
            alert('Ch·ª©c nƒÉng ghi √¢m h∆∞·ªõng d·∫´n ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.loadSampleInstructions = function() {
        console.log('üö® GLOBAL: loadSampleInstructions called');
        const textarea = document.getElementById('customInstructionsText');
        if (textarea) {
            textarea.value = 'B·∫°n l√† tr·ª£ l√Ω AI th√¥ng minh chuy√™n v·ªÅ qu·∫£n l√Ω kh√°ch s·∫°n. H√£y ph·∫£n h·ªìi m·ªôt c√°ch chuy√™n nghi·ªáp v√† h·ªØu √≠ch.';
        }
    };
    
    window.clearCustomInstructions = function() {
        console.log('üö® GLOBAL: clearCustomInstructions called');
        const textarea = document.getElementById('customInstructionsText');
        if (textarea) {
            textarea.value = '';
        }
    };
    
    window.saveCustomInstructions = function() {
        console.log('üö® GLOBAL: saveCustomInstructions called');
        const textarea = document.getElementById('customInstructionsText');
        if (textarea) {
            localStorage.setItem('customInstructions', textarea.value);
            alert('ƒê√£ l∆∞u h∆∞·ªõng d·∫´n t√πy ch·ªânh!');
        }
    };
    
    window.testSheetsConnection = function() {
        console.log('üö® GLOBAL: testSheetsConnection called');
        if (typeof testSheetsConnectionAsync === 'function') {
            testSheetsConnectionAsync();
        } else {
            alert('Ch·ª©c nƒÉng test k·∫øt n·ªëi ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.viewTemplates = function() {
        console.log('üö® GLOBAL: viewTemplates called');
        const templatesTab = document.getElementById('templates-tab');
        if (templatesTab) {
            templatesTab.click();
        }
    };
    
    window.clearAll = function() {
        console.log('üö® GLOBAL: clearAll called');
        if (confirm('X√≥a t·∫•t c·∫£ d·ªØ li·ªáu?')) {
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => textarea.value = '');
        }
    };
    
    window.switchToVoice = function() {
        console.log('üö® GLOBAL: switchToVoice called');
        const voiceTab = document.getElementById('voice-tab');
        if (voiceTab) {
            voiceTab.click();
        }
    };
    
    window.switchToChat = function() {
        console.log('üö® GLOBAL: switchToChat called');
        const chatTab = document.getElementById('chat-tab');
        if (chatTab) {
            chatTab.click();
        }
    };
    
    window.addNewTemplate = function() {
        console.log('üö® GLOBAL: addNewTemplate called');
        if (typeof addNewTemplateAsync === 'function') {
            addNewTemplateAsync();
        } else {
            alert('Ch·ª©c nƒÉng th√™m template ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.copyTemplatePreview = function() {
        console.log('üö® GLOBAL: copyTemplatePreview called');
        const preview = document.getElementById('templatePreview');
        if (preview && preview.textContent) {
            navigator.clipboard.writeText(preview.textContent).then(() => {
                alert('ƒê√£ copy template preview!');
            }).catch(() => {
                alert('Kh√¥ng th·ªÉ copy');
            });
        }
    };
    
    window.copyToClipboard = function(text) {
        console.log('üö® GLOBAL: copyToClipboard called');
        navigator.clipboard.writeText(text).then(() => {
            alert('ƒê√£ copy!');
        }).catch(() => {
            alert('Kh√¥ng th·ªÉ copy');
        });
    };
    
    window.openInSafari = function() {
        console.log('üö® GLOBAL: openInSafari called');
        if (window.navigator.standalone) {
            window.location.href = window.location.href;
        } else {
            window.open(window.location.href, '_blank');
        }
    };
    
    // Template tab specific functions - they'll be properly implemented after templates load
    window.retryLoadTemplates = function() {
        console.log('üö® GLOBAL: retryLoadTemplates called');
        if (typeof retryLoadTemplatesAsync === 'function') {
            retryLoadTemplatesAsync();
        } else {
            alert('Ch·ª©c nƒÉng reload templates ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.testTemplatesConnection = function() {
        console.log('üö® GLOBAL: testTemplatesConnection called');
        if (typeof testTemplatesConnectionAsync === 'function') {
            testTemplatesConnectionAsync();
        } else {
            alert('Ch·ª©c nƒÉng test templates ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.toggleCategoryForTab = function(categoryId) {
        console.log('üö® GLOBAL: toggleCategoryForTab called with:', categoryId);
        if (typeof toggleCategoryForTabAsync === 'function') {
            toggleCategoryForTabAsync(categoryId);
        } else {
            // Simple toggle logic for immediate feedback
            const content = document.getElementById(`category-${categoryId}`);
            const icon = document.getElementById(`icon-${categoryId}`);
            if (content && icon) {
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                    icon.className = 'fas fa-chevron-down';
                } else {
                    content.style.display = 'block';
                    icon.className = 'fas fa-chevron-up';
                }
            }
        }
    };
    
    window.useTemplateFromTab = function(templateId) {
        console.log('üö® GLOBAL: useTemplateFromTab called with:', templateId);
        if (typeof useTemplateFromTabAsync === 'function') {
            useTemplateFromTabAsync(templateId);
        } else {
            alert('Template function ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.copyTemplateFromTab = function(templateId) {
        console.log('üö® GLOBAL: copyTemplateFromTab called with:', templateId);
        if (typeof copyTemplateFromTabAsync === 'function') {
            copyTemplateFromTabAsync(templateId);
        } else {
            alert('Copy template function ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o...');
        }
    };
    
    window.expandAllCategories = function() {
        console.log('üö® GLOBAL: expandAllCategories called');
        if (typeof expandAllCategoriesAsync === 'function') {
            expandAllCategoriesAsync();
        } else {
            // Simple expand logic for immediate feedback
            const allContent = document.querySelectorAll('[id^="category-"]');
            const allIcons = document.querySelectorAll('[id^="icon-"]');
            allContent.forEach(content => content.style.display = 'block');
            allIcons.forEach(icon => icon.className = 'fas fa-chevron-up');
        }
    };
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üö® EMERGENCY DEBUG: DOMContentLoaded fired - AI Assistant Hub initializing...');
        console.log('üö® EMERGENCY DEBUG: Document ready state:', document.readyState);
        
        // Test if we can find basic elements
        const testElement = document.getElementById('imagePasteArea');
        console.log('üö® EMERGENCY DEBUG: imagePasteArea element found:', !!testElement);
        
        // Test if we can add event listeners
        try {
            window.addEventListener('test', function() {});
            console.log('üö® EMERGENCY DEBUG: Event listeners working');
        } catch (error) {
            console.error('üö® EMERGENCY DEBUG: Event listeners broken:', error);
        }
        
        // Test if Bootstrap is loaded
        try {
            if (typeof bootstrap !== 'undefined') {
                console.log('üö® EMERGENCY DEBUG: Bootstrap is loaded');
            } else {
                console.error('üö® EMERGENCY DEBUG: Bootstrap is NOT loaded - tabs won\'t work');
            }
        } catch (error) {
            console.error('üö® EMERGENCY DEBUG: Bootstrap check failed:', error);
        }
        
        // Detect Safari and show additional help
        try {
            detectBrowserAndShowHelp();
            console.log('üö® EMERGENCY DEBUG: detectBrowserAndShowHelp completed');
        } catch (error) {
            console.error('üö® EMERGENCY DEBUG: detectBrowserAndShowHelp failed:', error);
        }
        
        // Initialize AI Chat Assistant with error handling
        try {
            setupImageHandling();
            console.log('‚úÖ Image handling initialized');
        } catch (error) {
            console.error('‚ùå Error initializing image handling:', error);
        }
        
        try {
            console.log('üö® EMERGENCY DEBUG: About to call loadTemplateCategories...');
            loadTemplateCategories().catch(error => {
                console.error('üö® EMERGENCY DEBUG: Template loading failed but continuing:', error);
            });
            console.log('‚úÖ Template categories loading started');
        } catch (error) {
            console.error('‚ùå Error loading template categories:', error);
        }
        
        // Initialize Voice Translator
        try {
            checkSpeechRecognitionSupport();
            console.log('‚úÖ Speech recognition support checked');
        } catch (error) {
            console.error('‚ùå Error checking speech recognition:', error);
        }
        
        try {
            checkTranslateButton();
            console.log('‚úÖ Translate button checked');
        } catch (error) {
            console.error('‚ùå Error checking translate button:', error);
        }
        
        // Debug: Add template loading button for debugging
        console.log('üöÄ AI Assistant Hub initialization completed');
        
        // LINK GLOBAL FUNCTIONS TO LOCAL ASYNC IMPLEMENTATIONS
        try {
            // Link the async functions to global scope
            window.analyzeImageAsync = analyzeImage;
            window.toggleRecordingAsync = toggleRecording;
            window.translateTextAsync = translateText;
            window.showAddTemplateModalAsync = showAddTemplateModal;
            window.importFromSheetsAsync = importFromSheets;
            
            console.log('üö® EMERGENCY DEBUG: Available functions check:');
            console.log('- selectImageFile:', typeof window.selectImageFile);
            console.log('- toggleRecording:', typeof window.toggleRecording);
            console.log('- analyzeImage:', typeof window.analyzeImage);
            console.log('- removeImage:', typeof window.removeImage);
            console.log('- toggleCustomInstructions:', typeof window.toggleCustomInstructions);
            console.log('- showAddTemplateModal:', typeof window.showAddTemplateModal);
            console.log('- importFromSheets:', typeof window.importFromSheets);
            
        } catch (error) {
            console.error('üö® EMERGENCY: Function linking failed:', error);
        }
        
        // Enhanced event listener for templates tab
        const templatesTab = document.getElementById('templates-tab');
        if (templatesTab) {
            // Handle both click and bootstrap tab events
            templatesTab.addEventListener('click', function() {
                console.log('[TEMPLATES] Templates tab clicked, loaded:', isTemplatesLoaded);
                if (!isTemplatesLoaded) {
                    loadTemplatesForTab();
                }
            });
            
            // Also listen for Bootstrap tab shown event
            templatesTab.addEventListener('shown.bs.tab', function() {
                console.log('[TEMPLATES] Templates tab shown via Bootstrap, loaded:', isTemplatesLoaded);
                if (!isTemplatesLoaded) {
                    loadTemplatesForTab();
                }
            });
        }
        
        // Handle category change for add template modal
        const categorySelect = document.getElementById('addTemplateCategory');
        if (categorySelect) {
            categorySelect.addEventListener('change', function() {
                const customDiv = document.getElementById('customCategoryDiv');
                if (this.value === 'OTHER') {
                    customDiv.style.display = 'block';
                    document.getElementById('customCategory').required = true;
                } else {
                    customDiv.style.display = 'none';
                    document.getElementById('customCategory').required = false;
                }
            });
        }
        
        // Debug: Check if templates should load immediately
        console.log('[TEMPLATES] DOM loaded, checking if templates tab is active...');
        if (templatesTab && templatesTab.classList.contains('active')) {
            console.log('[TEMPLATES] Templates tab is already active, loading templates...');
            loadTemplatesForTab();
        }
        
        // Auto-load templates if templates tab is in URL hash
        if (window.location.hash === '#templates-panel' || window.location.hash.includes('templates')) {
            console.log('[TEMPLATES] Templates tab detected in URL hash, loading templates...');
            setTimeout(() => {
                const templatesTab = document.getElementById('templates-tab');
                if (templatesTab) {
                    templatesTab.click();
                }
            }, 500);
        }
    });
    
    // Browser detection and help for Safari users
    function detectBrowserAndShowHelp() {
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        console.log('Browser detection:', {
            isSafari: isSafari,
            isIOS: isIOS,
            isMobile: isMobile,
            userAgent: navigator.userAgent
        });
        
        if (isSafari || isIOS) {
            // Add Safari-specific help text
            setTimeout(() => {
                const helpDiv = document.createElement('div');
                helpDiv.className = 'alert alert-info alert-dismissible fade show mt-2';
                helpDiv.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Safari users:</strong> N·∫øu g·∫∑p v·∫•n ƒë·ªÅ ch·ªçn ·∫£nh, h√£y th·ª≠ n√∫t "Safari Fix" m√†u v√†ng. 
                    Tr√™n iOS, b·∫°n c√≥ th·ªÉ c·∫ßn cho ph√©p quy·ªÅn truy c·∫≠p ·∫£nh trong Settings.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const pasteArea = document.getElementById('imagePasteArea');
                if (pasteArea && pasteArea.parentNode) {
                    pasteArea.parentNode.insertBefore(helpDiv, pasteArea);
                }
            }, 2000);
        }
    }
    
    // ==================== AI CHAT ASSISTANT FUNCTIONS ====================
    
    // Load template categories from API
    async function loadTemplateCategories() {
        try {
            console.log('üîÑ Loading template categories...');
            
            // Simplified fetch without timeout for maximum compatibility
            console.log('üö® EMERGENCY DEBUG: Starting template fetch...');
            
            const response = await fetch('/api/templates', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('üö® EMERGENCY DEBUG: Template fetch completed, status:', response.status);
            
            console.log('üì° Template API response status:', response.status);
            
            if (response.ok) {
                const responseData = await response.json();
                console.log('üìã Raw API response:', responseData);
                
                // Validate and ensure allTemplates is always an array
                if (Array.isArray(responseData)) {
                    allTemplates = responseData;
                } else if (responseData && Array.isArray(responseData.templates)) {
                    allTemplates = responseData.templates;
                } else {
                    console.error('Invalid API response format:', responseData);
                    allTemplates = []; // Fallback to empty array
                    throw new Error('API returned invalid data format');
                }
                
                console.log('üìã Templates loaded:', allTemplates.length, 'templates');
                populateTemplateCategoryDropdown();
                console.log('‚úÖ Template categories populated successfully');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        } catch (error) {
            console.error('‚ùå Error loading templates:', error);
            
            // Ensure allTemplates is always an array to prevent map errors
            allTemplates = [];
            
            // Show user-friendly error
            const categorySelect = document.getElementById('templateCategory');
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">‚ö†Ô∏è L·ªói t·∫£i templates</option>';
            }
            
            // Show error notification
            showError(`Kh√¥ng th·ªÉ t·∫£i message templates: ${error.message}`);
        }
    }
    
    // Populate template category dropdown
    function populateTemplateCategoryDropdown() {
        const categorySelect = document.getElementById('templateCategory');
        
        // Validate allTemplates is an array before using map
        if (!Array.isArray(allTemplates)) {
            console.error('allTemplates is not an array:', allTemplates);
            categorySelect.innerHTML = '<option value="">‚ö†Ô∏è L·ªói templates data</option>';
            return;
        }
        
        const categories = [...new Set(allTemplates.map(t => t.Category))].sort();
        
        categorySelect.innerHTML = '<option value="">T·ª± ƒë·ªông ch·ªçn</option>';
        
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });
    }
    
    // Load specific templates when category is selected
    function loadSpecificTemplates() {
        const categorySelect = document.getElementById('templateCategory');
        const specificSelect = document.getElementById('specificTemplate');
        const selectedCategory = categorySelect.value;
        
        specificSelect.innerHTML = '<option value="">Ch·ªçn m·∫´u c·ª• th·ªÉ</option>';
        specificSelect.disabled = !selectedCategory;
        hideTemplatePreview();
        
        if (selectedCategory && Array.isArray(allTemplates)) {
            const categoryTemplates = allTemplates.filter(t => t.Category === selectedCategory);
            
            categoryTemplates.forEach((template, index) => {
                const option = document.createElement('option');
                option.value = index.toString();
                option.textContent = template.Label;
                specificSelect.appendChild(option);
            });
            
            specificSelect.categoryTemplates = categoryTemplates;
            specificSelect.disabled = false;
        }
    }
    
    // Preview selected template
    function previewSelectedTemplate() {
        const specificSelect = document.getElementById('specificTemplate');
        const previewDiv = document.getElementById('templatePreview');
        const previewContent = document.getElementById('templatePreviewContent');
        
        if (specificSelect.value && specificSelect.categoryTemplates) {
            try {
                const templateIndex = parseInt(specificSelect.value);
                const template = specificSelect.categoryTemplates[templateIndex];
                
                if (template) {
                    previewContent.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong class="text-primary">${template.Category} - ${template.Label}:</strong>
                                <div class="mt-1">${template.Message}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyTemplatePreview()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    `;
                    previewDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error getting template:', error);
                hideTemplatePreview();
            }
        } else {
            hideTemplatePreview();
        }
    }
    
    function hideTemplatePreview() {
        document.getElementById('templatePreview').style.display = 'none';
    }
    
    function copyTemplatePreview() {
        const specificSelect = document.getElementById('specificTemplate');
        if (specificSelect.value && specificSelect.categoryTemplates) {
            try {
                const templateIndex = parseInt(specificSelect.value);
                const template = specificSelect.categoryTemplates[templateIndex];
                if (template && template.Message) {
                    copyToClipboard(template.Message);
                    showSuccess('ƒê√£ copy m·∫´u tin nh·∫Øn!');
                }
            } catch (error) {
                console.error('Error copying template:', error);
            }
        }
    }
    
    // Setup image upload and paste handling
    let imageHandlingInitialized = false;
    
    function setupImageHandling() {
        if (imageHandlingInitialized) {
            console.log('‚ö†Ô∏è Image handling already initialized, skipping...');
            return;
        }
        
        const pasteArea = document.getElementById('imagePasteArea');
        const fileInput = document.getElementById('imageFileInput');
        const cameraInput = document.getElementById('cameraInput');
        
        // Check if required elements exist
        if (!pasteArea || !fileInput || !cameraInput) {
            console.error('‚ùå Image handling: Required elements not found');
            return;
        }
        
        console.log('‚úÖ Image handling: All elements found, setting up events');
        
        // Handle paste event (only add once to document)
        document.addEventListener('paste', function(e) {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    handleImageFile(file);
                    break;
                }
            }
        });
        
        // Handle drag and drop
        pasteArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            pasteArea.classList.add('dragover');
        });
        
        pasteArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            pasteArea.classList.remove('dragover');
        });
        
        pasteArea.addEventListener('drop', function(e) {
            e.preventDefault();
            pasteArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                handleImageFile(files[0]);
            }
        });
        
        // Handle file inputs (only add once per input)
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });
        
        cameraInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                handleImageFile(e.target.files[0]);
            }
        });
        
        // Handle front camera input
        const frontCameraInput = document.getElementById('frontCameraInput');
        if (frontCameraInput) {
            frontCameraInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleImageFile(e.target.files[0]);
                }
            });
        }
        
        imageHandlingInitialized = true;
        console.log('‚úÖ Image handling initialization complete - protected from duplicate setup');
    }
    
    // Image handling functions moved to global scope above DOMContentLoaded
    
    function handleImageFile(file) {
        console.log('Processing file:', file.name, 'Type:', file.type, 'Size:', file.size);
        
        if (!file.type.startsWith('image/')) {
            alert('Vui l√≤ng ch·ªçn file ·∫£nh (PNG, JPG, JPEG)');
            return;
        }
        
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            alert('File qu√° l·ªõn. Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n 10MB');
            return;
        }
        
        // Show loading for large files
        if (file.size > 1024 * 1024) { // > 1MB
            showLoading(true);
        }
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                currentImageData = e.target.result;
                showImagePreview(e.target.result);
                showLoading(false);
                console.log('Image loaded successfully');
            } catch (error) {
                console.error('Error processing image:', error);
                showError('L·ªói khi x·ª≠ l√Ω ·∫£nh: ' + error.message);
                showLoading(false);
            }
        };
        
        reader.onerror = function(error) {
            console.error('FileReader error:', error);
            showError('L·ªói khi ƒë·ªçc file ·∫£nh');
            showLoading(false);
        };
        
        // Start reading file
        try {
            reader.readAsDataURL(file);
        } catch (error) {
            console.error('Error starting file read:', error);
            showError('L·ªói khi kh·ªüi t·∫°o ƒë·ªçc file');
            showLoading(false);
        }
    }
    
    function showImagePreview(imageSrc) {
        const previewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        
        try {
            imagePreview.src = imageSrc;
            imagePreview.onload = function() {
                previewContainer.style.display = 'block';
                document.getElementById('imagePasteArea').style.display = 'none';
                showSuccess('·∫¢nh ƒë√£ ƒë∆∞·ª£c t·∫£i l√™n th√†nh c√¥ng! üì∏');
                console.log('Image preview shown successfully');
            };
            
            imagePreview.onerror = function() {
                console.error('Error displaying image preview');
                showError('L·ªói hi·ªÉn th·ªã ·∫£nh preview');
                removeImage(); // Reset state
            };
        } catch (error) {
            console.error('Error in showImagePreview:', error);
            showError('L·ªói khi hi·ªÉn th·ªã ·∫£nh: ' + error.message);
        }
    }
    
    function removeImage() {
        currentImageData = null;
        document.getElementById('imagePreviewContainer').style.display = 'none';
        document.getElementById('imagePasteArea').style.display = 'block';
        document.getElementById('imageFileInput').value = '';
        
        document.getElementById('responseArea').innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-robot fa-2x mb-3 text-primary"></i>
                <h6 class="text-primary">üß† AI Chat Assistant - Context-Aware Intelligence</h6>
                <p class="mb-3">T·∫£i ·∫£nh ƒëo·∫°n chat l√™n, AI s·∫Ω ƒë·ªçc v√† hi·ªÉu <strong>to√†n b·ªô b·ªëi c·∫£nh</strong> ƒë·ªÉ ƒë∆∞a ra ph·∫£n h·ªìi th√¥ng minh!</p>
            </div>
        `;
    }
    
    async function analyzeImage() {
        if (!currentImageData) {
            alert('Vui l√≤ng t·∫£i ·∫£nh tr∆∞·ªõc!');
            return;
        }
        
        showLoading(true);
        document.getElementById('processingStatus').style.display = 'block';
        
        try {
            const aiConfig = getCurrentAIConfig();
            const requestData = {
                image_b64: currentImageData,
                ai_config: aiConfig
            };
            
            const response = await fetch('/api/ai_chat_analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            
            displayAIResponse(result, aiConfig);
            
        } catch (error) {
            console.error('AI Analysis error:', error);
            showError('L·ªói khi ph√¢n t√≠ch ·∫£nh: ' + error.message);
        } finally {
            showLoading(false);
            document.getElementById('processingStatus').style.display = 'none';
        }
    }
    
    function getCurrentAIConfig() {
        const categorySelect = document.getElementById('templateCategory');
        const specificSelect = document.getElementById('specificTemplate');
        const responseModeRadios = document.getElementsByName('responseMode');
        const customInstructions = document.getElementById('customInstructions').value.trim();
        
        let selectedTemplate = null;
        if (specificSelect.value && specificSelect.categoryTemplates) {
            try {
                const templateIndex = parseInt(specificSelect.value);
                selectedTemplate = specificSelect.categoryTemplates[templateIndex];
            } catch (error) {
                console.error('Error getting selected template:', error);
            }
        }
        
        let responseMode = 'auto';
        for (const radio of responseModeRadios) {
            if (radio.checked) {
                responseMode = radio.value;
                break;
            }
        }
        
        return {
            selectedCategory: categorySelect.value,
            selectedTemplate: selectedTemplate,
            responseMode: responseMode,
            customInstructions: customInstructions
        };
    }
    
    function displayAIResponse(result, aiConfig) {
        const responseArea = document.getElementById('responseArea');
        
        let html = '';
        
        if (aiConfig) {
            html += `
                <div class="alert alert-info border-start border-4 border-info py-2 px-3 mb-3">
                    <h6 class="mb-2"><i class="fas fa-cogs"></i> C·∫•u h√¨nh AI ƒë√£ s·ª≠ d·ª•ng:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Template:</strong> ${aiConfig.selectedTemplate ? 
                                `${aiConfig.selectedTemplate.Category} - ${aiConfig.selectedTemplate.Label}` : 
                                'T·ª± ƒë·ªông ch·ªçn'}
                        </div>
                        <div class="col-md-6">
                            <strong>Phong c√°ch:</strong> 
                            <span class="badge ${aiConfig.responseMode === 'yes' ? 'bg-success' : 
                                aiConfig.responseMode === 'no' ? 'bg-danger' : 'bg-secondary'}">
                                ${aiConfig.responseMode === 'yes' ? 'T√≠ch c·ª±c (Yes)' : 
                                  aiConfig.responseMode === 'no' ? 'Ti√™u c·ª±c (No)' : 'T·ª± ƒë·ªông (Auto)'}
                            </span>
                        </div>
                    </div>
                    ${aiConfig.customInstructions ? `
                        <div class="mt-2">
                            <strong>Custom Instructions:</strong> 
                            <div class="small bg-light p-2 rounded">${aiConfig.customInstructions}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        if (result.conversation_context) {
            html += `
                <div class="alert alert-primary border-start border-4 border-primary py-3 px-3 mb-3">
                    <h6><i class="fas fa-comments"></i> Ph√¢n t√≠ch B·ªëi c·∫£nh Cu·ªôc h·ªôi tho·∫°i:</h6>
                    <p class="mb-2" style="line-height: 1.6;">${result.conversation_context}</p>
                </div>
            `;
        }
        
        if (result.ai_response) {
            html += `
                <div class="ai-response">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6><i class="fas fa-robot text-success"></i> Ph·∫£n h·ªìi AI (C√≥ context):</h6>
                        <button class="btn btn-sm btn-outline-primary copy-button" onclick="copyToClipboard(\`${result.ai_response.replace(/`/g, '\\`')}\`)">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div style="white-space: pre-wrap; line-height: 1.6; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">${result.ai_response}</div>
                </div>
            `;
        }
        
        responseArea.innerHTML = html;
    }
    
    // ==================== VOICE TRANSLATOR FUNCTIONS ====================
    
    function checkSpeechRecognitionSupport() {
        const supportText = document.getElementById('supportText');
        const recordButton = document.getElementById('recordButton');
        
        // Enhanced mobile detection
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        
        console.log('Browser detection:', {
            isMobile,
            isIOS, 
            isAndroid,
            userAgent: navigator.userAgent,
            hasWebkitSpeech: 'webkitSpeechRecognition' in window,
            hasSpeech: 'SpeechRecognition' in window
        });
        
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            if (isIOS && isPWA) {
                supportText.innerHTML = '‚ö†Ô∏è PWA Mode: Voice c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông. <br><a href="#" onclick="openInSafari()" class="btn btn-sm btn-primary mt-2">M·ªü trong Safari</a>';
                recordButton.disabled = false; // Still allow trying
            } else if (isIOS) {
                supportText.innerHTML = '‚úÖ iOS Safari: H·ªó tr·ª£ voice. Nh·∫•n MIC v√† n√≥i ngay.';
            } else if (isAndroid) {
                supportText.innerHTML = '‚úÖ Android: H·ªó tr·ª£ ƒë·∫ßy ƒë·ªß. Nh·∫•n MIC ƒë·ªÉ b·∫Øt ƒë·∫ßu.';
            } else {
                supportText.innerHTML = '‚úÖ Desktop: H·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i';
            }
            initializeSpeechRecognition();
        } else {
            if (isIOS && isPWA) {
                supportText.innerHTML = '‚ùå PWA Mode: Voice kh√¥ng kh·∫£ d·ª•ng. <br><a href="#" onclick="openInSafari()" class="btn btn-sm btn-primary mt-2">M·ªü trong Safari</a>';
            } else if (isIOS) {
                supportText.innerHTML = '‚ùå iOS: C·∫ßn s·ª≠ d·ª•ng Safari browser ƒë·ªÉ d√πng t√≠nh nƒÉng n√†y';
            } else {
                supportText.innerHTML = '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i';
            }
            recordButton.disabled = true;
            recordButton.innerHTML = '<i class="fas fa-times"></i>';
        }
    }
    
    function openInSafari() {
        const currentUrl = window.location.href;
        // Open current page in Safari browser
        if (confirm('M·ªü trong Safari ƒë·ªÉ s·ª≠ d·ª•ng voice?\n\nVoice recognition c√≥ th·ªÉ ho·∫°t ƒë·ªông t·ªët h∆°n trong Safari.')) {
            // Create a link that opens in Safari
            const link = document.createElement('a');
            link.href = currentUrl;
            link.target = '_blank';
            link.rel = 'noopener';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    
    function initializeSpeechRecognition() {
        try {
            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
            recognition = new SpeechRecognition();
            
            // Mobile-optimized settings
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            // Enhanced settings for mobile
            recognition.continuous = !isMobile; // iOS works better with false
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;
            
            // Start with default language
            recognition.lang = getLanguageCode(document.getElementById('sourceLanguage').value);
            
            // iOS specific settings
            if (isIOS) {
                recognition.continuous = false;
                recognition.interimResults = false; // More reliable on iOS
            }
            
            recognition.onstart = function() {
                console.log('Speech recognition started');
                updateStatus('listening', 'üé§ ƒêang nghe... (n√≥i ngay)');
                const button = document.getElementById('recordButton');
                button.innerHTML = '<i class="fas fa-stop"></i>';
                button.classList.add('recording');
                button.style.backgroundColor = '#dc3545';
                isRecording = true;
                
                // Auto-stop on mobile after 10 seconds
                if (isMobile) {
                    setTimeout(() => {
                        if (isRecording) {
                            recognition.stop();
                        }
                    }, 10000);
                }
            };
            
            recognition.onresult = function(event) {
                console.log('Speech recognition result:', event.results);
                let interimTranscript = '';
                let newFinalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    console.log(`Result ${i}: "${transcript}" (final: ${event.results[i].isFinal})`);
                    
                    if (event.results[i].isFinal) {
                        newFinalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (newFinalTranscript) {
                    finalTranscript += newFinalTranscript;
                    console.log('Final transcript updated:', finalTranscript);
                }
                
                const fullText = finalTranscript + interimTranscript;
                document.getElementById('recognizedText').value = fullText;
                document.getElementById('manualText').value = fullText;
                checkTranslateButton();
                
                // On mobile, auto-translate when we get final result
                if (isMobile && newFinalTranscript) {
                    setTimeout(() => {
                        if (document.getElementById('translateButton') && !document.getElementById('translateButton').disabled) {
                            performTranslation();
                        }
                    }, 500);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error, event);
                let errorMessage = 'L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i';
                
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                switch(event.error) {
                    case 'aborted':
                        if (isIOS) {
                            errorMessage = '‚ùå iOS: Voice b·ªã ch·∫∑n.\n\nüîß Gi·∫£i ph√°p: Ki·ªÉm tra quy·ªÅn microphone';
                            updateStatus('error', errorMessage);
                            // Show guidance for iOS
                            setTimeout(() => {
                                alert('Voice kh√¥ng ho·∫°t ƒë·ªông.\n\nKi·ªÉm tra:\n1. Quy·ªÅn microphone trong Settings\n2. Th·ª≠ reload trang\n3. D√πng Safari browser');
                            }, 1000);
                        } else {
                            errorMessage = '‚ö†Ô∏è Voice b·ªã ng·∫Øt. Th·ª≠ l·∫°i.';
                        }
                        break;
                    case 'no-speech':
                        errorMessage = '‚ö†Ô∏è Kh√¥ng nghe th·∫•y gi·ªçng n√≥i. Th·ª≠ l·∫°i.';
                        break;
                    case 'audio-capture':
                        errorMessage = '‚ùå Kh√¥ng th·ªÉ truy c·∫≠p microphone';
                        break;
                    case 'not-allowed':
                        errorMessage = '‚ùå Microphone b·ªã ch·∫∑n. Cho ph√©p trong c√†i ƒë·∫∑t browser.';
                        break;
                    case 'network':
                        errorMessage = '‚ùå L·ªói m·∫°ng. Ki·ªÉm tra k·∫øt n·ªëi internet.';
                        break;
                    default:
                        if (isIOS && isPWA) {
                            errorMessage = `‚ùå PWA Error: ${event.error}\n\nTh·ª≠ m·ªü trong Safari browser`;
                        } else {
                            errorMessage = `‚ùå L·ªói: ${event.error}`;
                        }
                }
                
                updateStatus('error', errorMessage);
                resetRecordButton();
            };
            
            recognition.onend = function() {
                console.log('Speech recognition ended');
                isRecording = false;
                updateStatus('ready', finalTranscript ? '‚úÖ ƒê√£ ghi √¢m xong' : 'S·∫µn s√†ng ghi √¢m');
                resetRecordButton();
            };
            
            console.log('Speech recognition initialized successfully');
            
        } catch (error) {
            console.error('Failed to initialize speech recognition:', error);
            document.getElementById('supportText').innerHTML = '‚ùå L·ªói kh·ªüi t·∫°o nh·∫≠n di·ªán gi·ªçng n√≥i';
        }
    }
    
    function getLanguageCode(langCode) {
        const langMap = {
            'vi': 'vi-VN', 'en': 'en-US', 'zh': 'zh-CN', 'ja': 'ja-JP',
            'ko': 'ko-KR', 'fr': 'fr-FR', 'de': 'de-DE', 'es': 'es-ES'
        };
        return langMap[langCode] || langCode;
    }
    
    function toggleRecordingInternal() {
        console.log('Toggle recording clicked, recognition:', !!recognition, 'isRecording:', isRecording);
        
        if (!recognition) {
            alert('Speech recognition kh√¥ng kh·∫£ d·ª•ng!\n\nKi·ªÉm tra:\n- D√πng Chrome/Safari\n- Cho ph√©p truy c·∫≠p microphone\n- K·∫øt n·ªëi internet ·ªïn ƒë·ªãnh');
            return;
        }
        
        if (isRecording) {
            console.log('Stopping recognition...');
            recognition.stop();
        } else {
            try {
                // Request microphone permission explicitly on mobile
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            console.log('Microphone access granted');
                            // Stop the stream since speech recognition will handle it
                            stream.getTracks().forEach(track => track.stop());
                            startRecognition();
                        })
                        .catch(error => {
                            console.error('Microphone access denied:', error);
                            alert('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p microphone!\n\nC√°ch kh·∫Øc ph·ª•c:\n1. Cho ph√©p microphone trong browser\n2. Ki·ªÉm tra c√†i ƒë·∫∑t thi·∫øt b·ªã\n3. Th·ª≠ l√†m m·ªõi trang');
                        });
                } else {
                    // Fallback for browsers without getUserMedia
                    startRecognition();
                }
            } catch (error) {
                console.error('Error starting recognition:', error);
                alert('L·ªói kh·ªüi ƒë·ªông ghi √¢m: ' + error.message);
            }
        }
    }
    
    function startRecognition() {
        try {
            console.log('Starting speech recognition...');
            recognition.lang = getLanguageCode(document.getElementById('sourceLanguage').value);
            finalTranscript = '';
            document.getElementById('recognizedText').value = '';
            document.getElementById('manualText').value = '';
            
            // Clear any previous errors
            updateStatus('ready', 'ƒêang kh·ªüi ƒë·ªông...');
            
            recognition.start();
        } catch (error) {
            console.error('Recognition start error:', error);
            if (error.name === 'InvalidStateError') {
                alert('‚ö†Ô∏è Microphone ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng.\nƒê·ª£i 1 gi√¢y r·ªìi th·ª≠ l·∫°i.');
            } else {
                alert('L·ªói kh·ªüi ƒë·ªông: ' + error.message);
            }
        }
    }
    
    function updateStatus(status, text) {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        indicator.className = 'status-indicator status-' + status;
        statusText.textContent = text;
    }
    
    function resetRecordButton() {
        const button = document.getElementById('recordButton');
        if (button) {
            button.innerHTML = '<i class="fas fa-microphone"></i>';
            button.classList.remove('recording');
            button.style.backgroundColor = '';
            button.style.animation = '';
        }
    }
    
    function syncTextAndCheck() {
        const manualText = document.getElementById('manualText').value;
        document.getElementById('recognizedText').value = manualText;
        finalTranscript = manualText;
        checkTranslateButton();
    }
    
    function checkTranslateButton() {
        const recognizedText = document.getElementById('recognizedText').value.trim();
        const manualText = document.getElementById('manualText').value.trim();
        const translateButton = document.getElementById('translateButton');
        
        if (recognizedText || manualText) {
            translateButton.disabled = false;
            translateButton.classList.remove('btn-secondary');
            translateButton.classList.add('translate-btn');
        } else {
            translateButton.disabled = true;
            translateButton.classList.add('btn-secondary');
            translateButton.classList.remove('translate-btn');
        }
    }
    
    async function translateText() {
        const text = document.getElementById('recognizedText').value.trim() || 
                    document.getElementById('manualText').value.trim();
        
        if (!text) {
            alert('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n c·∫ßn d·ªãch!');
            return;
        }
        
        const sourceLanguage = document.getElementById('sourceLanguage').value;
        const targetLanguage = document.getElementById('targetLanguage').value;
        
        if (sourceLanguage === targetLanguage) {
            alert('Ng√¥n ng·ªØ ngu·ªìn v√† ƒë√≠ch kh√¥ng th·ªÉ gi·ªëng nhau!');
            return;
        }
        
        updateStatus('processing', 'ƒêang d·ªãch...');
        const translateButton = document.getElementById('translateButton');
        const originalText = translateButton.innerHTML;
        translateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang d·ªãch...';
        translateButton.disabled = true;
        
        try {
            const response = await fetch('/api/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: text,
                    source_lang: sourceLanguage,
                    target_lang: targetLanguage
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            if (result.error) {
                throw new Error(result.error);
            }
            
            document.getElementById('translatedText').textContent = result.translated_text;
            document.getElementById('translationResult').style.display = 'block';
            updateStatus('ready', 'D·ªãch th√†nh c√¥ng!');
            
        } catch (error) {
            console.error('Translation error:', error);
            alert('L·ªói khi d·ªãch: ' + error.message);
            updateStatus('ready', 'L·ªói d·ªãch thu·∫≠t');
        } finally {
            translateButton.innerHTML = originalText;
            checkTranslateButton();
        }
    }
    
    async function copyTranslation() {
        const translatedText = document.getElementById('translatedText').textContent;
        
        try {
            await navigator.clipboard.writeText(translatedText);
            const copyBtn = document.querySelector('.copy-btn');
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            copyBtn.classList.add('btn-success');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('btn-success');
            }, 2000);
            
        } catch (error) {
            alert('ƒê√£ copy v√†o clipboard!');
        }
    }
    
    function swapLanguages() {
        const sourceSelect = document.getElementById('sourceLanguage');
        const targetSelect = document.getElementById('targetLanguage');
        
        const tempValue = sourceSelect.value;
        sourceSelect.value = targetSelect.value;
        targetSelect.value = tempValue;
        
        if (recognition) {
            recognition.lang = getLanguageCode(sourceSelect.value);
        }
    }
    
    // ==================== UTILITY FUNCTIONS ====================
    
    async function copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
            showSuccess('ƒê√£ copy ph·∫£n h·ªìi!');
        } catch (error) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showSuccess('ƒê√£ copy ph·∫£n h·ªìi!');
        }
    }
    
    function showLoading(show) {
        try {
            const overlay = document.querySelector('.loading-overlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
                console.log('üö® EMERGENCY DEBUG: Loading overlay', show ? 'shown' : 'hidden');
            } else {
                console.error('üö® EMERGENCY DEBUG: Loading overlay element not found');
            }
        } catch (error) {
            console.error('üö® EMERGENCY DEBUG: showLoading error:', error);
        }
    }
    
    function showSuccess(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 m-3 alert alert-success alert-dismissible';
        toast.style.zIndex = '9999';
        toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    function showError(message) {
        const toast = document.createElement('div');
        toast.className = 'position-fixed top-0 end-0 m-3 alert alert-danger alert-dismissible';
        toast.style.zIndex = '9999';
        toast.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }
    
    // Quick action functions - MOVED TO END OF FILE TO AVOID DUPLICATES
    
    // ==================== CUSTOM INSTRUCTIONS FUNCTIONS ====================
    // Note: voiceInstructionRecognition already declared above, removing duplicate
    
    function toggleCustomInstructions() {
        const section = document.getElementById('customInstructionsSection');
        const icon = document.getElementById('customToggleIcon');
        
        if (section.style.display === 'none') {
            section.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
            // Load saved instructions
            loadSavedInstructions();
        } else {
            section.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
        }
    }
    
    function loadSavedInstructions() {
        const saved = localStorage.getItem('aiCustomInstructions');
        if (saved) {
            document.getElementById('customInstructions').value = saved;
        }
    }
    
    function saveCustomInstructions() {
        const instructions = document.getElementById('customInstructions').value.trim();
        if (instructions) {
            localStorage.setItem('aiCustomInstructions', instructions);
            showSuccess('üíæ ƒê√£ l∆∞u custom instructions!');
        } else {
            localStorage.removeItem('aiCustomInstructions');
            showSuccess('üóëÔ∏è ƒê√£ x√≥a custom instructions!');
        }
    }
    
    function clearCustomInstructions() {
        document.getElementById('customInstructions').value = '';
        localStorage.removeItem('aiCustomInstructions');
        showSuccess('üóëÔ∏è ƒê√£ x√≥a custom instructions!');
    }
    
    function loadSampleInstructions() {
        const samples = [
            "Tr·∫£ l·ªùi ng·∫Øn g·ªçn v√† th√¢n thi·ªán, s·ª≠ d·ª•ng emoji ph√π h·ª£p, lu√¥n ƒë·ªÅ c·∫≠p ƒë·∫øn t√™n kh√°ch h√†ng",
            "Ph·∫£n h·ªìi chuy√™n nghi·ªáp v√† l·ªãch s·ª±, t·∫≠p trung v√†o gi·∫£i ph√°p, kh√¥ng d√πng emoji",
            "Tr·∫£ l·ªùi chi ti·∫øt v√† nhi·ªát t√¨nh, gi·∫£i th√≠ch r√µ r√†ng c√°c d·ªãch v·ª•, s·ª≠ d·ª•ng tone t√≠ch c·ª±c",
            "Phong c√°ch th√¢n m·∫≠t nh∆∞ b·∫°n b√®, d√πng ng√¥n ng·ªØ ƒë∆°n gi·∫£n, nhi·ªÅu emoji vui v·∫ª",
            "T·∫≠p trung v√†o vi·ªác b√°n h√†ng, ƒë·ªÅ xu·∫•t upgrade d·ªãch v·ª•, nh·∫•n m·∫°nh ∆∞u ƒë√£i"
        ];
        
        const randomSample = samples[Math.floor(Math.random() * samples.length)];
        document.getElementById('customInstructions').value = randomSample;
        showSuccess('üí° ƒê√£ t·∫£i m·∫´u instructions!');
    }
    
    function startVoiceInstructions() {
        const btn = document.getElementById('voiceInstructBtn');
        
        if (isVoiceInstructionRecording) {
            stopVoiceInstructions();
            return;
        }
        
        // Enhanced mobile detection and support
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                     window.navigator.standalone === true;
        
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            if (isIOS && isPWA) {
                showError('‚ùå PWA Mode: Voice kh√¥ng kh·∫£ d·ª•ng.\n\nM·ªü trong Safari browser ƒë·ªÉ s·ª≠ d·ª•ng voice.');
            } else if (isIOS) {
                showError('‚ùå iOS: C·∫ßn s·ª≠ d·ª•ng Safari browser ƒë·ªÉ d√πng voice');
            } else {
                showError('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i');
            }
            return;
        }
        
        // Special handling for PWA mode
        if (isIOS && isPWA) {
            if (!confirm('‚ö†Ô∏è PWA Mode ph√°t hi·ªán!\n\nVoice c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông trong app mode.\n\nB·∫°n c√≥ mu·ªën th·ª≠ kh√¥ng? (Khuy·∫øn ngh·ªã: D√πng Safari browser)')) {
                return;
            }
        }
        
        // Request microphone permission first on mobile
        if (isMobile && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    console.log('Microphone access granted for voice instructions');
                    stream.getTracks().forEach(track => track.stop());
                    initVoiceInstructionRecognition();
                })
                .catch(error => {
                    console.error('Microphone access denied for voice instructions:', error);
                    showError('‚ùå Kh√¥ng th·ªÉ truy c·∫≠p microphone!\nCho ph√©p microphone trong browser settings.');
                    return;
                });
        } else {
            initVoiceInstructionRecognition();
        }
    }
    
    function initVoiceInstructionRecognition() {
        const btn = document.getElementById('voiceInstructBtn');
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        try {
            const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
            voiceInstructionRecognition = new SpeechRecognition();
            
            // Mobile-optimized settings
            voiceInstructionRecognition.continuous = !isMobile;
            voiceInstructionRecognition.interimResults = !isIOS; // iOS works better without interim
            voiceInstructionRecognition.maxAlternatives = 1;
            voiceInstructionRecognition.lang = 'vi-VN';
            
            voiceInstructionRecognition.onstart = function() {
                console.log('Voice instruction recognition started');
                isVoiceInstructionRecording = true;
                btn.innerHTML = '<i class="fas fa-stop"></i>';
                btn.className = 'btn btn-danger';
                btn.style.animation = 'pulse 1s infinite';
                showSuccess('üé§ ƒêang nghe... N√≥i h∆∞·ªõng d·∫´n cho AI (max 15s)');
                
                // Auto-stop on mobile after 15 seconds
                if (isMobile) {
                    setTimeout(() => {
                        if (isVoiceInstructionRecording) {
                            voiceInstructionRecognition.stop();
                        }
                    }, 15000);
                }
            };
            
            voiceInstructionRecognition.onresult = function(event) {
                console.log('Voice instruction result:', event.results);
                let transcript = '';
                let finalText = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const text = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalText += text;
                    } else {
                        transcript += text;
                    }
                }
                
                // Update textarea with current text
                if (finalText) {
                    document.getElementById('customInstructions').value = finalText;
                    showSuccess('‚úÖ ƒê√£ ghi nh·∫≠n h∆∞·ªõng d·∫´n b·∫±ng voice!');
                } else if (transcript) {
                    // Show interim results
                    document.getElementById('customInstructions').placeholder = `ƒêang nghe: "${transcript}"...`;
                }
            };
            
            voiceInstructionRecognition.onerror = function(event) {
                console.error('Voice instruction error:', event.error, event);
                let errorMessage = 'L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i';
                
                const isPWA = window.matchMedia('(display-mode: standalone)').matches || 
                             window.navigator.standalone === true;
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                switch(event.error) {
                    case 'aborted':
                        if (isIOS && isPWA) {
                            errorMessage = '‚ùå PWA Mode: Voice Instructions b·ªã ch·∫∑n.\n\nüîß Gi·∫£i ph√°p: M·ªü trong Safari browser';
                            showError(errorMessage);
                            setTimeout(() => {
                                if (confirm('Voice Instructions kh√¥ng ho·∫°t ƒë·ªông trong PWA mode.\n\nM·ªü trong Safari browser?')) {
                                    openInSafari();
                                }
                            }, 1000);
                        } else {
                            errorMessage = '‚ö†Ô∏è Voice Instructions b·ªã ng·∫Øt. Th·ª≠ l·∫°i.';
                        }
                        break;
                    case 'no-speech':
                        errorMessage = '‚ö†Ô∏è Kh√¥ng nghe th·∫•y gi·ªçng n√≥i. Th·ª≠ l·∫°i.';
                        break;
                    case 'audio-capture':
                        errorMessage = '‚ùå Kh√¥ng th·ªÉ truy c·∫≠p microphone';
                        break;
                    case 'not-allowed':
                        errorMessage = '‚ùå Microphone b·ªã ch·∫∑n. Cho ph√©p trong c√†i ƒë·∫∑t browser.';
                        break;
                    case 'network':
                        errorMessage = '‚ùå L·ªói m·∫°ng. Ki·ªÉm tra k·∫øt n·ªëi internet.';
                        break;
                    default:
                        if (isIOS && isPWA) {
                            errorMessage = `‚ùå PWA Error: ${event.error}\n\nTh·ª≠ m·ªü trong Safari browser`;
                        } else {
                            errorMessage = `‚ùå L·ªói: ${event.error}`;
                        }
                }
                
                showError(errorMessage);
                stopVoiceInstructions();
            };
            
            voiceInstructionRecognition.onend = function() {
                console.log('Voice instruction recognition ended');
                stopVoiceInstructions();
            };
            
            // Start recognition
            voiceInstructionRecognition.start();
            
        } catch (error) {
            console.error('Failed to initialize voice instruction recognition:', error);
            showError('‚ùå L·ªói kh·ªüi t·∫°o nh·∫≠n di·ªán gi·ªçng n√≥i: ' + error.message);
        }
    }
    
    function stopVoiceInstructions() {
        if (voiceInstructionRecognition) {
            voiceInstructionRecognition.stop();
        }
        
        isVoiceInstructionRecording = false;
        const btn = document.getElementById('voiceInstructBtn');
        btn.innerHTML = '<i class="fas fa-microphone"></i>';
        btn.className = 'btn btn-outline-danger';
    }

    // ==================== TEMPLATES MANAGEMENT FUNCTIONS ====================
    // Variables declared at top of file to avoid duplicates

    // Enhanced load templates with proper error handling
    async function loadTemplatesForTab() {
        const container = document.getElementById('templatesContainer');
        
        // Show loading with detailed status
        container.innerHTML = `
            <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
                <p class="mt-2 text-muted">ƒêang t·∫£i danh s√°ch m·∫´u tin nh·∫Øn...</p>
                <small class="text-muted">K·∫øt n·ªëi API templates...</small>
            </div>
        `;
        
        try {
            console.log('[TEMPLATES] Starting to load templates from API...');
            
            const response = await fetch('/api/templates', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('[TEMPLATES] Response status:', response.status);
            console.log('[TEMPLATES] Response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('[TEMPLATES] Received data:', data);
            console.log('[TEMPLATES] Data type:', typeof data);
            console.log('[TEMPLATES] Is array:', Array.isArray(data));
            
            // Handle different response formats
            let templatesData = [];
            
            if (data.success === false) {
                // API returned error format
                console.error('[TEMPLATES] API returned error:', data.error);
                throw new Error(data.error || 'API returned error status');
            } else if (Array.isArray(data)) {
                // Direct array format
                templatesData = data;
            } else if (data.templates && Array.isArray(data.templates)) {
                // Wrapped in templates property
                templatesData = data.templates;
            } else {
                console.error('[TEMPLATES] Unexpected data format:', data);
                throw new Error('Invalid data format from API');
            }
            
            console.log('[TEMPLATES] Processing templates data:', templatesData);
            
            // Transform data for display
            templates = templatesData.map((item, index) => {
                console.log(`[TEMPLATES] Processing template ${index}:`, item);
                
                return {
                    id: index.toString(),
                    name: `${item.Category || 'Chung'} - ${item.Label || 'DEFAULT'}`,
                    content: item.Message || item.Content || item.content || '',
                    category: item.Category || 'Chung',
                    label: item.Label || 'DEFAULT'
                };
            });
            
            console.log('[TEMPLATES] Transformed templates:', templates);
            
            isTemplatesLoaded = true;
            renderTemplatesForTab();
            
        } catch (error) {
            console.error('[TEMPLATES] Load error:', error);
            
            // Show detailed error message
            container.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <h6><i class="fas fa-exclamation-triangle"></i> L·ªói t·∫£i m·∫´u tin nh·∫Øn</h6>
                    <p class="mb-2"><strong>Chi ti·∫øt l·ªói:</strong> ${error.message}</p>
                    <div class="mt-3">
                        <button class="btn btn-primary btn-sm me-2" onclick="retryLoadTemplates()">
                            <i class="fas fa-retry"></i> Th·ª≠ l·∫°i
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="testTemplatesConnection()">
                            <i class="fas fa-info-circle"></i> Test API
                        </button>
                    </div>
                </div>
            `;
            
            // Also show toast notification
            showError('Kh√¥ng th·ªÉ t·∫£i m·∫´u tin nh·∫Øn: ' + error.message);
        }
    }
    
    // Test connection function
    async function testTemplatesConnection() {
        try {
            showLoading(true);
            
            const response = await fetch('/api/templates/debug');
            const result = await response.json();
            
            console.log('[TEMPLATES] Debug result:', result);
            
            if (result.file_exists) {
                showSuccess('‚úÖ K·∫øt n·ªëi templates API th√†nh c√¥ng!');
                if (result.templates_count > 0) {
                    showSuccess(`üìã T√¨m th·∫•y ${result.templates_count} templates`);
                }
            } else {
                showError('‚ö†Ô∏è File templates kh√¥ng t·ªìn t·∫°i');
            }
            
        } catch (error) {
            console.error('[TEMPLATES] Test connection error:', error);
            showError('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Retry function
    async function retryLoadTemplates() {
        console.log('[TEMPLATES] Retrying template load...');
        templates = [];
        isTemplatesLoaded = false;
        await loadTemplatesForTab();
    }

    // Enhanced render function with better error handling
    function renderTemplatesForTab() {
        const container = document.getElementById('templatesContainer');
        
        if (!templates || templates.length === 0) {
            container.innerHTML = `
                <div class="text-center p-4">
                    <div class="text-muted mb-3">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <h6>Ch∆∞a c√≥ m·∫´u tin nh·∫Øn n√†o</h6>
                        <p>H√£y th√™m m·∫´u tin nh·∫Øn ƒë·∫ßu ti√™n ho·∫∑c import t·ª´ Google Sheets</p>
                    </div>
                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-primary btn-sm" onclick="showAddTemplateModal()">
                            <i class="fas fa-plus"></i> Th√™m m·∫´u ƒë·∫ßu ti√™n
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="importFromSheets()">
                            <i class="fas fa-download"></i> Import t·ª´ Sheets
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
        try {
            // Group templates by category
            const groupedTemplates = {};
            templates.forEach(template => {
                const category = template.category || 'Kh√°c';
                if (!groupedTemplates[category]) {
                    groupedTemplates[category] = [];
                }
                groupedTemplates[category].push(template);
            });
            
            console.log('[TEMPLATES] Grouped templates:', groupedTemplates);
            
            // Render categories
            const categoriesHtml = Object.keys(groupedTemplates).map(category => {
                const categoryTemplates = groupedTemplates[category];
                const categoryId = category.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                
                return `
                    <div class="template-category mb-3 border rounded">
                        <div class="template-header p-3 bg-light rounded-top" onclick="toggleCategoryForTab('${categoryId}')" style="cursor: pointer;">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1 text-primary">
                                        <i class="fas fa-folder me-2"></i>${category}
                                    </h6>
                                    <small class="text-muted">
                                        <i class="fas fa-file-text me-1"></i>${categoryTemplates.length} m·∫´u tin nh·∫Øn
                                    </small>
                                </div>
                                <i class="fas fa-chevron-down transition-all" id="icon-${categoryId}"></i>
                            </div>
                        </div>
                        <div class="template-content border-top" id="category-${categoryId}" style="display: none;">
                            <div class="p-3">
                                ${categoryTemplates.map(template => `
                                    <div class="template-item border-start border-3 border-primary ms-2 ps-3 mb-3 bg-light rounded">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 text-secondary">
                                                    <i class="fas fa-tag me-1"></i>
                                                    ${template.label !== 'DEFAULT' ? template.label : 'M·∫∑c ƒë·ªãnh'}
                                                </h6>
                                                <small class="text-muted">Template ID: ${template.id}</small>
                                            </div>
                                            <div class="template-actions">
                                                <button class="btn btn-sm btn-primary me-1" onclick="useTemplateFromTab('${template.id}')" title="S·ª≠ d·ª•ng template">
                                                    <i class="fas fa-paper-plane"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="copyTemplateFromTab('${template.id}')" title="Copy n·ªôi dung">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="template-content-text bg-white p-3 rounded border" style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.5; max-height: 200px; overflow-y: auto;">
                                            ${template.content || 'N·ªôi dung tr·ªëng'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="templates-list">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-0">
                                <i class="fas fa-clipboard-list text-primary me-2"></i>
                                T·ªïng c·ªông: ${templates.length} m·∫´u tin nh·∫Øn
                            </h6>
                            <small class="text-muted">Trong ${Object.keys(groupedTemplates).length} danh m·ª•c</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="expandAllCategories()">
                            <i class="fas fa-expand-arrows-alt"></i> M·ªü r·ªông t·∫•t c·∫£
                        </button>
                    </div>
                    ${categoriesHtml}
                </div>
            `;
            
            console.log('[TEMPLATES] Render completed successfully');
            
        } catch (error) {
            console.error('[TEMPLATES] Render error:', error);
            container.innerHTML = `
                <div class="alert alert-warning" role="alert">
                    <h6><i class="fas fa-exclamation-triangle"></i> L·ªói hi·ªÉn th·ªã templates</h6>
                    <p>ƒê√£ t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu nh∆∞ng kh√¥ng th·ªÉ hi·ªÉn th·ªã: ${error.message}</p>
                    <button class="btn btn-sm btn-primary" onclick="retryLoadTemplates()">
                        <i class="fas fa-retry"></i> Th·ª≠ l·∫°i
                    </button>
                </div>
            `;
        }
    }

    // Enhanced toggle function
    function toggleCategoryForTab(categoryId) {
        try {
            const content = document.getElementById(`category-${categoryId}`);
            const icon = document.getElementById(`icon-${categoryId}`);
            
            if (!content || !icon) {
                console.error('[TEMPLATES] Toggle elements not found:', categoryId);
                return;
            }
            
            if (content.style.display === 'block') {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down transition-all';
            } else {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up transition-all';
            }
        } catch (error) {
            console.error('[TEMPLATES] Toggle error:', error);
        }
    }

    // Expand all categories
    function expandAllCategories() {
        try {
            const allContent = document.querySelectorAll('[id^="category-"]');
            const allIcons = document.querySelectorAll('[id^="icon-"]');
            
            allContent.forEach(content => {
                content.style.display = 'block';
            });
            
            allIcons.forEach(icon => {
                icon.className = 'fas fa-chevron-up transition-all';
            });
            
            showSuccess('‚úÖ ƒê√£ m·ªü r·ªông t·∫•t c·∫£ danh m·ª•c');
        } catch (error) {
            console.error('[TEMPLATES] Expand all error:', error);
        }
    }

    // Enhanced template actions
    function useTemplateFromTab(id) {
        try {
            const template = templates.find(t => t.id === id);
            if (!template) {
                showError('Kh√¥ng t√¨m th·∫•y template v·ªõi ID: ' + id);
                return;
            }
            
            if (!template.content) {
                showError('Template n√†y kh√¥ng c√≥ n·ªôi dung');
                return;
            }
            
            copyToClipboard(template.content);
            showSuccess(`‚úÖ ƒê√£ copy "${template.name}" ƒë·ªÉ s·ª≠ d·ª•ng!`);
            
        } catch (error) {
            console.error('[TEMPLATES] Use template error:', error);
            showError('L·ªói khi s·ª≠ d·ª•ng template: ' + error.message);
        }
    }

    function copyTemplateFromTab(id) {
        try {
            const template = templates.find(t => t.id === id);
            if (!template) {
                showError('Kh√¥ng t√¨m th·∫•y template v·ªõi ID: ' + id);
                return;
            }
            
            if (!template.content) {
                showError('Template n√†y kh√¥ng c√≥ n·ªôi dung ƒë·ªÉ copy');
                return;
            }
            
            copyToClipboard(template.content);
            showSuccess(`üìã ƒê√£ copy n·ªôi dung "${template.label}"!`);
            
        } catch (error) {
            console.error('[TEMPLATES] Copy template error:', error);
            showError('L·ªói khi copy template: ' + error.message);
        }
    }

    // Templates tab event listeners now handled in main DOMContentLoaded
    
    // Import from Google Sheets
    async function importFromSheets() {
        showLoading(true);
        try {
            console.log('[IMPORT] Starting import from Google Sheets...');
            
            const response = await fetch('/templates/import', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json, text/html'
                }
            });
            
            console.log('[IMPORT] Response status:', response.status);
            console.log('[IMPORT] Response redirected:', response.redirected);
            console.log('[IMPORT] Response URL:', response.url);
            
            if (response.status === 200 || response.redirected) {
                showSuccess('‚úÖ Import th√†nh c√¥ng t·ª´ Google Sheets!');
                
                // Force reload templates
                console.log('[IMPORT] Reloading templates after import...');
                templates = []; // Clear cache
                isTemplatesLoaded = false; // Reset flag
                
                await loadTemplatesForTab();
                // Also reload for AI chat
                await loadTemplateCategories();
                
                console.log('[IMPORT] Templates reloaded successfully');
            } else {
                // Try to get error message from response
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorText = await response.text();
                    console.log('[IMPORT] Error response:', errorText);
                    errorMessage = errorText || errorMessage;
                } catch (e) {
                    console.log('[IMPORT] Could not read error response:', e);
                }
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('[IMPORT] Import error:', error);
            showError('‚ùå L·ªói khi import t·ª´ Sheets: ' + error.message + '. Vui l√≤ng ki·ªÉm tra Google Sheets c√≥ worksheet "MessageTemplate" kh√¥ng?');
        } finally {
            showLoading(false);
        }
    }
    
    // Export to Google Sheets
    async function exportToSheets() {
        showLoading(true);
        try {
            console.log('[EXPORT] Starting export to Google Sheets...');
            
            // Check if we have templates to export
            if (!templates || templates.length === 0) {
                showError('‚ùå Kh√¥ng c√≥ m·∫´u tin nh·∫Øn ƒë·ªÉ export. Vui l√≤ng th√™m √≠t nh·∫•t 1 template tr∆∞·ªõc.');
                return;
            }
            
            const response = await fetch('/templates/export', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json, text/html'
                }
            });
            
            console.log('[EXPORT] Response status:', response.status);
            console.log('[EXPORT] Response redirected:', response.redirected);
            
            if (response.status === 200 || response.redirected) {
                showSuccess('‚úÖ Export th√†nh c√¥ng ra Google Sheets!');
                console.log('[EXPORT] Export completed successfully');
            } else {
                // Try to get error message from response
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorText = await response.text();
                    console.log('[EXPORT] Error response:', errorText);
                    errorMessage = errorText || errorMessage;
                } catch (e) {
                    console.log('[EXPORT] Could not read error response:', e);
                }
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('[EXPORT] Export error:', error);
            showError('‚ùå L·ªói khi export ra Sheets: ' + error.message);
        } finally {
            showLoading(false);
        }
    }
    
    // Show add template modal
    function showAddTemplateModal() {
        // Reset form
        document.getElementById('addTemplateForm').reset();
        document.getElementById('customCategoryDiv').style.display = 'none';
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('addTemplateModal'));
        modal.show();
    }
    
    // Template modal category handling now in main DOMContentLoaded
    
    // Add new template
    async function addNewTemplate() {
        console.log('üîß Starting addNewTemplate function...');
        
        const form = document.getElementById('addTemplateForm');
        
        // Get form data first with enhanced element checking
        const categorySelect = document.getElementById('addTemplateCategory');
        
        // Debug: Check if we have the right element
        console.log('üîç Element debugging:', {
            categorySelectElement: categorySelect,
            categorySelectId: categorySelect ? categorySelect.id : 'NOT FOUND',
            categorySelectTagName: categorySelect ? categorySelect.tagName : 'NOT FOUND',
            allElementsWithSameId: document.querySelectorAll('#addTemplateCategory').length
        });
        
        if (!categorySelect) {
            showError('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y dropdown danh m·ª•c!');
            return;
        }
        
        const customCategory = document.getElementById('customCategory').value.trim();
        const label = document.getElementById('templateLabel').value.trim();
        const message = document.getElementById('templateMessage').value.trim();
        
        console.log('üìù Form data:', {
            categoryValue: categorySelect.value,
            customCategory: customCategory,
            label: label,
            message: message
        });
        
        // Determine final category
        let finalCategory = categorySelect.value;
        if (finalCategory === 'OTHER' && customCategory) {
            finalCategory = customCategory.toUpperCase();
        }
        
        console.log('üéØ Final category determined:', finalCategory);
        
        // Enhanced validation with detailed logging
        if (!finalCategory || finalCategory === '' || finalCategory === 'OTHER') {
            console.error('‚ùå Category validation failed:', {
                finalCategory: finalCategory,
                categorySelectValue: categorySelect.value,
                customCategory: customCategory
            });
            
            // Highlight the category field
            categorySelect.classList.add('is-invalid');
            setTimeout(() => categorySelect.classList.remove('is-invalid'), 3000);
            
            if (categorySelect.value === 'OTHER' && !customCategory) {
                showError('‚ùå B·∫°n ƒë√£ ch·ªçn "Kh√°c" - vui l√≤ng nh·∫≠p t√™n danh m·ª•c t√πy ch·ªânh!');
            } else if (!categorySelect.value) {
                showError('‚ùå Vui l√≤ng ch·ªçn danh m·ª•c t·ª´ dropdown!');
            } else {
                showError('‚ùå L·ªói danh m·ª•c: "' + finalCategory + '"');
            }
            return;
        }
        
        if (!label || label === '') {
            console.error('‚ùå Label validation failed');
            const labelField = document.getElementById('templateLabel');
            labelField.classList.add('is-invalid');
            setTimeout(() => labelField.classList.remove('is-invalid'), 3000);
            showError('‚ùå Vui l√≤ng nh·∫≠p nh√£n!');
            return;
        }
        
        if (!message || message === '') {
            console.error('‚ùå Message validation failed');
            const messageField = document.getElementById('templateMessage');
            messageField.classList.add('is-invalid');
            setTimeout(() => messageField.classList.remove('is-invalid'), 3000);
            showError('‚ùå Vui l√≤ng nh·∫≠p n·ªôi dung tin nh·∫Øn!');
            return;
        }
        
        console.log('‚úÖ All validations passed, proceeding with template creation...');
        
        // Prepare new template data
        const newTemplate = {
            Category: finalCategory,
            Label: label,
            Message: message
        };
        
        showLoading(true);
        
        try {
            // Call API to add new template
            const response = await fetch('/api/templates/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newTemplate)
            });
            
            if (response.ok) {
                const result = await response.json();
                showSuccess(result.message || '‚úÖ ƒê√£ th√™m m·∫´u tin nh·∫Øn th√†nh c√¥ng v√† export ra Google Sheets!');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addTemplateModal'));
                modal.hide();
                
                // Reload templates
                templates = []; // Clear cache
                await loadTemplatesForTab();
                // Also reload for AI chat
                await loadTemplateCategories();
            } else {
                const error = await response.json();
                throw new Error(error.message || 'L·ªói khi th√™m m·∫´u tin nh·∫Øn');
            }
        } catch (error) {
            console.error('Add template error:', error);
            showError('‚ùå L·ªói khi th√™m m·∫´u tin nh·∫Øn: ' + error.message);
        } finally {
            showLoading(false);
        }
    }
    
    // Helper functions for quick actions
    function viewTemplates() {
        // Switch to templates tab and force load
        console.log('[TEMPLATES] viewTemplates() called - switching to templates tab');
        const templatesTabElement = document.getElementById('templates-tab');
        const templatesTab = new bootstrap.Tab(templatesTabElement);
        templatesTab.show();
        
        // Force load templates if not loaded
        if (!isTemplatesLoaded) {
            console.log('[TEMPLATES] Forcing template load...');
            loadTemplatesForTab();
        }
    }
    
    function clearAll() {
        // Clear all chat data
        currentImageData = null;
        const chatAnalysisResult = document.getElementById('chatAnalysisResult');
        if (chatAnalysisResult) {
            chatAnalysisResult.innerHTML = '';
        }
        
        const imagePreview = document.getElementById('imagePreview');
        if (imagePreview) {
            imagePreview.style.display = 'none';
        }
        
        showSuccess('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!');
    }
    
    function switchToVoice() {
        const voiceTabElement = document.getElementById('voice-tab');
        const voiceTab = new bootstrap.Tab(voiceTabElement);
        voiceTab.show();
    }
    
    function switchToChat() {
        const chatTabElement = document.getElementById('chat-tab');
        const chatTab = new bootstrap.Tab(chatTabElement);
        chatTab.show();
    }
    
    // Test Google Sheets connection
    async function testSheetsConnection() {
        showLoading(true);
        try {
            console.log('[TEST] Testing Google Sheets connection...');
            
            const response = await fetch('/api/templates/debug', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('[TEST] Debug response:', data);
                
                let message = 'üìä **K·∫øt qu·∫£ test k·∫øt n·ªëi:**\n\n';
                message += `üóÇÔ∏è **File local:** ${data.file_exists ? '‚úÖ T·ªìn t·∫°i' : '‚ùå Kh√¥ng t·ªìn t·∫°i'}\n`;
                message += `üìÅ **ƒê∆∞·ªùng d·∫´n:** ${data.file_path}\n`;
                message += `üìù **S·ªë templates:** ${data.templates_count}\n`;
                
                if (data.sample_template) {
                    message += `üìã **Template m·∫´u:** ${data.sample_template.Category} - ${data.sample_template.Label}\n`;
                }
                
                if (data.error) {
                    message += `‚ö†Ô∏è **L·ªói:** ${data.error}\n`;
                }
                
                // Additional advice
                message += '\nüí° **ƒê·ªÉ import t·ª´ Google Sheets:**\n';
                message += '1. ƒê·∫£m b·∫£o c√≥ worksheet t√™n "MessageTemplate"\n';
                message += '2. Worksheet ph·∫£i c√≥ c·ªôt: Category, Label, Message\n';
                message += '3. Ki·ªÉm tra quy·ªÅn truy c·∫≠p Google Sheets\n';
                
                showSuccess(message);
            } else {
                throw new Error(`Test failed: HTTP ${response.status}`);
            }
        } catch (error) {
            console.error('[TEST] Connection test error:', error);
            showError('‚ùå L·ªói test k·∫øt n·ªëi: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // üß† RAG Chat Functions with Gemini Enhancement
    let ragCurrentQuery = '';
    let ragCurrentResponse = null;
    let ragConversationId = null;

    // Initialize conversation ID
    function initializeRAGConversation() {
        ragConversationId = `conv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        console.log(`üîÑ Started new conversation: ${ragConversationId}`);
    }

    async function sendRAGQuery() {
        const query = document.getElementById('ragQueryInput').value.trim();
        const guestName = document.getElementById('ragGuestName').value.trim();
        const geminiMode = document.getElementById('geminiModeToggle').checked;
        
        if (!query) {
            alert('Please enter a question!');
            return;
        }
        
        ragCurrentQuery = query;
        
        // Initialize conversation if needed
        if (!ragConversationId) {
            initializeRAGConversation();
        }
        
        console.log(`üß† Sending ${geminiMode ? 'Gemini' : 'Simple'} RAG query: "${query}" for guest: "${guestName}"`);
        
        try {
            // Show loading state
            document.getElementById('ragResponseArea').style.display = 'block';
            document.getElementById('ragAnswer').innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-spinner fa-spin me-2"></i> 
                    ${geminiMode ? 'Gemini AI thinking...' : 'RAG processing...'}
                </div>
            `;
            
            // Choose endpoint based on mode
            const endpoint = geminiMode ? '/api/ai_chat_gemini_rag' : '/api/ai_chat_rag';
            
            // Prepare request data
            const requestData = {
                message: query,
                guest_name: guestName
            };
            
            // Add conversation ID for Gemini mode
            if (geminiMode) {
                requestData.conversation_id = ragConversationId;
            }
            
            // Send request
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayRAGResponse(result);
                // Clear input after successful query
                document.getElementById('ragQueryInput').value = '';
            } else {
                throw new Error(result.error || 'Unknown error');
            }
            
        } catch (error) {
            console.error('RAG query error:', error);
            document.getElementById('ragAnswer').innerHTML = 
                `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
        }
    }

    // Handle mode toggle
    document.addEventListener('DOMContentLoaded', function() {
        const toggle = document.getElementById('geminiModeToggle');
        const indicator = document.getElementById('ragModeIndicator');
        const description = document.getElementById('ragModeDescription');
        
        function updateModeDisplay() {
            if (toggle.checked) {
                indicator.className = 'badge bg-success';
                indicator.textContent = 'üöÄ Gemini Mode';
                description.textContent = 'Natural language AI with advanced reasoning';
            } else {
                indicator.className = 'badge bg-info';
                indicator.textContent = 'üß† Simple RAG';
                description.textContent = 'Fast keyword-based matching';
            }
        }
        
        toggle.addEventListener('change', function() {
            updateModeDisplay();
            // Reset conversation when switching modes
            ragConversationId = null;
            console.log(`üîÑ Switched to ${this.checked ? 'Gemini' : 'Simple'} mode`);
        });
        
        // Initial setup
        updateModeDisplay();
    });

    function displayRAGResponse(result) {
        ragCurrentResponse = result;
        
        // Display main answer with enhanced formatting for Gemini responses
        const answerHtml = result.gemini_enhanced ? 
            `<div class="fw-bold mb-2">${result.answer.replace(/\n/g, '<br>')}</div>` :
            `<div class="fw-bold mb-2">${result.answer}</div>`;
            
        document.getElementById('ragAnswer').innerHTML = answerHtml;
        
        // Update confidence badge with model information
        const confidence = result.confidence || 0;
        const confidenceBadge = document.getElementById('ragConfidence');
        
        if (result.gemini_enhanced) {
            confidenceBadge.className = 'badge bg-gradient me-2';
            confidenceBadge.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
            confidenceBadge.textContent = 'üöÄ Gemini Enhanced';
        } else if (confidence > 0.8) {
            confidenceBadge.className = 'badge bg-success me-2';
            confidenceBadge.textContent = 'High Confidence';
        } else if (confidence > 0.5) {
            confidenceBadge.className = 'badge bg-warning me-2';
            confidenceBadge.textContent = 'Medium Confidence';
        } else {
            confidenceBadge.className = 'badge bg-secondary me-2';
            confidenceBadge.textContent = 'Low Confidence';
        }
        
        // Display timestamp with model info
        const modelInfo = result.model_used ? ` (${result.model_used})` : '';
        document.getElementById('ragTimestamp').textContent = 
            new Date(result.timestamp).toLocaleTimeString() + modelInfo;
        
        // Display guest context if available
        if (result.booking_context && result.booking_context.guest_name) {
            const guestContext = document.getElementById('ragGuestContext');
            const guestInfo = document.getElementById('ragGuestInfo');
            
            const context = result.booking_context;
            const contextInfo = result.contextual_info || {};
            
            let guestInfoHtml = `${context.guest_name}`;
            if (contextInfo.vip_status) {
                guestInfoHtml += ` <span class="badge bg-gold">VIP</span>`;
            }
            if (contextInfo.status_message) {
                guestInfoHtml += ` - ${contextInfo.status_message}`;
            }
            if (context.booking_id) {
                guestInfoHtml += ` (${context.booking_id})`;
            }
            
            guestInfo.innerHTML = guestInfoHtml;
            guestContext.style.display = 'block';
        } else {
            document.getElementById('ragGuestContext').style.display = 'none';
        }
        
        // Display sources
        if (result.sources && result.sources.length > 0) {
            document.getElementById('ragSourcesList').textContent = result.sources.join(', ');
        } else {
            document.getElementById('ragSourcesList').textContent = 'Hotel Knowledge Base';
        }
        
        // Display suggestions
        if (result.suggestions && result.suggestions.length > 0) {
            const suggestionsList = document.getElementById('ragSuggestionsList');
            suggestionsList.innerHTML = result.suggestions.map(suggestion => 
                `<div class="mt-1">‚Ä¢ ${suggestion}</div>`
            ).join('');
        } else {
            document.getElementById('ragSuggestionsList').innerHTML = '<div class="mt-1">Ask about check-in/out times, local attractions, or services</div>';
        }
        
        console.log('‚úÖ RAG response displayed successfully');
    }

    function ragQuickQuestion(question) {
        document.getElementById('ragQueryInput').value = question;
        sendRAGQuery();
    }

    function copyRAGResponse() {
        if (!ragCurrentResponse) {
            alert('No response to copy!');
            return;
        }
        
        let copyText = `Question: ${ragCurrentQuery}\n\nAnswer: ${ragCurrentResponse.answer}`;
        
        if (ragCurrentResponse.suggestions && ragCurrentResponse.suggestions.length > 0) {
            copyText += `\n\nSuggestions:\n${ragCurrentResponse.suggestions.map(s => `‚Ä¢ ${s}`).join('\n')}`;
        }
        
        // Copy to clipboard
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(copyText).then(() => {
                showSuccess('üìã RAG response copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                fallbackCopyRAG(copyText);
            });
        } else {
            fallbackCopyRAG(copyText);
        }
    }

    function fallbackCopyRAG(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showSuccess('üìã RAG response copied to clipboard!');
        } catch (err) {
            console.error('Fallback copy failed:', err);
            alert(`RAG Response:\n\n${text}`);
        }
        
        document.body.removeChild(textArea);
    }

    function clearRAGResponse() {
        document.getElementById('ragResponseArea').style.display = 'none';
        ragCurrentQuery = '';
        ragCurrentResponse = null;
    }

    // Global functions for RAG (making them available in global scope)
    window.sendRAGQuery = sendRAGQuery;
    window.ragQuickQuestion = ragQuickQuestion;
    window.copyRAGResponse = copyRAGResponse;
    window.clearRAGResponse = clearRAGResponse;

    console.log('‚úÖ RAG Chat functions initialized');
</script>
{% endblock %}
