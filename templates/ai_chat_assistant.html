<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistant - L·ªÖ T√¢n Th√¥ng Minh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:9998;}
        .image-paste-area{border:2px dashed #dee2e6;border-radius:8px;padding:40px;text-align:center;background:#f8f9fa;transition:all 0.3s;cursor:pointer;}
        .image-paste-area:hover{border-color:#0d6efd;background:#e7f3ff;}
        .image-paste-area.dragover{border-color:#0d6efd;background:#e7f3ff;transform:scale(1.02);}
        .image-preview{max-width:100%;max-height:400px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);}
        .response-area{background:#f8f9fa;border-radius:8px;padding:20px;margin-top:20px;min-height:150px;}
        .copy-button{position:absolute;top:10px;right:10px;}
        .ai-response{position:relative;background:white;border-radius:8px;padding:15px;border-left:4px solid #28a745;box-shadow:0 2px 4px rgba(0,0,0,0.05);}
        .analysis-info{background:#e3f2fd;border-radius:6px;padding:12px;margin-bottom:15px;font-size:0.9em;}
        .template-match{background:#fff3cd;border-radius:6px;padding:10px;margin:10px 0;border-left:3px solid #ffc107;}
        
        /* Enhanced Template Preview Styles */
        #templatePreview {
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: translateY(0);
        }
        #templatePreview.show {
            opacity: 1;
            transform: translateY(0);
        }
        #templatePreview.hide {
            opacity: 0;
            transform: translateY(-10px);
        }
        
        /* Dropdown Enhanced Styles */
        #specificTemplate {
            transition: all 0.3s ease;
            position: relative;
        }
        #specificTemplate:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        /* Quick Preview Tooltip */
        #quickPreviewTooltip {
            transition: opacity 0.2s ease;
            word-wrap: break-word;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(4px);
        }
        
        /* Template Preview Box Enhanced */
        .alert.alert-light {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
        }
        
        /* Copy Button in Preview */
        .btn-outline-secondary {
            transition: all 0.2s ease;
        }
        .btn-outline-secondary:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        /* Debug Console Styles (for development) */
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            margin-top: 10px;
            display: none; /* Hidden by default, can be shown for debugging */
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .image-paste-area {
                padding: 25px 15px;
                font-size: 0.9rem;
            }
            
            .image-paste-area h5 {
                font-size: 1.1rem;
            }
            
            .image-preview {
                max-height: 250px;
            }
            
            .btn-sm {
                font-size: 0.8rem;
                padding: 4px 8px;
            }
            
            .form-select-sm {
                font-size: 0.85rem;
            }
            
            .response-area {
                padding: 15px;
                font-size: 0.9rem;
            }
            
            .ai-response {
                padding: 12px;
            }
            
            .template-match {
                padding: 8px;
                font-size: 0.85rem;
            }
            
            .analysis-info {
                padding: 10px;
                font-size: 0.85rem;
            }
            
            .copy-button {
                position: static;
                margin-top: 10px;
                width: 100%;
            }
            
            /* Better mobile touch targets */
            .btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .image-paste-area {
                min-height: 140px;
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(0,123,255,0.1);
            }
            
            /* Mobile upload buttons */
            .d-block.d-md-none .btn {
                margin: 5px 2px;
                flex: 1;
            }
        }
        
        /* Touch improvements */
        .btn, .image-paste-area, .copy-btn {
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.1s ease;
        }
        
        .btn:active, .image-paste-area:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center my-4">
            <h1 class="mb-0">
                <i class="fas fa-robot text-primary"></i> AI Chat Assistant
            </h1>
            <div>
                <button class="btn btn-info me-2" onclick="viewTemplates()">
                    <i class="fas fa-list"></i> Xem m·∫´u tin nh·∫Øn
                </button>
                <button class="btn btn-success" onclick="clearAll()">
                    <i class="fas fa-refresh"></i> L√†m m·ªõi
                </button>
            </div>
        </div>
        
        <div class="row">
            <!-- Ph·∫ßn t·∫£i ·∫£nh -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-image"></i> T·∫£i ·∫¢nh ƒêo·∫°n Chat
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="imagePasteArea" class="image-paste-area" onclick="selectImageFile()">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <h5>D√°n ·∫£nh, ch·ªçn file ho·∫∑c ch·ª•p ·∫£nh</h5>
                            <p class="text-muted mb-2">
                                H·ªó tr·ª£: PNG, JPG, JPEG<br>
                                <kbd>Ctrl+V</kbd> ƒë·ªÉ d√°n ·∫£nh t·ª´ clipboard
                            </p>
                            <!-- Mobile-specific upload options -->
                            <div class="d-block d-md-none mt-2">
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="selectImageFile()">
                                    <i class="fas fa-folder-open"></i> Ch·ªçn t·ª´ th∆∞ vi·ªán
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="capturePhoto()">
                                    <i class="fas fa-camera"></i> Ch·ª•p ·∫£nh
                                </button>
                            </div>
                        </div>
                        
                        <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                        
                        <div id="imagePreviewContainer" class="mt-3" style="display: none;">
                            <img id="imagePreview" class="image-preview" alt="Xem tr∆∞·ªõc ·∫£nh">
                            <div class="mt-2">
                                <button class="btn btn-danger btn-sm" onclick="removeImage()">
                                    <i class="fas fa-trash"></i> X√≥a ·∫£nh
                                </button>
                                <button class="btn btn-primary btn-sm ms-2" onclick="analyzeImage()">
                                    <i class="fas fa-magic"></i> Ph√¢n t√≠ch v·ªõi AI
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ph·∫ßn c·∫•u h√¨nh v√† k·∫øt qu·∫£ AI -->
            <div class="col-md-6">
                <!-- AI Configuration Panel -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs"></i> T√πy Ch·ªçn Ph·∫£n H·ªìi AI
                        </h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="row align-items-center">
                            <!-- Template Selection -->
                            <div class="col-md-4">
                                <label for="templateCategory" class="form-label small mb-1">M·∫´u tin nh·∫Øn:</label>
                                <select id="templateCategory" class="form-select form-select-sm" onchange="loadSpecificTemplates()">
                                    <option value="">T·ª± ƒë·ªông ch·ªçn</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="specificTemplate" class="form-label small mb-1">M·∫´u c·ª• th·ªÉ:</label>
                                <select id="specificTemplate" class="form-select form-select-sm" disabled 
                                        onchange="previewSelectedTemplate()" 
                                        onmouseenter="enableHoverPreview()" 
                                        onmouseleave="disableHoverPreview()">
                                    <option value="">Ch·ªçn category tr∆∞·ªõc</option>
                                </select>
                                <!-- Quick preview tooltip -->
                                <div id="quickPreviewTooltip" class="position-absolute bg-dark text-white p-2 rounded shadow" 
                                     style="display: none; z-index: 1000; max-width: 300px; font-size: 0.8rem; top: 100%; left: 0;">
                                </div>
                            </div>
                            <!-- Yes/No Mode -->
                            <div class="col-md-4">
                                <label class="form-label small mb-1">Phong c√°ch tr·∫£ l·ªùi:</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="responseMode" id="responseModeAuto" value="auto" checked>
                                    <label class="btn btn-outline-secondary btn-sm" for="responseModeAuto">Auto</label>
                                    
                                    <input type="radio" class="btn-check" name="responseMode" id="responseModeYes" value="yes">
                                    <label class="btn btn-outline-success btn-sm" for="responseModeYes">Yes</label>
                                    
                                    <input type="radio" class="btn-check" name="responseMode" id="responseModeNo" value="no">
                                    <label class="btn btn-outline-danger btn-sm" for="responseModeNo">No</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Template Preview Area -->
                        <div id="templatePreview" class="mt-2" style="display: none;">
                            <div class="alert alert-light border-start border-4 border-primary py-2 px-3 mb-0">
                                <small class="text-muted d-block mb-1">Preview m·∫´u ƒë√£ ch·ªçn:</small>
                                <div id="templatePreviewContent" class="small"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Response Area -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-comments"></i> Ph·∫£n H·ªìi AI
                        </h5>
                        <div id="processingStatus" class="text-muted" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch...
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="responseArea" class="response-area">
                            <div class="text-center text-muted">
                                <i class="fas fa-robot fa-2x mb-3 text-primary"></i>
                                <h6 class="text-primary">üß† AI Chat Assistant - Context-Aware Intelligence</h6>
                                <p class="mb-3">T·∫£i ·∫£nh ƒëo·∫°n chat l√™n, AI s·∫Ω ƒë·ªçc v√† hi·ªÉu <strong>to√†n b·ªô b·ªëi c·∫£nh</strong> ƒë·ªÉ ƒë∆∞a ra ph·∫£n h·ªìi th√¥ng minh!</p>
                                
                                <div class="alert alert-primary border-primary border-2 mt-3" style="font-size: 0.9em; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                                    <h6 class="text-primary mb-3"><i class="fas fa-star me-1"></i> T√≠nh nƒÉng Context-Aware AI m·ªõi!</h6>
                                    <div class="row text-start">
                                        <div class="col-md-6 mb-2">
                                            <i class="fas fa-comments me-2 text-primary"></i>
                                            <strong>ƒê·ªçc to√†n b·ªô cu·ªôc h·ªôi tho·∫°i:</strong><br>
                                            <small class="text-muted">AI hi·ªÉu t√¨nh hu·ªëng t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi, kh√¥ng ch·ªâ tin nh·∫Øn cu·ªëi</small>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <i class="fas fa-brain me-2 text-success"></i>
                                            <strong>Nh·∫≠n di·ªán t∆∞∆°ng t√°c tr∆∞·ªõc:</strong><br>
                                            <small class="text-muted">Nh·ªõ nh·ªØng g√¨ ƒë√£ th·∫£o lu·∫≠n v√† ph·∫£n h·ªìi ph√π h·ª£p</small>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <i class="fas fa-magic me-2 text-warning"></i>
                                            <strong>Template th√¥ng minh:</strong><br>
                                            <small class="text-muted">T·ª± ƒë·ªông ch·ªçn m·∫´u tin nh·∫Øn ph√π h·ª£p v·ªõi context</small>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <i class="fas fa-sync-alt me-2 text-info"></i>
                                            <strong>Auto-Sync Google Sheets:</strong><br>
                                            <small class="text-muted">Lu√¥n s·ª≠ d·ª•ng m·∫´u tin nh·∫Øn m·ªõi nh·∫•t</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3 p-3 bg-light border rounded">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb me-1 text-warning"></i>
                                                <strong>Kh√°c bi·ªát:</strong> AI c≈© ch·ªâ ƒë·ªçc tin nh·∫Øn cu·ªëi. AI m·ªõi hi·ªÉu c·∫£ c√¢u chuy·ªán!
                                            </small>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <span class="badge bg-success px-3 py-2">
                                                <i class="fas fa-check-circle me-1"></i> Context-Ready
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ph·∫ßn h∆∞·ªõng d·∫´n -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i> H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <i class="fas fa-upload fa-2x text-primary mb-2"></i>
                                    <h6>B∆∞·ªõc 1: T·∫£i ·∫¢nh</h6>
                                    <p class="small text-muted">D√°n ·∫£nh ƒëo·∫°n chat ho·∫∑c ch·ªçn file t·ª´ m√°y t√≠nh</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <i class="fas fa-comments fa-2x text-info mb-2"></i>
                                    <h6>B∆∞·ªõc 2: AI ƒê·ªçc Context</h6>
                                    <p class="small text-muted">AI ph√¢n t√≠ch to√†n b·ªô cu·ªôc h·ªôi tho·∫°i ƒë·ªÉ hi·ªÉu b·ªëi c·∫£nh</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <i class="fas fa-magic fa-2x text-warning mb-2"></i>
                                    <h6>B∆∞·ªõc 3: Ph·∫£n H·ªìi Th√¥ng Minh</h6>
                                    <p class="small text-muted">AI t·∫°o ph·∫£n h·ªìi ph√π h·ª£p v·ªõi context v√† s·ª≠ d·ª•ng template</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <i class="fas fa-copy fa-2x text-success mb-2"></i>
                                    <h6>B∆∞·ªõc 4: Copy & G·ª≠i</h6>
                                    <p class="small text-muted">Copy ph·∫£n h·ªìi c√≥ context v√† g·ª≠i cho kh√°ch h√†ng</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Context Features Highlight -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-star"></i> T√≠nh nƒÉng m·ªõi: Context-Aware AI</h6>
                                    <ul class="mb-0 small">
                                        <li><strong>ƒê·ªçc to√†n b·ªô cu·ªôc h·ªôi tho·∫°i:</strong> AI hi·ªÉu t√¨nh hu·ªëng t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi</li>
                                        <li><strong>Nh·∫≠n di·ªán t∆∞∆°ng t√°c tr∆∞·ªõc:</strong> Nh·ªõ nh·ªØng g√¨ ƒë√£ th·∫£o lu·∫≠n tr∆∞·ªõc ƒë√≥</li>
                                        <li><strong>Ph·∫£n h·ªìi c√≥ context:</strong> Tr·∫£ l·ªùi ph√π h·ª£p v·ªõi to√†n b·ªô t√¨nh hu·ªëng</li>
                                        <li><strong>Template th√¥ng minh:</strong> T·ª± ƒë·ªông ch·ªçn template ph√π h·ª£p v·ªõi context</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentImageData = null;
        let allTemplates = []; // Store all templates for filtering
        
        // Load page
        document.addEventListener('DOMContentLoaded', function() {
            setupImageHandling();
            loadTemplateCategories(); // Load template options on page load
            initializeRealtimePreview(); // Initialize realtime preview
            
            console.log('AI Chat Assistant page loaded successfully'); // Debug log
        });
        
        // Load template categories from API
        async function loadTemplateCategories() {
            try {
                const response = await fetch('/api/templates');
                if (response.ok) {
                    allTemplates = await response.json();
                    populateTemplateCategoryDropdown();
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }
        
        // Populate template category dropdown
        function populateTemplateCategoryDropdown() {
            const categorySelect = document.getElementById('templateCategory');
            const categories = [...new Set(allTemplates.map(t => t.Category))].sort();
            
            // Clear existing options except first one
            categorySelect.innerHTML = '<option value="">T·ª± ƒë·ªông ch·ªçn</option>';
            
            // Add category options
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }
        
        // Load specific templates when category is selected
        function loadSpecificTemplates() {
            const categorySelect = document.getElementById('templateCategory');
            const specificSelect = document.getElementById('specificTemplate');
            const selectedCategory = categorySelect.value;
            
            console.log('Loading templates for category:', selectedCategory); // Debug log
            
            // Clear specific template dropdown
            specificSelect.innerHTML = '<option value="">Ch·ªçn m·∫´u c·ª• th·ªÉ</option>';
            specificSelect.disabled = !selectedCategory;
            
            // Hide template preview
            hideTemplatePreview();
            
            if (selectedCategory) {
                // Filter templates by category
                const categoryTemplates = allTemplates.filter(t => t.Category === selectedCategory);
                console.log('Found templates:', categoryTemplates); // Debug log
                
                // Populate specific template dropdown - FIX: Don't stringify, use index
                categoryTemplates.forEach((template, index) => {
                    const option = document.createElement('option');
                    option.value = index.toString(); // Use index instead of stringified JSON
                    option.textContent = template.Label; // Show label properly
                    option.setAttribute('data-category', selectedCategory);
                    option.setAttribute('data-template-index', index.toString());
                    specificSelect.appendChild(option);
                });
                
                // Store category templates for later access
                specificSelect.categoryTemplates = categoryTemplates;
                specificSelect.disabled = false;
            }
        }
        
        // Hide template preview
        function hideTemplatePreview() {
            document.getElementById('templatePreview').style.display = 'none';
        }
        
        // Preview selected template with enhanced debugging
        function previewSelectedTemplate() {
            const categorySelect = document.getElementById('templateCategory');
            const specificSelect = document.getElementById('specificTemplate');
            const previewDiv = document.getElementById('templatePreview');
            const previewContent = document.getElementById('templatePreviewContent');
            
            console.log('Preview function called, selected value:', specificSelect.value); // Debug log
            
            if (specificSelect.value && specificSelect.value !== '' && specificSelect.categoryTemplates) {
                try {
                    const templateIndex = parseInt(specificSelect.value);
                    const template = specificSelect.categoryTemplates[templateIndex];
                    
                    console.log('Selected template:', template); // Debug log
                    
                    if (template) {
                        const previewHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="text-primary">${template.Category} - ${template.Label}:</strong>
                                    <div class="mt-1">${template.Message}</div>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyTemplatePreview()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        `;
                        
                        previewContent.innerHTML = previewHTML;
                        previewDiv.style.display = 'block';
                        
                        // Add smooth animation
                        previewDiv.style.opacity = '0';
                        setTimeout(() => {
                            previewDiv.style.transition = 'opacity 0.3s ease';
                            previewDiv.style.opacity = '1';
                        }, 10);
                        
                        console.log('Preview displayed successfully'); // Debug log
                    }
                    
                } catch (error) {
                    console.error('Error getting template:', error);
                    hideTemplatePreview();
                }
            } else {
                hideTemplatePreview();
            }
        }
        
        // Copy template preview to clipboard
        function copyTemplatePreview() {
            const specificSelect = document.getElementById('specificTemplate');
            if (specificSelect.value && specificSelect.categoryTemplates) {
                try {
                    const templateIndex = parseInt(specificSelect.value);
                    const template = specificSelect.categoryTemplates[templateIndex];
                    if (template && template.Message) {
                        copyToClipboard(template.Message);
                        showSuccess('ƒê√£ copy m·∫´u tin nh·∫Øn!');
                    }
                } catch (error) {
                    console.error('Error copying template:', error);
                }
            }
        }
        
        // Enable hover preview for dropdown options
        function enableHoverPreview() {
            const specificSelect = document.getElementById('specificTemplate');
            const tooltip = document.getElementById('quickPreviewTooltip');
            
            // Add event listeners for option hover (when dropdown is open)
            specificSelect.addEventListener('mouseover', function(e) {
                if (e.target.tagName === 'OPTION' && e.target.value) {
                    showQuickPreview(e.target.value, e.target);
                }
            });
            
            // Also show preview when option is focused (keyboard navigation)
            specificSelect.addEventListener('focus', function(e) {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    showQuickPreview(selectedOption.value, selectedOption);
                }
            });
        }
        
        // Disable hover preview
        function disableHoverPreview() {
            hideQuickPreview();
        }
        
        // Show quick preview tooltip
        function showQuickPreview(templateValue, targetElement) {
            if (!templateValue) return;
            
            try {
                const template = JSON.parse(templateValue);
                const tooltip = document.getElementById('quickPreviewTooltip');
                
                tooltip.innerHTML = `
                    <div><strong>${template.Category} - ${template.Label}</strong></div>
                    <div class="mt-1 text-light">${template.Message.substring(0, 100)}${template.Message.length > 100 ? '...' : ''}</div>
                `;
                
                // Position tooltip
                const selectRect = document.getElementById('specificTemplate').getBoundingClientRect();
                tooltip.style.display = 'block';
                tooltip.style.left = '0px';
                tooltip.style.top = '100%';
                
            } catch (error) {
                console.error('Error showing quick preview:', error);
            }
        }
        
        // Hide quick preview tooltip
        function hideQuickPreview() {
            const tooltip = document.getElementById('quickPreviewTooltip');
            tooltip.style.display = 'none';
        }
        
        // Enhanced template preview with real-time updates
        function initializeRealtimePreview() {
            const specificSelect = document.getElementById('specificTemplate');
            
            // Add input event for immediate response
            specificSelect.addEventListener('input', function() {
                previewSelectedTemplate();
            });
            
            // Add click event for mobile devices
            specificSelect.addEventListener('click', function() {
                setTimeout(previewSelectedTemplate, 100); // Small delay for option selection
            });
            
            // Keyboard navigation support
            specificSelect.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    setTimeout(previewSelectedTemplate, 50);
                }
            });
        }
        
        // Get current AI configuration
        function getCurrentAIConfig() {
            const categorySelect = document.getElementById('templateCategory');
            const specificSelect = document.getElementById('specificTemplate');
            const responseModeRadios = document.getElementsByName('responseMode');
            
            let selectedTemplate = null;
            if (specificSelect.value && specificSelect.categoryTemplates) {
                try {
                    const templateIndex = parseInt(specificSelect.value);
                    selectedTemplate = specificSelect.categoryTemplates[templateIndex];
                } catch (error) {
                    console.error('Error getting selected template:', error);
                }
            }
            
            let responseMode = 'auto';
            for (const radio of responseModeRadios) {
                if (radio.checked) {
                    responseMode = radio.value;
                    break;
                }
            }
            
            return {
                selectedCategory: categorySelect.value,
                selectedTemplate: selectedTemplate,
                responseMode: responseMode
            };
        }
        
        // Setup image upload and paste handling
        function setupImageHandling() {
            const pasteArea = document.getElementById('imagePasteArea');
            const fileInput = document.getElementById('imageFileInput');
            const cameraInput = document.getElementById('cameraInput');
            
            // Handle paste event
            document.addEventListener('paste', function(e) {
                const items = e.clipboardData.items;
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const file = item.getAsFile();
                        handleImageFile(file);
                        break;
                    }
                }
            });
            
            // Handle drag and drop
            pasteArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                pasteArea.classList.add('dragover');
            });
            
            pasteArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                pasteArea.classList.remove('dragover');
            });
            
            pasteArea.addEventListener('drop', function(e) {
                e.preventDefault();
                pasteArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handleImageFile(files[0]);
                }
            });
            
            // Handle file input (gallery)
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleImageFile(e.target.files[0]);
                }
            });
            
            // Handle camera input
            cameraInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleImageFile(e.target.files[0]);
                }
            });
            
            // Check if device is mobile for better UX
            if (isMobile()) {
                console.log('Mobile device detected, enabling mobile-specific features');
                pasteArea.querySelector('h5').textContent = 'Ch·∫°m ƒë·ªÉ ch·ªçn ·∫£nh ho·∫∑c ch·ª•p ·∫£nh';
                pasteArea.querySelector('p').innerHTML = `
                    H·ªó tr·ª£: PNG, JPG, JPEG<br>
                    <small>Ch·ª•p ·∫£nh tr·ª±c ti·∫øp ho·∫∑c ch·ªçn t·ª´ th∆∞ vi·ªán</small>
                `;
            }
        }
        
        // Select image file
        function selectImageFile() {
            document.getElementById('imageFileInput').click();
        }
        
        // Capture photo (mobile camera)
        function capturePhoto() {
            document.getElementById('cameraInput').click();
        }
        
        // Check if device is mobile
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768);
        }
        
        // Handle image file with compression for mobile
        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('Vui l√≤ng ch·ªçn file ·∫£nh (PNG, JPG, JPEG)');
                return;
            }
            
            // Check file size (limit for mobile)
            const maxSize = isMobile() ? 5 * 1024 * 1024 : 10 * 1024 * 1024; // 5MB mobile, 10MB desktop
            if (file.size > maxSize) {
                alert(`File qu√° l·ªõn. Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n ${isMobile() ? '5MB' : '10MB'}`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                showImagePreview(e.target.result);
                
                // Show success message for mobile users
                if (isMobile()) {
                    showSuccess('ƒê√£ t·∫£i ·∫£nh th√†nh c√¥ng! Nh·∫•n "Ph√¢n t√≠ch v·ªõi AI" ƒë·ªÉ ti·∫øp t·ª•c.');
                }
            };
            
            reader.onerror = function() {
                alert('L·ªói khi ƒë·ªçc file ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
            };
            
            reader.readAsDataURL(file);
        }
        
        // Show image preview
        function showImagePreview(imageSrc) {
            const previewContainer = document.getElementById('imagePreviewContainer');
            const imagePreview = document.getElementById('imagePreview');
            
            imagePreview.src = imageSrc;
            previewContainer.style.display = 'block';
            
            // Hide paste area
            document.getElementById('imagePasteArea').style.display = 'none';
        }
        
        // Remove image
        function removeImage() {
            currentImageData = null;
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('imagePasteArea').style.display = 'block';
            document.getElementById('imageFileInput').value = '';
            
            // Clear response area
            document.getElementById('responseArea').innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-robot fa-2x mb-3"></i>
                    <p>T·∫£i ·∫£nh ƒëo·∫°n chat l√™n v√† nh·∫•n "Ph√¢n t√≠ch v·ªõi AI" ƒë·ªÉ nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi th√¥ng minh t·ª´ AI l·ªÖ t√¢n.</p>
                </div>
            `;
        }
        
        // Analyze image with AI
        async function analyzeImage() {
            if (!currentImageData) {
                alert('Vui l√≤ng t·∫£i ·∫£nh tr∆∞·ªõc!');
                return;
            }
            
            showLoading(true);
            document.getElementById('processingStatus').style.display = 'block';
            
            try {
                // Get current AI configuration
                const aiConfig = getCurrentAIConfig();
                
                // Prepare request data
                const requestData = {
                    image_b64: currentImageData,
                    ai_config: aiConfig
                };
                
                const response = await fetch('/api/ai_chat_analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                displayAIResponse(result, aiConfig);
                
            } catch (error) {
                console.error('AI Analysis error:', error);
                showError('L·ªói khi ph√¢n t√≠ch ·∫£nh: ' + error.message);
            } finally {
                showLoading(false);
                document.getElementById('processingStatus').style.display = 'none';
            }
        }
        
        // Display AI response
        function displayAIResponse(result, aiConfig) {
            const responseArea = document.getElementById('responseArea');
            
            let html = '';
            
            // AI Configuration Used
            if (aiConfig) {
                html += `
                    <div class="alert alert-info border-start border-4 border-info py-2 px-3 mb-3">
                        <h6 class="mb-2"><i class="fas fa-cogs"></i> C·∫•u h√¨nh AI ƒë√£ s·ª≠ d·ª•ng:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Template:</strong> ${aiConfig.selectedTemplate ? 
                                    `${aiConfig.selectedTemplate.Category} - ${aiConfig.selectedTemplate.Label}` : 
                                    'T·ª± ƒë·ªông ch·ªçn'}
                            </div>
                            <div class="col-md-6">
                                <strong>Phong c√°ch:</strong> 
                                <span class="badge ${aiConfig.responseMode === 'yes' ? 'bg-success' : 
                                    aiConfig.responseMode === 'no' ? 'bg-danger' : 'bg-secondary'}">
                                    ${aiConfig.responseMode === 'yes' ? 'T√≠ch c·ª±c (Yes)' : 
                                      aiConfig.responseMode === 'no' ? 'Ti√™u c·ª±c (No)' : 'T·ª± ƒë·ªông (Auto)'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // NEW: Conversation Context Analysis
            if (result.conversation_context) {
                html += `
                    <div class="alert alert-primary border-start border-4 border-primary py-3 px-3 mb-3">
                        <h6><i class="fas fa-comments"></i> Ph√¢n t√≠ch B·ªëi c·∫£nh Cu·ªôc h·ªôi tho·∫°i:</h6>
                        <p class="mb-2" style="line-height: 1.6;">${result.conversation_context}</p>
                        ${result.previous_interactions ? `
                            <div class="mt-2 pt-2 border-top border-light">
                                <small class="text-muted"><strong>T∆∞∆°ng t√°c tr∆∞·ªõc ƒë√≥:</strong></small>
                                <div class="small mt-1">${result.previous_interactions}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // NEW: Latest Message Analysis
            if (result.latest_message_analysis) {
                html += `
                    <div class="alert alert-warning border-start border-4 border-warning py-2 px-3 mb-3">
                        <h6><i class="fas fa-search"></i> Ph√¢n t√≠ch Tin nh·∫Øn M·ªõi nh·∫•t:</h6>
                        <p class="mb-0">${result.latest_message_analysis}</p>
                    </div>
                `;
            }
            
            // Template matches
            if (result.matched_templates && result.matched_templates.length > 0) {
                html += `<h6><i class="fas fa-lightbulb"></i> M·∫´u tin nh·∫Øn ph√π h·ª£p:</h6>`;
                result.matched_templates.forEach(template => {
                    html += `
                        <div class="template-match">
                            <strong>${template.category} - ${template.label}</strong>
                            <p class="mb-0 mt-1">${template.message}</p>
                        </div>
                    `;
                });
            }
            
            // AI Response
            if (result.ai_response) {
                html += `
                    <div class="ai-response">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6><i class="fas fa-robot text-success"></i> Ph·∫£n h·ªìi AI (C√≥ context):</h6>
                            <button class="btn btn-sm btn-outline-primary copy-button" onclick="copyToClipboard(\`${result.ai_response.replace(/`/g, '\\`')}\`)">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <div style="white-space: pre-wrap; line-height: 1.6; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">${result.ai_response}</div>
                    </div>
                `;
            }
            
            // NEW: Context Rationale
            if (result.context_rationale) {
                html += `
                    <div class="alert alert-light border-start border-4 border-secondary py-2 px-3 mt-3">
                        <h6><i class="fas fa-lightbulb"></i> L√Ω do Context ·∫£nh h∆∞·ªüng ƒë·∫øn ph·∫£n h·ªìi:</h6>
                        <p class="mb-0 small text-muted">${result.context_rationale}</p>
                    </div>
                `;
            }
            
            // Fallback for old analysis_info (for backward compatibility)
            if (!result.conversation_context && result.analysis_info) {
                html += `
                    <div class="analysis-info">
                        <h6><i class="fas fa-search"></i> Ph√¢n t√≠ch n·ªôi dung:</h6>
                        <p class="mb-0">${result.analysis_info}</p>
                    </div>
                `;
            }
            
            responseArea.innerHTML = html;
        }
        
        // Copy to clipboard
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showSuccess('ƒê√£ copy ph·∫£n h·ªìi!');
            } catch (error) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('ƒê√£ copy ph·∫£n h·ªìi!');
            }
        }
        
        // Utility functions
        function showLoading(show) {
            document.querySelector('.loading-overlay').style.display = show ? 'flex' : 'none';
        }
        
        function showSuccess(message) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 m-3 alert alert-success alert-dismissible';
            toast.style.zIndex = '9999';
            toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function showError(message) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 m-3 alert alert-danger alert-dismissible';
            toast.style.zIndex = '9999';
            toast.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }
        
        function viewTemplates() { window.location.href = '/templates'; }
        function clearAll() { removeImage(); }
    </script>
</body>
</html>
        