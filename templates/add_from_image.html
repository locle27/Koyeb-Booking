<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√™m ƒê·∫∑t Ph√≤ng t·ª´ ·∫¢nh</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #0056b3; }
        #paste-area { border: 2px dashed #007bff; border-radius: 8px; padding: 40px; text-align: center; background-color: #f0f8ff; cursor: pointer; transition: background-color 0.3s; }
        #paste-area:hover { background-color: #e7f3ff; }
        #results-container { margin-top: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { color: #d9534f; background-color: #f2dede; border: 1px solid #ebccd1; padding: 15px; border-radius: 5px; margin-top: 15px; }
        .success-message { color: #28a745; background-color: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #e9ecef; }
        .save-button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
        .save-button:hover { background-color: #218838; }
        .header-container { text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 style="margin: 0; color: #0056b3;">üì∏ Th√™m ƒê·∫∑t Ph√≤ng t·ª´ ·∫¢nh</h1>
        </div>
        <p>D√°n (Ctrl+V) h√¨nh ·∫£nh ch·ª©a danh s√°ch ƒë·∫∑t ph√≤ng v√†o khu v·ª±c d∆∞·ªõi ƒë√¢y.</p>
        
        <div id="paste-area">
            <p>D√°n h√¨nh ·∫£nh v√†o ƒë√¢y</p>
        </div>

        <div id="results-container">
            <div id="spinner" class="spinner"></div>
            <div id="message-box"></div>
            <form id="save-form" action="/bookings/save_extracted" method="POST" style="display: none;">
                <input type="hidden" name="extracted_json" id="extracted_json_input">
                <div id="results-table"></div>
                <button type="submit" class="save-button">üíæ L∆∞u c√°c ƒë·∫∑t ph√≤ng h·ª£p l·ªá</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('paste', async (event) => {
            const pasteArea = document.getElementById('paste-area');
            const spinner = document.getElementById('spinner');
            const messageBox = document.getElementById('message-box');
            const saveForm = document.getElementById('save-form');
            const resultsTable = document.getElementById('results-table');

            // X√≥a k·∫øt qu·∫£ c≈©
            messageBox.innerHTML = '';
            resultsTable.innerHTML = '';
            saveForm.style.display = 'none';

            const items = (event.clipboardData || window.clipboardData).items;
            let imageFile = null;

            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    imageFile = item.getAsFile();
                    break;
                }
            }

            if (!imageFile) {
                messageBox.innerHTML = `<div class="error-message">L·ªói: D·ªØ li·ªáu d√°n v√†o kh√¥ng ph·∫£i l√† h√¨nh ·∫£nh.</div>`;
                return;
            }

            spinner.style.display = 'block';
            pasteArea.style.display = 'none';

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                
                try {
                    const response = await fetch('/api/process_pasted_image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image_b64: base64Image })
                    });

                    spinner.style.display = 'none';

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `L·ªói t·ª´ server: ${response.status} ${response.statusText}`);
                    }

                    const extractedData = await response.json();
                    console.log('Extracted data received:', extractedData); // Debug log

                    // === PH·∫¶N S·ª¨A L·ªñI QUAN TR·ªåNG NH·∫§T ===
                    // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p API tr·∫£ v·ªÅ object v·ªõi error message
                    if (extractedData && extractedData.error) {
                        messageBox.innerHTML = `<div class="error-message">L·ªói x·ª≠ l√Ω ·∫£nh: ${extractedData.error}</div>`;
                        pasteArea.style.display = 'block';
                        return;
                    }

                    // Lu√¥n ki·ªÉm tra d·ªØ li·ªáu tr·∫£ v·ªÅ c√≥ ph·∫£i l√† m·ªôt m·∫£ng (Array) hay kh√¥ng tr∆∞·ªõc khi d√πng .length
                    if (!extractedData || !Array.isArray(extractedData)) {
                        console.log('Invalid response format, trying to extract from object...');
                        
                        // Ki·ªÉm tra n·∫øu data ƒë∆∞·ª£c wrap trong object
                        let bookingsArray = null;
                        if (extractedData && typeof extractedData === 'object') {
                            // T√¨m array trong c√°c properties c·ªßa object
                            for (const key in extractedData) {
                                if (Array.isArray(extractedData[key])) {
                                    bookingsArray = extractedData[key];
                                    break;
                                }
                            }
                        }
                        
                        if (!bookingsArray || bookingsArray.length === 0) {
                            messageBox.innerHTML = `<div class="error-message">
                                Kh√¥ng t√¨m th·∫•y ƒë·∫∑t ph√≤ng n√†o trong ·∫£nh. Vui l√≤ng th·ª≠:
                                <ul style="margin-top: 10px;">
                                    <li>Ch·ª•p ·∫£nh r√µ n√©t h∆°n</li>
                                    <li>ƒê·∫£m b·∫£o vƒÉn b·∫£n trong ·∫£nh d·ªÖ ƒë·ªçc</li>
                                    <li>·∫¢nh ch·ª©a th√¥ng tin ƒë·∫∑t ph√≤ng ho√†n ch·ªânh</li>
                                </ul>
                            </div>`;
                            pasteArea.style.display = 'block';
                            return;
                        }
                        
                        // S·ª≠ d·ª•ng array t√¨m ƒë∆∞·ª£c
                        console.log('Found bookings array in object:', bookingsArray);
                        extractedData = bookingsArray;
                    }

                    if (extractedData.length === 0) {
                        messageBox.innerHTML = `<div class="error-message">Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng n√†o trong ·∫£nh n√†y.</div>`;
                        pasteArea.style.display = 'block';
                        return;
                    }

                    // Hi·ªÉn th·ªã k·∫øt qu·∫£ v·ªõi x·ª≠ l√Ω l·ªói t·ªët h∆°n
                    let tableHtml = '<table><thead><tr><th>T√™n kh√°ch</th><th>M√£ ƒë·∫∑t ph√≤ng</th><th>Ng√†y ƒë·∫øn</th><th>Ng√†y ƒëi</th><th>Lo·∫°i ph√≤ng</th><th>T·ªïng ti·ªÅn</th><th>Hoa h·ªìng</th><th>Tr·∫°ng th√°i</th></tr></thead><tbody>';
                    let validBookings = [];
                    let invalidCount = 0;

                    for (const booking of extractedData) {
                        // N·∫øu c√≥ l·ªói trong t·ª´ng booking, hi·ªÉn th·ªã l·ªói ƒë√≥
                        if (booking.error) {
                            invalidCount++;
                            tableHtml += `<tr style="background-color: #f8d7da;"><td colspan="8" class="error-message">‚ùå ${booking.error}</td></tr>`;
                            continue;
                        }
                        
                        // Validate required fields
                        const hasRequiredFields = booking.guest_name && 
                                                booking.check_in_date && 
                                                booking.check_out_date;
                        
                        if (!hasRequiredFields) {
                            invalidCount++;
                            tableHtml += `<tr style="background-color: #f8d7da;">
                                <td colspan="8" class="error-message">‚ùå Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc: ${booking.guest_name || 'T√™n kh√°ch'}</td>
                            </tr>`;
                            continue;
                        }
                        
                        validBookings.push(booking);
                        
                        // X·ª≠ l√Ω hoa h·ªìng
                        const commission = booking.commission || 0;
                        const commissionDisplay = commission > 0 ? commission.toLocaleString('vi-VN') + ' VND' : 'Ch∆∞a c√≥';
                        
                        tableHtml += `
                            <tr style="background-color: #d4edda;">
                                <td>${booking.guest_name || 'N/A'}</td>
                                <td>${booking.booking_id || 'T·ª± t·∫°o'}</td>
                                <td>${booking.check_in_date || 'N/A'}</td>
                                <td>${booking.check_out_date || 'N/A'}</td>
                                <td>${booking.room_type || 'N/A'}</td>
                                <td>${booking.total_payment ? booking.total_payment.toLocaleString('vi-VN') + ' VND' : 'N/A'}</td>
                                <td style="color: #e67e22; font-weight: bold;">${commissionDisplay}</td>
                                <td>‚úÖ H·ª£p l·ªá</td>
                            </tr>
                        `;
                    }
                    tableHtml += '</tbody></table>';
                    resultsTable.innerHTML = tableHtml;

                    // N·∫øu c√≥ booking h·ª£p l·ªá, hi·ªÉn th·ªã form l∆∞u
                    if (validBookings.length > 0) {
                        document.getElementById('extracted_json_input').value = JSON.stringify(validBookings);
                        saveForm.style.display = 'block';
                        
                        let successMessage = `‚úÖ ƒê√£ tr√≠ch xu·∫•t th√†nh c√¥ng ${validBookings.length} ƒë·∫∑t ph√≤ng h·ª£p l·ªá`;
                        if (invalidCount > 0) {
                            successMessage += ` (${invalidCount} m·ª•c kh√¥ng h·ª£p l·ªá)`;
                        }
                        successMessage += '. Ki·ªÉm tra th√¥ng tin v√† nh·∫•n L∆∞u.';
                        
                        messageBox.innerHTML = `<div class="success-message">${successMessage}</div>`;
                    } else {
                        let errorMessage = `‚ùå Kh√¥ng c√≥ ƒë·∫∑t ph√≤ng n√†o h·ª£p l·ªá ƒë·ªÉ l∆∞u`;
                        if (invalidCount > 0) {
                            errorMessage += ` (${invalidCount} m·ª•c kh√¥ng h·ª£p l·ªá)`;
                        }
                        errorMessage += `. Vui l√≤ng th·ª≠ v·ªõi ·∫£nh kh√°c ho·∫∑c ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng th√¥ng tin.`;
                        
                        messageBox.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                    }

                } catch (error) {
                    spinner.style.display = 'none';
                    messageBox.innerHTML = `<div class="error-message">L·ªói nghi√™m tr·ªçng: ${error.message}</div>`;
                    pasteArea.style.display = 'block';
                }
            };
            reader.readAsDataURL(imageFile);
        });
    </script>
</body>
</html>