<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√™m ƒê·∫∑t Ph√≤ng t·ª´ ·∫¢nh</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #0056b3; }
        #paste-area { border: 2px dashed #007bff; border-radius: 8px; padding: 40px; text-align: center; background-color: #f0f8ff; cursor: pointer; transition: background-color 0.3s; }
        #paste-area:hover { background-color: #e7f3ff; }
        #results-container { margin-top: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { color: #d9534f; background-color: #f2dede; border: 1px solid #ebccd1; padding: 15px; border-radius: 5px; margin-top: 15px; }
        .success-message { color: #28a745; background-color: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #e9ecef; }
        .save-button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
        .save-button:hover { background-color: #218838; }
        .header-container { text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <button onclick="goBack()" style="background-color: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    <span>‚Üê</span> Quay l·∫°i
                </button>
                <h1 style="margin: 0; color: #0056b3;">üì∏ Th√™m ƒê·∫∑t Ph√≤ng t·ª´ ·∫¢nh</h1>
                <div style="width: 100px;"></div> <!-- Spacer for center alignment -->
            </div>
        </div>
        <p>D√°n (Ctrl+V) h√¨nh ·∫£nh ch·ª©a danh s√°ch ƒë·∫∑t ph√≤ng v√†o khu v·ª±c d∆∞·ªõi ƒë√¢y.</p>
        
        <div id="paste-area">
            <p>üñºÔ∏è D√°n h√¨nh ·∫£nh v√†o ƒë√¢y (Ctrl+V)</p>
            <p style="margin-top: 10px; font-size: 14px; color: #666;">
                Ho·∫∑c <button type="button" id="file-select-btn" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">üìÅ Ch·ªçn file ·∫£nh</button>
            </p>
            <input type="file" id="file-input" accept="image/*" style="display: none;">
        </div>

        <div id="results-container">
            <div id="spinner" class="spinner"></div>
            <div id="message-box"></div>
            <form id="save-form" action="/bookings/save_extracted" method="POST" style="display: none;">
                <input type="hidden" name="extracted_json" id="extracted_json_input">
                <div id="results-table"></div>
                <button type="submit" class="save-button">üíæ L∆∞u c√°c ƒë·∫∑t ph√≤ng h·ª£p l·ªá</button>
            </form>
        </div>
    </div>

    <script>
        // Function to go back to previous page
        function goBack() {
            // Try to go back in browser history first
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // Fallback to bookings page if no history
                window.location.href = '/bookings';
            }
        }
        
        // Unified function to process image
        async function processImage(imageFile) {
            const pasteArea = document.getElementById('paste-area');
            const spinner = document.getElementById('spinner');
            const messageBox = document.getElementById('message-box');
            const saveForm = document.getElementById('save-form');
            const resultsTable = document.getElementById('results-table');

            // Clear previous results
            messageBox.innerHTML = '';
            resultsTable.innerHTML = '';
            saveForm.style.display = 'none';
            spinner.style.display = 'block';
            pasteArea.style.display = 'none';

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                
                try {
                    const response = await fetch('/api/process_pasted_image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image_b64: base64Image })
                    });

                    spinner.style.display = 'none';

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `L·ªói t·ª´ server: ${response.status} ${response.statusText}`);
                    }

                    let apiResponse = await response.json(); // ‚úÖ S·ª¨A: ƒë·ªïi const th√†nh let
                    console.log('API Response received:', apiResponse);

                    // === X·ª¨ L√ù DUPLICATE CHECK ===
                    let extractedData = apiResponse;
                    let duplicateCheck = null;
                    
                    // Ki·ªÉm tra n·∫øu API tr·∫£ v·ªÅ duplicate check
                    if (apiResponse && apiResponse.duplicate_check) {
                        duplicateCheck = apiResponse.duplicate_check;
                        extractedData = apiResponse.bookings || apiResponse;
                        
                        // ‚úÖ FIX: Ch·ªâ hi·ªÉn th·ªã duplicate warning n·∫øu th·ª±c s·ª± c√≥ duplicate
                        if (duplicateCheck.has_duplicates && duplicateCheck.duplicates && duplicateCheck.duplicates.length > 0) {
                            await showDuplicateWarning(duplicateCheck);
                            return;
                        }
                    }

                    console.log('üîç Raw API Response:', extractedData);
                    console.log('üîç ExtractedData type:', typeof extractedData, 'Array?', Array.isArray(extractedData));
                    
                    // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p API tr·∫£ v·ªÅ object v·ªõi error message
                    if (extractedData && extractedData.error) {
                        messageBox.innerHTML = `<div class="error-message">‚ùå L·ªói x·ª≠ l√Ω ·∫£nh: ${extractedData.error}</div>`;
                        pasteArea.style.display = 'block';
                        return;
                    }

                    // Ki·ªÉm tra v√† chu·∫©n h√≥a d·ªØ li·ªáu tr·∫£ v·ªÅ
                    let bookingsArray = null;
                    
                    if (Array.isArray(extractedData)) {
                        bookingsArray = extractedData;
                        console.log('‚úÖ Data is already an array:', bookingsArray);
                    } else if (extractedData && typeof extractedData === 'object') {
                        console.log('üîÑ Data is object, searching for bookings array...');
                        
                        // T√¨m array trong c√°c properties c·ªßa object
                        const possibleKeys = ['bookings', 'data', 'results', 'items'];
                        for (const key of possibleKeys) {
                            if (Array.isArray(extractedData[key])) {
                                bookingsArray = extractedData[key];
                                console.log(`‚úÖ Found bookings in property '${key}':`, bookingsArray);
                                break;
                            }
                        }
                        
                        // N·∫øu kh√¥ng t√¨m th·∫•y, t√¨m b·∫•t k·ª≥ array n√†o
                        if (!bookingsArray) {
                            for (const key in extractedData) {
                                if (Array.isArray(extractedData[key])) {
                                    bookingsArray = extractedData[key];
                                    console.log(`‚úÖ Found array in property '${key}':`, bookingsArray);
                                    break;
                                }
                            }
                        }
                        
                        // ‚úÖ FIX: Special case for duplicate check with clean bookings
                        if (!bookingsArray && duplicateCheck && duplicateCheck.clean_bookings) {
                            bookingsArray = duplicateCheck.clean_bookings;
                            console.log('‚úÖ Using clean_bookings from duplicate check:', bookingsArray);
                        }
                        
                        // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, th·ª≠ convert object th√†nh array
                        if (!bookingsArray && Object.keys(extractedData).length > 0) {
                            bookingsArray = [extractedData];
                            console.log('üîÑ Converting single object to array:', bookingsArray);
                        }
                    }
                    
                    // Ki·ªÉm tra k·∫øt qu·∫£ cu·ªëi c√πng
                    if (!bookingsArray || !Array.isArray(bookingsArray) || bookingsArray.length === 0) {
                        console.log('‚ùå No valid bookings found');
                        messageBox.innerHTML = `<div class="error-message">
                            ‚ùå Kh√¥ng t√¨m th·∫•y ƒë·∫∑t ph√≤ng n√†o trong ·∫£nh. Vui l√≤ng th·ª≠:
                            <ul style="margin-top: 10px;">
                                <li>üì∑ Ch·ª•p ·∫£nh r√µ n√©t h∆°n</li>
                                <li>üìù ƒê·∫£m b·∫£o vƒÉn b·∫£n trong ·∫£nh d·ªÖ ƒë·ªçc</li>
                                <li>üìã ·∫¢nh ch·ª©a th√¥ng tin ƒë·∫∑t ph√≤ng ho√†n ch·ªânh</li>
                                <li>üîç Th·ª≠ v·ªõi ·∫£nh kh√°c</li>
                            </ul>
                        </div>`;
                        pasteArea.style.display = 'block';
                        return;
                    }
                    
                    // ‚úÖ S·ª¨A: S·ª≠ d·ª•ng array ƒë√£ chu·∫©n h√≥a
                    extractedData = bookingsArray;
                    console.log(`‚úÖ Final bookings data (${extractedData.length} items):`, extractedData);

                    if (extractedData.length === 0) {
                        messageBox.innerHTML = `<div class="error-message">Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë·∫∑t ph√≤ng n√†o trong ·∫£nh n√†y.</div>`;
                        pasteArea.style.display = 'block';
                        return;
                    }

                    // Hi·ªÉn th·ªã k·∫øt qu·∫£ v·ªõi x·ª≠ l√Ω l·ªói t·ªët h∆°n
                    let tableHtml = '<table><thead><tr><th>T√™n kh√°ch</th><th>M√£ ƒë·∫∑t ph√≤ng</th><th>Ng√†y ƒë·∫øn</th><th>Ng√†y ƒëi</th><th>Lo·∫°i ph√≤ng</th><th>T·ªïng ti·ªÅn</th><th>Hoa h·ªìng</th><th>Tr·∫°ng th√°i</th></tr></thead><tbody>';
                    let validBookings = [];
                    let invalidCount = 0;

                    for (const booking of extractedData) {
                        console.log('üîç Processing booking:', booking);
                        
                        // N·∫øu c√≥ l·ªói trong t·ª´ng booking, hi·ªÉn th·ªã l·ªói ƒë√≥
                        if (booking.error) {
                            invalidCount++;
                            tableHtml += `<tr style="background-color: #f8d7da;"><td colspan="8" class="error-message">‚ùå ${booking.error}</td></tr>`;
                            continue;
                        }
                        
                        // Validate required fields v·ªõi th√¥ng b√°o c·ª• th·ªÉ h∆°n
                        const hasGuestName = booking.guest_name && booking.guest_name.trim() !== '';
                        const hasCheckinDate = booking.check_in_date && booking.check_in_date.trim() !== '';
                        const hasCheckoutDate = booking.check_out_date && booking.check_out_date.trim() !== '';
                        
                        if (!hasGuestName || !hasCheckinDate || !hasCheckoutDate) {
                            invalidCount++;
                            const missingFields = [];
                            if (!hasGuestName) missingFields.push('üë§ T√™n kh√°ch');
                            if (!hasCheckinDate) missingFields.push('üìÖ Ng√†y ƒë·∫øn');
                            if (!hasCheckoutDate) missingFields.push('üìÖ Ng√†y ƒëi');
                            
                            tableHtml += `<tr style="background-color: #f8d7da;">
                                <td colspan="8" class="error-message">‚ùå Thi·∫øu th√¥ng tin: ${missingFields.join(', ')}</td>
                            </tr>`;
                            continue;
                        }
                        
                        // Booking h·ª£p l·ªá
                        validBookings.push(booking);
                        
                        // X·ª≠ l√Ω hoa h·ªìng an to√†n
                        const commission = booking.commission || 0;
                        const commissionDisplay = commission > 0 ? 
                            `üí∞ ${commission.toLocaleString('vi-VN')} VND` : '‚ûñ Ch∆∞a c√≥';
                        
                        // X·ª≠ l√Ω t·ªïng ti·ªÅn an to√†n
                        const totalPayment = booking.total_payment || 0;
                        const totalPaymentDisplay = totalPayment > 0 ?
                            `üí∏ ${totalPayment.toLocaleString('vi-VN')} VND` : '‚ûñ Ch∆∞a c√≥';
                        
                        tableHtml += `
                            <tr style="background-color: #d4edda;">
                                <td>üë§ ${booking.guest_name || 'N/A'}</td>
                                <td>üè∑Ô∏è ${booking.booking_id || 'T·ª± t·∫°o'}</td>
                                <td>üìÖ ${booking.check_in_date || 'N/A'}</td>
                                <td>üìÖ ${booking.check_out_date || 'N/A'}</td>
                                <td>üè† ${booking.room_type || 'N/A'}</td>
                                <td style="font-weight: bold;">${totalPaymentDisplay}</td>
                                <td style="color: #e67e22; font-weight: bold;">${commissionDisplay}</td>
                                <td>‚úÖ H·ª£p l·ªá</td>
                            </tr>
                        `;
                    }
                    tableHtml += '</tbody></table>';
                    resultsTable.innerHTML = tableHtml;

                    // N·∫øu c√≥ booking h·ª£p l·ªá, hi·ªÉn th·ªã form l∆∞u
                    if (validBookings.length > 0) {
                        document.getElementById('extracted_json_input').value = JSON.stringify(validBookings);
                        saveForm.style.display = 'block';
                        
                        let successMessage = `üéâ ƒê√£ tr√≠ch xu·∫•t th√†nh c√¥ng <strong>${validBookings.length}</strong> ƒë·∫∑t ph√≤ng h·ª£p l·ªá`;
                        if (invalidCount > 0) {
                            successMessage += ` (‚ö†Ô∏è ${invalidCount} m·ª•c kh√¥ng h·ª£p l·ªá)`;
                        }
                        successMessage += '.<br>üìã Ki·ªÉm tra th√¥ng tin v√† nh·∫•n <strong>üíæ L∆∞u</strong> ƒë·ªÉ th√™m v√†o h·ªá th·ªëng.';
                        
                        messageBox.innerHTML = `<div class="success-message">${successMessage}</div>`;
                        
                        // Scroll to results ƒë·ªÉ user d·ªÖ th·∫•y
                        resultsTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        let errorMessage = `‚ùå Kh√¥ng c√≥ ƒë·∫∑t ph√≤ng n√†o h·ª£p l·ªá ƒë·ªÉ l∆∞u`;
                        if (invalidCount > 0) {
                            errorMessage += ` (üîç ƒê√£ t√¨m th·∫•y ${invalidCount} m·ª•c nh∆∞ng thi·∫øu th√¥ng tin quan tr·ªçng)`;
                        }
                        errorMessage += `.<br><br>üí° <strong>G·ª£i √Ω kh·∫Øc ph·ª•c:</strong>
                            <ul style="margin-top: 8px; text-align: left;">
                                <li>üì∏ Ch·ª•p ·∫£nh r√µ n√©t v√† ƒë·ªß s√°ng</li>
                                <li>üìã ƒê·∫£m b·∫£o ·∫£nh c√≥ ƒë·∫ßy ƒë·ªß: T√™n kh√°ch, Ng√†y ƒë·∫øn, Ng√†y ƒëi</li>
                                <li>üî§ VƒÉn b·∫£n trong ·∫£nh d·ªÖ ƒë·ªçc, kh√¥ng b·ªã che khu·∫•t</li>
                                <li>üîÑ Th·ª≠ ch·ª•p ·∫£nh kh√°c ho·∫∑c screenshot t·ª´ m√†n h√¨nh</li>
                            </ul>`;
                        
                        messageBox.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                    }

                } catch (error) {
                    spinner.style.display = 'none';
                    messageBox.innerHTML = `<div class="error-message">L·ªói nghi√™m tr·ªçng: ${error.message}</div>`;
                    pasteArea.style.display = 'block';
                }
            };
            reader.readAsDataURL(imageFile);
        }

        // Paste event handler
        document.addEventListener('paste', async (event) => {
            const items = (event.clipboardData || window.clipboardData).items;
            let imageFile = null;

            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    imageFile = item.getAsFile();
                    break;
                }
            }

            if (!imageFile) {
                document.getElementById('message-box').innerHTML = `<div class="error-message">‚ùå D·ªØ li·ªáu d√°n v√†o kh√¥ng ph·∫£i l√† h√¨nh ·∫£nh. Vui l√≤ng copy ·∫£nh v√† th·ª≠ l·∫°i.</div>`;
                return;
            }

            await processImage(imageFile);
        });

        // File input event handler
        document.addEventListener('DOMContentLoaded', function() {
            const fileSelectBtn = document.getElementById('file-select-btn');
            const fileInput = document.getElementById('file-input');

            fileSelectBtn.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', async function(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    await processImage(file);
                } else {
                    document.getElementById('message-box').innerHTML = `<div class="error-message">‚ùå Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá (PNG, JPG, JPEG).</div>`;
                }
            });
        });

        // === DUPLICATE WARNING FUNCTIONS ===
        async function showDuplicateWarning(duplicateCheck) {
            const messageBox = document.getElementById('message-box');
            const resultsTable = document.getElementById('results-table');
            const saveForm = document.getElementById('save-form');
            const pasteArea = document.getElementById('paste-area');
            
            // Hide paste area and show duplicate warning
            pasteArea.style.display = 'none';
            saveForm.style.display = 'none';
            
            let warningHtml = `
                <div class="error-message" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%); color: white; border: none;">
                    <h4><i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è Ph√°t hi·ªán kh√°ch tr√πng l·∫∑p!</h4>
                    <p>T√¨m th·∫•y <strong>${duplicateCheck.duplicates.length}</strong> kh√°ch c√≥ th·ªÉ ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng:</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <h5>üîç Danh s√°ch kh√°ch tr√πng l·∫∑p:</h5>
            `;
            
            duplicateCheck.duplicates.forEach((dup, index) => {
                const newBooking = dup.new_booking;
                const existingBooking = dup.existing_booking;
                
                warningHtml += `
                    <div style="border: 2px solid #ff9500; border-radius: 8px; padding: 15px; margin: 10px 0; background: #fff3e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong style="color: #e65100;">Kh√°ch #${index + 1}: ${newBooking.guest_name}</strong>
                            <div>
                                <button class="btn btn-success btn-sm me-2" onclick="keepNewBooking(${index})" 
                                        style="background: #4caf50; color: white; border: none; padding: 5px 10px; border-radius: 4px;">
                                    ‚úÖ Gi·ªØ booking m·ªõi
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="skipDuplicateBooking(${index})"
                                        style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px;">
                                    ‚ùå B·ªè qua (c√≥ th·ªÉ tr√πng)
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="border: 2px solid #4caf50; border-radius: 6px; padding: 10px;">
                                <h6 style="color: #2e7d32; margin-bottom: 8px;">üìù Booking M·ªöI (t·ª´ ·∫£nh)</h6>
                                <div><strong>T√™n:</strong> ${newBooking.guest_name}</div>
                                <div><strong>Check-in:</strong> ${newBooking.check_in_date}</div>
                                <div><strong>Check-out:</strong> ${newBooking.check_out_date}</div>
                                <div><strong>Ph√≤ng:</strong> ${newBooking.room_type || 'N/A'}</div>
                                <div><strong>T·ªïng ti·ªÅn:</strong> ${newBooking.total_payment ? newBooking.total_payment.toLocaleString() + 'ƒë' : 'N/A'}</div>
                            </div>
                            
                            <div style="border: 2px solid #ff5722; border-radius: 6px; padding: 10px;">
                                <h6 style="color: #d84315; margin-bottom: 8px;">üóÉÔ∏è Booking HI·ªÜN T·∫†I (trong h·ªá th·ªëng)</h6>
                                <div><strong>ID:</strong> ${existingBooking.booking_id}</div>
                                <div><strong>T√™n:</strong> ${existingBooking.guest_name}</div>
                                <div><strong>Check-in:</strong> ${existingBooking.check_in_date}</div>
                                <div><strong>Check-out:</strong> ${existingBooking.check_out_date}</div>
                                <div><strong>T·ªïng ti·ªÅn:</strong> ${existingBooking.total_payment ? existingBooking.total_payment.toLocaleString() + 'ƒë' : 'N/A'}</div>
                                <div><strong>Tr·∫°ng th√°i:</strong> <span style="color: ${existingBooking.status === 'OK' ? '#4caf50' : '#f44336'};">${existingBooking.status}</span></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            warningHtml += `
                </div>
                
                <div style="background: #e3f2fd; border-radius: 8px; padding: 15px; margin: 20px 0;">
                    <h6 style="color: #1976d2; margin-bottom: 10px;">üí° H∆∞·ªõng d·∫´n:</h6>
                    <ul style="color: #424242; margin: 0;">
                        <li><strong>‚úÖ Gi·ªØ booking m·ªõi:</strong> N·∫øu ƒë√¢y l√† booking kh√°c (c√πng t√™n nh∆∞ng kh√°c th·ªùi gian/ph√≤ng)</li>
                        <li><strong>‚ùå B·ªè qua:</strong> N·∫øu ƒë√¢y l√† booking tr√πng l·∫∑p (c√πng kh√°ch, c√πng th·ªùi gian)</li>
                        <li><strong>üîç So s√°nh k·ªπ:</strong> Ng√†y check-in, ph√≤ng, t·ªïng ti·ªÅn ƒë·ªÉ quy·∫øt ƒë·ªãnh ch√≠nh x√°c</li>
                    </ul>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="processAfterDuplicateCheck()"
                            style="background: #2196f3; color: white; border: none; padding: 12px 25px; border-radius: 6px; font-size: 16px;">
                        üîÑ X·ª≠ l√Ω booking ƒë√£ ch·ªçn
                    </button>
                    <button class="btn btn-secondary" onclick="resetForm()"
                            style="background: #757575; color: white; border: none; padding: 12px 25px; border-radius: 6px; font-size: 16px; margin-left: 10px;">
                        üîô Quay l·∫°i
                    </button>
                </div>
            `;
            
            messageBox.innerHTML = warningHtml;
            
            // Store duplicate data globally for later processing
            window.duplicateCheckData = duplicateCheck;
            window.selectedBookings = [...duplicateCheck.clean_bookings]; // Start with non-duplicate bookings
        }
        
        function keepNewBooking(index) {
            const duplicate = window.duplicateCheckData.duplicates[index];
            window.selectedBookings.push(duplicate.new_booking);
            
            // Update UI to show selection
            const button = event.target;
            button.style.background = '#4caf50';
            button.innerHTML = '‚úÖ ƒê√£ ch·ªçn';
            button.disabled = true;
            
            // Disable other button
            const skipButton = button.nextElementSibling;
            skipButton.style.background = '#ccc';
            skipButton.disabled = true;
        }
        
        function skipDuplicateBooking(index) {
            // Don't add to selected bookings
            
            // Update UI to show selection
            const button = event.target;
            button.style.background = '#f44336';
            button.innerHTML = '‚ùå ƒê√£ b·ªè qua';
            button.disabled = true;
            
            // Disable other button
            const keepButton = button.previousElementSibling;
            keepButton.style.background = '#ccc';
            keepButton.disabled = true;
        }
        
        function processAfterDuplicateCheck() {
            if (!window.selectedBookings || window.selectedBookings.length === 0) {
                alert('‚ùå Kh√¥ng c√≥ booking n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ x·ª≠ l√Ω!');
                return;
            }
            
            // Process selected bookings as normal
            processSelectedBookings(window.selectedBookings);
        }
        
        function processSelectedBookings(bookings) {
            const messageBox = document.getElementById('message-box');
            const resultsTable = document.getElementById('results-table');
            const saveForm = document.getElementById('save-form');
            
            // Build results table
            let tableHtml = '<table><thead><tr><th>T√™n kh√°ch</th><th>M√£ ƒë·∫∑t ph√≤ng</th><th>Ng√†y ƒë·∫øn</th><th>Ng√†y ƒëi</th><th>Lo·∫°i ph√≤ng</th><th>T·ªïng ti·ªÅn</th><th>Hoa h·ªìng</th><th>Tr·∫°ng th√°i</th></tr></thead><tbody>';
            
            bookings.forEach((booking) => {
                const commission = booking.commission || 0;
                const commissionDisplay = commission > 0 ? 
                    `üí∞ ${commission.toLocaleString('vi-VN')} VND` : '‚ûñ Ch∆∞a c√≥';
                
                const totalPayment = booking.total_payment || 0;
                const totalPaymentDisplay = totalPayment > 0 ?
                    `üí∏ ${totalPayment.toLocaleString('vi-VN')} VND` : '‚ûñ Ch∆∞a c√≥';
                
                tableHtml += `
                    <tr style="background-color: #d4edda;">
                        <td>üë§ ${booking.guest_name || 'N/A'}</td>
                        <td>üè∑Ô∏è ${booking.booking_id || 'T·ª± t·∫°o'}</td>
                        <td>üìÖ ${booking.check_in_date || 'N/A'}</td>
                        <td>üìÖ ${booking.check_out_date || 'N/A'}</td>
                        <td>üè† ${booking.room_type || 'N/A'}</td>
                        <td style="font-weight: bold;">${totalPaymentDisplay}</td>
                        <td style="color: #e67e22; font-weight: bold;">${commissionDisplay}</td>
                        <td>‚úÖ H·ª£p l·ªá</td>
                    </tr>
                `;
            });
            tableHtml += '</tbody></table>';
            resultsTable.innerHTML = tableHtml;
            
            // Set up save form
            document.getElementById('extracted_json_input').value = JSON.stringify(bookings);
            saveForm.style.display = 'block';
            
            messageBox.innerHTML = `<div class="success-message">üéâ ƒê√£ x·ª≠ l√Ω xong duplicate check! T√¨m th·∫•y <strong>${bookings.length}</strong> booking h·ª£p l·ªá ƒë·ªÉ l∆∞u.</div>`;
            
            // Scroll to results
            resultsTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function resetForm() {
            location.reload();
        }
    </script>
</body>
</html>