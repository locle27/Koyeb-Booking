<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThÃªm Äáº·t PhÃ²ng tá»« áº¢nh</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 20px; background-color: #f8f9fa; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #0056b3; }
        #paste-area { border: 2px dashed #007bff; border-radius: 8px; padding: 40px; text-align: center; background-color: #f0f8ff; cursor: pointer; transition: background-color 0.3s; }
        #paste-area:hover { background-color: #e7f3ff; }
        #results-container { margin-top: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message { color: #d9534f; background-color: #f2dede; border: 1px solid #ebccd1; padding: 15px; border-radius: 5px; margin-top: 15px; }
        .success-message { color: #28a745; background-color: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 5px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #e9ecef; }
        .save-button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
        .save-button:hover { background-color: #218838; }
        .header-container { text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 style="margin: 0; color: #0056b3;">ğŸ“¸ ThÃªm Äáº·t PhÃ²ng tá»« áº¢nh</h1>
        </div>
        <p>DÃ¡n (Ctrl+V) hÃ¬nh áº£nh chá»©a danh sÃ¡ch Ä‘áº·t phÃ²ng vÃ o khu vá»±c dÆ°á»›i Ä‘Ã¢y.</p>
        
        <div id="paste-area">
            <p>ğŸ–¼ï¸ DÃ¡n hÃ¬nh áº£nh vÃ o Ä‘Ã¢y (Ctrl+V)</p>
            <p style="margin-top: 10px; font-size: 14px; color: #666;">
                Hoáº·c <button type="button" id="file-select-btn" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">ğŸ“ Chá»n file áº£nh</button>
            </p>
            <input type="file" id="file-input" accept="image/*" style="display: none;">
        </div>

        <div id="results-container">
            <div id="spinner" class="spinner"></div>
            <div id="message-box"></div>
            <form id="save-form" action="/bookings/save_extracted" method="POST" style="display: none;">
                <input type="hidden" name="extracted_json" id="extracted_json_input">
                <div id="results-table"></div>
                <button type="submit" class="save-button">ğŸ’¾ LÆ°u cÃ¡c Ä‘áº·t phÃ²ng há»£p lá»‡</button>
            </form>
        </div>
    </div>

    <script>
        // Unified function to process image
        async function processImage(imageFile) {
            const pasteArea = document.getElementById('paste-area');
            const spinner = document.getElementById('spinner');
            const messageBox = document.getElementById('message-box');
            const saveForm = document.getElementById('save-form');
            const resultsTable = document.getElementById('results-table');

            // Clear previous results
            messageBox.innerHTML = '';
            resultsTable.innerHTML = '';
            saveForm.style.display = 'none';
            spinner.style.display = 'block';
            pasteArea.style.display = 'none';

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Image = e.target.result;
                
                try {
                    const response = await fetch('/api/process_pasted_image', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image_b64: base64Image })
                    });

                    spinner.style.display = 'none';

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Lá»—i tá»« server: ${response.status} ${response.statusText}`);
                    }

                    let extractedData = await response.json(); // âœ… Sá»¬A: Ä‘á»•i const thÃ nh let
                    console.log('Extracted data received:', extractedData);

                    // === PHáº¦N Sá»¬A Lá»–I QUAN TRá»ŒNG NHáº¤T ===
                    console.log('ğŸ” Raw API Response:', extractedData);
                    
                    // Xá»­ lÃ½ trÆ°á»ng há»£p API tráº£ vá» object vá»›i error message
                    if (extractedData && extractedData.error) {
                        messageBox.innerHTML = `<div class="error-message">âŒ Lá»—i xá»­ lÃ½ áº£nh: ${extractedData.error}</div>`;
                        pasteArea.style.display = 'block';
                        return;
                    }

                    // Kiá»ƒm tra vÃ  chuáº©n hÃ³a dá»¯ liá»‡u tráº£ vá»
                    let bookingsArray = null;
                    
                    if (Array.isArray(extractedData)) {
                        bookingsArray = extractedData;
                        console.log('âœ… Data is already an array:', bookingsArray);
                    } else if (extractedData && typeof extractedData === 'object') {
                        console.log('ğŸ”„ Data is object, searching for bookings array...');
                        
                        // TÃ¬m array trong cÃ¡c properties cá»§a object
                        const possibleKeys = ['bookings', 'data', 'results', 'items'];
                        for (const key of possibleKeys) {
                            if (Array.isArray(extractedData[key])) {
                                bookingsArray = extractedData[key];
                                console.log(`âœ… Found bookings in property '${key}':`, bookingsArray);
                                break;
                            }
                        }
                        
                        // Náº¿u khÃ´ng tÃ¬m tháº¥y, tÃ¬m báº¥t ká»³ array nÃ o
                        if (!bookingsArray) {
                            for (const key in extractedData) {
                                if (Array.isArray(extractedData[key])) {
                                    bookingsArray = extractedData[key];
                                    console.log(`âœ… Found array in property '${key}':`, bookingsArray);
                                    break;
                                }
                            }
                        }
                        
                        // Náº¿u váº«n khÃ´ng tÃ¬m tháº¥y, thá»­ convert object thÃ nh array
                        if (!bookingsArray && Object.keys(extractedData).length > 0) {
                            bookingsArray = [extractedData];
                            console.log('ğŸ”„ Converting single object to array:', bookingsArray);
                        }
                    }
                    
                    // Kiá»ƒm tra káº¿t quáº£ cuá»‘i cÃ¹ng
                    if (!bookingsArray || !Array.isArray(bookingsArray) || bookingsArray.length === 0) {
                        console.log('âŒ No valid bookings found');
                        messageBox.innerHTML = `<div class="error-message">
                            âŒ KhÃ´ng tÃ¬m tháº¥y Ä‘áº·t phÃ²ng nÃ o trong áº£nh. Vui lÃ²ng thá»­:
                            <ul style="margin-top: 10px;">
                                <li>ğŸ“· Chá»¥p áº£nh rÃµ nÃ©t hÆ¡n</li>
                                <li>ğŸ“ Äáº£m báº£o vÄƒn báº£n trong áº£nh dá»… Ä‘á»c</li>
                                <li>ğŸ“‹ áº¢nh chá»©a thÃ´ng tin Ä‘áº·t phÃ²ng hoÃ n chá»‰nh</li>
                                <li>ğŸ” Thá»­ vá»›i áº£nh khÃ¡c</li>
                            </ul>
                        </div>`;
                        pasteArea.style.display = 'block';
                        return;
                    }
                    
                    // âœ… Sá»¬A: Sá»­ dá»¥ng array Ä‘Ã£ chuáº©n hÃ³a
                    extractedData = bookingsArray;
                    console.log(`âœ… Final bookings data (${extractedData.length} items):`, extractedData);

                    if (extractedData.length === 0) {
                        messageBox.innerHTML = `<div class="error-message">KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin Ä‘áº·t phÃ²ng nÃ o trong áº£nh nÃ y.</div>`;
                        pasteArea.style.display = 'block';
                        return;
                    }

                    // Hiá»ƒn thá»‹ káº¿t quáº£ vá»›i xá»­ lÃ½ lá»—i tá»‘t hÆ¡n
                    let tableHtml = '<table><thead><tr><th>TÃªn khÃ¡ch</th><th>MÃ£ Ä‘áº·t phÃ²ng</th><th>NgÃ y Ä‘áº¿n</th><th>NgÃ y Ä‘i</th><th>Loáº¡i phÃ²ng</th><th>Tá»•ng tiá»n</th><th>Hoa há»“ng</th><th>Tráº¡ng thÃ¡i</th></tr></thead><tbody>';
                    let validBookings = [];
                    let invalidCount = 0;

                    for (const booking of extractedData) {
                        console.log('ğŸ” Processing booking:', booking);
                        
                        // Náº¿u cÃ³ lá»—i trong tá»«ng booking, hiá»ƒn thá»‹ lá»—i Ä‘Ã³
                        if (booking.error) {
                            invalidCount++;
                            tableHtml += `<tr style="background-color: #f8d7da;"><td colspan="8" class="error-message">âŒ ${booking.error}</td></tr>`;
                            continue;
                        }
                        
                        // Validate required fields vá»›i thÃ´ng bÃ¡o cá»¥ thá»ƒ hÆ¡n
                        const hasGuestName = booking.guest_name && booking.guest_name.trim() !== '';
                        const hasCheckinDate = booking.check_in_date && booking.check_in_date.trim() !== '';
                        const hasCheckoutDate = booking.check_out_date && booking.check_out_date.trim() !== '';
                        
                        if (!hasGuestName || !hasCheckinDate || !hasCheckoutDate) {
                            invalidCount++;
                            const missingFields = [];
                            if (!hasGuestName) missingFields.push('ğŸ‘¤ TÃªn khÃ¡ch');
                            if (!hasCheckinDate) missingFields.push('ğŸ“… NgÃ y Ä‘áº¿n');
                            if (!hasCheckoutDate) missingFields.push('ğŸ“… NgÃ y Ä‘i');
                            
                            tableHtml += `<tr style="background-color: #f8d7da;">
                                <td colspan="8" class="error-message">âŒ Thiáº¿u thÃ´ng tin: ${missingFields.join(', ')}</td>
                            </tr>`;
                            continue;
                        }
                        
                        // Booking há»£p lá»‡
                        validBookings.push(booking);
                        
                        // Xá»­ lÃ½ hoa há»“ng an toÃ n
                        const commission = booking.commission || 0;
                        const commissionDisplay = commission > 0 ? 
                            `ğŸ’° ${commission.toLocaleString('vi-VN')} VND` : 'â– ChÆ°a cÃ³';
                        
                        // Xá»­ lÃ½ tá»•ng tiá»n an toÃ n
                        const totalPayment = booking.total_payment || 0;
                        const totalPaymentDisplay = totalPayment > 0 ?
                            `ğŸ’¸ ${totalPayment.toLocaleString('vi-VN')} VND` : 'â– ChÆ°a cÃ³';
                        
                        tableHtml += `
                            <tr style="background-color: #d4edda;">
                                <td>ğŸ‘¤ ${booking.guest_name || 'N/A'}</td>
                                <td>ğŸ·ï¸ ${booking.booking_id || 'Tá»± táº¡o'}</td>
                                <td>ğŸ“… ${booking.check_in_date || 'N/A'}</td>
                                <td>ğŸ“… ${booking.check_out_date || 'N/A'}</td>
                                <td>ğŸ  ${booking.room_type || 'N/A'}</td>
                                <td style="font-weight: bold;">${totalPaymentDisplay}</td>
                                <td style="color: #e67e22; font-weight: bold;">${commissionDisplay}</td>
                                <td>âœ… Há»£p lá»‡</td>
                            </tr>
                        `;
                    }
                    tableHtml += '</tbody></table>';
                    resultsTable.innerHTML = tableHtml;

                    // Náº¿u cÃ³ booking há»£p lá»‡, hiá»ƒn thá»‹ form lÆ°u
                    if (validBookings.length > 0) {
                        document.getElementById('extracted_json_input').value = JSON.stringify(validBookings);
                        saveForm.style.display = 'block';
                        
                        let successMessage = `ğŸ‰ ÄÃ£ trÃ­ch xuáº¥t thÃ nh cÃ´ng <strong>${validBookings.length}</strong> Ä‘áº·t phÃ²ng há»£p lá»‡`;
                        if (invalidCount > 0) {
                            successMessage += ` (âš ï¸ ${invalidCount} má»¥c khÃ´ng há»£p lá»‡)`;
                        }
                        successMessage += '.<br>ğŸ“‹ Kiá»ƒm tra thÃ´ng tin vÃ  nháº¥n <strong>ğŸ’¾ LÆ°u</strong> Ä‘á»ƒ thÃªm vÃ o há»‡ thá»‘ng.';
                        
                        messageBox.innerHTML = `<div class="success-message">${successMessage}</div>`;
                        
                        // Scroll to results Ä‘á»ƒ user dá»… tháº¥y
                        resultsTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        let errorMessage = `âŒ KhÃ´ng cÃ³ Ä‘áº·t phÃ²ng nÃ o há»£p lá»‡ Ä‘á»ƒ lÆ°u`;
                        if (invalidCount > 0) {
                            errorMessage += ` (ğŸ” ÄÃ£ tÃ¬m tháº¥y ${invalidCount} má»¥c nhÆ°ng thiáº¿u thÃ´ng tin quan trá»ng)`;
                        }
                        errorMessage += `.<br><br>ğŸ’¡ <strong>Gá»£i Ã½ kháº¯c phá»¥c:</strong>
                            <ul style="margin-top: 8px; text-align: left;">
                                <li>ğŸ“¸ Chá»¥p áº£nh rÃµ nÃ©t vÃ  Ä‘á»§ sÃ¡ng</li>
                                <li>ğŸ“‹ Äáº£m báº£o áº£nh cÃ³ Ä‘áº§y Ä‘á»§: TÃªn khÃ¡ch, NgÃ y Ä‘áº¿n, NgÃ y Ä‘i</li>
                                <li>ğŸ”¤ VÄƒn báº£n trong áº£nh dá»… Ä‘á»c, khÃ´ng bá»‹ che khuáº¥t</li>
                                <li>ğŸ”„ Thá»­ chá»¥p áº£nh khÃ¡c hoáº·c screenshot tá»« mÃ n hÃ¬nh</li>
                            </ul>`;
                        
                        messageBox.innerHTML = `<div class="error-message">${errorMessage}</div>`;
                    }

                } catch (error) {
                    spinner.style.display = 'none';
                    messageBox.innerHTML = `<div class="error-message">Lá»—i nghiÃªm trá»ng: ${error.message}</div>`;
                    pasteArea.style.display = 'block';
                }
            };
            reader.readAsDataURL(imageFile);
        }

        // Paste event handler
        document.addEventListener('paste', async (event) => {
            const items = (event.clipboardData || window.clipboardData).items;
            let imageFile = null;

            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    imageFile = item.getAsFile();
                    break;
                }
            }

            if (!imageFile) {
                document.getElementById('message-box').innerHTML = `<div class="error-message">âŒ Dá»¯ liá»‡u dÃ¡n vÃ o khÃ´ng pháº£i lÃ  hÃ¬nh áº£nh. Vui lÃ²ng copy áº£nh vÃ  thá»­ láº¡i.</div>`;
                return;
            }

            await processImage(imageFile);
        });

        // File input event handler
        document.addEventListener('DOMContentLoaded', function() {
            const fileSelectBtn = document.getElementById('file-select-btn');
            const fileInput = document.getElementById('file-input');

            fileSelectBtn.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', async function(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    await processImage(file);
                } else {
                    document.getElementById('message-box').innerHTML = `<div class="error-message">âŒ Vui lÃ²ng chá»n file áº£nh há»£p lá»‡ (PNG, JPG, JPEG).</div>`;
                }
            });
        });
    </script>
</body>
</html>