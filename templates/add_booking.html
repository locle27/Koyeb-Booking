{% extends "base.html" %}
{% block title %}ThÃªm Äáº·t phÃ²ng{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-plus-circle me-2"></i>ThÃªm Äáº·t phÃ²ng <small class="text-muted">Manual + Photo</small></h1>

<!-- Duplicate Warning Modal -->
{% if duplicate_warning %}
<div class="alert alert-warning border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%); color: white;">
    <h4 class="alert-heading">
        <i class="fas fa-exclamation-triangle me-2"></i>âš ï¸ PhÃ¡t hiá»‡n khÃ¡ch cÃ³ thá»ƒ trÃ¹ng láº·p!
    </h4>
    
    {% for duplicate in duplicate_warning.duplicates %}
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="card bg-white bg-opacity-20 border-0">
                <div class="card-body">
                    <h6 class="text-white">ğŸ“ Booking Má»šI (Ä‘ang thÃªm)</h6>
                    <div class="text-white-75">
                        <strong>TÃªn:</strong> {{ duplicate.new_booking.guest_name }}<br>
                        <strong>Check-in:</strong> {{ duplicate.new_booking.check_in_date }}<br>
                        <strong>Check-out:</strong> {{ duplicate.new_booking.check_out_date }}<br>
                        <strong>PhÃ²ng:</strong> {{ duplicate.new_booking.room_type }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-white bg-opacity-20 border-0">
                <div class="card-body">
                    <h6 class="text-white">ğŸ—ƒï¸ Booking HIá»†N Táº I (trong há»‡ thá»‘ng)</h6>
                    <div class="text-white-75">
                        <strong>ID:</strong> {{ duplicate.existing_booking.booking_id }}<br>
                        <strong>TÃªn:</strong> {{ duplicate.existing_booking.guest_name }}<br>
                        <strong>Check-in:</strong> {{ duplicate.existing_booking.check_in_date }}<br>
                        <strong>Check-out:</strong> {{ duplicate.existing_booking.check_out_date }}<br>
                        <strong>Tráº¡ng thÃ¡i:</strong> {{ duplicate.existing_booking.status }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <div class="mt-3">
        <h6>ğŸ’¡ Lá»±a chá»n cá»§a báº¡n:</h6>
        <div class="d-flex gap-3">
            <form method="POST" action="{{ url_for('add_booking') }}" style="display: inline;">
                {% for key, value in form_data.items() %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endfor %}
                <input type="hidden" name="force_add" value="1">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>âœ… Váº«n thÃªm booking má»›i
                </button>
            </form>
            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                <i class="fas fa-times me-1"></i>âŒ Há»§y vÃ  kiá»ƒm tra láº¡i
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Photo Upload Section -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
        <h6 class="mb-0 text-white fw-bold"><i class="fas fa-camera me-2"></i><span class="text-white">ğŸ“¸ ThÃªm tá»« áº¢nh (TÃ¹y chá»n)</span></h6>
    </div>
    <div class="card-body">
        <div id="photo-upload-area" class="border-2 border-dashed border-primary rounded p-4 text-center" style="cursor: pointer; background-color: #f8f9ff;">
            <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
            <p class="mb-2">DÃ¡n áº£nh (Ctrl+V) hoáº·c click Ä‘á»ƒ chá»n file</p>
            <small class="text-muted">AI sáº½ tá»± Ä‘á»™ng Ä‘iá»n thÃ´ng tin tá»« áº£nh</small>
            <input type="file" id="photo-input" accept="image/*" style="display: none;">
        </div>
        <div id="photo-processing" class="mt-3" style="display: none;">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                <small class="text-primary">AI Ä‘ang xá»­ lÃ½ áº£nh...</small>
            </div>
        </div>
    </div>
</div>

<form method="POST" action="{{ url_for('add_booking') }}">
    <div class="row g-3">
        <!-- Essential Information -->
        <div class="col-md-8">
            <label for="TÃªn ngÆ°á»i Ä‘áº·t" class="form-label"><i class="fas fa-user me-1"></i>TÃªn ngÆ°á»i Ä‘áº·t *</label>
            <input type="text" class="form-control" id="TÃªn ngÆ°á»i Ä‘áº·t" name="TÃªn ngÆ°á»i Ä‘áº·t" 
                   value="{{ form_data.get('TÃªn ngÆ°á»i Ä‘áº·t', '') if form_data else '' }}" 
                   placeholder="Nháº­p tÃªn khÃ¡ch hÃ ng" required>
        </div>
        <div class="col-md-4">
            <label for="Sá»‘ khÃ¡ch" class="form-label"><i class="fas fa-users me-1"></i>Sá»‘ khÃ¡ch</label>
            <input type="number" class="form-control" id="Sá»‘ khÃ¡ch" name="Sá»‘ khÃ¡ch" 
                   value="{{ form_data.get('Sá»‘ khÃ¡ch', '1') if form_data else '1' }}" 
                   placeholder="1" min="1" max="10">
        </div>

        <!-- Dates -->
        <div class="col-md-6">
            <label for="NgÃ y Ä‘áº¿n" class="form-label"><i class="fas fa-calendar-check me-1"></i>NgÃ y Ä‘áº¿n (Check-in) *</label>
            <input type="date" class="form-control" id="NgÃ y Ä‘áº¿n" name="NgÃ y Ä‘áº¿n" 
                   value="{{ form_data.get('NgÃ y Ä‘áº¿n', '') if form_data else '' }}" required>
        </div>
        <div class="col-md-6">
            <label for="NgÃ y Ä‘i" class="form-label"><i class="fas fa-calendar-times me-1"></i>NgÃ y Ä‘i (Check-out) *</label>
            <input type="date" class="form-control" id="NgÃ y Ä‘i" name="NgÃ y Ä‘i" 
                   value="{{ form_data.get('NgÃ y Ä‘i', '') if form_data else '' }}" required>
        </div>

        <!-- Payment Information -->
        <div class="col-md-6">
            <label for="Tá»•ng thanh toÃ¡n" class="form-label"><i class="fas fa-coins me-1"></i>Tá»•ng thanh toÃ¡n (VND) *</label>
            <input type="number" step="1000" class="form-control" id="Tá»•ng thanh toÃ¡n" name="Tá»•ng thanh toÃ¡n" 
                   value="{{ form_data.get('Tá»•ng thanh toÃ¡n', '') if form_data else '' }}"
                   placeholder="0" min="0" required>
        </div>
        <div class="col-md-6">
            <label for="Hoa há»“ng" class="form-label"><i class="fas fa-percentage me-1"></i>Hoa há»“ng (VND)</label>
            <input type="number" step="1000" class="form-control" id="Hoa há»“ng" name="Hoa há»“ng" 
                   value="{{ form_data.get('Hoa há»“ng', '') if form_data else '0' }}"
                   placeholder="0" min="0">
        </div>
        
        <!-- Status and Payment -->
        <div class="col-md-6">
            <label for="TÃ¬nh tráº¡ng" class="form-label"><i class="fas fa-flag me-1"></i>TÃ¬nh tráº¡ng</label>
            <select class="form-select" id="TÃ¬nh tráº¡ng" name="TÃ¬nh tráº¡ng">
                <option value="OK" {% if not form_data or form_data.get('TÃ¬nh tráº¡ng') == 'OK' %}selected{% endif %}>âœ… OK</option>
                <option value="ÄÃ£ há»§y" {% if form_data and form_data.get('TÃ¬nh tráº¡ng') == 'ÄÃ£ há»§y' %}selected{% endif %}>âŒ ÄÃ£ há»§y</option>
            </select>
        </div>
        <div class="col-md-6">
            <label for="NgÆ°á»i thu tiá»n" class="form-label"><i class="fas fa-user-tie me-1"></i>NgÆ°á»i thu tiá»n</label>
            <select class="form-select" id="NgÆ°á»i thu tiá»n" name="NgÆ°á»i thu tiá»n">
                <option value="" {% if not form_data or not form_data.get('NgÆ°á»i thu tiá»n') %}selected{% endif %}>ğŸš« ChÆ°a thu</option>
                <option value="LOC LE" {% if form_data and form_data.get('NgÆ°á»i thu tiá»n') == 'LOC LE' %}selected{% endif %}>ğŸ‘¤ LOC LE</option>
                <option value="THAO LE" {% if form_data and form_data.get('NgÆ°á»i thu tiá»n') == 'THAO LE' %}selected{% endif %}>ğŸ‘¤ THAO LE</option>
            </select>
        </div>

        <!-- Hidden fields with default values -->
        <input type="hidden" name="Sá»‘ Ä‘áº·t phÃ²ng" value="AUTO_{{ range(10000, 99999) | random }}">
        <input type="hidden" name="TÃªn chá»— nghá»‰" value="118 Hang Bac Hostel">
        <input type="hidden" name="ÄÆ°á»£c Ä‘áº·t vÃ o" value="">
        <input type="hidden" name="Tiá»n tá»‡" value="VND">
        <input type="hidden" name="Vá»‹ trÃ­" value="HÃ  Ná»™i">
        <input type="hidden" name="ThÃ nh viÃªn Genius" value="KhÃ´ng">

    </div>

    <button type="submit" class="btn btn-primary mt-4">ThÃªm Äáº·t phÃ²ng</button>
    <a href="{{ url_for('view_bookings') }}" class="btn btn-secondary mt-4">Há»§y</a>
</form>

<script>
// Photo processing functions
function processPhoto(imageData) {
    document.getElementById('photo-processing').style.display = 'block';
    
    fetch('/api/process_pasted_image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image_b64: imageData })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('photo-processing').style.display = 'none';
        if (data.bookings && data.bookings[0] && !data.bookings[0].error) {
            const booking = data.bookings[0];
            // Auto-fill form
            document.querySelector('input[name="TÃªn ngÆ°á»i Ä‘áº·t"]').value = booking.guest_name || '';
            document.querySelector('input[name="NgÃ y Ä‘áº¿n"]').value = booking.check_in_date || '';
            document.querySelector('input[name="NgÃ y Ä‘i"]').value = booking.check_out_date || '';
            document.querySelector('input[name="Tá»•ng thanh toÃ¡n"]').value = booking.total_payment || '';
            document.querySelector('input[name="Hoa há»“ng"]').value = booking.commission || '';
            document.querySelector('input[name="Sá»‘ khÃ¡ch"]').value = booking.guest_count || '1';
        }
    })
    .catch(error => {
        document.getElementById('photo-processing').style.display = 'none';
        console.error('Photo processing error:', error);
    });
}

// Setup photo upload events
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('photo-upload-area');
    const photoInput = document.getElementById('photo-input');
    
    uploadArea.onclick = () => photoInput.click();
    photoInput.onchange = function(e) {
        if (e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = e => processPhoto(e.target.result);
            reader.readAsDataURL(e.target.files[0]);
        }
    };
    
    // Paste support
    document.addEventListener('paste', function(e) {
        const items = e.clipboardData.items;
        for (let item of items) {
            if (item.type.startsWith('image/')) {
                const file = item.getAsFile();
                const reader = new FileReader();
                reader.onload = e => processPhoto(e.target.result);
                reader.readAsDataURL(file);
                break;
            }
        }
    });
});

function clearForm() {
    // Clear all form fields
    document.querySelectorAll('input, select').forEach(function(element) {
        if (element.type === 'text' || element.type === 'number' || element.type === 'date') {
            element.value = '';
        } else if (element.tagName === 'SELECT') {
            element.selectedIndex = 0;
        }
    });
    
    // Hide any duplicate warning
    const warning = document.querySelector('.alert-warning');
    if (warning) {
        warning.style.display = 'none';
    }
    
    // Focus on first input
    document.querySelector('input[name="TÃªn ngÆ°á»i Ä‘áº·t"]').focus();
}
</script>
{% endblock %} 