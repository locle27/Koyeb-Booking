{% extends "base.html" %}

{% block title %}L·ªãch Doanh Thu - Hotel Management{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-calendar-alt me-2 text-primary"></i>üìÖ L·ªãch Doanh Thu
            </h1>
            <p class="text-muted mb-0">Theo d√µi doanh thu theo ng√†y check-in</p>
        </div>
        <div class="text-end">
            <button class="btn btn-primary" onclick="window.location.reload()">
                <i class="fas fa-sync-alt me-1"></i>L√†m m·ªõi
            </button>
        </div>
    </div>

    <!-- Calendar Container -->
    <div class="calendar-container mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="text-white mb-0">
                <i class="fas fa-coins me-2"></i>Doanh Thu Theo Ng√†y
            </h4>
            <div class="text-white">
                <small>{{ daily_totals|length if daily_totals else 0 }} ng√†y</small>
            </div>
        </div>

        {% if daily_totals and daily_totals|length > 0 %}
        <div class="calendar-grid">
            {% for day in daily_totals %}
            <div class="card calendar-day-card border-0 h-100" 
                 onclick="showDayDetails('{{ day.date }}', {{ day.guest_count }}, {{ day.guest_names|tojson }}, {{ day.booking_ids|tojson }}, {{ day.daily_total if day.daily_total else 0 }}, {{ day.individual_amounts|tojson if day.individual_amounts else [] }})">
                <div class="card-body p-4">
                    <!-- Date Header -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="calendar-date text-dark">
                            {% if day.date %}
                                {{ day.date.strftime('%d/%m/%Y') if day.date.strftime else day.date }}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                        <div>
                            {% if day.is_today %}
                                <span class="badge today-badge text-white px-2 py-1">H√îM NAY</span>
                            {% elif day.days_from_today == 1 %}
                                <span class="badge bg-info text-white px-2 py-1">NG√ÄY MAI</span>
                            {% elif day.days_from_today == -1 %}
                                <span class="badge bg-secondary text-white px-2 py-1">H√îM QUA</span>
                            {% elif day.days_from_today > 0 %}
                                <span class="badge bg-light text-dark px-2 py-1">+{{ day.days_from_today }} ng√†y</span>
                            {% elif day.days_from_today < 0 %}
                                <span class="badge bg-light text-dark px-2 py-1">{{ day.days_from_today }} ng√†y</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Guest Count -->
                    <div class="guest-count mb-3">
                        <i class="fas fa-users me-1"></i>{{ day.guest_count }} kh√°ch check-in
                    </div>

                    <!-- Revenue Amount -->
                    <div class="text-center">
                        <div class="revenue-amount">
                            {{ "{:,.0f}".format(day.daily_total if day.daily_total else 0) }}ƒë
                        </div>
                        <small class="text-muted">T·ªïng doanh thu</small>
                    </div>

                    <!-- Action Button -->
                    <div class="text-center mt-3">
                        <div class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye me-1"></i>Xem chi ti·∫øt
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-white py-5">
            <i class="fas fa-calendar-times fa-3x mb-3 opacity-75"></i>
            <h5>Kh√¥ng c√≥ d·ªØ li·ªáu</h5>
            <p class="mb-0">Ch∆∞a c√≥ booking n√†o trong kho·∫£ng th·ªùi gian n√†y</p>
        </div>
        {% endif %}
    </div>

    <!-- Summary Statistics -->
    {% if daily_totals and daily_totals|length > 0 %}
    <div class="row">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="h4 mb-0 text-primary">{{ daily_totals|length }}</div>
                    <small class="text-muted">T·ªïng s·ªë ng√†y</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    {% set total_guests = daily_totals | sum(attribute='guest_count') %}
                    <div class="h4 mb-0 text-info">{{ total_guests }}</div>
                    <small class="text-muted">T·ªïng kh√°ch</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    {% set total_revenue = daily_totals | sum(attribute='daily_total') %}
                    <div class="h4 mb-0 text-success">{{ "{:,.0f}".format(total_revenue) }}ƒë</div>
                    <small class="text-muted">T·ªïng doanh thu</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    {% if total_guests > 0 %}
                        {% set avg_per_guest = total_revenue / total_guests %}
                        <div class="h4 mb-0 text-warning">{{ "{:,.0f}".format(avg_per_guest) }}ƒë</div>
                    {% else %}
                        <div class="h4 mb-0 text-warning">0ƒë</div>
                    {% endif %}
                    <small class="text-muted">TB/kh√°ch</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Day Details Modal Script -->
<script>
// Show day details modal (reuse from dashboard)
function showDayDetails(date, guestCount, guestNames, bookingIds, dailyTotal, individualAmounts) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-calendar-day me-2"></i>Chi ti·∫øt doanh thu ng√†y: ${date}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <strong><i class="fas fa-coins me-2"></i>T·ªïng doanh thu:</strong> 
                        <span class="fs-5 fw-bold">${dailyTotal ? dailyTotal.toLocaleString() : '0'}ƒë</span>
                        <small class="text-muted ms-2">(${guestCount} kh√°ch check-in)</small>
                    </div>
                    <h6><i class="fas fa-list me-2"></i>Danh s√°ch kh√°ch v√† s·ªë ti·ªÅn:</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>T√™n kh√°ch</th>
                                    <th>S·ªë ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${guestNames.map((name, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${name}</strong></td>
                                        <td><span class="badge bg-success fs-6">${individualAmounts && individualAmounts[index] ? individualAmounts[index].toLocaleString() : '0'}ƒë</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>Doanh thu t√≠nh theo ng√†y check-in
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Clean up modal after it's hidden
    modal.addEventListener('hidden.bs.modal', function () {
        document.body.removeChild(modal);
    });
}
</script>

{% endblock %}

{% block extra_css %}
<style>
/* Calendar Styling */
.calendar-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 20px;
}

.calendar-day-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
}

.calendar-day-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.revenue-amount {
    font-size: 1.5rem;
    font-weight: bold;
    color: #28a745;
}

.calendar-date {
    font-size: 1.2rem;
    font-weight: bold;
}

.guest-count {
    color: #6c757d;
    font-size: 0.9rem;
}

.today-badge {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

@media (max-width: 768px) {
    .calendar-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .revenue-amount {
        font-size: 1.3rem;
    }
}
</style>
{% endblock %}
