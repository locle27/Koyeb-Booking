{% extends "base.html" %}
{% block title %}Ph√¢n t√≠ch Gi√° Th·ªã tr∆∞·ªùng{% endblock %}

{% block content %}
<div class="container-fluid px-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="text-primary mb-1">
                <i class="fas fa-chart-line me-2"></i>Ph√¢n t√≠ch Gi√° Th·ªã tr∆∞·ªùng
            </h3>
            <p class="text-muted mb-0">Crawl v√† ph√¢n t√≠ch gi√° t·ª´ Booking.com ƒë·ªÉ hi·ªÉu th·ªã tr∆∞·ªùng c·∫°nh tranh</p>
        </div>
        <a href="/" class="btn btn-outline-primary">
            <i class="fas fa-home me-1"></i>V·ªÅ trang ch·ªß
        </a>
    </div>

    <!-- URL Input Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-link me-2"></i>C·∫•u h√¨nh Ph√¢n t√≠ch
            </h5>
        </div>
        <div class="card-body">
            <form id="analysisForm">
                <div class="row">
                    <div class="col-md-9">
                        <label class="form-label fw-bold">
                            <i class="fas fa-globe me-1"></i>URL Booking.com:
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fab fa-chrome"></i>
                            </span>
                            <input type="url" 
                                   id="bookingUrl" 
                                   class="form-control" 
                                   placeholder="D√°n URL t√¨m ki·∫øm t·ª´ Booking.com..."
                                   required>
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    onclick="loadDefaultUrl()"
                                    title="T·∫£i URL m·∫∑c ƒë·ªãnh cho Khu Ph·ªë C·ªï">
                                <i class="fas fa-magic"></i> M·∫∑c ƒë·ªãnh
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Copy URL t·ª´ trang t√¨m ki·∫øm Booking.com (ƒë√£ l·ªçc theo khu v·ª±c v√† gi√°)
                        </small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">S·ªë l∆∞·ª£ng t·ªëi ƒëa:</label>
                        <select id="maxProperties" class="form-select">
                            <option value="10">10 properties</option>
                            <option value="15" selected>15 properties</option>
                            <option value="20">20 properties</option>
                            <option value="25">25 properties</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="submit" 
                            id="analyzeBtn" 
                            class="btn btn-primary btn-lg me-2">
                        <i class="fas fa-search me-2"></i>Ph√¢n t√≠ch Gi√° Th·ªã tr∆∞·ªùng
                    </button>
                    <button type="button" 
                            class="btn btn-outline-info" 
                            onclick="showUrlGuide()">
                        <i class="fas fa-question-circle me-1"></i>H∆∞·ªõng d·∫´n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- URL Guide Modal -->
    <div class="modal fade" id="urlGuideModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-graduation-cap me-2"></i>H∆∞·ªõng d·∫´n l·∫•y URL Booking.com
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">üìã C√°c b∆∞·ªõc th·ª±c hi·ªán:</h6>
                            <ol class="list-group list-group-numbered">
                                <li class="list-group-item">Truy c·∫≠p <strong>Booking.com</strong></li>
                                <li class="list-group-item">T√¨m ki·∫øm khu v·ª±c (VD: "Khu Ph·ªë C·ªï")</li>
                                <li class="list-group-item">Ch·ªçn ng√†y check-in/check-out</li>
                                <li class="list-group-item">√Åp d·ª•ng filter gi√° n·∫øu c·∫ßn</li>
                                <li class="list-group-item">Copy URL t·ª´ thanh ƒë·ªãa ch·ªâ</li>
                                <li class="list-group-item">Paste v√†o √¥ input b√™n tr√°i</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">‚úÖ Tips ƒë·ªÉ c√≥ k·∫øt qu·∫£ t·ªët:</h6>
                            <ul class="list-group">
                                <li class="list-group-item">
                                    <i class="fas fa-filter text-primary me-2"></i>
                                    L·ªçc theo gi√° t·ª´ 500k-2M ƒë·ªÉ c√≥ d·ªØ li·ªáu relevant
                                </li>
                                <li class="list-group-item">
                                    <i class="fas fa-map-marker-alt text-success me-2"></i>
                                    Ch·ªçn khu v·ª±c c·ª• th·ªÉ (Qu·∫≠n/Ph·ªë) thay v√¨ to√†n th√†nh ph·ªë
                                </li>
                                <li class="list-group-item">
                                    <i class="fas fa-calendar text-warning me-2"></i>
                                    Ch·ªçn ng√†y trong t∆∞∆°ng lai g·∫ßn (1-7 ng√†y)
                                </li>
                                <li class="list-group-item">
                                    <i class="fas fa-users text-info me-2"></i>
                                    ƒê·∫∑t cho 2 kh√°ch ƒë·ªÉ c√≥ gi√° realistic
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Section -->
    <div id="loadingSection" class="card border-warning bg-warning-subtle" style="display: none;">
        <div class="card-body text-center">
            <div class="spinner-border text-warning me-3" role="status">
                <span class="visually-hidden">ƒêang t·∫£i...</span>
            </div>
            <h5 class="text-warning mb-2">
                <i class="fas fa-robot me-2"></i>ƒêang ph√¢n t√≠ch th·ªã tr∆∞·ªùng...
            </h5>
            <p class="mb-0">Crawling Booking.com v√† x·ª≠ l√Ω d·ªØ li·ªáu (c√≥ th·ªÉ m·∫•t 30-60 gi√¢y)</p>
            <div class="progress mt-3" style="height: 8px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                     role="progressbar" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
        <!-- Summary Cards -->
        <div class="row mb-4" id="summaryCards">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Price Analysis Chart -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Ph√¢n b·ªë Gi√° theo T·∫ßng
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="priceDistributionChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb me-2"></i>Insights
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="insightsList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Table -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Chi ti·∫øt Properties <span id="propertyCount" class="badge bg-primary"></span>
                </h5>
                <div>
                    <button class="btn btn-outline-success btn-sm" onclick="exportAnalysisData()">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="refreshAnalysis()">
                        <i class="fas fa-refresh me-1"></i>L√†m m·ªõi
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="propertiesTable">
                        <thead class="table-dark">
                            <tr>
                                <th>T√™n Property</th>
                                <th>Gi√°/ƒë√™m</th>
                                <th>Rating</th>
                                <th>V·ªã tr√≠</th>
                                <th>Lo·∫°i ph√≤ng</th>
                                <th>So s√°nh</th>
                            </tr>
                        </thead>
                        <tbody id="propertiesTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Section -->
    <div id="errorSection" class="alert alert-danger" style="display: none;">
        <h5 class="alert-heading">
            <i class="fas fa-exclamation-triangle me-2"></i>L·ªói ph√¢n t√≠ch
        </h5>
        <p id="errorMessage" class="mb-0"></p>
        <hr>
        <div class="mb-0">
            <button class="btn btn-outline-danger btn-sm" onclick="showUrlGuide()">
                <i class="fas fa-question-circle me-1"></i>Xem h∆∞·ªõng d·∫´n
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="hideError()">
                <i class="fas fa-times me-1"></i>ƒê√≥ng
            </button>
        </div>
    </div>
</div>

<!-- Include Chart.js for price distribution chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.price-high { color: #dc3545; font-weight: bold; }
.price-medium { color: #fd7e14; font-weight: bold; }
.price-low { color: #28a745; font-weight: bold; }
.price-very-low { color: #20c997; font-weight: bold; }

.summary-card {
    transition: transform 0.2s ease-in-out;
}
.summary-card:hover {
    transform: translateY(-5px);
}

.insights-item {
    padding: 8px 12px;
    margin: 5px 0;
    border-left: 4px solid #0d6efd;
    background: #f8f9fa;
    border-radius: 0 8px 8px 0;
}
</style>

<script>
let currentAnalysisData = null;
let priceChart = null;

// Form submission
document.getElementById('analysisForm').addEventListener('submit', function(e) {
    e.preventDefault();
    analyzeMarketPrices();
});

// Load default URL
async function loadDefaultUrl() {
    try {
        showLoading('ƒêang t·∫£i URL m·∫∑c ƒë·ªãnh...');
        
        const response = await fetch('/api/get_default_booking_url');
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('bookingUrl').value = result.default_url;
            hideLoading();
            
            // Show success message
            const toast = document.createElement('div');
            toast.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong class="me-auto">Th√†nh c√¥ng</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ƒê√£ t·∫£i URL cho ${result.location}<br>
                        <small class="text-muted">${result.description}</small>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => toast.remove(), 5000);
        } else {
            hideLoading();
            showError('Kh√¥ng th·ªÉ t·∫£i URL m·∫∑c ƒë·ªãnh: ' + result.error);
        }
    } catch (error) {
        hideLoading();
        showError('L·ªói k·∫øt n·ªëi: ' + error.message);
    }
}

// Main analysis function
async function analyzeMarketPrices() {
    const bookingUrl = document.getElementById('bookingUrl').value.trim();
    const maxProperties = parseInt(document.getElementById('maxProperties').value);
    
    if (!bookingUrl) {
        showError('Vui l√≤ng nh·∫≠p URL Booking.com');
        return;
    }
    
    if (!bookingUrl.includes('booking.com')) {
        showError('URL ph·∫£i t·ª´ Booking.com');
        return;
    }
    
    try {
        showLoading('ƒêang crawl v√† ph√¢n t√≠ch d·ªØ li·ªáu...');
        hideError();
        hideResults();
        
        const response = await fetch('/api/analyze_market_prices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                booking_url: bookingUrl,
                max_properties: maxProperties
            })
        });
        
        const result = await response.json();
        
        hideLoading();
        
        if (result.success) {
            currentAnalysisData = result;
            displayResults(result);
        } else {
            showError(result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh trong qu√° tr√¨nh ph√¢n t√≠ch');
        }
        
    } catch (error) {
        hideLoading();
        showError('L·ªói k·∫øt n·ªëi: ' + error.message);
    }
}

// Display results
function displayResults(data) {
    const summary = data.summary || {};
    const properties = data.properties || [];
    const insights = data.insights || [];
    const priceRanges = data.price_ranges || {};
    
    // Update summary cards
    updateSummaryCards(summary);
    
    // Update insights
    updateInsights(insights);
    
    // Update properties table
    updatePropertiesTable(properties, summary);
    
    // Update price distribution chart
    updatePriceChart(priceRanges);
    
    // Show results
    document.getElementById('resultsSection').style.display = 'block';
    
    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// Update summary cards
function updateSummaryCards(summary) {
    const cardsHtml = `
        <div class="col-md-3">
            <div class="card text-center summary-card bg-primary text-white">
                <div class="card-body">
                    <i class="fas fa-building fa-2x mb-2"></i>
                    <h4>${summary.total_found || 0}</h4>
                    <p class="mb-0">Properties</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center summary-card bg-success text-white">
                <div class="card-body">
                    <i class="fas fa-coins fa-2x mb-2"></i>
                    <h4>${formatPrice(summary.avg_price || 0)}</h4>
                    <p class="mb-0">Gi√° trung b√¨nh</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center summary-card bg-info text-white">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h4>${formatPrice(summary.median_price || 0)}</h4>
                    <p class="mb-0">Gi√° trung v·ªã</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center summary-card bg-warning text-white">
                <div class="card-body">
                    <i class="fas fa-arrows-alt-v fa-2x mb-2"></i>
                    <h4>${formatPrice(summary.min_price || 0)} - ${formatPrice(summary.max_price || 0)}</h4>
                    <p class="mb-0">Kho·∫£ng gi√°</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('summaryCards').innerHTML = cardsHtml;
}

// Update insights
function updateInsights(insights) {
    const insightsHtml = insights.map(insight => 
        `<div class="insights-item">${insight}</div>`
    ).join('');
    
    document.getElementById('insightsList').innerHTML = insightsHtml || 
        '<p class="text-muted">Kh√¥ng c√≥ insights n√†o ƒë∆∞·ª£c t·∫°o.</p>';
}

// Update properties table
function updatePropertiesTable(properties, summary) {
    const avgPrice = summary.avg_price || 0;
    
    const tbody = document.getElementById('propertiesTableBody');
    const propertyCount = document.getElementById('propertyCount');
    
    propertyCount.textContent = properties.length;
    
    tbody.innerHTML = properties.map(prop => {
        const priceClass = getPriceClass(prop.price_vnd, avgPrice);
        const comparison = getComparisonText(prop.price_vnd, avgPrice);
        
        return `
            <tr>
                <td>
                    <strong>${escapeHtml(prop.name)}</strong>
                    <br><small class="text-muted">${escapeHtml(prop.room_type)}</small>
                </td>
                <td class="${priceClass}">
                    ${prop.price_display}
                </td>
                <td>
                    ${prop.rating !== 'N/A' ? 
                        `<span class="badge bg-warning text-dark">${prop.rating}</span>` : 
                        '<span class="text-muted">N/A</span>'
                    }
                </td>
                <td>
                    <small>${escapeHtml(prop.location || 'N/A')}</small>
                </td>
                <td>
                    <span class="badge bg-light text-dark">${escapeHtml(prop.room_type)}</span>
                </td>
                <td>
                    <small class="${priceClass}">${comparison}</small>
                </td>
            </tr>
        `;
    }).join('');
}

// Update price distribution chart
function updatePriceChart(priceRanges) {
    const ctx = document.getElementById('priceDistributionChart').getContext('2d');
    
    // Destroy existing chart
    if (priceChart) {
        priceChart.destroy();
    }
    
    const labels = Object.keys(priceRanges).map(key => {
        const translations = {
            'budget': 'B√¨nh d√¢n',
            'mid_range': 'Trung c·∫•p', 
            'upscale': 'Cao c·∫•p',
            'luxury': 'Sang tr·ªçng'
        };
        return translations[key] || key;
    });
    
    const data = Object.values(priceRanges).map(range => range.count || 0);
    const percentages = Object.values(priceRanges).map(range => range.percentage || 0);
    
    priceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#28a745', // Budget - Green
                    '#ffc107', // Mid-range - Yellow
                    '#fd7e14', // Upscale - Orange
                    '#dc3545'  // Luxury - Red
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const percentage = percentages[context.dataIndex] || 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Utility functions
function formatPrice(price) {
    if (!price || price === 0) return '0‚Ç´';
    return (price / 1000).toFixed(0) + 'k‚Ç´';
}

function getPriceClass(price, avgPrice) {
    if (price > avgPrice * 1.5) return 'price-high';
    if (price > avgPrice * 1.1) return 'price-medium';
    if (price < avgPrice * 0.7) return 'price-very-low';
    return 'price-low';
}

function getComparisonText(price, avgPrice) {
    const ratio = price / avgPrice;
    if (ratio > 1.5) return 'üî¥ Cao h∆°n TB 50%+';
    if (ratio > 1.1) return 'üü† Cao h∆°n TB';
    if (ratio < 0.7) return 'üü¢ Th·∫•p h∆°n TB 30%+';
    return 'üü° G·∫ßn TB';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// UI control functions
function showLoading(message = 'ƒêang t·∫£i...') {
    const loadingSection = document.getElementById('loadingSection');
    loadingSection.querySelector('p').textContent = message;
    loadingSection.style.display = 'block';
    
    // Disable form
    document.getElementById('analyzeBtn').disabled = true;
}

function hideLoading() {
    document.getElementById('loadingSection').style.display = 'none';
    document.getElementById('analyzeBtn').disabled = false;
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').style.display = 'block';
}

function hideError() {
    document.getElementById('errorSection').style.display = 'none';
}

function hideResults() {
    document.getElementById('resultsSection').style.display = 'none';
}

function showUrlGuide() {
    new bootstrap.Modal(document.getElementById('urlGuideModal')).show();
}

function refreshAnalysis() {
    if (currentAnalysisData) {
        displayResults(currentAnalysisData);
    }
}

function exportAnalysisData() {
    if (!currentAnalysisData || !currentAnalysisData.properties) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export');
        return;
    }
    
    // Convert to CSV
    const properties = currentAnalysisData.properties;
    const csvContent = "data:text/csv;charset=utf-8," 
        + "T√™n Property,Gi√° (VND),Rating,V·ªã tr√≠,Lo·∫°i ph√≤ng\n"
        + properties.map(prop => 
            `"${prop.name}","${prop.price_vnd}","${prop.rating}","${prop.location}","${prop.room_type}"`
        ).join("\n");
    
    // Download
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `market_analysis_${new Date().getTime()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Auto-load default URL on page load
    loadDefaultUrl();
});
</script>
{% endblock %}
