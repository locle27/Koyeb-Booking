{% extends "base.html" %}
{% block title %}Ph√¢n t√≠ch Gi√° Th·ªã tr∆∞·ªùng{% endblock %}

{% block content %}
<div class="container-fluid px-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="text-primary mb-1">
                <i class="fas fa-chart-line me-2"></i>Ph√¢n t√≠ch Gi√° Th·ªã tr∆∞·ªùng
            </h3>
            <p class="text-muted mb-0">Crawl v√† ph√¢n t√≠ch gi√° t·ª´ Booking.com ƒë·ªÉ hi·ªÉu th·ªã tr∆∞·ªùng c·∫°nh tranh</p>
        </div>
        <a href="/" class="btn btn-outline-primary">
            <i class="fas fa-home me-1"></i>V·ªÅ trang ch·ªß
        </a>
    </div>

    <!-- URL Input Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-link me-2"></i>C·∫•u h√¨nh Ph√¢n t√≠ch
            </h5>
        </div>
        <div class="card-body">
            <form id="analysisForm">
                <div class="row">
                    <div class="col-md-9">
                        <label class="form-label fw-bold">
                            <i class="fas fa-globe me-1"></i>URL Booking.com:
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fab fa-chrome"></i>
                            </span>
                            <input type="url" 
                                   id="bookingUrl" 
                                   class="form-control" 
                                   placeholder="D√°n URL t√¨m ki·∫øm t·ª´ Booking.com..."
                                   required>
                            <button type="button" 
                                    class="btn btn-outline-secondary" 
                                    onclick="loadDefaultUrl()"
                                    title="T·∫£i URL m·∫∑c ƒë·ªãnh cho Khu Ph·ªë C·ªï">
                                <i class="fas fa-magic"></i> M·∫∑c ƒë·ªãnh
                            </button>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Copy URL t·ª´ trang t√¨m ki·∫øm Booking.com (ƒë√£ l·ªçc theo khu v·ª±c v√† gi√°)
                        </small>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">S·ªë l∆∞·ª£ng t·ªëi ƒëa:</label>
                        <select id="maxProperties" class="form-select">
                            <option value="10">10 properties</option>
                            <option value="15" selected>15 properties</option>
                            <option value="20">20 properties</option>
                            <option value="25">25 properties</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="submit" 
                            id="analyzeBtn" 
                            class="btn btn-primary btn-lg me-2">
                        <i class="fas fa-search me-2"></i>Ph√¢n t√≠ch Gi√° Th·ªã tr∆∞·ªùng
                    </button>
                    <button type="button" 
                            class="btn btn-outline-info" 
                            onclick="showUrlGuide()">
                        <i class="fas fa-question-circle me-1"></i>H∆∞·ªõng d·∫´n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- URL Guide Modal -->
    <div class="modal fade" id="urlGuideModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-graduation-cap me-2"></i>H∆∞·ªõng d·∫´n l·∫•y URL Booking.com
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">üìã C√°c b∆∞·ªõc th·ª±c hi·ªán:</h6>
                            <ol class="list-group list-group-numbered">
                                <li class="list-group-item">Truy c·∫≠p <strong>Booking.com</strong></li>
                                <li class="list-group-item">T√¨m ki·∫øm khu v·ª±c (VD: "Khu Ph·ªë C·ªï")</li>
                                <li class="list-group-item">Ch·ªçn ng√†y check-in/check-out</li>
                                <li class="list-group-item">√Åp d·ª•ng filter gi√° n·∫øu c·∫ßn</li>
                                <li class="list-group-item">Copy URL t·ª´ thanh ƒë·ªãa ch·ªâ</li>
                                <li class="list-group-item">Paste v√†o √¥ input b√™n tr√°i</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">‚úÖ Tips ƒë·ªÉ c√≥ k·∫øt qu·∫£ t·ªët:</h6>
                            <ul class="list-group">
                                <li class="list-group-item">
                                    <i class="fas fa-filter text-primary me-2"></i>
                                    L·ªçc theo gi√° t·ª´ 500k-2M ƒë·ªÉ c√≥ d·ªØ li·ªáu relevant
                                </li>
                                <li class="list-group-item">
                                    <i class="fas fa-map-marker-alt text-success me-2"></i>
                                    Ch·ªçn khu v·ª±c c·ª• th·ªÉ (Qu·∫≠n/Ph·ªë) thay v√¨ to√†n th√†nh ph·ªë
                                </li>
                                <li class="list-group-item">
                                    <i class="fas fa-calendar text-warning me-2"></i>
                                    Ch·ªçn ng√†y trong t∆∞∆°ng lai g·∫ßn (1-7 ng√†y)
                                </li>
                                <li class="list-group-item">
                                    <i class="fas fa-users text-info me-2"></i>
                                    ƒê·∫∑t cho 2 kh√°ch ƒë·ªÉ c√≥ gi√° realistic
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Section -->
    <div id="loadingSection" class="card border-warning bg-warning-subtle" style="display: none;">
        <div class="card-body text-center">
            <div class="spinner-border text-warning me-3" role="status">
                <span class="visually-hidden">ƒêang t·∫£i...</span>
            </div>
            <h5 class="text-warning mb-2">
                <i class="fas fa-robot me-2"></i>ƒêang ph√¢n t√≠ch th·ªã tr∆∞·ªùng...
            </h5>
            <p class="mb-0">Crawling Booking.com v√† x·ª≠ l√Ω d·ªØ li·ªáu (c√≥ th·ªÉ m·∫•t 30-60 gi√¢y)</p>
            <div class="progress mt-3" style="height: 8px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                     role="progressbar" style="width: 100%"></div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
        <!-- Summary Cards -->
        <div class="row mb-4" id="summaryCards">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- AI Pricing Analysis Section -->
        <div class="row mb-4" id="aiAnalysisSection" style="display: none;">
            <div class="col-12">
                <div class="card shadow-sm border-primary">
                    <div class="card-header bg-gradient-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-robot me-2"></i>AI Pricing Analyst - Budget Segment Insights
                            </h5>
                            <div>
                                <input type="number" 
                                       id="priceThresholdInput" 
                                       class="form-control form-control-sm d-inline-block" 
                                       style="width: 120px;" 
                                       value="500000" 
                                       min="100000" 
                                       max="2000000" 
                                       step="50000">
                                <span class="text-white ms-1">‚Ç´</span>
                                <button class="btn btn-light btn-sm ms-2" onclick="runAIAnalysis()" id="aiAnalyzeBtn">
                                    <i class="fas fa-brain me-1"></i>Ph√¢n t√≠ch AI
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- AI Loading -->
                        <div id="aiLoadingSection" style="display: none;">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary me-3" role="status">
                                    <span class="visually-hidden">AI ƒëang ph√¢n t√≠ch...</span>
                                </div>
                                <h6 class="text-primary mb-2">
                                    <i class="fas fa-brain me-2"></i>AI ƒëang ph√¢n t√≠ch th·ªã tr∆∞·ªùng...
                                </h6>
                                <p class="mb-0">Gemini AI ƒëang t·∫°o insights chuy√™n s√¢u v·ªÅ pricing strategy</p>
                            </div>
                        </div>

                        <!-- AI Results -->
                        <div id="aiResultsSection" style="display: none;">
                            <!-- Market Overview Cards -->
                            <div class="row mb-4" id="aiOverviewCards">
                                <!-- Will be populated by JavaScript -->
                            </div>

                            <!-- Strategic Recommendations -->
                            <div class="row mb-4">
                                <div class="col-lg-6">
                                    <div class="card border-success h-100">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-lightbulb me-2"></i>C∆° h·ªôi Pricing
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="pricingOpportunities">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="card border-warning h-100">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="fas fa-tasks me-2"></i>Strategic Recommendations
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="strategicRecommendations">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Risk Analysis & Actionable Insights -->
                            <div class="row mb-4">
                                <div class="col-lg-6">
                                    <div class="card border-danger h-100">
                                        <div class="card-header bg-danger text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-exclamation-triangle me-2"></i>Risk Analysis
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="riskAnalysis">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="card border-info h-100">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-rocket me-2"></i>H√†nh ƒë·ªông Ngay l·∫≠p t·ª©c
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="actionableInsights">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AI Confidence & Method -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info d-flex align-items-center">
                                        <i class="fas fa-info-circle me-3 fs-5"></i>
                                        <div>
                                            <strong>AI Analysis Confidence:</strong> <span id="aiConfidence">-</span>
                                            <br>
                                            <small class="text-muted">
                                                Analysis timestamp: <span id="aiTimestamp">-</span> | 
                                                Method: <span id="aiMethod">-</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Error Section -->
                        <div id="aiErrorSection" class="alert alert-danger" style="display: none;">
                            <h6 class="alert-heading">
                                <i class="fas fa-exclamation-triangle me-2"></i>L·ªói AI Analysis
                            </h6>
                            <p id="aiErrorMessage" class="mb-0"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Price Analysis Chart -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Ph√¢n b·ªë Gi√° theo T·∫ßng
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="position: relative; height: 300px; max-width: 100%;">
                            <canvas id="priceDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-lightbulb me-2"></i>Insights
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="insightsList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Table -->
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Chi ti·∫øt Properties <span id="propertyCount" class="badge bg-primary"></span>
                </h5>
                <div>
                    <button class="btn btn-outline-success btn-sm" onclick="exportAnalysisData()">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="refreshAnalysis()">
                        <i class="fas fa-refresh me-1"></i>L√†m m·ªõi
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="propertiesTable">
                        <thead class="table-dark">
                            <tr>
                                <th>T√™n Property</th>
                                <th>Gi√°/ƒë√™m</th>
                                <th>Rating</th>
                                <th>V·ªã tr√≠</th>
                                <th>Lo·∫°i ph√≤ng</th>
                                <th>So s√°nh</th>
                            </tr>
                        </thead>
                        <tbody id="propertiesTableBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Section -->
    <div id="errorSection" class="alert alert-danger" style="display: none;">
        <h5 class="alert-heading">
            <i class="fas fa-exclamation-triangle me-2"></i>L·ªói ph√¢n t√≠ch
        </h5>
        <p id="errorMessage" class="mb-0"></p>
        <hr>
        <div class="mb-0">
            <button class="btn btn-outline-danger btn-sm" onclick="showUrlGuide()">
                <i class="fas fa-question-circle me-1"></i>Xem h∆∞·ªõng d·∫´n
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="hideError()">
                <i class="fas fa-times me-1"></i>ƒê√≥ng
            </button>
        </div>
    </div>
</div>

<!-- Include Chart.js for price distribution chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.price-high { color: #dc3545; font-weight: bold; }
.price-medium { color: #fd7e14; font-weight: bold; }
.price-low { color: #28a745; font-weight: bold; }
.price-very-low { color: #20c997; font-weight: bold; }

.summary-card {
    transition: transform 0.2s ease-in-out;
}
.summary-card:hover {
    transform: translateY(-5px);
}

.insights-item {
    padding: 8px 12px;
    margin: 5px 0;
    border-left: 4px solid #0d6efd;
    background: #f8f9fa;
    border-radius: 0 8px 8px 0;
}

/* AI Analysis Styling */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.ai-opportunity-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.ai-opportunity-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.ai-insight-item {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}

.ai-recommendation-item {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}

#priceThresholdInput {
    background: rgba(255,255,255,0.9);
    border: 1px solid rgba(255,255,255,0.5);
    color: #333;
}

#priceThresholdInput:focus {
    background: white;
    border-color: #fff;
    box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
}
</style>

<script>
let currentAnalysisData = null;
let priceChart = null;
const GOOGLE_API_KEY = "{{ GOOGLE_API_KEY if GOOGLE_API_KEY else '' }}"; // Check if API key available

// Form submission
document.getElementById('analysisForm').addEventListener('submit', function(e) {
    e.preventDefault();
    analyzeMarketPrices();
});

// Load default URL
async function loadDefaultUrl() {
    try {
        showLoading('ƒêang t·∫£i URL m·∫∑c ƒë·ªãnh...');
        
        const response = await fetch('/api/get_default_booking_url');
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('bookingUrl').value = result.default_url;
            hideLoading();
            
            // Show success message
            const toast = document.createElement('div');
            toast.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong class="me-auto">Th√†nh c√¥ng</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ƒê√£ t·∫£i URL cho ${result.location}<br>
                        <small class="text-muted">${result.description}</small>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => toast.remove(), 5000);
        } else {
            hideLoading();
            showError('Kh√¥ng th·ªÉ t·∫£i URL m·∫∑c ƒë·ªãnh: ' + result.error);
        }
    } catch (error) {
        hideLoading();
        showError('L·ªói k·∫øt n·ªëi: ' + error.message);
    }
}

// Main analysis function
async function analyzeMarketPrices() {
    const bookingUrl = document.getElementById('bookingUrl').value.trim();
    const maxProperties = parseInt(document.getElementById('maxProperties').value);
    
    if (!bookingUrl) {
        showError('Vui l√≤ng nh·∫≠p URL Booking.com');
        return;
    }
    
    if (!bookingUrl.includes('booking.com')) {
        showError('URL ph·∫£i t·ª´ Booking.com');
        return;
    }
    
    try {
        showLoading('ƒêang crawl v√† ph√¢n t√≠ch d·ªØ li·ªáu...');
        hideError();
        hideResults();
        
        const response = await fetch('/api/analyze_market_prices', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                booking_url: bookingUrl,
                max_properties: maxProperties
            })
        });
        
        const result = await response.json();
        
        hideLoading();
        
        if (result.success) {
            currentAnalysisData = result;
            displayResults(result);
        } else {
            showError(result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh trong qu√° tr√¨nh ph√¢n t√≠ch');
        }
        
    } catch (error) {
        hideLoading();
        showError('L·ªói k·∫øt n·ªëi: ' + error.message);
    }
}

// AI Pricing Analysis Functions
async function runAIAnalysis() {
    if (!currentAnalysisData || !currentAnalysisData.properties) {
        showError('Vui l√≤ng ch·∫°y Market Analysis tr∆∞·ªõc khi s·ª≠ d·ª•ng AI Analyst');
        return;
    }
    
    const priceThreshold = parseInt(document.getElementById('priceThresholdInput').value) || 500000;
    
    try {
        showAILoading();
        hideAIError();
        
        const response = await fetch('/api/ai_pricing_analysis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                properties: currentAnalysisData.properties,
                price_threshold: priceThreshold
            })
        });
        
        const result = await response.json();
        
        hideAILoading();
        
        if (result.success) {
            displayAIResults(result);
        } else {
            showAIError(result.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh trong AI analysis');
        }
        
    } catch (error) {
        hideAILoading();
        showAIError('L·ªói k·∫øt n·ªëi AI: ' + error.message);
    }
}

function displayAIResults(aiData) {
    console.log('Displaying AI results:', aiData);
    
    // Show AI section
    document.getElementById('aiAnalysisSection').style.display = 'block';
    document.getElementById('aiResultsSection').style.display = 'block';
    
    // Update overview cards
    updateAIOverviewCards(aiData);
    
    // Update pricing opportunities
    updatePricingOpportunities(aiData.ai_analysis?.pricing_opportunities || []);
    
    // Update strategic recommendations
    updateStrategicRecommendations(aiData.ai_analysis?.strategic_recommendations || []);
    
    // Update risk analysis
    updateRiskAnalysis(aiData.ai_analysis?.risk_analysis || {});
    
    // Update actionable insights
    updateActionableInsights(aiData.ai_analysis?.actionable_insights || []);
    
    // Update metadata
    document.getElementById('aiConfidence').textContent = aiData.ai_confidence || 'Medium';
    document.getElementById('aiTimestamp').textContent = new Date(aiData.analysis_timestamp).toLocaleString();
    document.getElementById('aiMethod').textContent = aiData.method || 'gemini_ai_analysis';
    
    // Scroll to AI section
    document.getElementById('aiAnalysisSection').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

function updateAIOverviewCards(aiData) {
    const stats = aiData.segment_statistics || {};
    const market = aiData.ai_analysis?.market_overview || {};
    const competitive = aiData.ai_analysis?.competitive_analysis || {};
    
    const cardsHtml = `
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white h-100">
                <div class="card-body">
                    <i class="fas fa-filter fa-2x mb-2"></i>
                    <h4>${stats.total_properties || 0}</h4>
                    <p class="mb-0">Properties < ${(aiData.price_threshold / 1000).toFixed(0)}k‚Ç´</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white h-100">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h4>${formatPrice(stats.avg_price || 0)}</h4>
                    <p class="mb-0">Avg Budget Price</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white h-100">
                <div class="card-body">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h4>${competitive.competition_level || 'High'}</h4>
                    <p class="mb-0">Competition</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark h-100">
                <div class="card-body">
                    <i class="fas fa-heartbeat fa-2x mb-2"></i>
                    <h4>${market.segment_health || 'Good'}</h4>
                    <p class="mb-0">Segment Health</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('aiOverviewCards').innerHTML = cardsHtml;
}

function updatePricingOpportunities(opportunities) {
    if (!opportunities || opportunities.length === 0) {
        document.getElementById('pricingOpportunities').innerHTML = 
            '<p class="text-muted">Kh√¥ng c√≥ c∆° h·ªôi pricing ƒë∆∞·ª£c x√°c ƒë·ªãnh.</p>';
        return;
    }
    
    const opportunitiesHtml = opportunities.map((opp, index) => `
        <div class="mb-3 p-3 border rounded bg-light">
            <h6 class="text-success">
                <i class="fas fa-lightbulb me-2"></i>${opp.opportunity || 'Opportunity ' + (index + 1)}
            </h6>
            <p class="mb-2"><strong>L√Ω do:</strong> ${opp.rationale || 'N/A'}</p>
            <p class="mb-2"><strong>Th·ª±c hi·ªán:</strong> ${opp.implementation || 'N/A'}</p>
            <p class="mb-0"><strong>T√°c ƒë·ªông:</strong> ${opp.expected_impact || 'N/A'}</p>
        </div>
    `).join('');
    
    document.getElementById('pricingOpportunities').innerHTML = opportunitiesHtml;
}

function updateStrategicRecommendations(recommendations) {
    if (!recommendations || recommendations.length === 0) {
        document.getElementById('strategicRecommendations').innerHTML = 
            '<p class="text-muted">Kh√¥ng c√≥ strategic recommendations.</p>';
        return;
    }
    
    const recommendationsHtml = recommendations.map((rec, index) => {
        const priorityColor = rec.priority === 'High' ? 'danger' : 
                            rec.priority === 'Medium' ? 'warning' : 'success';
        
        return `
            <div class="mb-3 p-3 border rounded bg-light">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>${rec.strategy || 'Strategy ' + (index + 1)}
                    </h6>
                    <span class="badge bg-${priorityColor}">${rec.priority || 'Medium'}</span>
                </div>
                <p class="mb-2"><strong>Th·ªùi gian:</strong> ${rec.timeframe || 'N/A'}</p>
                <p class="mb-0"><strong>Metrics:</strong> ${rec.success_metrics || 'N/A'}</p>
            </div>
        `;
    }).join('');
    
    document.getElementById('strategicRecommendations').innerHTML = recommendationsHtml;
}

function updateRiskAnalysis(riskAnalysis) {
    let riskHtml = '';
    
    if (riskAnalysis.pricing_risks && riskAnalysis.pricing_risks.length > 0) {
        riskHtml += '<h6><i class="fas fa-exclamation-triangle me-2"></i>Pricing Risks:</h6>';
        riskHtml += '<ul class="mb-3">';
        riskAnalysis.pricing_risks.forEach(risk => {
            riskHtml += `<li>${risk}</li>`;
        });
        riskHtml += '</ul>';
    }
    
    if (riskAnalysis.mitigation_strategies && riskAnalysis.mitigation_strategies.length > 0) {
        riskHtml += '<h6><i class="fas fa-shield-alt me-2"></i>Mitigation Strategies:</h6>';
        riskHtml += '<ul class="mb-0">';
        riskAnalysis.mitigation_strategies.forEach(strategy => {
            riskHtml += `<li>${strategy}</li>`;
        });
        riskHtml += '</ul>';
    }
    
    if (!riskHtml) {
        riskHtml = '<p class="text-muted">Kh√¥ng c√≥ risk analysis chi ti·∫øt.</p>';
    }
    
    document.getElementById('riskAnalysis').innerHTML = riskHtml;
}

function updateActionableInsights(insights) {
    if (!insights || insights.length === 0) {
        document.getElementById('actionableInsights').innerHTML = 
            '<p class="text-muted">Kh√¥ng c√≥ actionable insights.</p>';
        return;
    }
    
    const insightsHtml = insights.map((insight, index) => `
        <div class="d-flex align-items-start mb-3">
            <div class="badge bg-info rounded-circle me-3 d-flex align-items-center justify-content-center" 
                 style="width: 30px; height: 30px; font-size: 14px;">
                ${index + 1}
            </div>
            <div class="flex-grow-1">
                <p class="mb-0">${insight}</p>
            </div>
        </div>
    `).join('');
    
    document.getElementById('actionableInsights').innerHTML = insightsHtml;
}

// AI UI Control Functions
function showAILoading() {
    document.getElementById('aiLoadingSection').style.display = 'block';
    document.getElementById('aiResultsSection').style.display = 'none';
    document.getElementById('aiErrorSection').style.display = 'none';
    document.getElementById('aiAnalyzeBtn').disabled = true;
    document.getElementById('aiAnalysisSection').style.display = 'block';
}

function hideAILoading() {
    document.getElementById('aiLoadingSection').style.display = 'none';
    document.getElementById('aiAnalyzeBtn').disabled = false;
}

function showAIError(message) {
    document.getElementById('aiErrorMessage').textContent = message;
    document.getElementById('aiErrorSection').style.display = 'block';
    document.getElementById('aiResultsSection').style.display = 'none';
}

function hideAIError() {
    document.getElementById('aiErrorSection').style.display = 'none';
}

// Auto-trigger AI analysis when market analysis completes successfully
function displayResults(data) {
    const summary = data.summary || {};
    const properties = data.properties || [];
    const insights = data.insights || [];
    const priceRanges = data.price_ranges || {};
    
    // Update summary cards
    updateSummaryCards(summary);
    
    // Update insights
    updateInsights(insights);
    
    // Update properties table
    updatePropertiesTable(properties, summary);
    
    // Update price distribution chart
    updatePriceChart(priceRanges);
    
    // Show results
    document.getElementById('resultsSection').style.display = 'block';
    
    // *** NEW: Auto-trigger AI analysis if we have properties ***
    if (properties && properties.length > 0) {
        // Set reasonable price threshold based on data
        const prices = properties.map(p => p.price_vnd || 0).filter(p => p > 0);
        if (prices.length > 0) {
            const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
            // Set threshold slightly below average to capture budget segment
            const suggestedThreshold = Math.round(avgPrice * 0.8 / 50000) * 50000; // Round to nearest 50k
            document.getElementById('priceThresholdInput').value = Math.max(300000, Math.min(1000000, suggestedThreshold));
        }
        
        // Show AI section with call-to-action
        document.getElementById('aiAnalysisSection').style.display = 'block';
        
        // Auto-run AI analysis after 2 seconds
        setTimeout(() => {
            if (GOOGLE_API_KEY) { // Only if API key is available
                runAIAnalysis();
            }
        }, 2000);
    }
    
    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// Update summary cards
function updateSummaryCards(summary) {
    const cardsHtml = `
        <div class="col-md-3">
            <div class="card text-center summary-card bg-primary text-white">
                <div class="card-body">
                    <i class="fas fa-building fa-2x mb-2"></i>
                    <h4>${summary.total_found || 0}</h4>
                    <p class="mb-0">Properties</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center summary-card bg-success text-white">
                <div class="card-body">
                    <i class="fas fa-coins fa-2x mb-2"></i>
                    <h4>${formatPrice(summary.avg_price || 0)}</h4>
                    <p class="mb-0">Gi√° trung b√¨nh</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center summary-card bg-info text-white">
                <div class="card-body">
                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                    <h4>${formatPrice(summary.median_price || 0)}</h4>
                    <p class="mb-0">Gi√° trung v·ªã</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center summary-card bg-warning text-white">
                <div class="card-body">
                    <i class="fas fa-arrows-alt-v fa-2x mb-2"></i>
                    <h4>${formatPrice(summary.min_price || 0)} - ${formatPrice(summary.max_price || 0)}</h4>
                    <p class="mb-0">Kho·∫£ng gi√°</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('summaryCards').innerHTML = cardsHtml;
}

// Update insights
function updateInsights(insights) {
    const insightsHtml = insights.map(insight => 
        `<div class="insights-item">${insight}</div>`
    ).join('');
    
    document.getElementById('insightsList').innerHTML = insightsHtml || 
        '<p class="text-muted">Kh√¥ng c√≥ insights n√†o ƒë∆∞·ª£c t·∫°o.</p>';
}

// Update properties table
function updatePropertiesTable(properties, summary) {
    const avgPrice = summary.avg_price || 0;
    
    const tbody = document.getElementById('propertiesTableBody');
    const propertyCount = document.getElementById('propertyCount');
    
    propertyCount.textContent = properties.length;
    
    tbody.innerHTML = properties.map(prop => {
        const priceClass = getPriceClass(prop.price_vnd, avgPrice);
        const comparison = getComparisonText(prop.price_vnd, avgPrice);
        
        return `
            <tr>
                <td>
                    <strong>${escapeHtml(prop.name)}</strong>
                    <br><small class="text-muted">${escapeHtml(prop.room_type)}</small>
                </td>
                <td class="${priceClass}">
                    ${prop.price_display}
                </td>
                <td>
                    ${prop.rating !== 'N/A' ? 
                        `<span class="badge bg-warning text-dark">${prop.rating}</span>` : 
                        '<span class="text-muted">N/A</span>'
                    }
                </td>
                <td>
                    <small>${escapeHtml(prop.location || 'N/A')}</small>
                </td>
                <td>
                    <span class="badge bg-light text-dark">${escapeHtml(prop.room_type)}</span>
                </td>
                <td>
                    <small class="${priceClass}">${comparison}</small>
                </td>
            </tr>
        `;
    }).join('');
}

// Update price distribution chart
function updatePriceChart(priceRanges) {
    const ctx = document.getElementById('priceDistributionChart').getContext('2d');
    
    // Destroy existing chart
    if (priceChart) {
        priceChart.destroy();
    }
    
    const labels = Object.keys(priceRanges).map(key => {
        const translations = {
            'budget': 'B√¨nh d√¢n',
            'mid_range': 'Trung c·∫•p', 
            'upscale': 'Cao c·∫•p',
            'luxury': 'Sang tr·ªçng'
        };
        return translations[key] || key;
    });
    
    const data = Object.values(priceRanges).map(range => range.count || 0);
    const percentages = Object.values(priceRanges).map(range => range.percentage || 0);
    
    priceChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#28a745', // Budget - Green
                    '#ffc107', // Mid-range - Yellow
                    '#fd7e14', // Upscale - Orange
                    '#dc3545'  // Luxury - Red
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const percentage = percentages[context.dataIndex] || 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Utility functions
function formatPrice(price) {
    if (!price || price === 0) return '0‚Ç´';
    return (price / 1000).toFixed(0) + 'k‚Ç´';
}

function getPriceClass(price, avgPrice) {
    if (price > avgPrice * 1.5) return 'price-high';
    if (price > avgPrice * 1.1) return 'price-medium';
    if (price < avgPrice * 0.7) return 'price-very-low';
    return 'price-low';
}

function getComparisonText(price, avgPrice) {
    const ratio = price / avgPrice;
    if (ratio > 1.5) return 'üî¥ Cao h∆°n TB 50%+';
    if (ratio > 1.1) return 'üü† Cao h∆°n TB';
    if (ratio < 0.7) return 'üü¢ Th·∫•p h∆°n TB 30%+';
    return 'üü° G·∫ßn TB';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// UI control functions
function showLoading(message = 'ƒêang t·∫£i...') {
    const loadingSection = document.getElementById('loadingSection');
    loadingSection.querySelector('p').textContent = message;
    loadingSection.style.display = 'block';
    
    // Disable form
    document.getElementById('analyzeBtn').disabled = true;
}

function hideLoading() {
    document.getElementById('loadingSection').style.display = 'none';
    document.getElementById('analyzeBtn').disabled = false;
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').style.display = 'block';
}

function hideError() {
    document.getElementById('errorSection').style.display = 'none';
}

function hideResults() {
    document.getElementById('resultsSection').style.display = 'none';
}

function showUrlGuide() {
    new bootstrap.Modal(document.getElementById('urlGuideModal')).show();
}

function refreshAnalysis() {
    if (currentAnalysisData) {
        displayResults(currentAnalysisData);
    }
}

function exportAnalysisData() {
    if (!currentAnalysisData || !currentAnalysisData.properties) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export');
        return;
    }
    
    // Convert to CSV
    const properties = currentAnalysisData.properties;
    const csvContent = "data:text/csv;charset=utf-8," 
        + "T√™n Property,Gi√° (VND),Rating,V·ªã tr√≠,Lo·∫°i ph√≤ng\n"
        + properties.map(prop => 
            `"${prop.name}","${prop.price_vnd}","${prop.rating}","${prop.location}","${prop.room_type}"`
        ).join("\n");
    
    // Download
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `market_analysis_${new Date().getTime()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Auto-load default URL on page load
    loadDefaultUrl();
});
</script>
{% endblock %}
