{% extends "base.html" %}

{% block title %}Dashboard - Hotel Management{% endblock %}

{% block extra_css %}
<style>
/* Mobile Dashboard Optimizations */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 8px !important;
        padding-right: 8px !important;
    }
    
    .card {
        margin-bottom: 8px !important;
    }
    
    .card-body {
        padding: 8px !important;
    }
    
    .card-header {
        padding: 6px 8px !important;
    }
    
    .btn-group .btn {
        padding: 2px 6px !important;
        font-size: 12px !important;
    }
    
    .alert {
        margin-bottom: 8px !important;
        padding: 8px !important;
    }
    
    .row {
        margin-bottom: 8px !important;
    }
    
    /* Compact notification cards on mobile - NO HEIGHT LIMITS */
    .notification-card-mobile {
        /* Removed max-height and overflow restrictions for full visibility */
    }
    
    /* Hide some text on very small screens */
    @media (max-width: 576px) {
        .d-sm-none {
            display: none !important;
        }
        
        .btn-sm {
            padding: 1px 4px !important;
            font-size: 10px !important;
        }
        
        .card-header h6, .card-header h5 {
            font-size: 12px !important;
        }
        
        small, .small {
            font-size: 10px !important;
        }
    }
}

/* Compact layout improvements */
.compact-card {
    border-radius: 8px !important;
}

.compact-card .card-body {
    padding: 12px !important;
}

.notification-item {
    padding: 6px 8px !important;
    margin-bottom: 4px !important;
    border-radius: 6px !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- ‚ö†Ô∏è PIN NOTIFICATION CHO NG√ÄY QU√Å T·∫¢I (FIXED TOP) -->
    {% if overcrowded_days and overcrowded_days|length > 0 %}
    {% set urgent_days = overcrowded_days | selectattr('alert_level', 'equalto', 'urgent') | list %}
    {% set today_overcrowded = overcrowded_days | selectattr('is_today', 'equalto', true) | list %}
    
    <div class="alert alert-warning border-0 shadow-lg mb-0 fixed-top" 
         style="top: 0; z-index: 1050; border-radius: 0 0 10px 10px; background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-exclamation-triangle fa-2x text-white"></i>
                </div>
                <div class="text-white">
                    <div class="fw-bold fs-6 mb-1">
                        ‚ö†Ô∏è C·∫¢NH B√ÅO QU√Å T·∫¢I: {{ overcrowded_days|length }} ng√†y c√≥ >4 kh√°ch
                    </div>
                    <div class="small">
                        {% if today_overcrowded %}
                            <span class="badge bg-danger me-2">H√îM NAY: {{ today_overcrowded[0].guest_count }} kh√°ch</span>
                        {% endif %}
                        {% if urgent_days %}
                            <span class="badge bg-warning text-dark me-2">Kh·∫©n c·∫•p: {{ urgent_days|length }} ng√†y</span>
                        {% endif %}
                        <span class="text-white-75">T·ªëi ƒëa: 4 ph√≤ng c√≥ s·∫µn</span>
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-light btn-sm me-2" onclick="scrollToOvercrowdedSection()">
                    <i class="fas fa-eye me-1"></i>Xem chi ti·∫øt
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="dismissPinNotification()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Spacer ƒë·ªÉ content kh√¥ng b·ªã che b·ªüi fixed notification -->
    <div style="height: 80px;"></div>
    {% endif %}

    <h1 class="mt-4">üìä Dashboard T·ªïng quan</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">T·ªïng quan v·ªÅ hi·ªáu su·∫•t kh√°ch s·∫°n</li>
    </ol>

    <!-- ‚ö° DASHBOARD CONTROLS - Quick Actions -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tools text-primary me-2"></i>
                            <small class="text-muted fw-bold">Dashboard Controls</small>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="refreshDashboardData()" 
                                    data-action="refresh-dashboard"
                                    title="L√†m m·ªõi d·ªØ li·ªáu overdue payment">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Data
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" 
                                    onclick="window.location.reload()" 
                                    title="T·∫£i l·∫°i to√†n b·ªô trang">
                                <i class="fas fa-redo me-1"></i>Reload Page
                            </button>
                            <a href="{{ url_for('view_bookings', show_all='true') }}" 
                               class="btn btn-sm btn-outline-info" 
                               title="Xem t·∫•t c·∫£ booking">
                                <i class="fas fa-list me-1"></i>All Bookings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter"></i>
            T√πy ch·ªânh kho·∫£ng th·ªùi gian
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('dashboard') }}" class="row g-3 align-items-center">
                <div class="col-md-5">
                    <label for="start_date" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-md-5">
                    <label for="end_date" class="form-label">Ng√†y k·∫øt th√∫c</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> L·ªçc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- üîî ARRIVAL & DEPARTURE NOTIFICATIONS (QUICKNOTES STYLE) -->
    {% if arrival_notifications or departure_notifications %}
    <div class="row mb-2">
        <!-- Arrival Notifications -->
        {% if arrival_notifications and arrival_notifications|length > 0 %}
        <div class="col-md-6 mb-2">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-white fw-bold small">
                            <i class="fas fa-plane-arrival me-1"></i>üìú Kh√°ch ƒê·∫øn ({{ arrival_notifications|length }})
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" onclick="copyArrivalTaxiMessage('Kh√°ch')" title="Copy taxi message">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="btn btn-light btn-sm px-2" onclick="editDefaultArrivalTime()" title="Ch·ªânh th·ªùi gian">
                                <i class="fas fa-clock"></i>
                            </button>
                            <small class="text-white ms-2" id="defaultArrivalTime">14:00</small>
                        </div>
                    </div>
                    <div>
                        {% for notification in arrival_notifications %}
                        <div class="bg-white bg-opacity-90 rounded mb-1 px-2 py-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-dark small">{{ notification.guest_name }}</div>
                                    <div class="text-muted" style="font-size: 11px;">
                                        <i class="fas fa-calendar me-1"></i>{{ notification.checkin_date }}
                                        <button class="btn btn-sm p-0 ms-2 text-primary" onclick="editGuestArrivalTime('{{ notification.booking_id }}', '{{ notification.guest_name }}')" title="Ch·ªânh gi·ªù">
                                            <i class="fas fa-clock me-1"></i><span id="time-{{ notification.booking_id }}">14:00</span>
                                        </button>
                                        {% if notification.priority == 'urgent' %}
                                        <span class="badge bg-danger ms-1 px-1" style="font-size: 9px;">H√îM NAY</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark ms-1 px-1" style="font-size: 9px;">MAI</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-success px-1 mb-1" onclick="copyPaymentMessage('{{ notification.guest_name }}', {{ notification.total_amount|float }}, {{ notification['Hoa h·ªìng']|default(0)|float }})" title="Copy payment message">
                                        <i class="fas fa-dollar-sign"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary px-1 mb-1" onclick="copyArrivalTaxiMessage('{{ notification.guest_name }}')" title="Copy taxi message">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <div class="small fw-bold text-success">{{ "{:,.0f}".format(notification.total_amount|float) }}ƒë</div>
                                    <div class="text-muted" style="font-size: 10px;">{{ notification.booking_id }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Departure Notifications -->
        {% if departure_notifications and departure_notifications|length > 0 %}
        <div class="col-md-6 mb-2">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-white fw-bold small">
                            <i class="fas fa-plane-departure me-1"></i>üöñ Kh√°ch ƒêi ({{ departure_notifications|length }})
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" onclick="copyTaxiMessage('Kh√°ch')" title="Copy taxi">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        {% for notification in departure_notifications %}
                        <div class="bg-white bg-opacity-90 rounded mb-1 px-2 py-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-dark small">{{ notification.guest_name }}</div>
                                    <div class="text-muted" style="font-size: 11px;">
                                        <i class="fas fa-calendar me-1"></i>{{ notification.checkout_date }}
                                        {% if notification.priority == 'urgent' %}
                                        <span class="badge bg-danger ms-1 px-1" style="font-size: 9px;">H√îM NAY</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark ms-1 px-1" style="font-size: 9px;">MAI</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-primary px-1" onclick="copyTaxiMessage('{{ notification.guest_name }}')" title="Copy taxi">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <div class="text-muted mt-1" style="font-size: 10px;">{{ notification.booking_id }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Quick Notes Display (ULTRA COMPACT) -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-white fw-bold small">
                            <i class="fas fa-sticky-note me-1"></i>üìù Quick Notes
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" data-bs-toggle="modal" data-bs-target="#quickNotesModal" title="T·∫°o m·ªõi">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-outline-light btn-sm px-2" onclick="syncQuickNotes()" title="Sync">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="quickNotesContainer">
                        <div class="text-center py-1">
                            <small class="text-white">ƒêang t·∫£i...</small>
                        </div>
                    </div>
                    <input type="file" id="quickNotesFileInput" accept=".json" style="display: none;" onchange="handleQuickNotesImport(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- üí∞ MONTHLY EXPENSE TRACKER (COMPACT) -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); min-height: 60px;">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-0 text-white fw-bold small">
                                <i class="fas fa-receipt me-1"></i>üí∞ Chi Ph√≠ Th√°ng
                            </h6>
                            <div id="monthlyExpenseSummary" class="text-white-50 small">
                                <span id="currentMonthText"></span>: <span id="monthlyTotal">ƒêang t·∫£i...</span>
                            </div>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" data-bs-toggle="modal" data-bs-target="#expenseModal" title="Th√™m chi ph√≠">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-outline-light btn-sm px-2" data-bs-toggle="modal" data-bs-target="#expenseReviewModal" title="Xem chi ti·∫øt">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-light btn-sm px-2" onclick="loadMonthlyExpenses()" title="T·∫£i l·∫°i">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ‚ö†Ô∏è KH√ÅCH CH∆ØA THU TI·ªÄN QU√Å H·∫†N (COMPACT) -->
    {% if overdue_unpaid_guests and overdue_unpaid_guests|length > 0 %}
    <div class="card border-0 shadow-sm mb-3" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
        <div class="card-body py-2 px-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-white fw-bold">
                    <i class="fas fa-exclamation-triangle me-1"></i>‚ö†Ô∏è CH∆ØA THU ({{ overdue_unpaid_guests|length }})
                </h6>
                <div class="text-white text-end">
                    <div class="fw-bold">{{ "{:,.0f}".format(overdue_total_amount if overdue_total_amount else 0) }}ƒë</div>
                    <small>T·ªïng ch∆∞a thu</small>
                </div>
            </div>
        
            <div class="table-responsive">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        {% for guest in overdue_unpaid_guests[:5] %}
                        <tr class="bg-white bg-opacity-90">
                            <td class="py-1 px-2">
                                <div class="fw-bold text-dark small">{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', 'N/A') }}</div>
                                <div class="text-muted" style="font-size: 11px;">
                                    {% if guest.get('Check-in Date') %}
                                        {% if guest['Check-in Date'] is string %}
                                            {{ guest['Check-in Date'] }}
                                        {% else %}
                                            {{ guest['Check-in Date'].strftime('%d/%m') if guest['Check-in Date'] else 'N/A' }}
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                    <span class="badge bg-danger ms-1 px-1" style="font-size: 9px;">{{ guest.get('days_overdue', 0) }}d</span>
                                </div>
                            </td>
                            <td class="py-1 px-2 text-end">
                                <div class="fw-bold text-danger small">
                                    {% set amount = guest.get('calculated_total_amount') or guest.get('T·ªïng thanh to√°n', 0) or 0 %}
                                    {{ "{:,.0f}".format(amount) }}ƒë
                                </div>
                                <div class="text-muted" style="font-size: 10px;">
                                    {% set commission = guest.get('Hoa h·ªìng', 0) or 0 %}
                                    {% if commission > 0 %}
                                        <i class="fas fa-percentage me-1"></i>{{ "{:,.0f}".format(commission) }}ƒë
                                        <br>
                                    {% endif %}
                                    {{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', 'N/A') }}
                                </div>
                            </td>
                            <td class="py-1 px-1">
                                <div class="btn-group-vertical btn-group-sm">
                                    {% set booking_id = guest.get('S·ªë ƒë·∫∑t ph√≤ng', '') %}
                                    {% set guest_name = guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', '') %}
                                    {% set total_amount = guest.get('calculated_total_amount') or guest.get('T·ªïng thanh to√°n', 0) or 0 %}
                                    {% set commission = guest.get('Hoa h·ªìng', 0) or 0 %}
                                    {% set room_fee = guest.get('calculated_room_fee') or guest.get('T·ªïng thanh to√°n', 0) or 0 %}
                                    {% set taxi_fee = guest.get('calculated_taxi_fee', 0) or 0 %}
                                    
                                    <button class="btn btn-success btn-sm py-1 px-2" style="font-size: 12px;"
                                            onclick="openCollectModal('{{ booking_id }}', '{{ guest_name }}', {{ total_amount }}, {{ commission }}, {{ room_fee }}, {{ taxi_fee }})">
                                        <i class="fas fa-money-bill-wave me-1"></i>Thu
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm py-1 px-2" style="font-size: 11px;"
                                            onclick="openEditAmountModal('{{ booking_id }}', '{{ guest_name }}', {{ room_fee }}, {{ taxi_fee }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        
            {% if overdue_unpaid_guests|length > 5 %}
            <div class="text-center mt-2">
                <button class="btn btn-outline-light btn-sm" onclick="toggleMoreOverdue()">
                    <i class="fas fa-chevron-down me-1"></i>+{{ overdue_unpaid_guests|length - 5 }}
                </button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ‚ö†Ô∏è C·∫¢NH B√ÅO NG√ÄY QU√Å T·∫¢I (QU√Å 4 KH√ÅCH) -->
    {% if overcrowded_days and overcrowded_days|length > 0 %}
    <div class="alert border-0 shadow-lg mb-4" id="overcrowdedSection" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h4 class="alert-heading text-white mb-2">
                    <i class="fas fa-users me-2"></i>‚ö†Ô∏è C·∫¢NH B√ÅO NG√ÄY QU√Å T·∫¢I
                </h4>
                <p class="text-white mb-0">{{ overcrowded_days|length }} ng√†y c√≥ h∆°n 4 kh√°ch check-in (T·ªëi ƒëa: 4 ph√≤ng)</p>
            </div>
            <div class="text-end">
                <button class="btn btn-light btn-sm" onclick="toggleOvercrowdedDetails()">
                    <i class="fas fa-eye me-1"></i><span id="overcrowdToggleText">Chi ti·∫øt</span>
                </button>
            </div>
        </div>
        
        <!-- Quick Summary -->
        <div class="row mt-3">
            {% set urgent_days = overcrowded_days | selectattr('alert_level', 'equalto', 'urgent') | list %}
            {% set warning_days = overcrowded_days | selectattr('alert_level', 'equalto', 'warning') | list %}
            {% set future_days = overcrowded_days | selectattr('is_future', 'equalto', true) | list %}
            
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ urgent_days|length }}</div>
                        <small class="text-white-75">Kh·∫©n c·∫•p (‚â§3 ng√†y)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ warning_days|length }}</div>
                        <small class="text-white-75">C·∫£nh b√°o (‚â§7 ng√†y)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ future_days|length }}</div>
                        <small class="text-white-75">T∆∞∆°ng lai</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed List (Initially Hidden) -->
        <div id="overcrowdedDetails" style="display: none;" class="mt-3">
            <hr class="text-white-50 my-3">
            <div class="row">
                {% for day in overcrowded_days[:6] %}
                <div class="col-md-6 col-lg-4 mb-2">
                    <div class="card bg-white border-0">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold text-dark">
                                        {% if day.date %}
                                            {{ day.date.strftime('%d/%m/%Y') if day.date.strftime else day.date }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                        
                                        {% if day.is_today %}
                                            <span class="badge bg-danger ms-1">H√îM NAY</span>
                                        {% elif day.days_from_today == 1 %}
                                            <span class="badge bg-warning ms-1">NG√ÄY MAI</span>
                                        {% elif day.days_from_today > 0 and day.days_from_today <= 3 %}
                                            <span class="badge bg-danger ms-1">{{ day.days_from_today }} NG√ÄY N·ªÆA</span>
                                        {% elif day.days_from_today > 0 %}
                                            <span class="badge bg-info ms-1">{{ day.days_from_today }} ng√†y</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-users me-1"></i>{{ day.guest_count }} kh√°ch check-in
                                        <span class="ms-2 badge bg-{{ day.alert_color }}">
                                            {% if day.guest_count > 6 %}
                                                NGHI√äM TR·ªåNG
                                            {% elif day.guest_count > 4 %}
                                                QU√Å T·∫¢I
                                            {% endif %}
                                        </span>
                                    </small>
                                    <div class="fw-bold text-success mt-1">
                                        <i class="fas fa-coins me-1"></i>{{ "{:,.0f}".format(day.daily_total if day.daily_total else 0) }}ƒë
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showDayDetails('{{ day.date }}', {{ day.guest_count }}, {{ day.guest_names|tojson }}, {{ day.booking_ids|tojson }}, {{ day.daily_total if day.daily_total else 0 }}, {{ day.individual_amounts|tojson if day.individual_amounts else [] }})"
                                            title="Xem chi ti·∫øt kh√°ch">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if overcrowded_days|length > 6 %}
            <div class="text-center mt-2">
                <small class="text-white-75">... v√† {{ overcrowded_days|length - 6 }} ng√†y kh√°c</small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}


    <!-- Key Metrics -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">Doanh thu</div>
                            <div class="fs-3 fw-bold">{{ "{:,.0f}".format(total_revenue) }}ƒë</div>
                        </div>
                        <i class="fas fa-coins fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">L∆∞·ª£ng kh√°ch</div>
                            <div class="fs-3 fw-bold">{{ total_guests }}</div>
                        </div>
                        <i class="fas fa-users fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- More metrics can be added here -->
    </div>

    <!-- Charts -->
    <!-- Bi·ªÉu ƒë·ªì doanh thu chuy√™n nghi·ªáp -->
    <div class="row">
        <div class="col-xl-12">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-line me-2"></i>
                            <span class="fw-bold">üìà Doanh thu theo th√°ng (T·∫•t c·∫£ th·ªùi gian)</span>
                        </div>
                        <div class="badge bg-light text-dark">Chi ti·∫øt ƒë·∫ßy ƒë·ªß</div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="monthlyRevenueChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- B·∫£ng chi ti·∫øt v√† ph√¢n t√≠ch -->
    {% if monthly_revenue_with_unpaid %}
    <div class="row">
        <div class="col-xl-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-1 text-primary"></i> 
                        Chi ti·∫øt Doanh thu theo th√°ng (Bao g·ªìm kh√°ch ch∆∞a thu ti·ªÅn)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="border-0">
                                        <i class="fas fa-calendar-alt me-1"></i>Th√°ng
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-check-circle me-1 text-success"></i>ƒê√£ thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-clock me-1 text-warning"></i>Ch∆∞a thu
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-users me-1 text-info"></i>Kh√°ch ch∆∞a thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-coins me-1 text-info"></i>T·ªïng c·ªông
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-percentage me-1 text-primary"></i>T·ª∑ l·ªá thu
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in monthly_revenue_with_unpaid %}
                                <tr class="border-bottom">
                                    <td>
                                        <div class="fw-bold text-primary">{{ row.get('Th√°ng', 'N/A') }}</div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-success">
                                            {{ "{:,.0f}".format(row.get('ƒê√£ thu', 0) | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-danger">
                                            {{ "{:,.0f}".format(row.get('Ch∆∞a thu', 0) | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set uncollected_count = row.get('S·ªë kh√°ch ch∆∞a thu', 0) %}
                                        {% if uncollected_count > 0 %}
                                        <span class="badge bg-warning text-dark">
                                            {{ uncollected_count }} kh√°ch
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> ƒê√£ thu h·∫øt
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% set total = (row.get('ƒê√£ thu', 0) | float) + (row.get('Ch∆∞a thu', 0) | float) %}
                                        <div class="fw-bold text-dark">
                                            {{ "{:,.0f}".format(total) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set collected = row.get('ƒê√£ thu', 0) | float %}
                                        {% set uncollected = row.get('Ch∆∞a thu', 0) | float %}
                                        {% set total = collected + uncollected %}
                                        {% set percentage = (collected / total * 100) if total > 0 else 0 %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if percentage >= 90 %}bg-success{% elif percentage >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ percentage }}%;" 
                                                 aria-valuenow="{{ percentage }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                <small class="fw-bold">{{ "{:.1f}%".format(percentage) }}</small>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-1 text-primary"></i> 
                        Ph√¢n b·ªï theo Ng∆∞·ªùi thu
                    </h6>
                </div>
                <div class="card-body">
                    <div id="collectorChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Thu Ti·ªÅn -->
<div class="modal fade" id="collectPaymentModal" tabindex="-1" aria-labelledby="collectPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="collectPaymentModalLabel">
                    <i class="fas fa-money-bill-wave me-2"></i>Thu Ti·ªÅn Kh√°ch H√†ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="collectPaymentForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n kh√°ch h√†ng:</label>
                        <div class="fw-bold text-primary" id="modalGuestName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ ƒë·∫∑t ph√≤ng:</label>
                        <div class="fw-bold text-muted" id="modalBookingId"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">T·ªïng s·ªë ti·ªÅn c·∫ßn thu:</label>
                        <div class="fw-bold text-danger fs-5" id="modalTotalAmount"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hoa h·ªìng d·ª± ki·∫øn:</label>
                        <div class="fw-bold text-warning fs-6" id="modalCommissionAmount">Ch∆∞a c√≥ th√¥ng tin</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i hoa h·ªìng:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="commissionType" id="hasCommission" value="normal" checked>
                            <label class="form-check-label fw-bold text-warning" for="hasCommission">
                                <i class="fas fa-percentage me-1"></i>C√≥ hoa h·ªìng (b√¨nh th∆∞·ªùng)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="commissionType" id="noCommission" value="none">
                            <label class="form-check-label fw-bold text-muted" for="noCommission">
                                <i class="fas fa-ban me-1"></i>Kh√¥ng c√≥ hoa h·ªìng (0%)
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="collectedAmount" class="form-label">S·ªë ti·ªÅn th·ª±c thu (VND):</label>
                        <input type="number" class="form-control" id="collectedAmount" 
                               placeholder="Nh·∫≠p s·ªë ti·ªÅn ƒë√£ thu" min="0" step="1000">
                        <div class="form-text">C√≥ th·ªÉ thu m·ªôt ph·∫ßn ho·∫∑c to√†n b·ªô s·ªë ti·ªÅn</div>
                    </div>
                    <div class="mb-3">
                        <label for="collectorName" class="form-label">Ng∆∞·ªùi thu ti·ªÅn:</label>
                        <select class="form-select" id="collectorName" required>
                            <option value="">Ch·ªçn ng∆∞·ªùi thu ti·ªÅn</option>
                            <option value="LOC LE">LOC LE</option>
                            <option value="THAO LE">THAO LE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i thu ti·ªÅn:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentType" id="paymentTypeRoom" value="room" checked>
                            <label class="form-check-label fw-bold text-primary" for="paymentTypeRoom">
                                <i class="fas fa-bed me-1"></i>Thu ti·ªÅn ph√≤ng
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Taxi:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hasTaxi" name="hasTaxi">
                            <label class="form-check-label fw-bold text-success" for="hasTaxi">
                                <i class="fas fa-taxi me-1"></i>C√≥ taxi
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="noTaxi" name="noTaxi">
                            <label class="form-check-label fw-bold text-danger" for="noTaxi">
                                <i class="fas fa-ban me-1"></i>Kh√¥ng c√≥ taxi
                            </label>
                        </div>
                    </div>
                    <div class="mb-3" id="taxiAmountGroup" style="display: none;">
                        <label for="taxiAmount" class="form-label">S·ªë ti·ªÅn taxi (VND):</label>
                        <input type="number" class="form-control" id="taxiAmount" 
                               placeholder="Nh·∫≠p s·ªë ti·ªÅn taxi" min="0" step="1000">
                        <div class="form-text">S·ªë ti·ªÅn taxi ri√™ng bi·ªát v·ªõi ti·ªÅn ph√≤ng</div>
                    </div>
                    <div class="mb-3">
                        <label for="paymentNote" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn):</label>
                        <textarea class="form-control" id="paymentNote" rows="2" 
                                  placeholder="Ghi ch√∫ v·ªÅ vi·ªác thu ti·ªÅn..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" id="confirmCollectBtn" onclick="collectPayment()">
                    <i class="fas fa-check me-1"></i>X√°c nh·∫≠n thu ti·ªÅn
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Amount Modal -->
<div class="modal fade" id="editAmountModal" tabindex="-1" aria-labelledby="editAmountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editAmountModalLabel">
                    <i class="fas fa-edit me-2"></i>S·ª≠a S·ªë Ti·ªÅn Kh√°ch H√†ng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAmountForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n kh√°ch h√†ng:</label>
                        <div class="fw-bold text-primary" id="editModalGuestName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ ƒë·∫∑t ph√≤ng:</label>
                        <div class="fw-bold text-muted" id="editModalBookingId"></div>
                    </div>
                    <div class="mb-3">
                        <label for="editRoomAmount" class="form-label">Ti·ªÅn ph√≤ng (VND):</label>
                        <input type="number" class="form-control" id="editRoomAmount" 
                               placeholder="Nh·∫≠p ti·ªÅn ph√≤ng" min="0" step="1000">
                        <div class="form-text">C·∫≠p nh·∫≠t s·ªë ti·ªÅn ph√≤ng c·∫ßn thu</div>
                    </div>
                    <div class="mb-3">
                        <label for="editTaxiAmount" class="form-label">Ti·ªÅn taxi (VND):</label>
                        <input type="number" class="form-control" id="editTaxiAmount" 
                               placeholder="Nh·∫≠p ti·ªÅn taxi" min="0" step="1000">
                        <div class="form-text">C·∫≠p nh·∫≠t s·ªë ti·ªÅn taxi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥)</div>
                    </div>
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <strong>T·ªïng s·ªë ti·ªÅn m·ªõi:</strong> 
                            <span id="editTotalPreview" class="fw-bold">0ƒë</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNote" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn):</label>
                        <textarea class="form-control" id="editNote" rows="2" 
                                  placeholder="L√Ω do thay ƒë·ªïi s·ªë ti·ªÅn..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-warning" id="confirmEditBtn" onclick="updateBookingAmounts()">
                    <i class="fas fa-save me-1"></i>C·∫≠p nh·∫≠t s·ªë ti·ªÅn
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
// ==================== GLOBAL VARIABLES - MUST BE FIRST ====================
var currentEditBookingData = {};
var currentBookingData = {};

// Pass chart data from server to dashboard.js
const monthlyRevenueChartData = {{ monthly_revenue_chart_json | tojson | safe }};
const collectorChartData = {{ collector_chart_json | tojson | safe }};

// Quick Notes functionality
document.addEventListener('DOMContentLoaded', function() {
    // Load QuickNotes asynchronously to prevent blocking
    setTimeout(() => {
        try {
            loadQuickNotesOnDashboard();
        } catch (error) {
            console.error('Failed to load QuickNotes:', error);
            document.getElementById('quickNotesContainer').innerHTML = `
                <div class="text-center py-1">
                    <small class="text-white">L·ªói t·∫£i ghi ch√∫</small>
                </div>
            `;
        }
    }, 50);
    
    // Add event listeners for taxi checkboxes
    const hasTaxiCheckbox = document.getElementById('hasTaxi');
    const noTaxiCheckbox = document.getElementById('noTaxi');
    
    if (hasTaxiCheckbox && noTaxiCheckbox) {
        hasTaxiCheckbox.addEventListener('change', function() {
            const taxiAmountGroup = document.getElementById('taxiAmountGroup');
            if (this.checked) {
                noTaxiCheckbox.checked = false;
                taxiAmountGroup.style.display = 'block';
            } else {
                taxiAmountGroup.style.display = 'none';
            }
        });
        
        noTaxiCheckbox.addEventListener('change', function() {
            if (this.checked) {
                hasTaxiCheckbox.checked = false;
                document.getElementById('taxiAmountGroup').style.display = 'none';
                document.getElementById('taxiAmount').value = '';
            }
        });
    }
});

function openCollectModal(bookingId, guestName, totalAmount, commission, roomFee, taxiFee) {
    // FIXED: Add debug logging and parameter validation
    console.log('[CollectModal] Called with:', {bookingId, guestName, totalAmount, commission, roomFee, taxiFee});
    
    // Validate required parameters
    if (!bookingId || !guestName) {
        console.error('[CollectModal] Missing required parameters');
        alert('‚ö†Ô∏è Missing booking information. Please refresh the page.');
        return;
    }
    
    // Store booking data for later use
    currentBookingData = {
        bookingId: bookingId,
        guestName: guestName,
        totalAmount: totalAmount || 0,
        commission: commission || 0,
        roomFee: roomFee || totalAmount || 0,
        taxiFee: taxiFee || 0
    };
    
    // Reset form
    document.getElementById('collectPaymentForm').reset();
    document.getElementById('hasTaxi').checked = false;
    document.getElementById('noTaxi').checked = false;
    document.getElementById('taxiAmountGroup').style.display = 'none';
    
    // Reset commission type to default
    document.getElementById('hasCommission').checked = true;
    document.getElementById('noCommission').checked = false;
    
    // Populate modal data
    document.getElementById('modalGuestName').textContent = guestName;
    document.getElementById('modalBookingId').textContent = bookingId;
    document.getElementById('modalTotalAmount').textContent = totalAmount.toLocaleString() + 'ƒë';
    
    // Show commission info
    const commissionElement = document.getElementById('modalCommissionAmount');
    if (commission && commission > 0) {
        commissionElement.textContent = commission.toLocaleString() + 'ƒë';
        commissionElement.parentElement.style.display = 'block';
    } else {
        commissionElement.textContent = 'Ch∆∞a c√≥ th√¥ng tin';
        commissionElement.parentElement.style.display = 'block';
    }
    
    // Add event listeners for commission type changes
    document.getElementById('hasCommission').addEventListener('change', function() {
        if (this.checked) {
            updateCommissionDisplay(commission);
        }
    });
    
    document.getElementById('noCommission').addEventListener('change', function() {
        if (this.checked) {
            updateCommissionDisplay(0);
        }
    });
    
    // Set default collected amount to total amount for room payment
    document.getElementById('collectedAmount').value = totalAmount;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('collectPaymentModal'));
    modal.show();
}

// Function to update commission display based on selected type
function updateCommissionDisplay(originalCommission) {
    const commissionElement = document.getElementById('modalCommissionAmount');
    const noCommissionSelected = document.getElementById('noCommission').checked;
    
    if (noCommissionSelected) {
        commissionElement.textContent = '0ƒë (Kh√¥ng c√≥ hoa h·ªìng)';
        commissionElement.className = 'fw-bold text-muted fs-6';
    } else {
        if (originalCommission && originalCommission > 0) {
            commissionElement.textContent = originalCommission.toLocaleString() + 'ƒë';
            commissionElement.className = 'fw-bold text-warning fs-6';
        } else {
            commissionElement.textContent = 'Ch∆∞a c√≥ th√¥ng tin';
            commissionElement.className = 'fw-bold text-warning fs-6';
        }
    }
}

function collectPayment() {
    const hasTaxi = document.getElementById('hasTaxi').checked;
    const noTaxi = document.getElementById('noTaxi').checked;
    const collectorName = document.getElementById('collectorName').value;
    const paymentNote = document.getElementById('paymentNote').value.trim();
    const noCommissionSelected = document.getElementById('noCommission').checked;
    
    let collectedAmount = 0;
    let finalNote = paymentNote;
    let paymentType = 'room';
    let finalCommission = noCommissionSelected ? 0 : currentBookingData.commission;
    
    if (hasTaxi) {
        // Thu ti·ªÅn taxi
        const taxiAmount = parseFloat(document.getElementById('taxiAmount').value) || 0;
        
        if (taxiAmount === 0) {
            alert('‚ùå Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn taxi!');
            return;
        }
        
        collectedAmount = taxiAmount;
        finalNote = paymentNote || 'Thu ti·ªÅn taxi';
        paymentType = 'taxi';
    } else {
        // Thu ti·ªÅn ph√≤ng (m·∫∑c ƒë·ªãnh)
        collectedAmount = parseFloat(document.getElementById('collectedAmount').value) || 0;
        finalNote = paymentNote || 'Thu ti·ªÅn ph√≤ng';
        paymentType = 'room';
    }
    
    // Validation
    if (!collectorName) {
        alert('‚ùå Vui l√≤ng ch·ªçn ng∆∞·ªùi thu ti·ªÅn!');
        return;
    }
    
    if (collectedAmount <= 0) {
        alert('‚ùå S·ªë ti·ªÅn thu kh√¥ng h·ª£p l·ªá!');
        return;
    }
    
    // Disable button and show loading
    const confirmBtn = document.getElementById('confirmCollectBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...';
    confirmBtn.disabled = true;
    
    // Add commission info to note if no commission selected
    if (noCommissionSelected) {
        finalNote += ' (Kh√¥ng c√≥ hoa h·ªìng)';
    }
    
    // Prepare data
    const requestData = {
        booking_id: currentBookingData.bookingId,
        collected_amount: collectedAmount,
        collector_name: collectorName,
        payment_note: finalNote,
        payment_type: paymentType,
        commission_amount: finalCommission,
        commission_type: noCommissionSelected ? 'none' : 'normal'
    };
    
    // Call API
    fetch('/api/collect_payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showDashboardToast(`‚úÖ ${data.message}`, 'success');
            
            // Update dashboard immediately without reload
            updateOverdueGuestsAfterPayment(currentBookingData.bookingId, collectedAmount, paymentType);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('collectPaymentModal'));
            modal.hide();
            
            // FIXED: Add page reload after successful payment to ensure fresh data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    })
    .catch(error => {
        console.error('Collect payment error:', error);
        showDashboardToast(`‚ùå L·ªói: ${error.message}`, 'error');
    })
    .finally(() => {
        // Restore button
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// Update overdue guests section after successful payment
function updateOverdueGuestsAfterPayment(bookingId, collectedAmount, paymentType) {
    // Find and remove the specific guest card
    const guestCards = document.querySelectorAll('.col-md-4');
    let removedGuestCard = null;
    
    guestCards.forEach(card => {
        const bookingIdElement = card.querySelector('small.text-muted:last-child');
        if (bookingIdElement && bookingIdElement.textContent.includes(bookingId)) {
            // Store the guest info before removing
            const guestNameElement = card.querySelector('h6.mb-1');
            const guestName = guestNameElement ? guestNameElement.textContent : 'Unknown';
            
            // Add a fade-out animation
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '0.3';
            card.style.transform = 'scale(0.95)';
            
            // Remove after animation
            setTimeout(() => {
                card.style.display = 'none';
                // Show success feedback
                showDashboardToast(`üí∞ ƒê√£ thu ${collectedAmount.toLocaleString()}ƒë t·ª´ ${guestName}`, 'success');
            }, 500);
            
            removedGuestCard = card;
        }
    });
    
    // Update the total amount and guest count
    setTimeout(() => {
        updateOverdueGuestsSummary(collectedAmount);
        
        // Check if no more overdue guests remain
        const remainingCards = document.querySelectorAll('.col-md-4:not([style*="display: none"])');
        const actualRemainingCards = Array.from(remainingCards).filter(card => {
            return card.style.display !== 'none' && !card.querySelector('h6.mb-1')?.textContent?.includes('N/A');
        });
        
        if (actualRemainingCards.length === 0) {
            // Hide the entire overdue section
            const overdueSection = document.querySelector('.alert.alert-danger');
            if (overdueSection) {
                overdueSection.style.transition = 'all 0.8s ease';
                overdueSection.style.opacity = '0';
                overdueSection.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    overdueSection.style.display = 'none';
                    showDashboardToast('üéâ Kh√¥ng c√≤n kh√°ch n√†o ch∆∞a thu ti·ªÅn!', 'success');
                }, 800);
            }
        }
    }, 600);
}

// Update the summary numbers in overdue section
function updateOverdueGuestsSummary(paidAmount) {
    // Update guest count
    const guestCountElement = document.querySelector('.alert-danger p');
    if (guestCountElement) {
        const currentText = guestCountElement.textContent;
        const currentCount = parseInt(currentText.match(/(\d+)/)?.[1] || '0');
        const newCount = Math.max(0, currentCount - 1);
        
        guestCountElement.textContent = `${newCount} kh√°ch ƒë√£ check-in nh∆∞ng ch∆∞a thu ti·ªÅn`;
    }
    
    // Update total amount
    const totalAmountElement = document.querySelector('.alert-danger .h5');
    if (totalAmountElement) {
        const currentAmountText = totalAmountElement.textContent.replace(/[^\d]/g, '');
        const currentAmount = parseInt(currentAmountText) || 0;
        const newAmount = Math.max(0, currentAmount - paidAmount);
        
        totalAmountElement.textContent = `${newAmount.toLocaleString()}ƒë`;
    }
}

// Update guest card amounts after editing (FIXED - Works with table structure)
function updateGuestCardAmounts(bookingId, newRoomAmount, newTaxiAmount) {
    // Calculate new total
    const newTotal = newRoomAmount + newTaxiAmount;
    
    // Find the guest row in the overdue table
    const overdueTable = document.querySelector('.table-responsive table tbody');
    if (overdueTable) {
        const rows = overdueTable.querySelectorAll('tr');
        
        rows.forEach(row => {
            // Find booking ID in the row (it's in the text-muted div at the end)
            const bookingIdText = row.querySelector('.text-muted');
            if (bookingIdText && bookingIdText.textContent.includes(bookingId)) {
                
                // Update the total amount display (fw-bold text-danger small)
                const totalAmountElement = row.querySelector('.fw-bold.text-danger.small');
                if (totalAmountElement) {
                    // Add update animation
                    totalAmountElement.style.transition = 'all 0.3s ease';
                    totalAmountElement.style.transform = 'scale(1.1)';
                    totalAmountElement.style.color = '#28a745'; // Green for update
                    
                    setTimeout(() => {
                        totalAmountElement.textContent = `${newTotal.toLocaleString()}ƒë`;
                        
                        setTimeout(() => {
                            totalAmountElement.style.transform = 'scale(1)';
                            totalAmountElement.style.color = '#dc3545'; // Back to red
                        }, 200);
                    }, 150);
                }
                
                // Update commission info if exists (shows in the same cell)
                const commissionElement = row.querySelector('.text-muted .fas.fa-percentage');
                if (commissionElement) {
                    const commissionContainer = commissionElement.parentElement;
                    // Keep existing commission or reset if needed
                }
                
                // Update the collect button onclick handler
                const collectButton = row.querySelector('button.btn-success');
                if (collectButton) {
                    const onclickAttr = collectButton.getAttribute('onclick');
                    if (onclickAttr) {
                        // Get guest name from the row
                        const guestNameElement = row.querySelector('.fw-bold.text-dark.small');
                        const guestName = guestNameElement ? guestNameElement.textContent : currentEditBookingData.guestName;
                        
                        // Update the onclick with new amounts
                        const updatedOnclick = onclickAttr.replace(
                            /openCollectModal\([^)]+\)/,
                            `openCollectModal('${bookingId}', '${guestName}', ${newTotal}, 0, ${newRoomAmount}, ${newTaxiAmount})`
                        );
                        collectButton.setAttribute('onclick', updatedOnclick);
                    }
                }
                
                // Update the edit button onclick handler
                const editButton = row.querySelector('button.btn-outline-primary');
                if (editButton) {
                    const onclickAttr = editButton.getAttribute('onclick');
                    if (onclickAttr) {
                        // Get guest name from the row
                        const guestNameElement = row.querySelector('.fw-bold.text-dark.small');
                        const guestName = guestNameElement ? guestNameElement.textContent : currentEditBookingData.guestName;
                        
                        // Update the onclick with new amounts
                        const updatedOnclick = onclickAttr.replace(
                            /openEditAmountModal\([^)]+\)/,
                            `openEditAmountModal('${bookingId}', '${guestName}', ${newRoomAmount}, ${newTaxiAmount})`
                        );
                        editButton.setAttribute('onclick', updatedOnclick);
                    }
                }
                
                console.log(`‚úÖ Updated amounts for ${bookingId}: Room=${newRoomAmount}ƒë, Taxi=${newTaxiAmount}ƒë, Total=${newTotal}ƒë`);
            }
        });
    }
    
    // Update the overdue total summary
    setTimeout(() => {
        recalculateOverdueTotal();
    }, 400);
    
    // Show success feedback
    showDashboardToast(`üìù ƒê√£ c·∫≠p nh·∫≠t s·ªë ti·ªÅn cho ${currentEditBookingData.guestName}`, 'success');
}

// Recalculate total overdue amount from table rows (FIXED)
function recalculateOverdueTotal() {
    const overdueTable = document.querySelector('.table-responsive table tbody');
    let totalAmount = 0;
    let totalGuests = 0;
    
    if (overdueTable) {
        const rows = overdueTable.querySelectorAll('tr');
        
        rows.forEach(row => {
            const amountElement = row.querySelector('.fw-bold.text-danger.small');
            if (amountElement) {
                const amountText = amountElement.textContent.replace(/[^\d]/g, '');
                const amount = parseInt(amountText) || 0;
                if (amount > 0) {
                    totalAmount += amount;
                    totalGuests++;
                }
            }
        });
    }
    
    // Update the header total (in the overdue section header)
    const headerTotalElement = document.querySelector('.card.border-0.shadow-sm .text-white.text-end .fw-bold');
    if (headerTotalElement) {
        headerTotalElement.textContent = `${totalAmount.toLocaleString()}ƒë`;
        console.log(`üìä Updated overdue total: ${totalAmount.toLocaleString()}ƒë for ${totalGuests} guests`);
    }
    
    // Update the guest count in the header title
    const titleElement = document.querySelector('.card.border-0.shadow-sm h6 .text-white.fw-bold');
    if (titleElement) {
        const currentText = titleElement.textContent;
        const updatedText = currentText.replace(/\(\d+\)/, `(${totalGuests})`);
        titleElement.textContent = updatedText;
    }
}

function loadQuickNotesOnDashboard() {
    const container = document.getElementById('quickNotesContainer');
    
    // Try to load from server first, fallback to localStorage
    loadQuickNotesFromServer()
        .then(serverNotes => {
            displayQuickNotes(serverNotes, container);
        })
        .catch(error => {
            console.log('Loading from localStorage as fallback...');
            const localNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            displayQuickNotes(localNotes, container);
        });
}

async function loadQuickNotesFromServer() {
    try {
        const response = await fetch('/api/quick_notes');
        const data = await response.json();
        
        if (data.success && data.notes) {
            // Convert server format to client format
            const convertedNotes = data.notes.map(note => ({
                id: note.id,
                type: note.type,
                content: note.content,
                date: note.date,
                time: note.time,
                guestName: note.guestname || '',
                created_at: note.createdat,
                completed: note.completed === 'true'
            }));
            
            // Also save to localStorage for offline access
            localStorage.setItem('quickNotes', JSON.stringify(convertedNotes));
            
            return convertedNotes;
        } else {
            throw new Error('Failed to load from server');
        }
    } catch (error) {
        console.error('Error loading from server:', error);
        throw error;
    }
}

function displayQuickNotes(notes, container) {
    // Filter active notes (not completed)
    const activeNotes = notes.filter(note => !note.completed);
    
    if (activeNotes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-sticky-note fa-3x text-white-50 mb-3"></i>
                <p class="mb-2 text-white fw-bold">Ch∆∞a c√≥ Quick Notes n√†o</p>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#quickNotesModal">
                    <i class="fas fa-plus me-1"></i>T·∫°o Note ƒë·∫ßu ti√™n
                </button>
            </div>
        `;
        return;
    }
    
    const typeIcons = {
        'thu-tien': 'fas fa-money-bill-wave',
        'huy-phong': 'fas fa-times-circle',
        'taxi': 'fas fa-taxi'
    };
    
    const typeNames = {
        'thu-tien': 'Thu ti·ªÅn l·∫°i',
        'huy-phong': 'H·ªßy ph√≤ng', 
        'taxi': 'Taxi'
    };
    
    const typeColors = {
        'thu-tien': 'success',
        'huy-phong': 'danger',
        'taxi': 'warning'
    };
    
    // Sort by reminder date/time
    activeNotes.sort((a, b) => {
        const dateA = new Date(`${a.date} ${a.time}`);
        const dateB = new Date(`${b.date} ${b.time}`);
        return dateA - dateB;
    });
    
    const notesHtml = activeNotes.map(note => {
        const reminderDate = new Date(`${note.date} ${note.time}`);
        const now = new Date();
        const isOverdue = reminderDate < now;
        const isToday = reminderDate.toDateString() === now.toDateString();
        
        let timeStatus = '';
        if (isOverdue) {
            timeStatus = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Qu√° h·∫°n</span>';
        } else if (isToday) {
            timeStatus = '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>H√¥m nay</span>';
        } else {
            const diffTime = Math.abs(reminderDate - now);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            timeStatus = `<span class="badge bg-info">${diffDays} ng√†y n·ªØa</span>`;
        }
        
        return `
            <div class="col-12 mb-3">
                <div class="card border-0 bg-white shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <i class="${typeIcons[note.type]} text-${typeColors[note.type]} me-2"></i>
                                <strong class="text-dark">${typeNames[note.type]}</strong>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="editQuickNote('${note.id}', '${note.type}', '${note.content.replace(/'/g, "\\'")}', '${note.date}', '${note.time}', '${note.guestName || ""}')" title="S·ª≠a note">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-success btn-sm" onclick="markNoteCompleted('${note.id}')" title="Ho√†n th√†nh v√† x√≥a note">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteQuickNote('${note.id}')" title="X√≥a note">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="bg-light rounded p-3 mb-3">
                            <p class="text-dark mb-0" style="font-size: 16px; line-height: 1.5; font-weight: 500;">${note.content}</p>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>${note.guestName}
                            </small>
                            <div>
                                <small class="text-muted d-block">
                                    <i class="fas fa-calendar me-1"></i>${note.date} ${note.time}
                                </small>
                                ${timeStatus}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="row">
            ${notesHtml}
        </div>
    `;
}


async function markNoteCompleted(noteId) {
    try {
        // Delete from server immediately when marked complete
        const response = await fetch(`/api/quick_notes/${noteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove from localStorage immediately
            let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            notes = notes.filter(note => note.id !== noteId);
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            
            // Show success toast
            showDashboardToast('‚úÖ ƒê√£ ho√†n th√†nh v√† x√≥a note kh·ªèi h·ªá th·ªëng!', 'success');
            
            // Reload notes display
            loadQuickNotesOnDashboard();
        } else {
            throw new Error(data.message || 'Server error');
        }
    } catch (error) {
        console.error('Error completing note:', error);
        showDashboardToast('‚ùå L·ªói khi x√≥a tr√™n server. ƒê√£ x√≥a local.', 'warning');
        
        // Fallback to localStorage only - still delete locally
        let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
        notes = notes.filter(note => note.id !== noteId);
        localStorage.setItem('quickNotes', JSON.stringify(notes));
        loadQuickNotesOnDashboard();
    }
}

async function deleteNoteFromDashboard(noteId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a note n√†y kh·ªèi Google Sheets?')) {
        try {
            // Delete from server first
            const response = await fetch(`/api/quick_notes/${noteId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Also delete from localStorage
                let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
                notes = notes.filter(note => note.id !== noteId);
                localStorage.setItem('quickNotes', JSON.stringify(notes));
                
                showDashboardToast('üóëÔ∏è ƒê√£ x√≥a note kh·ªèi Google Sheets!', 'info');
                loadQuickNotesOnDashboard();
            } else {
                throw new Error(data.message || 'Server error');
            }
        } catch (error) {
            console.error('Error deleting note:', error);
            showDashboardToast('‚ùå L·ªói khi x√≥a tr√™n server. ƒê√£ x√≥a local.', 'warning');
            
            // Fallback to localStorage only
            let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            notes = notes.filter(note => note.id !== noteId);
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            loadQuickNotesOnDashboard();
        }
    }
}

// Export Quick Notes to JSON file
function exportQuickNotes() {
    const notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
    
    if (notes.length === 0) {
        showDashboardToast('‚ö†Ô∏è Kh√¥ng c√≥ notes n√†o ƒë·ªÉ export!', 'warning');
        return;
    }
    
    // Create export data
    const exportData = {
        exportDate: new Date().toISOString(),
        totalNotes: notes.length,
        quickNotes: notes
    };
    
    // Create and download file
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `quick-notes-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showDashboardToast('üì• ƒê√£ export Quick Notes th√†nh c√¥ng!', 'success');
}

// Import Quick Notes from JSON file
function importQuickNotes() {
    document.getElementById('quickNotesFileInput').click();
}

function handleQuickNotesImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.json')) {
        showDashboardToast('‚ùå Vui l√≤ng ch·ªçn file JSON!', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Validate data structure
            if (!importedData.quickNotes || !Array.isArray(importedData.quickNotes)) {
                throw new Error('Invalid file format');
            }
            
            // Get existing notes
            const existingNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            
            // Ask user how to handle import
            const choice = confirm(
                `T√¨m th·∫•y ${importedData.quickNotes.length} notes trong file.\n\n` +
                `B·∫°n c√≥ ${existingNotes.length} notes hi·ªán t·∫°i.\n\n` +
                `Nh·∫•n OK ƒë·ªÉ THAY TH·∫æ t·∫•t c·∫£ notes hi·ªán t·∫°i\n` +
                `Nh·∫•n Cancel ƒë·ªÉ H·ª¶Y import`
            );
            
            if (choice) {
                // Replace all notes
                localStorage.setItem('quickNotes', JSON.stringify(importedData.quickNotes));
                loadQuickNotesOnDashboard();
                showDashboardToast(`‚úÖ ƒê√£ import ${importedData.quickNotes.length} notes th√†nh c√¥ng!`, 'success');
            } else {
                showDashboardToast('‚ùå ƒê√£ h·ªßy import', 'info');
            }
            
        } catch (error) {
            console.error('Import error:', error);
            showDashboardToast('‚ùå L·ªói ƒë·ªçc file! Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.', 'error');
        }
    };
    
    reader.readAsText(file);
    // Reset file input
    event.target.value = '';
}

// Sync Quick Notes from Google Sheets
async function syncQuickNotes() {
    const syncBtn = document.querySelector('button[onclick="syncQuickNotes()"]');
    const originalHtml = syncBtn.innerHTML;
    
    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang sync...';
    syncBtn.disabled = true;
    
    try {
        const serverNotes = await loadQuickNotesFromServer();
        showDashboardToast(`‚òÅÔ∏è ƒê√£ sync ${serverNotes.length} notes t·ª´ Google Sheets!`, 'success');
        loadQuickNotesOnDashboard();
    } catch (error) {
        console.error('Sync error:', error);
        showDashboardToast('‚ùå L·ªói khi sync t·ª´ Google Sheets!', 'error');
    } finally {
        syncBtn.innerHTML = originalHtml;
        syncBtn.disabled = false;
    }
}

function refreshQuickNotes() {
    const refreshBtn = document.querySelector('button[onclick="refreshQuickNotes()"]');
    const originalHtml = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫£i...';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        loadQuickNotesOnDashboard();
        refreshBtn.innerHTML = originalHtml;
        refreshBtn.disabled = false;
        showDashboardToast('üîÑ ƒê√£ l√†m m·ªõi Quick Notes!', 'info');
    }, 500);
}

function showDashboardToast(message, type = 'success') {
    const colors = {
        success: 'bg-success',
        error: 'bg-danger', 
        info: 'bg-info',
        warning: 'bg-warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 end-0 m-3 p-3 ${colors[type]} text-white rounded`;
    toast.style.zIndex = '9999';
    toast.innerHTML = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ==================== PIN NOTIFICATION FUNCTIONS ====================
function scrollToOvercrowdedSection() {
    const section = document.getElementById('overcrowdedSection');
    if (section) {
        section.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        
        // Highlight the section briefly
        section.style.boxShadow = '0 0 20px rgba(255, 149, 0, 0.8)';
        setTimeout(() => {
            section.style.boxShadow = '';
        }, 2000);
    }
}

function dismissPinNotification() {
    const notification = document.querySelector('.fixed-top.alert-warning');
    const spacer = notification?.nextElementSibling;
    
    if (notification) {
        notification.style.transform = 'translateY(-100%)';
        setTimeout(() => {
            notification.remove();
            if (spacer && spacer.style.height === '80px') {
                spacer.remove();
            }
        }, 300);
        
        // Save dismiss state for this session
        sessionStorage.setItem('overcrowdedPinDismissed', 'true');
        showDashboardToast('‚ÑπÔ∏è Notification ƒë√£ ƒë∆∞·ª£c ·∫©n cho phi√™n n√†y', 'info');
    }
}

// Check if pin notification should be shown
document.addEventListener('DOMContentLoaded', function() {
    const dismissed = sessionStorage.getItem('overcrowdedPinDismissed');
    const pinNotification = document.querySelector('.fixed-top.alert-warning');
    
    if (dismissed === 'true' && pinNotification) {
        pinNotification.style.display = 'none';
        const spacer = pinNotification.nextElementSibling;
        if (spacer && spacer.style.height === '80px') {
            spacer.style.display = 'none';
        }
    }
});

// Toggle overcrowded details section
function toggleOvercrowdedDetails() {
    const details = document.getElementById('overcrowdedDetails');
    const toggleText = document.getElementById('overcrowdToggleText');
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        toggleText.textContent = '·∫®n chi ti·∫øt';
    } else {
        details.style.display = 'none';
        toggleText.textContent = 'Chi ti·∫øt';
    }
}

// Show day details modal
function showDayDetails(date, guestCount, guestNames, bookingIds, dailyTotal, individualAmounts) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-calendar-day me-2"></i>Chi ti·∫øt doanh thu ng√†y: ${date}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <strong><i class="fas fa-coins me-2"></i>T·ªïng doanh thu:</strong> 
                        <span class="fs-5 fw-bold">${dailyTotal ? dailyTotal.toLocaleString() : '0'}ƒë</span>
                        <small class="text-muted ms-2">(${guestCount} kh√°ch check-in)</small>
                    </div>
                    <h6><i class="fas fa-list me-2"></i>Danh s√°ch kh√°ch v√† s·ªë ti·ªÅn:</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>T√™n kh√°ch</th>
                                    <th>S·ªë ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${guestNames.map((name, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${name}</strong></td>
                                        <td><span class="badge bg-success fs-6">${individualAmounts && individualAmounts[index] ? individualAmounts[index].toLocaleString() : '0'}ƒë</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>Doanh thu t√≠nh theo ng√†y check-in
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

// === QUICK NOTES MODAL FUNCTIONS ===
function openQuickNotesModal() {
    document.getElementById('quickNotesModal').modal('show');
}

function saveQuickNote() {
    const noteType = document.getElementById('noteType').value;
    const noteContent = document.getElementById('noteContent').value;
    const noteDate = document.getElementById('noteDate').value;
    const noteTime = document.getElementById('noteTime').value;
    const editId = document.getElementById('quickNotesForm').getAttribute('data-edit-id');
    
    // FIXED: Debug what we're getting from the form
    console.log('[SaveQuickNote] Form values:', {
        noteType, noteContent, noteDate, noteTime, editId,
        hasNoteType: !!noteType,
        hasNoteContent: !!noteContent,
        activeButtons: document.querySelectorAll('.note-type-btn.active').length
    });
    
    if (!noteType || !noteContent || !noteDate || !noteTime) {
        console.log('‚ùå QuickNote validation failed: Missing required fields');
        console.log(`Debug: noteType="${noteType}", noteContent="${noteContent}", noteDate="${noteDate}", noteTime="${noteTime}"`);
        // Show non-blocking error feedback
        const submitBtn = document.querySelector('#quickNotesModal .btn-primary');
        if (submitBtn) {
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚ö†Ô∏è Thi·∫øu th√¥ng tin';
            submitBtn.className = 'btn btn-warning';
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.className = 'btn btn-primary';
            }, 2000);
        }
        return;
    }
    
    // FIXED: Additional validation for empty strings
    if (noteType.trim() === '' || noteContent.trim() === '') {
        console.log('‚ùå QuickNote validation failed: Empty strings');
        alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin! H√£y ch·ªçn lo·∫°i ghi ch√∫ v√† nh·∫≠p n·ªôi dung.');
        return;
    }
    
    // FIXED: Fallback - try to get note type from active button if form field is empty
    if (!noteType || noteType.trim() === '') {
        const activeButton = document.querySelector('.note-type-btn.active');
        if (activeButton) {
            const onclickAttr = activeButton.getAttribute('onclick');
            if (onclickAttr && onclickAttr.includes('selectNoteType')) {
                const match = onclickAttr.match(/selectNoteType\('([^']+)'\)/);
                if (match) {
                    document.getElementById('noteType').value = match[1];
                    console.log(`[SaveQuickNote] Fixed noteType from button: ${match[1]}`);
                }
            }
        }
    }
    
    const isEditing = !!editId;
    
    const noteData = {
        id: editId || Date.now().toString(),
        type: noteType,
        content: noteContent,
        date: noteDate,
        time: noteTime,
        guest_name: isEditing ? (document.getElementById('quickNotesForm').getAttribute('data-guest-name') || '') : '', // Use stored guest name for edits
        completed: false, // Explicitly set as not completed
        created_at: new Date().toISOString()
    };
    
    // FIXED: Add debug logging for troubleshooting
    console.log(`[QuickNote] ${isEditing ? 'Editing' : 'Creating'} note:`, noteData);
    
    // Save to localStorage
    let savedNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
    if (isEditing) {
        // Update existing note
        const noteIndex = savedNotes.findIndex(note => note.id === editId);
        if (noteIndex !== -1) {
            savedNotes[noteIndex] = noteData;
        }
    } else {
        // Add new note
        savedNotes.unshift(noteData);
    }
    localStorage.setItem('quickNotes', JSON.stringify(savedNotes));
    
    // Send to server (different endpoints for create vs edit)
    const apiUrl = isEditing ? `/api/quick_notes/${editId}` : '/api/quick_notes';
    const method = isEditing ? 'PUT' : 'POST';
    
    fetch(apiUrl, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(noteData)
    })
    .then(response => {
        console.log(`[QuickNote] API Response Status: ${response.status}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log(`[QuickNote] API Response Data:`, data);
        if (data.success) {
            console.log(`Note ${isEditing ? 'updated' : 'saved'} to Google Sheets successfully`);
            showDashboardToast(`‚úÖ ƒê√£ ${isEditing ? 'c·∫≠p nh·∫≠t' : 'l∆∞u'} quick note v√†o Google Sheets!`, 'success');
            
            // FIXED: Close modal and reload to show fresh data
            const modal = bootstrap.Modal.getInstance(document.getElementById('quickNotesModal'));
            if (modal) modal.hide();
            
            setTimeout(() => {
                loadQuickNotesOnDashboard();
            }, 500);
        } else {
            console.error('Server save failed:', data.message || data.error || 'Unknown error');
            showDashboardToast(`‚ö†Ô∏è ƒê√£ ${isEditing ? 'c·∫≠p nh·∫≠t' : 'l∆∞u'} local, nh∆∞ng l·ªói khi sync l√™n Google Sheets: ${data.message || data.error || 'Unknown error'}`, 'warning');
        }
    })
    .catch(error => {
        console.error('Error saving to server:', error);
        showDashboardToast(`‚ö†Ô∏è ƒê√£ l∆∞u local, nh∆∞ng l·ªói khi sync l√™n Google Sheets: ${error.message}`, 'warning');
    });
    
    // Reset form (non-blocking)
    setTimeout(() => {
        try {
            document.getElementById('quickNotesForm').reset();
            document.getElementById('noteDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('noteTime').value = new Date().toTimeString().slice(0, 5);
        } catch (e) {
            console.error('QuickNotes form reset error:', e);
        }
    }, 50);
    
    // Close modal with enhanced safety (non-blocking)
    setTimeout(() => {
        try {
            const modalElement = document.getElementById('quickNotesModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            
            if (modal) {
                modal.hide();
            } else {
                // Enhanced fallback for modal cleanup
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
                
                // Clean up body and backdrop
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Remove all backdrops
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
            }
        } catch (e) {
            console.error('QuickNotes modal close error:', e);
            // Force cleanup if all else fails
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
        }
    }, 100);
    
    // Refresh notes display (non-blocking)
    setTimeout(() => {
        try {
            loadQuickNotesOnDashboard();
        } catch (error) {
            console.error('Error refreshing QuickNotes display:', error);
        }
    }, 150);
}

// Edit Quick Note function
function editQuickNote(noteId, noteType, noteContent, noteDate, noteTime, guestName) {
    // Populate the form with existing data
    document.getElementById('noteType').value = noteType;
    document.getElementById('noteContent').value = noteContent;
    document.getElementById('noteDate').value = noteDate;
    document.getElementById('noteTime').value = noteTime;
    
    // Store the guest name and edit ID in form attributes
    document.getElementById('quickNotesForm').setAttribute('data-edit-id', noteId);
    document.getElementById('quickNotesForm').setAttribute('data-guest-name', guestName || '');
    
    // Set note type visually
    document.querySelectorAll('.note-type-btn').forEach(btn => {
        btn.classList.remove('active', 'btn-primary', 'btn-outline-success', 'btn-outline-danger', 'btn-outline-warning');
        if (btn.getAttribute('onclick').includes(noteType)) {
            btn.classList.add('active', 'btn-primary');
        } else {
            // Restore original colors
            if (noteType === 'thu-tien') btn.classList.add('btn-outline-success');
            else if (noteType === 'huy-phong') btn.classList.add('btn-outline-danger');
            else if (noteType === 'taxi') btn.classList.add('btn-outline-warning');
        }
    });
    
    // Change modal title
    document.getElementById('quickNotesModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>S·ª≠a Quick Note';
    
    // Change save button text
    const saveBtn = document.querySelector('#quickNotesModal .btn-primary');
    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>C·∫≠p nh·∫≠t Note';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('quickNotesModal'));
    modal.show();
}

// Delete Quick Note function
async function deleteQuickNote(noteId) {
    if (!confirm('‚ùå B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a note n√†y?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
        return;
    }
    
    try {
        // Delete from server first
        const response = await fetch(`/api/quick_notes/${noteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Also delete from localStorage
            let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            notes = notes.filter(note => note.id !== noteId);
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            
            showDashboardToast('üóëÔ∏è ƒê√£ x√≥a note th√†nh c√¥ng!', 'success');
            loadQuickNotesOnDashboard();
        } else {
            throw new Error(data.message || 'Server error');
        }
    } catch (error) {
        console.error('Error deleting note:', error);
        showDashboardToast('‚ùå L·ªói khi x√≥a note: ' + error.message, 'error');
        
        // Fallback to localStorage only
        let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
        notes = notes.filter(note => note.id !== noteId);
        localStorage.setItem('quickNotes', JSON.stringify(notes));
        loadQuickNotesOnDashboard();
    }
}

// Reset Quick Notes modal when closed
document.getElementById('quickNotesModal').addEventListener('hidden.bs.modal', function() {
    // Reset form
    document.getElementById('quickNotesForm').reset();
    document.getElementById('quickNotesForm').removeAttribute('data-edit-id');
    document.getElementById('quickNotesForm').removeAttribute('data-guest-name');
    
    // Reset modal title
    document.getElementById('quickNotesModalLabel').innerHTML = '<i class="fas fa-sticky-note me-2"></i>T·∫°o Quick Note';
    
    // Reset save button text
    const saveBtn = document.querySelector('#quickNotesModal .btn-primary');
    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>L∆∞u Quick Note';
    
    // Reset note type buttons
    document.querySelectorAll('.note-type-btn').forEach(btn => {
        btn.classList.remove('active', 'btn-primary');
    });
    
    // Clear note type
    document.getElementById('noteType').value = '';
});

function selectNoteType(type) {
    document.getElementById('noteType').value = type;
    
    // Update button styles
    document.querySelectorAll('.note-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Set default content based on type
    const contentField = document.getElementById('noteContent');
    switch(type) {
        case 'thu-tien':
            contentField.value = 'Thu ti·ªÅn t·ª´ kh√°ch: ';
            break;
        case 'huy-phong':
            contentField.value = 'H·ªßy ph√≤ng cho kh√°ch: ';
            break;
        case 'taxi':
            contentField.value = 'ƒê·∫∑t taxi cho kh√°ch: ';
            break;
        default:
            contentField.value = '';
    }
    contentField.focus();
}

// ==================== EDIT AMOUNT MODAL FUNCTIONS ====================
// currentEditBookingData declared at top of script

function openEditAmountModal(bookingId, guestName, roomFee, taxiFee) {
    // FIXED: Add debug logging and parameter validation
    console.log('[EditAmount] Called with:', {bookingId, guestName, roomFee, taxiFee});
    
    // Validate required parameters
    if (!bookingId || !guestName) {
        console.error('[EditAmount] Missing required parameters');
        alert('‚ö†Ô∏è Missing booking information. Please refresh the page.');
        return;
    }
    
    // Store booking data for editing
    currentEditBookingData = {
        bookingId: bookingId,
        guestName: guestName,
        roomFee: roomFee || 0,
        taxiFee: taxiFee || 0
    };
    
    // Reset form
    document.getElementById('editAmountForm').reset();
    
    // Populate modal data
    document.getElementById('editModalGuestName').textContent = guestName;
    document.getElementById('editModalBookingId').textContent = bookingId;
    document.getElementById('editRoomAmount').value = roomFee || 0;
    document.getElementById('editTaxiAmount').value = taxiFee || 0;
    
    // Update total preview
    updateTotalPreview();
    
    // Add event listeners for real-time total calculation
    document.getElementById('editRoomAmount').addEventListener('input', updateTotalPreview);
    document.getElementById('editTaxiAmount').addEventListener('input', updateTotalPreview);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editAmountModal'));
    modal.show();
}

function updateTotalPreview() {
    const roomAmount = parseFloat(document.getElementById('editRoomAmount').value) || 0;
    const taxiAmount = parseFloat(document.getElementById('editTaxiAmount').value) || 0;
    const total = roomAmount + taxiAmount;
    
    document.getElementById('editTotalPreview').textContent = total.toLocaleString() + 'ƒë';
}

function updateBookingAmounts() {
    const roomAmount = parseFloat(document.getElementById('editRoomAmount').value) || 0;
    const taxiAmount = parseFloat(document.getElementById('editTaxiAmount').value) || 0;
    const editNote = document.getElementById('editNote').value.trim();
    
    // Validation
    if (roomAmount < 0 || taxiAmount < 0) {
        alert('‚ùå S·ªë ti·ªÅn kh√¥ng th·ªÉ √¢m!');
        return;
    }
    
    if (roomAmount === 0 && taxiAmount === 0) {
        alert('‚ùå Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt kho·∫£n ti·ªÅn!');
        return;
    }
    
    // Disable button and show loading
    const confirmBtn = document.getElementById('confirmEditBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang c·∫≠p nh·∫≠t...';
    confirmBtn.disabled = true;
    
    // Prepare update data for the new API endpoint
    const updateData = {
        booking_id: currentEditBookingData.bookingId,
        room_amount: roomAmount,
        taxi_amount: taxiAmount,
        edit_note: editNote
    };
    
    console.log('Sending update data:', updateData);
    
    // Call the correct API endpoint for updating guest amounts
    fetch('/api/update_guest_amounts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - close modal and update display immediately
            showDashboardToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t s·ªë ti·ªÅn th√†nh c√¥ng!', 'success');
            
            // Update the guest card immediately
            updateGuestCardAmounts(currentEditBookingData.bookingId, roomAmount, taxiAmount);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAmountModal'));
            modal.hide();
            
            // FIXED: Add page reload after successful update to ensure fresh data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    })
    .catch(error => {
        console.error('Update amounts error:', error);
        showDashboardToast(`‚ùå L·ªói c·∫≠p nh·∫≠t: ${error.message}`, 'error');
    })
    .finally(() => {
        // Restore button
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// ===== ARRIVAL & DEPARTURE NOTIFICATION FUNCTIONS =====

function createArrivalNotification() {
    // Quick action for arrival notifications
    const message = prompt("Nh·∫≠p tin nh·∫Øn ch√†o m·ª´ng cho kh√°ch ƒë·∫øn:", 
                          "Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi kh√°ch s·∫°n! Ph√≤ng ƒë√£ s·∫µn s√†ng. Vui l√≤ng li√™n h·ªá reception ƒë·ªÉ check-in.");
    
    if (message) {
        // Here you could send to messaging system or create a reminder
        showDashboardToast(`‚úÖ ƒê√£ t·∫°o th√¥ng b√°o ch√†o m·ª´ng kh√°ch ƒë·∫øn!`, 'success');
        
        // Optional: You could integrate with your messaging templates here
        console.log('Arrival notification created:', message);
    }
}

async function editDefaultArrivalTime() {
    const currentTime = document.getElementById('defaultArrivalTime').textContent;
    const newTime = prompt('Nh·∫≠p th·ªùi gian check-in m·∫∑c ƒë·ªãnh (HH:MM):', currentTime);
    
    if (newTime && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(newTime)) {
        try {
            // Save to server first
            const response = await fetch('/api/arrival_times', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'default',
                    time: newTime
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update UI after successful server save
                document.getElementById('defaultArrivalTime').textContent = newTime;
                
                // Update all guest times to new default (only visual, guests keep their custom times)
                const timeElements = document.querySelectorAll('[id^="time-"]');
                timeElements.forEach(el => {
                    // Only update if guest doesn't have custom time
                    const bookingId = el.id.replace('time-', '');
                    const guestTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
                    if (!guestTimes[bookingId]) {
                        el.textContent = newTime;
                    }
                });
                
                showDashboardToast(`‚è∞ ƒê√£ l∆∞u th·ªùi gian m·∫∑c ƒë·ªãnh: ${newTime} (sync t·∫•t c·∫£ thi·∫øt b·ªã)`, 'success');
                
                // Also save to localStorage as backup
                localStorage.setItem('defaultArrivalTime', newTime);
            } else {
                throw new Error(result.message || 'Server error');
            }
        } catch (error) {
            console.error('Error saving default time:', error);
            showDashboardToast('‚ùå L·ªói l∆∞u server. Ch·ªâ l∆∞u tr√™n thi·∫øt b·ªã n√†y.', 'warning');
            
            // Fallback to localStorage only
            document.getElementById('defaultArrivalTime').textContent = newTime;
            localStorage.setItem('defaultArrivalTime', newTime);
        }
    } else if (newTime) {
        showDashboardToast('‚ùå ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng h·ª£p l·ªá! S·ª≠ d·ª•ng HH:MM', 'error');
    }
}

async function editGuestArrivalTime(bookingId, guestName) {
    const currentTimeElement = document.getElementById(`time-${bookingId}`);
    const currentTime = currentTimeElement.textContent;
    const newTime = prompt(`Nh·∫≠p th·ªùi gian ƒë·∫øn cho ${guestName} (HH:MM):`, currentTime);
    
    if (newTime && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(newTime)) {
        try {
            // Save to server first
            const response = await fetch('/api/arrival_times', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'guest',
                    booking_id: bookingId,
                    time: newTime
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update UI after successful server save
                currentTimeElement.textContent = newTime;
                showDashboardToast(`‚è∞ ƒê√£ l∆∞u th·ªùi gian cho ${guestName}: ${newTime} (sync t·∫•t c·∫£ thi·∫øt b·ªã)`, 'success');
                
                // Also save to localStorage as backup
                const guestTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
                guestTimes[bookingId] = newTime;
                localStorage.setItem('guestArrivalTimes', JSON.stringify(guestTimes));
            } else {
                throw new Error(result.message || 'Server error');
            }
        } catch (error) {
            console.error('Error saving guest time:', error);
            showDashboardToast('‚ùå L·ªói l∆∞u server. Ch·ªâ l∆∞u tr√™n thi·∫øt b·ªã n√†y.', 'warning');
            
            // Fallback to localStorage only
            currentTimeElement.textContent = newTime;
            const guestTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
            guestTimes[bookingId] = newTime;
            localStorage.setItem('guestArrivalTimes', JSON.stringify(guestTimes));
        }
    } else if (newTime) {
        showDashboardToast('‚ùå ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng h·ª£p l·ªá! S·ª≠ d·ª•ng HH:MM', 'error');
    }
}

function copyTaxiMessage(guestName) {
    // Sample taxi message template
    const message = `Hi ${guestName}, If you need a taxi to the airport tomorrow, please don't hesitate to let me know. I can arrange one for you at a special discounted rate that our guests often appreciate.`;
    
    // Copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(message).then(() => {
            showDashboardToast(`üìã ƒê√£ copy tin nh·∫Øn taxi cho ${guestName}!`, 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            // Fallback method
            fallbackCopy(message, guestName);
        });
    } else {
        // Fallback for older browsers
        fallbackCopy(message, guestName);
    }
}

function fallbackCopy(text, guestName) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showDashboardToast(`üìã ƒê√£ copy tin nh·∫Øn taxi cho ${guestName}!`, 'success');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        alert(`Tin nh·∫Øn taxi cho ${guestName}:\n\n${text}`);
    }
    
    document.body.removeChild(textArea);
}

function copyArrivalTaxiMessage(guestName) {
    // Arrival taxi message template with custom content
    const message = `Hi ${guestName}, Have you arranged transportation from the airport yet? I have a driver who offers cheap taxi rates. Would you like me to book it for you? If you'd like to confirm the booking, kindly let me know. It's only 280,000 VND. That's cheaper than usual because I have my own driver ready available at the airport. You're welcome to check normal prices and compare. Please feel free to message me if you need anything, and I'll arrange a driver for you right at the airport.`;
    
    // Copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(message).then(() => {
            showDashboardToast(`üöï ƒê√£ copy tin nh·∫Øn taxi ƒë√≥n s√¢n bay cho ${guestName}!`, 'success');
        }).catch(err => {
            console.error('Failed to copy arrival taxi message:', err);
            // Fallback method
            fallbackCopyArrivalTaxi(message, guestName);
        });
    } else {
        // Fallback for older browsers
        fallbackCopyArrivalTaxi(message, guestName);
    }
}

function fallbackCopyArrivalTaxi(text, guestName) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showDashboardToast(`üöï ƒê√£ copy tin nh·∫Øn taxi ƒë√≥n s√¢n bay cho ${guestName}!`, 'success');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        alert(`Tin nh·∫Øn taxi ƒë√≥n s√¢n bay cho ${guestName}:\n\n${text}`);
    }
    
    document.body.removeChild(textArea);
}

// Commission calculation and payment message copy function
function calculateCommissionDiscount(totalAmount, commissionFromApp) {
    // Use the actual commission amount from app data
    const actualCommission = commissionFromApp || 0;
    
    // Calculate 35% discount FROM the actual commission
    const commissionDiscount = Math.round(actualCommission * 0.35);
    
    // Amount after commission discount
    const afterCommissionDiscount = totalAmount - commissionDiscount;
    
    // Round to nice numbers
    const roundedFinalAmount = roundToNiceAmount(afterCommissionDiscount);
    
    // Total discount = original - rounded final amount
    const totalDiscount = totalAmount - roundedFinalAmount;
    
    return {
        originalTotal: totalAmount,
        actualCommission: actualCommission,
        commissionDiscount: commissionDiscount,
        afterCommissionDiscount: afterCommissionDiscount,
        roundedFinalAmount: roundedFinalAmount,
        totalDiscount: totalDiscount
    };
}

function roundToNiceAmount(amount) {
    // ALWAYS round DOWN to give customer better discount
    // Round down to nearest 100k for clean amounts
    return Math.floor(amount / 100000) * 100000;
}

function copyPaymentMessage(guestName, totalAmount, commissionAmount) {
    try {
        // Calculate commission discount using actual app data
        const calculation = calculateCommissionDiscount(totalAmount, commissionAmount);
        
        // Format numbers with thousand separators
        const formattedDiscount = calculation.totalDiscount.toLocaleString();
        const discountUSD = (calculation.totalDiscount / 25000).toFixed(2); // Approximate VND to USD conversion
        const formattedFinalAmount = calculation.roundedFinalAmount.toLocaleString();
        
        // Create payment message template
        const message = `Hi ${guestName} Regarding payment, I can offer you a ${formattedDiscount} VND (approx. $${discountUSD} USD) discount if you're comfortable paying me directly in cash for the room, rather than through the booking platform. Your total would be ${formattedFinalAmount} VND instead. This is just an option, of course ‚Äì no pressure at all! Please let me know if you're interested. If you agree to this, I will then cancel your reservation on the booking app.`;
        
        // Copy to clipboard using the same method as taxi message
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(message).then(() => {
                showDashboardToast(`üí∞ ƒê√£ copy tin nh·∫Øn thanh to√°n cho ${guestName}! Gi·∫£m ${formattedDiscount}ƒë ‚Üí ${formattedFinalAmount}ƒë`, 'success');
            }).catch(err => {
                console.error('Failed to copy payment message:', err);
                fallbackCopyPayment(message, guestName, formattedDiscount, formattedFinalAmount);
            });
        } else {
            fallbackCopyPayment(message, guestName, formattedDiscount, formattedFinalAmount);
        }
    } catch (error) {
        console.error('Error calculating payment message:', error);
        showDashboardToast(`‚ùå L·ªói t√≠nh to√°n tin nh·∫Øn cho ${guestName}`, 'error');
    }
}

function fallbackCopyPayment(text, guestName, discountAmount, finalAmount) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showDashboardToast(`üí∞ ƒê√£ copy tin nh·∫Øn thanh to√°n cho ${guestName}! Gi·∫£m ${discountAmount}ƒë ‚Üí ${finalAmount || 'N/A'}ƒë`, 'success');
    } catch (err) {
        console.error('Fallback copy payment failed:', err);
        alert(`Tin nh·∫Øn thanh to√°n cho ${guestName}:\n\n${text}`);
    }
    
    document.body.removeChild(textArea);
}

function createDepartureNotification() {
    // Quick action for departure notifications
    const taxiNeeded = confirm("Kh√°ch c√≥ c·∫ßn h·ªó tr·ª£ ƒë·∫∑t taxi kh√¥ng?");
    
    if (taxiNeeded) {
        const message = "C·∫£m ∆°n b·∫°n ƒë√£ l∆∞u tr√∫ t·∫°i kh√°ch s·∫°n! Ch√∫ng t√¥i c√≥ th·ªÉ h·ªó tr·ª£ ƒë·∫∑t taxi ƒë·∫øn s√¢n bay v·ªõi gi√° ∆∞u ƒë√£i 280,000ƒë. Vui l√≤ng cho bi·∫øt th·ªùi gian kh·ªüi h√†nh.";
        
        // Create notification with taxi service
        showDashboardToast(`üöï ƒê√£ t·∫°o th√¥ng b√°o h·ªó tr·ª£ taxi cho kh√°ch ƒëi!`, 'success');
        console.log('Departure notification with taxi:', message);
    } else {
        const message = "C·∫£m ∆°n b·∫°n ƒë√£ l∆∞u tr√∫ t·∫°i kh√°ch s·∫°n! Ch√∫c b·∫°n c√≥ chuy·∫øn ƒëi an to√†n. N·∫øu c·∫ßn h·ªó tr·ª£ g√¨, vui l√≤ng li√™n h·ªá ch√∫ng t√¥i.";
        
        // Create standard departure notification
        showDashboardToast(`‚úÖ ƒê√£ t·∫°o th√¥ng b√°o c·∫£m ∆°n kh√°ch ƒëi!`, 'success');
        console.log('Departure notification:', message);
    }
}

// Quick notification function for mobile
function quickNotify(type, guestName) {
    const templates = {
        arrival: `Ch√†o m·ª´ng ${guestName}! Ph√≤ng ƒë√£ s·∫µn s√†ng, vui l√≤ng li√™n h·ªá reception.`,
        departure: `C·∫£m ∆°n ${guestName}! N·∫øu c·∫ßn taxi s√¢n bay (280k), vui l√≤ng cho bi·∫øt gi·ªù kh·ªüi h√†nh.`
    };
    
    const message = templates[type];
    if (message) {
        // Copy to clipboard for quick use
        navigator.clipboard.writeText(message).then(() => {
            showDashboardToast(`üìã ƒê√£ copy tin nh·∫Øn cho ${guestName}!`, 'success');
        });
    }
}
</script>

<!-- Quick Notes Modal -->
<div class="modal fade" id="quickNotesModal" tabindex="-1" aria-labelledby="quickNotesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="quickNotesModalLabel">
                    <i class="fas fa-sticky-note me-2"></i>T·∫°o Quick Note M·ªõi
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quickNotesForm">
                    <!-- Note Type Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Ch·ªçn lo·∫°i ghi ch√∫:</label>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-success w-100 note-type-btn" onclick="selectNoteType('thu-tien')">
                                    <i class="fas fa-money-bill-wave d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-bold">Thu ti·ªÅn</div>
                                    <small>Nh·∫Øc thu ti·ªÅn kh√°ch</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-danger w-100 note-type-btn" onclick="selectNoteType('huy-phong')">
                                    <i class="fas fa-times-circle d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-bold">H·ªßy ph√≤ng</div>
                                    <small>X·ª≠ l√Ω h·ªßy booking</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-warning w-100 note-type-btn" onclick="selectNoteType('taxi')">
                                    <i class="fas fa-taxi d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-bold">Taxi</div>
                                    <small>ƒê·∫∑t taxi cho kh√°ch</small>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden field for note type -->
                    <input type="hidden" id="noteType" name="noteType">
                    
                    <!-- Note Content -->
                    <div class="mb-3">
                        <label for="noteContent" class="form-label fw-bold">N·ªôi dung ghi ch√∫:</label>
                        <textarea class="form-control" id="noteContent" name="noteContent" rows="4" 
                                  placeholder="Nh·∫≠p chi ti·∫øt ghi ch√∫..."></textarea>
                    </div>
                    
                    <!-- Date and Time -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="noteDate" class="form-label fw-bold">Ng√†y:</label>
                            <input type="date" class="form-control" id="noteDate" name="noteDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="noteTime" class="form-label fw-bold">Gi·ªù:</label>
                            <input type="time" class="form-control" id="noteTime" name="noteTime" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-primary" onclick="saveQuickNote()">
                    <i class="fas fa-save me-1"></i>L∆∞u Quick Note
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Variables already declared at top of script

// Initialize modal date and time when modal opens
document.getElementById('quickNotesModal').addEventListener('show.bs.modal', function () {
    const now = new Date();
    document.getElementById('noteDate').value = now.toISOString().split('T')[0];
    document.getElementById('noteTime').value = now.toTimeString().slice(0, 5);
});

// Initialize arrival times from server, fallback to localStorage
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Try to load times from server first
        const response = await fetch('/api/arrival_times');
        const result = await response.json();
        
        if (result.success && result.data) {
            const serverData = result.data;
            
            // Update default time from server
            const defaultTimeElement = document.getElementById('defaultArrivalTime');
            if (defaultTimeElement && serverData.default_time) {
                defaultTimeElement.textContent = serverData.default_time;
                // Update localStorage with server data
                localStorage.setItem('defaultArrivalTime', serverData.default_time);
            }
            
            // Update guest times from server
            Object.entries(serverData.guest_times || {}).forEach(([bookingId, time]) => {
                const timeElement = document.getElementById(`time-${bookingId}`);
                if (timeElement) {
                    timeElement.textContent = time;
                }
            });
            
            // Update localStorage with server data
            localStorage.setItem('guestArrivalTimes', JSON.stringify(serverData.guest_times || {}));
            
            console.log('‚úÖ Loaded arrival times from server (synced across devices)');
        } else {
            throw new Error('Server data not available');
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Server sync failed, using local storage:', error.message);
        
        // Fallback to localStorage
        const defaultTime = localStorage.getItem('defaultArrivalTime');
        if (defaultTime) {
            const defaultTimeElement = document.getElementById('defaultArrivalTime');
            if (defaultTimeElement) {
                defaultTimeElement.textContent = defaultTime;
            }
        }
        
        // Load guest-specific arrival times from localStorage
        const guestTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
        Object.entries(guestTimes).forEach(([bookingId, time]) => {
            const timeElement = document.getElementById(`time-${bookingId}`);
            if (timeElement) {
                timeElement.textContent = time;
            }
        });
    }
});

</script>

<!-- Expense Modal -->
<div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);">
                <h5 class="modal-title text-white" id="expenseModalLabel">
                    <i class="fas fa-receipt me-2"></i>Th√™m Chi Ph√≠
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <div class="mb-3">
                        <label for="expenseDescription" class="form-label">N·ªôi dung chi ph√≠</label>
                        <input type="text" class="form-control" id="expenseDescription" placeholder="VD: ƒêi·ªán, n∆∞·ªõc, th·ª±c ph·∫©m..." required>
                    </div>
                    <div class="mb-3">
                        <label for="expenseAmount" class="form-label">S·ªë ti·ªÅn</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="expenseAmount" placeholder="100000" step="any" required>
                            <span class="input-group-text">ƒë</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="expenseDate" class="form-label">Ng√†y</label>
                        <input type="date" class="form-control" id="expenseDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="addExpense()" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); border: none;">
                    <i class="fas fa-save me-1"></i>L∆∞u Chi Ph√≠
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Expense Review Modal -->
<div class="modal fade" id="expenseReviewModal" tabindex="-1" aria-labelledby="expenseReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);">
                <h5 class="modal-title text-white" id="expenseReviewModalLabel">
                    <i class="fas fa-chart-line me-2"></i>Chi Ti·∫øt Chi Ph√≠ Th√°ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Month Selection -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="reviewMonth" class="form-label">Ch·ªçn th√°ng xem:</label>
                        <input type="month" class="form-control" id="reviewMonth">
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn btn-primary" onclick="loadExpenseReview()" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); border: none;">
                            <i class="fas fa-search me-1"></i>Xem Chi Ti·∫øt
                        </button>
                    </div>
                </div>
                
                <!-- Monthly Summary -->
                <div id="expenseReviewSummary" class="alert alert-info" style="display: none;">
                    <div class="row">
                        <div class="col-6">
                            <strong>T·ªïng s·ªë giao d·ªãch:</strong> <span id="reviewTotalCount">0</span>
                        </div>
                        <div class="col-6">
                            <strong>T·ªïng chi ph√≠:</strong> <span id="reviewTotalAmount" class="text-danger">0ƒë</span>
                        </div>
                    </div>
                </div>
                
                <!-- Expense List -->
                <div id="expenseReviewList">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                        <p>Ch·ªçn th√°ng ƒë·ªÉ xem chi ti·∫øt chi ph√≠</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize expense modal date
document.getElementById('expenseModal').addEventListener('show.bs.modal', function () {
    const now = new Date();
    document.getElementById('expenseDate').value = now.toISOString().split('T')[0];
});

// Load monthly expenses function (SIMPLIFIED - No more timeouts/aborts)
async function loadMonthlyExpenses() {
    try {
        const response = await fetch('/api/expenses');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Update current month display
        const now = new Date();
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                           'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const currentMonthText = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        
        const monthTextElement = document.getElementById('currentMonthText');
        const monthlyTotalElement = document.getElementById('monthlyTotal');
        
        if (monthTextElement) {
            monthTextElement.textContent = currentMonthText;
        }
        
        if (result.success && result.data && result.data.length > 0) {
            // Filter expenses for current month (simplified)
            const currentMonth = now.getMonth() + 1;
            const currentYear = now.getFullYear();
            
            const monthlyExpenses = result.data.filter(expense => {
                if (!expense.date) return false;
                
                try {
                    // Simple date parsing - expecting YYYY-MM-DD format from API
                    const expenseDate = new Date(expense.date);
                    if (isNaN(expenseDate.getTime())) return false;
                    
                    return expenseDate.getMonth() + 1 === currentMonth && 
                           expenseDate.getFullYear() === currentYear;
                } catch (error) {
                    return false;
                }
            });
            
            const monthlyTotal = monthlyExpenses.reduce((sum, expense) => {
                return sum + parseFloat(expense.amount || 0);
            }, 0);
            
            if (monthlyTotalElement) {
                if (monthlyTotal > 0) {
                    monthlyTotalElement.innerHTML = `<strong class="text-white">${monthlyTotal.toLocaleString()}ƒë</strong> (${monthlyExpenses.length} giao d·ªãch)`;
                } else {
                    monthlyTotalElement.textContent = 'Ch∆∞a c√≥ chi ph√≠';
                }
            }
        } else {
            if (monthlyTotalElement) {
                monthlyTotalElement.textContent = 'Ch∆∞a c√≥ chi ph√≠';
            }
        }
    } catch (error) {
        console.error('Error loading monthly expenses:', error);
        const monthlyTotalElement = document.getElementById('monthlyTotal');
        if (monthlyTotalElement) {
            monthlyTotalElement.textContent = 'L·ªói t·∫£i d·ªØ li·ªáu';
        }
    }
}

// Add expense function (FIXED - No more UI freezing)
async function addExpense() {
    const description = document.getElementById('expenseDescription').value.trim();
    const amount = document.getElementById('expenseAmount').value;
    const date = document.getElementById('expenseDate').value;
    const submitBtn = document.querySelector('#expenseModal .btn-primary');
    
    // Validation
    if (!description || !amount || !date) {
        if (submitBtn) {
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '‚ö†Ô∏è Thi·∫øu th√¥ng tin';
            submitBtn.className = 'btn btn-warning';
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.className = 'btn btn-primary';
            }, 2000);
        }
        return;
    }
    
    // Prevent multiple submissions
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l∆∞u...';
    }
    
    try {
        const response = await fetch('/api/expenses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                amount: parseFloat(amount),
                date: date
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('‚úÖ Expense added successfully');
            
            // Success feedback
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>ƒê√£ l∆∞u!';
                submitBtn.className = 'btn btn-success';
            }
            
            // Clean reset and close
            document.getElementById('expenseForm').reset();
            
            // Close modal properly
            const modalElement = document.getElementById('expenseModal');
            const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
            modal.hide();
            
            // Reload data after modal is closed
            modalElement.addEventListener('hidden.bs.modal', function reloadHandler() {
                loadMonthlyExpenses().catch(console.error);
                modalElement.removeEventListener('hidden.bs.modal', reloadHandler);
            });
            
        } else {
            throw new Error(result.error || 'Cannot save expense');
        }
        
    } catch (error) {
        console.error('‚ùå Error adding expense:', error);
        if (submitBtn) {
            submitBtn.innerHTML = '‚ùå L·ªói - Th·ª≠ l·∫°i';
            submitBtn.className = 'btn btn-danger';
        }
    } finally {
        // Reset button after 2 seconds
        if (submitBtn) {
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>L∆∞u Chi Ph√≠';
                submitBtn.className = 'btn btn-primary';
            }, 2000);
        }
    }
}

// Load monthly expenses on page load (async, non-blocking) - moved after function definition
setTimeout(() => {
    loadMonthlyExpenses().catch(error => {
        console.error('Failed to load monthly expenses:', error);
        const monthlyTotalElement = document.getElementById('monthlyTotal');
        if (monthlyTotalElement) {
            monthlyTotalElement.textContent = 'L·ªói t·∫£i chi ph√≠';
        }
    });
}, 100);

// Initialize expense review modal
document.getElementById('expenseReviewModal').addEventListener('show.bs.modal', function () {
    const now = new Date();
    document.getElementById('reviewMonth').value = now.toISOString().slice(0, 7); // YYYY-MM format
});

// Load expense review function
async function loadExpenseReview() {
    const selectedMonth = document.getElementById('reviewMonth').value;
    if (!selectedMonth) {
        alert('Vui l√≤ng ch·ªçn th√°ng ƒë·ªÉ xem chi ti·∫øt');
        return;
    }
    
    try {
        const response = await fetch('/api/expenses');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        const reviewList = document.getElementById('expenseReviewList');
        const reviewSummary = document.getElementById('expenseReviewSummary');
        const reviewTotalCount = document.getElementById('reviewTotalCount');
        const reviewTotalAmount = document.getElementById('reviewTotalAmount');
        
        if (result.success && result.data && result.data.length > 0) {
            // Parse selected month
            const [year, month] = selectedMonth.split('-').map(Number);
            
            // Filter expenses for selected month
            const monthlyExpenses = result.data.filter(expense => {
                if (!expense.date) return false;
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === month && 
                       expenseDate.getFullYear() === year;
            });
            
            if (monthlyExpenses.length > 0) {
                // Calculate totals
                const totalAmount = monthlyExpenses.reduce((sum, expense) => {
                    return sum + parseFloat(expense.amount || 0);
                }, 0);
                
                // Update summary
                reviewTotalCount.textContent = monthlyExpenses.length;
                reviewTotalAmount.textContent = `${totalAmount.toLocaleString()}ƒë`;
                reviewSummary.style.display = 'block';
                
                // Generate expense list
                let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr><th>Ng√†y</th><th>N·ªôi dung</th><th class="text-end">S·ªë ti·ªÅn</th><th class="text-center">Thao t√°c</th></tr></thead><tbody>';
                
                monthlyExpenses
                    .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by date desc
                    .forEach(expense => {
                        const amount = parseFloat(expense.amount || 0);
                        const date = new Date(expense.date).toLocaleDateString('vi-VN');
                        
                        html += `
                            <tr>
                                <td><small class="text-muted">${date}</small></td>
                                <td>${expense.description || 'N/A'}</td>
                                <td class="text-end text-danger fw-bold">-${amount.toLocaleString()}ƒë</td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editExpense('${expense.created_at}', '${expense.description}', ${expense.amount}, '${expense.date}')" title="S·ª≠a">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteExpense('${expense.created_at}')" title="X√≥a">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                
                html += '</tbody></table></div>';
                reviewList.innerHTML = html;
            } else {
                reviewSummary.style.display = 'none';
                reviewList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>Kh√¥ng c√≥ chi ph√≠ n√†o trong th√°ng ${selectedMonth}</p>
                    </div>
                `;
            }
        } else {
            reviewSummary.style.display = 'none';
            reviewList.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-database fa-2x mb-2"></i>
                    <p>Kh√¥ng c√≥ d·ªØ li·ªáu chi ph√≠</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading expense review:', error);
        reviewList.innerHTML = `
            <div class="text-center text-danger py-4">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</p>
            </div>
        `;
    }
}

// Edit expense function
function editExpense(expenseId, currentDescription, currentAmount, currentDate) {
    // Create edit modal dynamically
    const editModal = document.createElement('div');
    editModal.className = 'modal fade';
    editModal.id = 'editExpenseModal';
    editModal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);">
                    <h5 class="modal-title text-white">
                        <i class="fas fa-edit me-2"></i>S·ª≠a Chi Ph√≠
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editExpenseForm">
                        <div class="mb-3">
                            <label for="editExpenseDescription" class="form-label">N·ªôi dung chi ph√≠</label>
                            <input type="text" class="form-control" id="editExpenseDescription" value="${currentDescription}" required>
                        </div>
                        <div class="mb-3">
                            <label for="editExpenseAmount" class="form-label">S·ªë ti·ªÅn</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editExpenseAmount" value="${currentAmount}" step="any" required>
                                <span class="input-group-text">ƒë</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editExpenseDate" class="form-label">Ng√†y</label>
                            <input type="date" class="form-control" id="editExpenseDate" value="${currentDate}" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveExpenseEdit('${expenseId}')">
                        <i class="fas fa-save me-1"></i>L∆∞u thay ƒë·ªïi
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(editModal);
    const modal = new bootstrap.Modal(editModal);
    modal.show();
    
    // Clean up modal when hidden
    editModal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(editModal);
    });
}

// Save expense edit
async function saveExpenseEdit(expenseId) {
    const description = document.getElementById('editExpenseDescription').value.trim();
    const amount = document.getElementById('editExpenseAmount').value;
    const date = document.getElementById('editExpenseDate').value;
    
    if (!description || !amount || !date) {
        alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
        return;
    }
    
    const submitBtn = document.querySelector('#editExpenseModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l∆∞u...';
    
    try {
        const response = await fetch(`/api/expenses/${expenseId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                description: description,
                amount: parseFloat(amount),
                date: date
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showExpenseToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t chi ph√≠ th√†nh c√¥ng!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editExpenseModal'));
            modal.hide();
            
            // FIXED: Reload expense data after successful edit
            setTimeout(() => {
                loadMonthlyExpenses().catch(console.error);
                loadExpenseReview();
            }, 500);
            await loadMonthlyExpenses();
        } else {
            throw new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    } catch (error) {
        console.error('Error editing expense:', error);
        showExpenseToast('‚ùå L·ªói c·∫≠p nh·∫≠t chi ph√≠: ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Delete expense function
async function deleteExpense(expenseId) {
    if (!confirm('‚ùå B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a chi ph√≠ n√†y?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/expenses/${expenseId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showExpenseToast('üóëÔ∏è ƒê√£ x√≥a chi ph√≠ th√†nh c√¥ng!', 'success');
            
            // Refresh expense review and monthly expenses
            await loadExpenseReview();
            await loadMonthlyExpenses();
        } else {
            throw new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    } catch (error) {
        console.error('Error deleting expense:', error);
        showExpenseToast('‚ùå L·ªói x√≥a chi ph√≠: ' + error.message, 'error');
    }
}

// Helper function for expense toast notifications
function showExpenseToast(message, type = 'success') {
    const colors = {
        success: 'bg-success',
        error: 'bg-danger',
        info: 'bg-info',
        warning: 'bg-warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 end-0 m-3 p-3 ${colors[type]} text-white rounded shadow`;
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close btn-close-white ms-2" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.transition = 'all 0.3s ease';
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }
    }, 4000);
}

</script>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
