{% extends "base.html" %}

{% block title %}Dashboard - Hotel Management{% endblock %}

{% block extra_css %}
<style>
/* Mobile Dashboard Optimizations */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 8px !important;
        padding-right: 8px !important;
    }
    
    .card {
        margin-bottom: 8px !important;
    }
    
    .card-body {
        padding: 8px !important;
    }
    
    .card-header {
        padding: 6px 8px !important;
    }
    
    .btn-group .btn {
        padding: 2px 6px !important;
        font-size: 12px !important;
    }
    
    .alert {
        margin-bottom: 8px !important;
        padding: 8px !important;
    }
    
    .row {
        margin-bottom: 8px !important;
    }
    
    /* Compact notification cards on mobile */
    .notification-card-mobile {
        max-height: 100px;
        overflow-y: auto;
    }
    
    /* Hide some text on very small screens */
    @media (max-width: 576px) {
        .d-sm-none {
            display: none !important;
        }
        
        .btn-sm {
            padding: 1px 4px !important;
            font-size: 10px !important;
        }
        
        .card-header h6, .card-header h5 {
            font-size: 12px !important;
        }
        
        small, .small {
            font-size: 10px !important;
        }
    }
}

/* Compact layout improvements */
.compact-card {
    border-radius: 8px !important;
}

.compact-card .card-body {
    padding: 12px !important;
}

.notification-item {
    padding: 6px 8px !important;
    margin-bottom: 4px !important;
    border-radius: 6px !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- ‚ö†Ô∏è PIN NOTIFICATION CHO NG√ÄY QU√Å T·∫¢I (FIXED TOP) -->
    {% if overcrowded_days and overcrowded_days|length > 0 %}
    {% set urgent_days = overcrowded_days | selectattr('alert_level', 'equalto', 'urgent') | list %}
    {% set today_overcrowded = overcrowded_days | selectattr('is_today', 'equalto', true) | list %}
    
    <div class="alert alert-warning border-0 shadow-lg mb-0 fixed-top" 
         style="top: 0; z-index: 1050; border-radius: 0 0 10px 10px; background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-exclamation-triangle fa-2x text-white"></i>
                </div>
                <div class="text-white">
                    <div class="fw-bold fs-6 mb-1">
                        ‚ö†Ô∏è C·∫¢NH B√ÅO QU√Å T·∫¢I: {{ overcrowded_days|length }} ng√†y c√≥ >4 kh√°ch
                    </div>
                    <div class="small">
                        {% if today_overcrowded %}
                            <span class="badge bg-danger me-2">H√îM NAY: {{ today_overcrowded[0].guest_count }} kh√°ch</span>
                        {% endif %}
                        {% if urgent_days %}
                            <span class="badge bg-warning text-dark me-2">Kh·∫©n c·∫•p: {{ urgent_days|length }} ng√†y</span>
                        {% endif %}
                        <span class="text-white-75">T·ªëi ƒëa: 4 ph√≤ng c√≥ s·∫µn</span>
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-light btn-sm me-2" onclick="scrollToOvercrowdedSection()">
                    <i class="fas fa-eye me-1"></i>Xem chi ti·∫øt
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="dismissPinNotification()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Spacer ƒë·ªÉ content kh√¥ng b·ªã che b·ªüi fixed notification -->
    <div style="height: 80px;"></div>
    {% endif %}

    <h1 class="mt-4">üìä Dashboard T·ªïng quan</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">T·ªïng quan v·ªÅ hi·ªáu su·∫•t kh√°ch s·∫°n</li>
    </ol>

    <!-- ‚ö° DASHBOARD CONTROLS - Quick Actions -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card border-0 bg-light">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-tools text-primary me-2"></i>
                            <small class="text-muted fw-bold">Dashboard Controls</small>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="refreshDashboardData()" 
                                    data-action="refresh-dashboard"
                                    title="L√†m m·ªõi d·ªØ li·ªáu overdue payment">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Data
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-success" 
                                    onclick="window.location.reload()" 
                                    title="T·∫£i l·∫°i to√†n b·ªô trang">
                                <i class="fas fa-redo me-1"></i>Reload Page
                            </button>
                            <a href="{{ url_for('view_bookings', show_all='true') }}" 
                               class="btn btn-sm btn-outline-info" 
                               title="Xem t·∫•t c·∫£ booking">
                                <i class="fas fa-list me-1"></i>All Bookings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter"></i>
            T√πy ch·ªânh kho·∫£ng th·ªùi gian
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('dashboard') }}" class="row g-3 align-items-center">
                <div class="col-md-5">
                    <label for="start_date" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-md-5">
                    <label for="end_date" class="form-label">Ng√†y k·∫øt th√∫c</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> L·ªçc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- üîî ARRIVAL & DEPARTURE NOTIFICATIONS (QUICKNOTES STYLE) -->
    {% if arrival_notifications or departure_notifications %}
    <div class="row mb-2">
        <!-- Arrival Notifications -->
        {% if arrival_notifications and arrival_notifications|length > 0 %}
        <div class="col-md-6 mb-2">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-white fw-bold small">
                            <i class="fas fa-plane-arrival me-1"></i>üìú Kh√°ch ƒê·∫øn ({{ arrival_notifications|length }})
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" onclick="editDefaultArrivalTime()" title="Ch·ªânh th·ªùi gian">
                                <i class="fas fa-clock"></i>
                            </button>
                            <small class="text-white ms-2" id="defaultArrivalTime">14:00</small>
                        </div>
                    </div>
                    <div style="max-height: 120px; overflow-y: auto;">
                        {% for notification in arrival_notifications[:5] %}
                        <div class="bg-white bg-opacity-90 rounded mb-1 px-2 py-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-dark small">{{ notification.guest_name }}</div>
                                    <div class="text-muted" style="font-size: 11px;">
                                        <i class="fas fa-calendar me-1"></i>{{ notification.checkin_date }}
                                        <button class="btn btn-sm p-0 ms-2 text-primary" onclick="editGuestArrivalTime('{{ notification.booking_id }}', '{{ notification.guest_name }}')" title="Ch·ªânh gi·ªù">
                                            <i class="fas fa-clock me-1"></i><span id="time-{{ notification.booking_id }}">14:00</span>
                                        </button>
                                        {% if notification.priority == 'urgent' %}
                                        <span class="badge bg-danger ms-1 px-1" style="font-size: 9px;">H√îM NAY</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark ms-1 px-1" style="font-size: 9px;">MAI</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="small fw-bold text-success">{{ "{:,.0f}".format(notification.total_amount|float) }}ƒë</div>
                                    <div class="text-muted" style="font-size: 10px;">{{ notification.booking_id }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if arrival_notifications|length > 5 %}
                        <div class="text-center mt-1">
                            <small class="text-white">+{{ arrival_notifications|length - 5 }} kh√°c</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Departure Notifications -->
        {% if departure_notifications and departure_notifications|length > 0 %}
        <div class="col-md-6 mb-2">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-white fw-bold small">
                            <i class="fas fa-plane-departure me-1"></i>üöñ Kh√°ch ƒêi ({{ departure_notifications|length }})
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" onclick="copyTaxiMessage('Kh√°ch')" title="Copy taxi">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div style="max-height: 120px; overflow-y: auto;">
                        {% for notification in departure_notifications[:5] %}
                        <div class="bg-white bg-opacity-90 rounded mb-1 px-2 py-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <div class="fw-bold text-dark small">{{ notification.guest_name }}</div>
                                    <div class="text-muted" style="font-size: 11px;">
                                        <i class="fas fa-calendar me-1"></i>{{ notification.checkout_date }}
                                        {% if notification.priority == 'urgent' %}
                                        <span class="badge bg-danger ms-1 px-1" style="font-size: 9px;">H√îM NAY</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark ms-1 px-1" style="font-size: 9px;">MAI</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-primary px-1" onclick="copyTaxiMessage('{{ notification.guest_name }}')" title="Copy taxi">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <div class="text-muted mt-1" style="font-size: 10px;">{{ notification.booking_id }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if departure_notifications|length > 5 %}
                        <div class="text-center mt-1">
                            <small class="text-white">+{{ departure_notifications|length - 5 }} kh√°c</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Quick Notes Display (ULTRA COMPACT) -->
    <div class="row mb-2">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <h6 class="mb-0 text-white fw-bold small">
                            <i class="fas fa-sticky-note me-1"></i>üìù Quick Notes
                        </h6>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-light btn-sm px-2" data-bs-toggle="modal" data-bs-target="#quickNotesModal" title="T·∫°o m·ªõi">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-outline-light btn-sm px-2" onclick="syncQuickNotes()" title="Sync">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="quickNotesContainer">
                        <div class="text-center py-1">
                            <small class="text-white">ƒêang t·∫£i...</small>
                        </div>
                    </div>
                    <input type="file" id="quickNotesFileInput" accept=".json" style="display: none;" onchange="handleQuickNotesImport(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ö†Ô∏è KH√ÅCH CH∆ØA THU TI·ªÄN QU√Å H·∫†N (COMPACT) -->
    {% if overdue_unpaid_guests and overdue_unpaid_guests|length > 0 %}
    <div class="card border-0 shadow-sm mb-3" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
        <div class="card-body py-2 px-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 text-white fw-bold">
                    <i class="fas fa-exclamation-triangle me-1"></i>‚ö†Ô∏è CH∆ØA THU ({{ overdue_unpaid_guests|length }})
                </h6>
                <div class="text-white text-end">
                    <div class="fw-bold">{{ "{:,.0f}".format(overdue_total_amount if overdue_total_amount else 0) }}ƒë</div>
                    <small>T·ªïng ch∆∞a thu</small>
                </div>
            </div>
        
            <div class="table-responsive">
                <table class="table table-sm table-borderless mb-0">
                    <tbody>
                        {% for guest in overdue_unpaid_guests[:5] %}
                        <tr class="bg-white bg-opacity-90">
                            <td class="py-1 px-2">
                                <div class="fw-bold text-dark small">{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', 'N/A') }}</div>
                                <div class="text-muted" style="font-size: 11px;">
                                    {% if guest.get('Check-in Date') %}
                                        {% if guest['Check-in Date'] is string %}
                                            {{ guest['Check-in Date'] }}
                                        {% else %}
                                            {{ guest['Check-in Date'].strftime('%d/%m') if guest['Check-in Date'] else 'N/A' }}
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                    <span class="badge bg-danger ms-1 px-1" style="font-size: 9px;">{{ guest.get('days_overdue', 0) }}d</span>
                                </div>
                            </td>
                            <td class="py-1 px-2 text-end">
                                <div class="fw-bold text-danger small">
                                    {% set amount = guest.get('calculated_total_amount') or guest.get('T·ªïng thanh to√°n', 0) or 0 %}
                                    {{ "{:,.0f}".format(amount) }}ƒë
                                </div>
                                <div class="text-muted" style="font-size: 10px;">{{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', 'N/A') }}</div>
                            </td>
                            <td class="py-1 px-1">
                                <div class="btn-group-vertical btn-group-sm">
                                    {% set booking_id = guest.get('S·ªë ƒë·∫∑t ph√≤ng', '') %}
                                    {% set guest_name = guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', '') %}
                                    {% set total_amount = guest.get('calculated_total_amount') or guest.get('T·ªïng thanh to√°n', 0) or 0 %}
                                    {% set commission = guest.get('Hoa h·ªìng', 0) or 0 %}
                                    {% set room_fee = guest.get('calculated_room_fee') or guest.get('T·ªïng thanh to√°n', 0) or 0 %}
                                    {% set taxi_fee = guest.get('calculated_taxi_fee', 0) or 0 %}
                                    
                                    <button class="btn btn-success btn-sm py-1 px-2" style="font-size: 12px;"
                                            onclick="openCollectModal('{{ booking_id }}', '{{ guest_name }}', {{ total_amount }}, {{ commission }}, {{ room_fee }}, {{ taxi_fee }})">
                                        <i class="fas fa-money-bill-wave me-1"></i>Thu
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm py-1 px-2" style="font-size: 11px;"
                                            onclick="openEditAmountModal('{{ booking_id }}', '{{ guest_name }}', {{ room_fee }}, {{ taxi_fee }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        
            {% if overdue_unpaid_guests|length > 5 %}
            <div class="text-center mt-2">
                <button class="btn btn-outline-light btn-sm" onclick="toggleMoreOverdue()">
                    <i class="fas fa-chevron-down me-1"></i>+{{ overdue_unpaid_guests|length - 5 }}
                </button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- ‚ö†Ô∏è C·∫¢NH B√ÅO NG√ÄY QU√Å T·∫¢I (QU√Å 4 KH√ÅCH) -->
    {% if overcrowded_days and overcrowded_days|length > 0 %}
    <div class="alert border-0 shadow-lg mb-4" id="overcrowdedSection" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h4 class="alert-heading text-white mb-2">
                    <i class="fas fa-users me-2"></i>‚ö†Ô∏è C·∫¢NH B√ÅO NG√ÄY QU√Å T·∫¢I
                </h4>
                <p class="text-white mb-0">{{ overcrowded_days|length }} ng√†y c√≥ h∆°n 4 kh√°ch check-in (T·ªëi ƒëa: 4 ph√≤ng)</p>
            </div>
            <div class="text-end">
                <button class="btn btn-light btn-sm" onclick="toggleOvercrowdedDetails()">
                    <i class="fas fa-eye me-1"></i><span id="overcrowdToggleText">Chi ti·∫øt</span>
                </button>
            </div>
        </div>
        
        <!-- Quick Summary -->
        <div class="row mt-3">
            {% set urgent_days = overcrowded_days | selectattr('alert_level', 'equalto', 'urgent') | list %}
            {% set warning_days = overcrowded_days | selectattr('alert_level', 'equalto', 'warning') | list %}
            {% set future_days = overcrowded_days | selectattr('is_future', 'equalto', true) | list %}
            
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ urgent_days|length }}</div>
                        <small class="text-white-75">Kh·∫©n c·∫•p (‚â§3 ng√†y)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ warning_days|length }}</div>
                        <small class="text-white-75">C·∫£nh b√°o (‚â§7 ng√†y)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ future_days|length }}</div>
                        <small class="text-white-75">T∆∞∆°ng lai</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed List (Initially Hidden) -->
        <div id="overcrowdedDetails" style="display: none;" class="mt-3">
            <hr class="text-white-50 my-3">
            <div class="row">
                {% for day in overcrowded_days[:6] %}
                <div class="col-md-6 col-lg-4 mb-2">
                    <div class="card bg-white border-0">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold text-dark">
                                        {% if day.date %}
                                            {{ day.date.strftime('%d/%m/%Y') if day.date.strftime else day.date }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                        
                                        {% if day.is_today %}
                                            <span class="badge bg-danger ms-1">H√îM NAY</span>
                                        {% elif day.days_from_today == 1 %}
                                            <span class="badge bg-warning ms-1">NG√ÄY MAI</span>
                                        {% elif day.days_from_today > 0 and day.days_from_today <= 3 %}
                                            <span class="badge bg-danger ms-1">{{ day.days_from_today }} NG√ÄY N·ªÆA</span>
                                        {% elif day.days_from_today > 0 %}
                                            <span class="badge bg-info ms-1">{{ day.days_from_today }} ng√†y</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-users me-1"></i>{{ day.guest_count }} kh√°ch check-in
                                        <span class="ms-2 badge bg-{{ day.alert_color }}">
                                            {% if day.guest_count > 6 %}
                                                NGHI√äM TR·ªåNG
                                            {% elif day.guest_count > 4 %}
                                                QU√Å T·∫¢I
                                            {% endif %}
                                        </span>
                                    </small>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showDayDetails('{{ day.date }}', {{ day.guest_count }}, {{ day.guest_names|tojson }}, {{ day.booking_ids|tojson }})"
                                            title="Xem chi ti·∫øt kh√°ch">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if overcrowded_days|length > 6 %}
            <div class="text-center mt-2">
                <small class="text-white-75">... v√† {{ overcrowded_days|length - 6 }} ng√†y kh√°c</small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Key Metrics -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">Doanh thu</div>
                            <div class="fs-3 fw-bold">{{ "{:,.0f}".format(total_revenue) }}ƒë</div>
                        </div>
                        <i class="fas fa-coins fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">L∆∞·ª£ng kh√°ch</div>
                            <div class="fs-3 fw-bold">{{ total_guests }}</div>
                        </div>
                        <i class="fas fa-users fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- More metrics can be added here -->
    </div>

    <!-- Charts -->
    <!-- Bi·ªÉu ƒë·ªì doanh thu chuy√™n nghi·ªáp -->
    <div class="row">
        <div class="col-xl-12">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-line me-2"></i>
                            <span class="fw-bold">üìà Doanh thu theo th√°ng (T·∫•t c·∫£ th·ªùi gian)</span>
                        </div>
                        <div class="badge bg-light text-dark">Chi ti·∫øt ƒë·∫ßy ƒë·ªß</div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="monthlyRevenueChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- B·∫£ng chi ti·∫øt v√† ph√¢n t√≠ch -->
    {% if monthly_revenue_with_unpaid %}
    <div class="row">
        <div class="col-xl-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-1 text-primary"></i> 
                        Chi ti·∫øt Doanh thu theo th√°ng (Bao g·ªìm kh√°ch ch∆∞a thu ti·ªÅn)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="border-0">
                                        <i class="fas fa-calendar-alt me-1"></i>Th√°ng
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-check-circle me-1 text-success"></i>ƒê√£ thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-clock me-1 text-warning"></i>Ch∆∞a thu
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-users me-1 text-info"></i>Kh√°ch ch∆∞a thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-coins me-1 text-info"></i>T·ªïng c·ªông
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-percentage me-1 text-primary"></i>T·ª∑ l·ªá thu
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in monthly_revenue_with_unpaid %}
                                <tr class="border-bottom">
                                    <td>
                                        <div class="fw-bold text-primary">{{ row.get('Th√°ng', 'N/A') }}</div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-success">
                                            {{ "{:,.0f}".format(row.get('ƒê√£ thu', 0) | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-danger">
                                            {{ "{:,.0f}".format(row.get('Ch∆∞a thu', 0) | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set uncollected_count = row.get('S·ªë kh√°ch ch∆∞a thu', 0) %}
                                        {% if uncollected_count > 0 %}
                                        <span class="badge bg-warning text-dark">
                                            {{ uncollected_count }} kh√°ch
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> ƒê√£ thu h·∫øt
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% set total = (row.get('ƒê√£ thu', 0) | float) + (row.get('Ch∆∞a thu', 0) | float) %}
                                        <div class="fw-bold text-dark">
                                            {{ "{:,.0f}".format(total) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set collected = row.get('ƒê√£ thu', 0) | float %}
                                        {% set uncollected = row.get('Ch∆∞a thu', 0) | float %}
                                        {% set total = collected + uncollected %}
                                        {% set percentage = (collected / total * 100) if total > 0 else 0 %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if percentage >= 90 %}bg-success{% elif percentage >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ percentage }}%;" 
                                                 aria-valuenow="{{ percentage }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                <small class="fw-bold">{{ "{:.1f}%".format(percentage) }}</small>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-1 text-primary"></i> 
                        Ph√¢n b·ªï theo Ng∆∞·ªùi thu
                    </h6>
                </div>
                <div class="card-body">
                    <div id="collectorChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Thu Ti·ªÅn -->
<div class="modal fade" id="collectPaymentModal" tabindex="-1" aria-labelledby="collectPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="collectPaymentModalLabel">
                    <i class="fas fa-money-bill-wave me-2"></i>Thu Ti·ªÅn Kh√°ch H√†ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="collectPaymentForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n kh√°ch h√†ng:</label>
                        <div class="fw-bold text-primary" id="modalGuestName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ ƒë·∫∑t ph√≤ng:</label>
                        <div class="fw-bold text-muted" id="modalBookingId"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">T·ªïng s·ªë ti·ªÅn c·∫ßn thu:</label>
                        <div class="fw-bold text-danger fs-5" id="modalTotalAmount"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hoa h·ªìng d·ª± ki·∫øn:</label>
                        <div class="fw-bold text-warning fs-6" id="modalCommissionAmount">Ch∆∞a c√≥ th√¥ng tin</div>
                    </div>
                    <div class="mb-3">
                        <label for="collectedAmount" class="form-label">S·ªë ti·ªÅn th·ª±c thu (VND):</label>
                        <input type="number" class="form-control" id="collectedAmount" 
                               placeholder="Nh·∫≠p s·ªë ti·ªÅn ƒë√£ thu" min="0" step="1000">
                        <div class="form-text">C√≥ th·ªÉ thu m·ªôt ph·∫ßn ho·∫∑c to√†n b·ªô s·ªë ti·ªÅn</div>
                    </div>
                    <div class="mb-3">
                        <label for="collectorName" class="form-label">Ng∆∞·ªùi thu ti·ªÅn:</label>
                        <select class="form-select" id="collectorName" required>
                            <option value="">Ch·ªçn ng∆∞·ªùi thu ti·ªÅn</option>
                            <option value="LOC LE">LOC LE</option>
                            <option value="THAO LE">THAO LE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i thu ti·ªÅn:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentType" id="paymentTypeRoom" value="room" checked>
                            <label class="form-check-label fw-bold text-primary" for="paymentTypeRoom">
                                <i class="fas fa-bed me-1"></i>Thu ti·ªÅn ph√≤ng
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Taxi:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="hasTaxi" name="hasTaxi">
                            <label class="form-check-label fw-bold text-success" for="hasTaxi">
                                <i class="fas fa-taxi me-1"></i>C√≥ taxi
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="noTaxi" name="noTaxi">
                            <label class="form-check-label fw-bold text-danger" for="noTaxi">
                                <i class="fas fa-ban me-1"></i>Kh√¥ng c√≥ taxi
                            </label>
                        </div>
                    </div>
                    <div class="mb-3" id="taxiAmountGroup" style="display: none;">
                        <label for="taxiAmount" class="form-label">S·ªë ti·ªÅn taxi (VND):</label>
                        <input type="number" class="form-control" id="taxiAmount" 
                               placeholder="Nh·∫≠p s·ªë ti·ªÅn taxi" min="0" step="1000">
                        <div class="form-text">S·ªë ti·ªÅn taxi ri√™ng bi·ªát v·ªõi ti·ªÅn ph√≤ng</div>
                    </div>
                    <div class="mb-3">
                        <label for="paymentNote" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn):</label>
                        <textarea class="form-control" id="paymentNote" rows="2" 
                                  placeholder="Ghi ch√∫ v·ªÅ vi·ªác thu ti·ªÅn..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" id="confirmCollectBtn" onclick="collectPayment()">
                    <i class="fas fa-check me-1"></i>X√°c nh·∫≠n thu ti·ªÅn
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Amount Modal -->
<div class="modal fade" id="editAmountModal" tabindex="-1" aria-labelledby="editAmountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editAmountModalLabel">
                    <i class="fas fa-edit me-2"></i>S·ª≠a S·ªë Ti·ªÅn Kh√°ch H√†ng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAmountForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n kh√°ch h√†ng:</label>
                        <div class="fw-bold text-primary" id="editModalGuestName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ ƒë·∫∑t ph√≤ng:</label>
                        <div class="fw-bold text-muted" id="editModalBookingId"></div>
                    </div>
                    <div class="mb-3">
                        <label for="editRoomAmount" class="form-label">Ti·ªÅn ph√≤ng (VND):</label>
                        <input type="number" class="form-control" id="editRoomAmount" 
                               placeholder="Nh·∫≠p ti·ªÅn ph√≤ng" min="0" step="1000">
                        <div class="form-text">C·∫≠p nh·∫≠t s·ªë ti·ªÅn ph√≤ng c·∫ßn thu</div>
                    </div>
                    <div class="mb-3">
                        <label for="editTaxiAmount" class="form-label">Ti·ªÅn taxi (VND):</label>
                        <input type="number" class="form-control" id="editTaxiAmount" 
                               placeholder="Nh·∫≠p ti·ªÅn taxi" min="0" step="1000">
                        <div class="form-text">C·∫≠p nh·∫≠t s·ªë ti·ªÅn taxi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng c√≥)</div>
                    </div>
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <strong>T·ªïng s·ªë ti·ªÅn m·ªõi:</strong> 
                            <span id="editTotalPreview" class="fw-bold">0ƒë</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editNote" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn):</label>
                        <textarea class="form-control" id="editNote" rows="2" 
                                  placeholder="L√Ω do thay ƒë·ªïi s·ªë ti·ªÅn..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-warning" id="confirmEditBtn" onclick="updateBookingAmounts()">
                    <i class="fas fa-save me-1"></i>C·∫≠p nh·∫≠t s·ªë ti·ªÅn
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Pass chart data from server to dashboard.js
const monthlyRevenueChartData = {{ monthly_revenue_chart_json | tojson | safe }};
const collectorChartData = {{ collector_chart_json | tojson | safe }};

// Global variables for payment modal
let currentBookingData = {};

// Quick Notes functionality
document.addEventListener('DOMContentLoaded', function() {
    loadQuickNotesOnDashboard();
    
    // Add event listeners for taxi checkboxes
    const hasTaxiCheckbox = document.getElementById('hasTaxi');
    const noTaxiCheckbox = document.getElementById('noTaxi');
    
    if (hasTaxiCheckbox && noTaxiCheckbox) {
        hasTaxiCheckbox.addEventListener('change', function() {
            const taxiAmountGroup = document.getElementById('taxiAmountGroup');
            if (this.checked) {
                noTaxiCheckbox.checked = false;
                taxiAmountGroup.style.display = 'block';
            } else {
                taxiAmountGroup.style.display = 'none';
            }
        });
        
        noTaxiCheckbox.addEventListener('change', function() {
            if (this.checked) {
                hasTaxiCheckbox.checked = false;
                document.getElementById('taxiAmountGroup').style.display = 'none';
                document.getElementById('taxiAmount').value = '';
            }
        });
    }
});

function openCollectModal(bookingId, guestName, totalAmount, commission, roomFee, taxiFee) {
    // Store booking data for later use
    currentBookingData = {
        bookingId: bookingId,
        guestName: guestName,
        totalAmount: totalAmount || 0,
        commission: commission || 0,
        roomFee: roomFee || totalAmount || 0,
        taxiFee: taxiFee || 0
    };
    
    // Reset form
    document.getElementById('collectPaymentForm').reset();
    document.getElementById('hasTaxi').checked = false;
    document.getElementById('noTaxi').checked = false;
    document.getElementById('taxiAmountGroup').style.display = 'none';
    
    // Populate modal data
    document.getElementById('modalGuestName').textContent = guestName;
    document.getElementById('modalBookingId').textContent = bookingId;
    document.getElementById('modalTotalAmount').textContent = totalAmount.toLocaleString() + 'ƒë';
    
    // Show commission info
    const commissionElement = document.getElementById('modalCommissionAmount');
    if (commission && commission > 0) {
        commissionElement.textContent = commission.toLocaleString() + 'ƒë';
        commissionElement.parentElement.style.display = 'block';
    } else {
        commissionElement.textContent = 'Ch∆∞a c√≥ th√¥ng tin';
        commissionElement.parentElement.style.display = 'block';
    }
    
    // Set default collected amount to total amount for room payment
    document.getElementById('collectedAmount').value = totalAmount;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('collectPaymentModal'));
    modal.show();
}

function collectPayment() {
    const hasTaxi = document.getElementById('hasTaxi').checked;
    const noTaxi = document.getElementById('noTaxi').checked;
    const collectorName = document.getElementById('collectorName').value;
    const paymentNote = document.getElementById('paymentNote').value.trim();
    
    let collectedAmount = 0;
    let finalNote = paymentNote;
    let paymentType = 'room';
    
    if (hasTaxi) {
        // Thu ti·ªÅn taxi
        const taxiAmount = parseFloat(document.getElementById('taxiAmount').value) || 0;
        
        if (taxiAmount === 0) {
            alert('‚ùå Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn taxi!');
            return;
        }
        
        collectedAmount = taxiAmount;
        finalNote = paymentNote || 'Thu ti·ªÅn taxi';
        paymentType = 'taxi';
    } else {
        // Thu ti·ªÅn ph√≤ng (m·∫∑c ƒë·ªãnh)
        collectedAmount = parseFloat(document.getElementById('collectedAmount').value) || 0;
        finalNote = paymentNote || 'Thu ti·ªÅn ph√≤ng';
        paymentType = 'room';
    }
    
    // Validation
    if (!collectorName) {
        alert('‚ùå Vui l√≤ng ch·ªçn ng∆∞·ªùi thu ti·ªÅn!');
        return;
    }
    
    if (collectedAmount <= 0) {
        alert('‚ùå S·ªë ti·ªÅn thu kh√¥ng h·ª£p l·ªá!');
        return;
    }
    
    // Disable button and show loading
    const confirmBtn = document.getElementById('confirmCollectBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...';
    confirmBtn.disabled = true;
    
    // Prepare data
    const requestData = {
        booking_id: currentBookingData.bookingId,
        collected_amount: collectedAmount,
        collector_name: collectorName,
        payment_note: finalNote,
        payment_type: paymentType
    };
    
    // Call API
    fetch('/api/collect_payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showDashboardToast(`‚úÖ ${data.message}`, 'success');
            
            // Update dashboard immediately without reload
            updateOverdueGuestsAfterPayment(currentBookingData.bookingId, collectedAmount, paymentType);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('collectPaymentModal'));
            modal.hide();
            
            // No need for page reload anymore!
        } else {
            throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    })
    .catch(error => {
        console.error('Collect payment error:', error);
        showDashboardToast(`‚ùå L·ªói: ${error.message}`, 'error');
    })
    .finally(() => {
        // Restore button
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// Update overdue guests section after successful payment
function updateOverdueGuestsAfterPayment(bookingId, collectedAmount, paymentType) {
    // Find and remove the specific guest card
    const guestCards = document.querySelectorAll('.col-md-4');
    let removedGuestCard = null;
    
    guestCards.forEach(card => {
        const bookingIdElement = card.querySelector('small.text-muted:last-child');
        if (bookingIdElement && bookingIdElement.textContent.includes(bookingId)) {
            // Store the guest info before removing
            const guestNameElement = card.querySelector('h6.mb-1');
            const guestName = guestNameElement ? guestNameElement.textContent : 'Unknown';
            
            // Add a fade-out animation
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '0.3';
            card.style.transform = 'scale(0.95)';
            
            // Remove after animation
            setTimeout(() => {
                card.style.display = 'none';
                // Show success feedback
                showDashboardToast(`üí∞ ƒê√£ thu ${collectedAmount.toLocaleString()}ƒë t·ª´ ${guestName}`, 'success');
            }, 500);
            
            removedGuestCard = card;
        }
    });
    
    // Update the total amount and guest count
    setTimeout(() => {
        updateOverdueGuestsSummary(collectedAmount);
        
        // Check if no more overdue guests remain
        const remainingCards = document.querySelectorAll('.col-md-4:not([style*="display: none"])');
        const actualRemainingCards = Array.from(remainingCards).filter(card => {
            return card.style.display !== 'none' && !card.querySelector('h6.mb-1')?.textContent?.includes('N/A');
        });
        
        if (actualRemainingCards.length === 0) {
            // Hide the entire overdue section
            const overdueSection = document.querySelector('.alert.alert-danger');
            if (overdueSection) {
                overdueSection.style.transition = 'all 0.8s ease';
                overdueSection.style.opacity = '0';
                overdueSection.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    overdueSection.style.display = 'none';
                    showDashboardToast('üéâ Kh√¥ng c√≤n kh√°ch n√†o ch∆∞a thu ti·ªÅn!', 'success');
                }, 800);
            }
        }
    }, 600);
}

// Update the summary numbers in overdue section
function updateOverdueGuestsSummary(paidAmount) {
    // Update guest count
    const guestCountElement = document.querySelector('.alert-danger p');
    if (guestCountElement) {
        const currentText = guestCountElement.textContent;
        const currentCount = parseInt(currentText.match(/(\d+)/)?.[1] || '0');
        const newCount = Math.max(0, currentCount - 1);
        
        guestCountElement.textContent = `${newCount} kh√°ch ƒë√£ check-in nh∆∞ng ch∆∞a thu ti·ªÅn`;
    }
    
    // Update total amount
    const totalAmountElement = document.querySelector('.alert-danger .h5');
    if (totalAmountElement) {
        const currentAmountText = totalAmountElement.textContent.replace(/[^\d]/g, '');
        const currentAmount = parseInt(currentAmountText) || 0;
        const newAmount = Math.max(0, currentAmount - paidAmount);
        
        totalAmountElement.textContent = `${newAmount.toLocaleString()}ƒë`;
    }
}

// Update guest card amounts after editing
function updateGuestCardAmounts(bookingId, newRoomAmount, newTaxiAmount) {
    const guestCards = document.querySelectorAll('.col-md-4');
    
    guestCards.forEach(card => {
        const bookingIdElement = card.querySelector('small.text-muted:last-child');
        if (bookingIdElement && bookingIdElement.textContent.includes(bookingId)) {
            // Find the amount display elements
            const totalAmountElement = card.querySelector('.fw-bold.text-danger');
            const roomAmountElement = card.querySelector('small.text-muted.d-block');
            const taxiAmountElement = card.querySelector('small.text-info.d-block');
            
            // Calculate new total
            const newTotal = newRoomAmount + newTaxiAmount;
            
            // Update total amount with animation
            if (totalAmountElement) {
                totalAmountElement.style.transition = 'all 0.3s ease';
                totalAmountElement.style.transform = 'scale(1.1)';
                totalAmountElement.style.color = '#28a745'; // Green for update
                
                setTimeout(() => {
                    totalAmountElement.textContent = `${newTotal.toLocaleString()}ƒë`;
                    
                    setTimeout(() => {
                        totalAmountElement.style.transform = 'scale(1)';
                        totalAmountElement.style.color = '#dc3545'; // Back to red
                    }, 200);
                }, 150);
            }
            
            // Update room amount
            if (roomAmountElement) {
                roomAmountElement.textContent = `Ph√≤ng: ${newRoomAmount.toLocaleString()}ƒë`;
            }
            
            // Update taxi amount (create or remove element as needed)
            const existingTaxiElement = card.querySelector('small.text-info.d-block');
            if (newTaxiAmount > 0) {
                if (existingTaxiElement) {
                    // Update existing taxi element
                    existingTaxiElement.textContent = `Taxi: ${newTaxiAmount.toLocaleString()}ƒë`;
                } else {
                    // Create new taxi element
                    const newTaxiElement = document.createElement('small');
                    newTaxiElement.className = 'text-info d-block';
                    newTaxiElement.textContent = `Taxi: ${newTaxiAmount.toLocaleString()}ƒë`;
                    
                    // Insert after room amount
                    if (roomAmountElement && roomAmountElement.parentNode) {
                        roomAmountElement.parentNode.insertBefore(newTaxiElement, roomAmountElement.nextSibling);
                    }
                }
            } else {
                // Remove taxi element if amount is 0
                if (existingTaxiElement) {
                    existingTaxiElement.remove();
                }
            }
            
            // Update the onclick handlers for the buttons to use new amounts
            const collectButton = card.querySelector('button.btn-success');
            const editButton = card.querySelector('button.btn-outline-primary');
            
            if (collectButton) {
                const onclickAttr = collectButton.getAttribute('onclick');
                if (onclickAttr) {
                    // Update the onclick with new amounts
                    const updatedOnclick = onclickAttr.replace(
                        /openCollectModal\([^)]+\)/,
                        `openCollectModal('${bookingId}', '${currentEditBookingData.guestName}', ${newTotal}, 0, ${newRoomAmount}, ${newTaxiAmount})`
                    );
                    collectButton.setAttribute('onclick', updatedOnclick);
                }
            }
            
            if (editButton) {
                const onclickAttr = editButton.getAttribute('onclick');
                if (onclickAttr) {
                    // Update the onclick with new amounts
                    const updatedOnclick = onclickAttr.replace(
                        /openEditAmountModal\([^)]+\)/,
                        `openEditAmountModal('${bookingId}', '${currentEditBookingData.guestName}', ${newRoomAmount}, ${newTaxiAmount})`
                    );
                    editButton.setAttribute('onclick', updatedOnclick);
                }
            }
            
            // Show success feedback
            showDashboardToast(`üìù ƒê√£ c·∫≠p nh·∫≠t s·ªë ti·ªÅn cho ${currentEditBookingData.guestName}`, 'success');
        }
    });
    
    // Update the overdue total summary as well
    setTimeout(() => {
        // Force refresh the overdue total by recalculating from visible cards
        recalculateOverdueTotal();
    }, 400);
}

// Recalculate total overdue amount from visible cards
function recalculateOverdueTotal() {
    const visibleCards = document.querySelectorAll('.col-md-4:not([style*="display: none"])');
    let totalAmount = 0;
    let totalGuests = 0;
    
    visibleCards.forEach(card => {
        const amountElement = card.querySelector('.fw-bold.text-danger');
        if (amountElement) {
            const amountText = amountElement.textContent.replace(/[^\d]/g, '');
            const amount = parseInt(amountText) || 0;
            if (amount > 0) {
                totalAmount += amount;
                totalGuests++;
            }
        }
    });
    
    // Update the header total
    const totalAmountElement = document.querySelector('.alert-danger .h5');
    if (totalAmountElement) {
        totalAmountElement.textContent = `${totalAmount.toLocaleString()}ƒë`;
    }
    
    // Update guest count
    const guestCountElement = document.querySelector('.alert-danger p');
    if (guestCountElement) {
        guestCountElement.textContent = `${totalGuests} kh√°ch ƒë√£ check-in nh∆∞ng ch∆∞a thu ti·ªÅn`;
    }
}

function loadQuickNotesOnDashboard() {
    const container = document.getElementById('quickNotesContainer');
    
    // Try to load from server first, fallback to localStorage
    loadQuickNotesFromServer()
        .then(serverNotes => {
            displayQuickNotes(serverNotes, container);
        })
        .catch(error => {
            console.log('Loading from localStorage as fallback...');
            const localNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            displayQuickNotes(localNotes, container);
        });
}

async function loadQuickNotesFromServer() {
    try {
        const response = await fetch('/api/quick_notes');
        const data = await response.json();
        
        if (data.success && data.notes) {
            // Convert server format to client format
            const convertedNotes = data.notes.map(note => ({
                id: note.id,
                type: note.type,
                content: note.content,
                date: note.date,
                time: note.time,
                guestName: note.guestname || '',
                created_at: note.createdat,
                completed: note.completed === 'true'
            }));
            
            // Also save to localStorage for offline access
            localStorage.setItem('quickNotes', JSON.stringify(convertedNotes));
            
            return convertedNotes;
        } else {
            throw new Error('Failed to load from server');
        }
    } catch (error) {
        console.error('Error loading from server:', error);
        throw error;
    }
}

function displayQuickNotes(notes, container) {
    // Filter active notes (not completed)
    const activeNotes = notes.filter(note => !note.completed);
    
    if (activeNotes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-sticky-note fa-3x text-white-50 mb-3"></i>
                <p class="mb-2 text-white fw-bold">Ch∆∞a c√≥ Quick Notes n√†o</p>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#quickNotesModal">
                    <i class="fas fa-plus me-1"></i>T·∫°o Note ƒë·∫ßu ti√™n
                </button>
            </div>
        `;
        return;
    }
    
    const typeIcons = {
        'thu-tien': 'fas fa-money-bill-wave',
        'huy-phong': 'fas fa-times-circle',
        'taxi': 'fas fa-taxi'
    };
    
    const typeNames = {
        'thu-tien': 'Thu ti·ªÅn l·∫°i',
        'huy-phong': 'H·ªßy ph√≤ng', 
        'taxi': 'Taxi'
    };
    
    const typeColors = {
        'thu-tien': 'success',
        'huy-phong': 'danger',
        'taxi': 'warning'
    };
    
    // Sort by reminder date/time
    activeNotes.sort((a, b) => {
        const dateA = new Date(`${a.date} ${a.time}`);
        const dateB = new Date(`${b.date} ${b.time}`);
        return dateA - dateB;
    });
    
    const notesHtml = activeNotes.map(note => {
        const reminderDate = new Date(`${note.date} ${note.time}`);
        const now = new Date();
        const isOverdue = reminderDate < now;
        const isToday = reminderDate.toDateString() === now.toDateString();
        
        let timeStatus = '';
        if (isOverdue) {
            timeStatus = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Qu√° h·∫°n</span>';
        } else if (isToday) {
            timeStatus = '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>H√¥m nay</span>';
        } else {
            const diffTime = Math.abs(reminderDate - now);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            timeStatus = `<span class="badge bg-info">${diffDays} ng√†y n·ªØa</span>`;
        }
        
        return `
            <div class="col-12 mb-3">
                <div class="card border-0 bg-white shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <i class="${typeIcons[note.type]} text-${typeColors[note.type]} me-2"></i>
                                <strong class="text-dark">${typeNames[note.type]}</strong>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="markNoteCompleted('${note.id}')" title="Ho√†n th√†nh v√† x√≥a note">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                        <div class="bg-light rounded p-3 mb-3">
                            <p class="text-dark mb-0" style="font-size: 16px; line-height: 1.5; font-weight: 500;">${note.content}</p>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>${note.guestName}
                            </small>
                            <div>
                                <small class="text-muted d-block">
                                    <i class="fas fa-calendar me-1"></i>${note.date} ${note.time}
                                </small>
                                ${timeStatus}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="row">
            ${notesHtml}
        </div>
    `;
}


async function markNoteCompleted(noteId) {
    try {
        // Delete from server immediately when marked complete
        const response = await fetch(`/api/quick_notes/${noteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove from localStorage immediately
            let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            notes = notes.filter(note => note.id !== noteId);
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            
            // Show success toast
            showDashboardToast('‚úÖ ƒê√£ ho√†n th√†nh v√† x√≥a note kh·ªèi h·ªá th·ªëng!', 'success');
            
            // Reload notes display
            loadQuickNotesOnDashboard();
        } else {
            throw new Error(data.message || 'Server error');
        }
    } catch (error) {
        console.error('Error completing note:', error);
        showDashboardToast('‚ùå L·ªói khi x√≥a tr√™n server. ƒê√£ x√≥a local.', 'warning');
        
        // Fallback to localStorage only - still delete locally
        let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
        notes = notes.filter(note => note.id !== noteId);
        localStorage.setItem('quickNotes', JSON.stringify(notes));
        loadQuickNotesOnDashboard();
    }
}

async function deleteNoteFromDashboard(noteId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a note n√†y kh·ªèi Google Sheets?')) {
        try {
            // Delete from server first
            const response = await fetch(`/api/quick_notes/${noteId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Also delete from localStorage
                let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
                notes = notes.filter(note => note.id !== noteId);
                localStorage.setItem('quickNotes', JSON.stringify(notes));
                
                showDashboardToast('üóëÔ∏è ƒê√£ x√≥a note kh·ªèi Google Sheets!', 'info');
                loadQuickNotesOnDashboard();
            } else {
                throw new Error(data.message || 'Server error');
            }
        } catch (error) {
            console.error('Error deleting note:', error);
            showDashboardToast('‚ùå L·ªói khi x√≥a tr√™n server. ƒê√£ x√≥a local.', 'warning');
            
            // Fallback to localStorage only
            let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            notes = notes.filter(note => note.id !== noteId);
            localStorage.setItem('quickNotes', JSON.stringify(notes));
            loadQuickNotesOnDashboard();
        }
    }
}

// Export Quick Notes to JSON file
function exportQuickNotes() {
    const notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
    
    if (notes.length === 0) {
        showDashboardToast('‚ö†Ô∏è Kh√¥ng c√≥ notes n√†o ƒë·ªÉ export!', 'warning');
        return;
    }
    
    // Create export data
    const exportData = {
        exportDate: new Date().toISOString(),
        totalNotes: notes.length,
        quickNotes: notes
    };
    
    // Create and download file
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `quick-notes-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showDashboardToast('üì• ƒê√£ export Quick Notes th√†nh c√¥ng!', 'success');
}

// Import Quick Notes from JSON file
function importQuickNotes() {
    document.getElementById('quickNotesFileInput').click();
}

function handleQuickNotesImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.name.endsWith('.json')) {
        showDashboardToast('‚ùå Vui l√≤ng ch·ªçn file JSON!', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            // Validate data structure
            if (!importedData.quickNotes || !Array.isArray(importedData.quickNotes)) {
                throw new Error('Invalid file format');
            }
            
            // Get existing notes
            const existingNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
            
            // Ask user how to handle import
            const choice = confirm(
                `T√¨m th·∫•y ${importedData.quickNotes.length} notes trong file.\n\n` +
                `B·∫°n c√≥ ${existingNotes.length} notes hi·ªán t·∫°i.\n\n` +
                `Nh·∫•n OK ƒë·ªÉ THAY TH·∫æ t·∫•t c·∫£ notes hi·ªán t·∫°i\n` +
                `Nh·∫•n Cancel ƒë·ªÉ H·ª¶Y import`
            );
            
            if (choice) {
                // Replace all notes
                localStorage.setItem('quickNotes', JSON.stringify(importedData.quickNotes));
                loadQuickNotesOnDashboard();
                showDashboardToast(`‚úÖ ƒê√£ import ${importedData.quickNotes.length} notes th√†nh c√¥ng!`, 'success');
            } else {
                showDashboardToast('‚ùå ƒê√£ h·ªßy import', 'info');
            }
            
        } catch (error) {
            console.error('Import error:', error);
            showDashboardToast('‚ùå L·ªói ƒë·ªçc file! Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.', 'error');
        }
    };
    
    reader.readAsText(file);
    // Reset file input
    event.target.value = '';
}

// Sync Quick Notes from Google Sheets
async function syncQuickNotes() {
    const syncBtn = document.querySelector('button[onclick="syncQuickNotes()"]');
    const originalHtml = syncBtn.innerHTML;
    
    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang sync...';
    syncBtn.disabled = true;
    
    try {
        const serverNotes = await loadQuickNotesFromServer();
        showDashboardToast(`‚òÅÔ∏è ƒê√£ sync ${serverNotes.length} notes t·ª´ Google Sheets!`, 'success');
        loadQuickNotesOnDashboard();
    } catch (error) {
        console.error('Sync error:', error);
        showDashboardToast('‚ùå L·ªói khi sync t·ª´ Google Sheets!', 'error');
    } finally {
        syncBtn.innerHTML = originalHtml;
        syncBtn.disabled = false;
    }
}

function refreshQuickNotes() {
    const refreshBtn = document.querySelector('button[onclick="refreshQuickNotes()"]');
    const originalHtml = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫£i...';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        loadQuickNotesOnDashboard();
        refreshBtn.innerHTML = originalHtml;
        refreshBtn.disabled = false;
        showDashboardToast('üîÑ ƒê√£ l√†m m·ªõi Quick Notes!', 'info');
    }, 500);
}

function showDashboardToast(message, type = 'success') {
    const colors = {
        success: 'bg-success',
        error: 'bg-danger', 
        info: 'bg-info',
        warning: 'bg-warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 end-0 m-3 p-3 ${colors[type]} text-white rounded`;
    toast.style.zIndex = '9999';
    toast.innerHTML = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ==================== PIN NOTIFICATION FUNCTIONS ====================
function scrollToOvercrowdedSection() {
    const section = document.getElementById('overcrowdedSection');
    if (section) {
        section.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        
        // Highlight the section briefly
        section.style.boxShadow = '0 0 20px rgba(255, 149, 0, 0.8)';
        setTimeout(() => {
            section.style.boxShadow = '';
        }, 2000);
    }
}

function dismissPinNotification() {
    const notification = document.querySelector('.fixed-top.alert-warning');
    const spacer = notification?.nextElementSibling;
    
    if (notification) {
        notification.style.transform = 'translateY(-100%)';
        setTimeout(() => {
            notification.remove();
            if (spacer && spacer.style.height === '80px') {
                spacer.remove();
            }
        }, 300);
        
        // Save dismiss state for this session
        sessionStorage.setItem('overcrowdedPinDismissed', 'true');
        showDashboardToast('‚ÑπÔ∏è Notification ƒë√£ ƒë∆∞·ª£c ·∫©n cho phi√™n n√†y', 'info');
    }
}

// Check if pin notification should be shown
document.addEventListener('DOMContentLoaded', function() {
    const dismissed = sessionStorage.getItem('overcrowdedPinDismissed');
    const pinNotification = document.querySelector('.fixed-top.alert-warning');
    
    if (dismissed === 'true' && pinNotification) {
        pinNotification.style.display = 'none';
        const spacer = pinNotification.nextElementSibling;
        if (spacer && spacer.style.height === '80px') {
            spacer.style.display = 'none';
        }
    }
});

// Toggle overcrowded details section
function toggleOvercrowdedDetails() {
    const details = document.getElementById('overcrowdedDetails');
    const toggleText = document.getElementById('overcrowdToggleText');
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        toggleText.textContent = '·∫®n chi ti·∫øt';
    } else {
        details.style.display = 'none';
        toggleText.textContent = 'Chi ti·∫øt';
    }
}

// Show day details modal
function showDayDetails(date, guestCount, guestNames, bookingIds) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        <i class="fas fa-users me-2"></i>Chi ti·∫øt ng√†y qu√° t·∫£i: ${date}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong><i class="fas fa-exclamation-triangle me-2"></i>C·∫£nh b√°o:</strong> 
                        Ng√†y n√†y c√≥ ${guestCount} kh√°ch check-in, v∆∞·ª£t qu√° s·ª©c ch·ª©a 4 ph√≤ng.
                    </div>
                    <h6><i class="fas fa-list me-2"></i>Danh s√°ch kh√°ch check-in:</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>T√™n kh√°ch</th>
                                    <th>M√£ booking</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${guestNames.map((name, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${name}</strong></td>
                                        <td><span class="badge bg-info">${bookingIds[index]}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <h6><i class="fas fa-lightbulb me-2"></i>ƒê·ªÅ xu·∫•t gi·∫£i ph√°p:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>Li√™n h·ªá kh√°ch ƒë·ªÉ s·∫Øp x·∫øp l·∫°i l·ªãch check-in</li>
                            <li><i class="fas fa-check text-success me-2"></i>T√¨m ph√≤ng tr·ªëng ·ªü kh√°ch s·∫°n kh√°c g·∫ßn ƒë√≥</li>
                            <li><i class="fas fa-check text-success me-2"></i>ƒê·ªÅ xu·∫•t upgrade ho·∫∑c early check-in ng√†y h√¥m tr∆∞·ªõc</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

// === QUICK NOTES MODAL FUNCTIONS ===
function openQuickNotesModal() {
    document.getElementById('quickNotesModal').modal('show');
}

function saveQuickNote() {
    const noteType = document.getElementById('noteType').value;
    const noteContent = document.getElementById('noteContent').value;
    const noteDate = document.getElementById('noteDate').value;
    const noteTime = document.getElementById('noteTime').value;
    
    if (!noteType || !noteContent || !noteDate || !noteTime) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
    }
    
    const noteData = {
        id: Date.now().toString(),
        type: noteType,
        content: noteContent,
        date: noteDate,
        time: noteTime,
        guestName: '', // Add missing guestName field
        completed: false, // Explicitly set as not completed
        created_at: new Date().toISOString()
    };
    
    // Save to localStorage
    let savedNotes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
    savedNotes.unshift(noteData);
    localStorage.setItem('quickNotes', JSON.stringify(savedNotes));
    
    // Send to server
    fetch('/api/quick_notes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(noteData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Note saved to Google Sheets successfully');
            showDashboardToast('‚úÖ ƒê√£ l∆∞u quick note v√†o Google Sheets!', 'success');
        } else {
            console.error('Server save failed:', data.message);
            showDashboardToast('‚ö†Ô∏è ƒê√£ l∆∞u local, nh∆∞ng l·ªói khi sync l√™n Google Sheets', 'warning');
        }
    })
    .catch(error => {
        console.error('Error saving to server:', error);
        showDashboardToast('‚ö†Ô∏è ƒê√£ l∆∞u local, nh∆∞ng l·ªói khi sync l√™n Google Sheets', 'warning');
    });
    
    // Reset form
    document.getElementById('quickNotesForm').reset();
    document.getElementById('noteDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('noteTime').value = new Date().toTimeString().slice(0, 5);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('quickNotesModal'));
    if (modal) {
        modal.hide();
    } else {
        // Fallback: create new modal instance and hide
        const newModal = new bootstrap.Modal(document.getElementById('quickNotesModal'));
        newModal.hide();
    }
    
    // Refresh notes display
    loadQuickNotesOnDashboard();
}

function selectNoteType(type) {
    document.getElementById('noteType').value = type;
    
    // Update button styles
    document.querySelectorAll('.note-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Set default content based on type
    const contentField = document.getElementById('noteContent');
    switch(type) {
        case 'thu-tien':
            contentField.value = 'Thu ti·ªÅn t·ª´ kh√°ch: ';
            break;
        case 'huy-phong':
            contentField.value = 'H·ªßy ph√≤ng cho kh√°ch: ';
            break;
        case 'taxi':
            contentField.value = 'ƒê·∫∑t taxi cho kh√°ch: ';
            break;
        default:
            contentField.value = '';
    }
    contentField.focus();
}

// ==================== EDIT AMOUNT MODAL FUNCTIONS ====================
let currentEditBookingData = {};

function openEditAmountModal(bookingId, guestName, roomFee, taxiFee) {
    // Store booking data for editing
    currentEditBookingData = {
        bookingId: bookingId,
        guestName: guestName,
        roomFee: roomFee || 0,
        taxiFee: taxiFee || 0
    };
    
    // Reset form
    document.getElementById('editAmountForm').reset();
    
    // Populate modal data
    document.getElementById('editModalGuestName').textContent = guestName;
    document.getElementById('editModalBookingId').textContent = bookingId;
    document.getElementById('editRoomAmount').value = roomFee || 0;
    document.getElementById('editTaxiAmount').value = taxiFee || 0;
    
    // Update total preview
    updateTotalPreview();
    
    // Add event listeners for real-time total calculation
    document.getElementById('editRoomAmount').addEventListener('input', updateTotalPreview);
    document.getElementById('editTaxiAmount').addEventListener('input', updateTotalPreview);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editAmountModal'));
    modal.show();
}

function updateTotalPreview() {
    const roomAmount = parseFloat(document.getElementById('editRoomAmount').value) || 0;
    const taxiAmount = parseFloat(document.getElementById('editTaxiAmount').value) || 0;
    const total = roomAmount + taxiAmount;
    
    document.getElementById('editTotalPreview').textContent = total.toLocaleString() + 'ƒë';
}

function updateBookingAmounts() {
    const roomAmount = parseFloat(document.getElementById('editRoomAmount').value) || 0;
    const taxiAmount = parseFloat(document.getElementById('editTaxiAmount').value) || 0;
    const editNote = document.getElementById('editNote').value.trim();
    
    // Validation
    if (roomAmount < 0 || taxiAmount < 0) {
        alert('‚ùå S·ªë ti·ªÅn kh√¥ng th·ªÉ √¢m!');
        return;
    }
    
    if (roomAmount === 0 && taxiAmount === 0) {
        alert('‚ùå Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt kho·∫£n ti·ªÅn!');
        return;
    }
    
    // Disable button and show loading
    const confirmBtn = document.getElementById('confirmEditBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang c·∫≠p nh·∫≠t...';
    confirmBtn.disabled = true;
    
    // Prepare update data for the new API endpoint
    const updateData = {
        booking_id: currentEditBookingData.bookingId,
        room_amount: roomAmount,
        taxi_amount: taxiAmount,
        edit_note: editNote
    };
    
    console.log('Sending update data:', updateData);
    
    // Call the correct API endpoint for updating guest amounts
    fetch('/api/update_guest_amounts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Success - close modal and update display immediately
            showDashboardToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t s·ªë ti·ªÅn th√†nh c√¥ng!', 'success');
            
            // Update the guest card immediately
            updateGuestCardAmounts(currentEditBookingData.bookingId, roomAmount, taxiAmount);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAmountModal'));
            modal.hide();
            
            // No page reload needed!
        } else {
            throw new Error(data.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
    })
    .catch(error => {
        console.error('Update amounts error:', error);
        showDashboardToast(`‚ùå L·ªói c·∫≠p nh·∫≠t: ${error.message}`, 'error');
    })
    .finally(() => {
        // Restore button
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// ===== ARRIVAL & DEPARTURE NOTIFICATION FUNCTIONS =====

function createArrivalNotification() {
    // Quick action for arrival notifications
    const message = prompt("Nh·∫≠p tin nh·∫Øn ch√†o m·ª´ng cho kh√°ch ƒë·∫øn:", 
                          "Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi kh√°ch s·∫°n! Ph√≤ng ƒë√£ s·∫µn s√†ng. Vui l√≤ng li√™n h·ªá reception ƒë·ªÉ check-in.");
    
    if (message) {
        // Here you could send to messaging system or create a reminder
        showDashboardToast(`‚úÖ ƒê√£ t·∫°o th√¥ng b√°o ch√†o m·ª´ng kh√°ch ƒë·∫øn!`, 'success');
        
        // Optional: You could integrate with your messaging templates here
        console.log('Arrival notification created:', message);
    }
}

function editDefaultArrivalTime() {
    const currentTime = document.getElementById('defaultArrivalTime').textContent;
    const newTime = prompt('Nh·∫≠p th·ªùi gian check-in m·∫∑c ƒë·ªãnh (HH:MM):', currentTime);
    
    if (newTime && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(newTime)) {
        document.getElementById('defaultArrivalTime').textContent = newTime;
        
        // Update all guest times to new default
        const timeElements = document.querySelectorAll('[id^="time-"]');
        timeElements.forEach(el => {
            el.textContent = newTime;
        });
        
        showDashboardToast(`‚è∞ ƒê√£ c·∫≠p nh·∫≠t th·ªùi gian check-in m·∫∑c ƒë·ªãnh: ${newTime}`, 'success');
        
        // Save to localStorage for persistence
        localStorage.setItem('defaultArrivalTime', newTime);
    } else if (newTime) {
        showDashboardToast('‚ùå ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng h·ª£p l·ªá! S·ª≠ d·ª•ng HH:MM', 'error');
    }
}

function editGuestArrivalTime(bookingId, guestName) {
    const currentTimeElement = document.getElementById(`time-${bookingId}`);
    const currentTime = currentTimeElement.textContent;
    const newTime = prompt(`Nh·∫≠p th·ªùi gian ƒë·∫øn cho ${guestName} (HH:MM):`, currentTime);
    
    if (newTime && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(newTime)) {
        currentTimeElement.textContent = newTime;
        showDashboardToast(`‚è∞ ƒê√£ c·∫≠p nh·∫≠t th·ªùi gian ƒë·∫øn cho ${guestName}: ${newTime}`, 'success');
        
        // Save guest-specific time to localStorage
        const guestTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
        guestTimes[bookingId] = newTime;
        localStorage.setItem('guestArrivalTimes', JSON.stringify(guestTimes));
    } else if (newTime) {
        showDashboardToast('‚ùå ƒê·ªãnh d·∫°ng th·ªùi gian kh√¥ng h·ª£p l·ªá! S·ª≠ d·ª•ng HH:MM', 'error');
    }
}

function copyTaxiMessage(guestName) {
    // Sample taxi message template
    const message = `Hi ${guestName}, If you need a taxi to the airport tomorrow, please don't hesitate to let me know. I can arrange one for you at a special discounted rate that our guests often appreciate.`;
    
    // Copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(message).then(() => {
            showDashboardToast(`üìã ƒê√£ copy tin nh·∫Øn taxi cho ${guestName}!`, 'success');
        }).catch(err => {
            console.error('Failed to copy:', err);
            // Fallback method
            fallbackCopy(message, guestName);
        });
    } else {
        // Fallback for older browsers
        fallbackCopy(message, guestName);
    }
}

function fallbackCopy(text, guestName) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.opacity = '0';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showDashboardToast(`üìã ƒê√£ copy tin nh·∫Øn taxi cho ${guestName}!`, 'success');
    } catch (err) {
        console.error('Fallback copy failed:', err);
        alert(`Tin nh·∫Øn taxi cho ${guestName}:\n\n${text}`);
    }
    
    document.body.removeChild(textArea);
}

function createDepartureNotification() {
    // Quick action for departure notifications
    const taxiNeeded = confirm("Kh√°ch c√≥ c·∫ßn h·ªó tr·ª£ ƒë·∫∑t taxi kh√¥ng?");
    
    if (taxiNeeded) {
        const message = "C·∫£m ∆°n b·∫°n ƒë√£ l∆∞u tr√∫ t·∫°i kh√°ch s·∫°n! Ch√∫ng t√¥i c√≥ th·ªÉ h·ªó tr·ª£ ƒë·∫∑t taxi ƒë·∫øn s√¢n bay v·ªõi gi√° ∆∞u ƒë√£i 280,000ƒë. Vui l√≤ng cho bi·∫øt th·ªùi gian kh·ªüi h√†nh.";
        
        // Create notification with taxi service
        showDashboardToast(`üöï ƒê√£ t·∫°o th√¥ng b√°o h·ªó tr·ª£ taxi cho kh√°ch ƒëi!`, 'success');
        console.log('Departure notification with taxi:', message);
    } else {
        const message = "C·∫£m ∆°n b·∫°n ƒë√£ l∆∞u tr√∫ t·∫°i kh√°ch s·∫°n! Ch√∫c b·∫°n c√≥ chuy·∫øn ƒëi an to√†n. N·∫øu c·∫ßn h·ªó tr·ª£ g√¨, vui l√≤ng li√™n h·ªá ch√∫ng t√¥i.";
        
        // Create standard departure notification
        showDashboardToast(`‚úÖ ƒê√£ t·∫°o th√¥ng b√°o c·∫£m ∆°n kh√°ch ƒëi!`, 'success');
        console.log('Departure notification:', message);
    }
}

// Quick notification function for mobile
function quickNotify(type, guestName) {
    const templates = {
        arrival: `Ch√†o m·ª´ng ${guestName}! Ph√≤ng ƒë√£ s·∫µn s√†ng, vui l√≤ng li√™n h·ªá reception.`,
        departure: `C·∫£m ∆°n ${guestName}! N·∫øu c·∫ßn taxi s√¢n bay (280k), vui l√≤ng cho bi·∫øt gi·ªù kh·ªüi h√†nh.`
    };
    
    const message = templates[type];
    if (message) {
        // Copy to clipboard for quick use
        navigator.clipboard.writeText(message).then(() => {
            showDashboardToast(`üìã ƒê√£ copy tin nh·∫Øn cho ${guestName}!`, 'success');
        });
    }
}
</script>

<!-- Quick Notes Modal -->
<div class="modal fade" id="quickNotesModal" tabindex="-1" aria-labelledby="quickNotesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="quickNotesModalLabel">
                    <i class="fas fa-sticky-note me-2"></i>T·∫°o Quick Note M·ªõi
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="quickNotesForm">
                    <!-- Note Type Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Ch·ªçn lo·∫°i ghi ch√∫:</label>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-success w-100 note-type-btn" onclick="selectNoteType('thu-tien')">
                                    <i class="fas fa-money-bill-wave d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-bold">Thu ti·ªÅn</div>
                                    <small>Nh·∫Øc thu ti·ªÅn kh√°ch</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-danger w-100 note-type-btn" onclick="selectNoteType('huy-phong')">
                                    <i class="fas fa-times-circle d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-bold">H·ªßy ph√≤ng</div>
                                    <small>X·ª≠ l√Ω h·ªßy booking</small>
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-outline-warning w-100 note-type-btn" onclick="selectNoteType('taxi')">
                                    <i class="fas fa-taxi d-block mb-2" style="font-size: 2rem;"></i>
                                    <div class="fw-bold">Taxi</div>
                                    <small>ƒê·∫∑t taxi cho kh√°ch</small>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden field for note type -->
                    <input type="hidden" id="noteType" name="noteType">
                    
                    <!-- Note Content -->
                    <div class="mb-3">
                        <label for="noteContent" class="form-label fw-bold">N·ªôi dung ghi ch√∫:</label>
                        <textarea class="form-control" id="noteContent" name="noteContent" rows="4" 
                                  placeholder="Nh·∫≠p chi ti·∫øt ghi ch√∫..."></textarea>
                    </div>
                    
                    <!-- Date and Time -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="noteDate" class="form-label fw-bold">Ng√†y:</label>
                            <input type="date" class="form-control" id="noteDate" name="noteDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="noteTime" class="form-label fw-bold">Gi·ªù:</label>
                            <input type="time" class="form-control" id="noteTime" name="noteTime" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-primary" onclick="saveQuickNote()">
                    <i class="fas fa-save me-1"></i>L∆∞u Quick Note
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize modal date and time when modal opens
document.getElementById('quickNotesModal').addEventListener('show.bs.modal', function () {
    const now = new Date();
    document.getElementById('noteDate').value = now.toISOString().split('T')[0];
    document.getElementById('noteTime').value = now.toTimeString().slice(0, 5);
});

// Initialize arrival times from localStorage
document.addEventListener('DOMContentLoaded', function() {
    // Load default arrival time
    const defaultTime = localStorage.getItem('defaultArrivalTime');
    if (defaultTime) {
        const defaultTimeElement = document.getElementById('defaultArrivalTime');
        if (defaultTimeElement) {
            defaultTimeElement.textContent = defaultTime;
        }
    }
    
    // Load guest-specific arrival times
    const guestTimes = JSON.parse(localStorage.getItem('guestArrivalTimes') || '{}');
    Object.entries(guestTimes).forEach(([bookingId, time]) => {
        const timeElement = document.getElementById(`time-${bookingId}`);
        if (timeElement) {
            timeElement.textContent = time;
        }
    });
});
</script>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}