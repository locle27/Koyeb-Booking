{% extends "base.html" %}

{% block title %}Dashboard - Hotel Management{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">üìä Dashboard T·ªïng quan</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">T·ªïng quan v·ªÅ hi·ªáu su·∫•t kh√°ch s·∫°n</li>
    </ol>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter"></i>
            T√πy ch·ªânh kho·∫£ng th·ªùi gian
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('dashboard') }}" class="row g-3 align-items-center">
                <div class="col-md-5">
                    <label for="start_date" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-md-5">
                    <label for="end_date" class="form-label">Ng√†y k·∫øt th√∫c</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> L·ªçc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚ö†Ô∏è KH√ÅCH CH∆ØA THU TI·ªÄN QU√Å H·∫†N -->
    {% if overdue_unpaid_guests and overdue_unpaid_guests|length > 0 %}
    <div class="alert alert-danger border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h4 class="alert-heading text-white mb-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è KH√ÅCH CH∆ØA THU TI·ªÄN QU√Å H·∫†N
                </h4>
                <p class="text-white mb-0">{{ overdue_unpaid_guests|length }} kh√°ch ƒë√£ check-in nh∆∞ng ch∆∞a thu ti·ªÅn</p>
            </div>
            <div class="text-end">
                <div class="text-white">
                    <div class="h5 mb-0">{{ "{:,.0f}".format(overdue_total_amount) }}ƒë</div>
                    <small>T·ªïng ti·ªÅn ch∆∞a thu</small>
                </div>
            </div>
        </div>
        
        <hr class="text-white-50 my-3">
        
        <div class="row">
            {% for guest in overdue_unpaid_guests[:3] %}
            <div class="col-md-4 mb-2">
                <div class="card bg-white bg-opacity-90 border-0">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 text-dark">{{ guest['T√™n ng∆∞·ªùi ƒë·∫∑t'] }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>{{ guest['Check-in Date'].strftime('%d/%m/%Y') }}
                                    <span class="ms-2 badge bg-danger">{{ guest['days_overdue'] }} ng√†y</span>
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-danger">{{ "{:,.0f}".format(guest['T·ªïng thanh to√°n']) }}ƒë</div>
                                <small class="text-muted">ID: {{ guest['S·ªë ƒë·∫∑t ph√≤ng'] }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if overdue_unpaid_guests|length > 3 %}
        <div class="text-center mt-3">
            <button class="btn btn-outline-light" onclick="toggleMoreOverdue()">
                <i class="fas fa-chevron-down me-1"></i> Xem th√™m {{ overdue_unpaid_guests|length - 3 }} kh√°ch
            </button>
        </div>
        <div id="moreOverdueGuests" style="display: none;" class="mt-3">
            <div class="row">
                {% for guest in overdue_unpaid_guests[3:] %}
                <div class="col-md-4 mb-2">
                    <div class="card bg-white bg-opacity-90 border-0">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1 text-dark">{{ guest['T√™n ng∆∞·ªùi ƒë·∫∑t'] }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>{{ guest['Check-in Date'].strftime('%d/%m/%Y') }}
                                        <span class="ms-2 badge bg-danger">{{ guest['days_overdue'] }} ng√†y</span>
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-danger">{{ "{:,.0f}".format(guest['T·ªïng thanh to√°n']) }}ƒë</div>
                                    <small class="text-muted">ID: {{ guest['S·ªë ƒë·∫∑t ph√≤ng'] }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Key Metrics -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">Doanh thu</div>
                            <div class="fs-3 fw-bold">{{ "{:,.0f}".format(total_revenue) }}ƒë</div>
                        </div>
                        <i class="fas fa-coins fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">L∆∞·ª£ng kh√°ch</div>
                            <div class="fs-3 fw-bold">{{ total_guests }}</div>
                        </div>
                        <i class="fas fa-users fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- More metrics can be added here -->
    </div>

    <!-- Charts -->
    <!-- Bi·ªÉu ƒë·ªì doanh thu chuy√™n nghi·ªáp -->
    <div class="row">
        <div class="col-xl-12">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-line me-2"></i>
                            <span class="fw-bold">üìà Doanh thu theo th√°ng (T·∫•t c·∫£ th·ªùi gian)</span>
                        </div>
                        <div class="badge bg-light text-dark">Chi ti·∫øt ƒë·∫ßy ƒë·ªß</div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="monthlyRevenueChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- B·∫£ng chi ti·∫øt v√† ph√¢n t√≠ch -->
    {% if monthly_revenue_with_unpaid %}
    <div class="row">
        <div class="col-xl-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-1 text-primary"></i> 
                        Chi ti·∫øt Doanh thu theo th√°ng (Bao g·ªìm kh√°ch ch∆∞a thu ti·ªÅn)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="border-0">
                                        <i class="fas fa-calendar-alt me-1"></i>Th√°ng
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-check-circle me-1 text-success"></i>ƒê√£ thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-clock me-1 text-warning"></i>Ch∆∞a thu
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-users me-1 text-info"></i>Kh√°ch ch∆∞a thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-coins me-1 text-info"></i>T·ªïng c·ªông
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-percentage me-1 text-primary"></i>T·ª∑ l·ªá thu
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in monthly_revenue_with_unpaid %}
                                <tr class="border-bottom">
                                    <td>
                                        <div class="fw-bold text-primary">{{ row['Th√°ng'] }}</div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-success">
                                            {{ "{:,.0f}".format(row['ƒê√£ thu'] | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-danger">
                                            {{ "{:,.0f}".format(row['Ch∆∞a thu'] | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% if row['S·ªë kh√°ch ch∆∞a thu'] > 0 %}
                                        <span class="badge bg-warning text-dark">
                                            {{ row['S·ªë kh√°ch ch∆∞a thu'] }} kh√°ch
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> ƒê√£ thu h·∫øt
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-dark">
                                            {{ "{:,.0f}".format((row['ƒê√£ thu'] | float) + (row['Ch∆∞a thu'] | float)) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set total = (row['ƒê√£ thu'] | float) + (row['Ch∆∞a thu'] | float) %}
                                        {% set percentage = (row['ƒê√£ thu'] | float) / total * 100 if total > 0 else 0 %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if percentage >= 90 %}bg-success{% elif percentage >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ percentage }}%;" 
                                                 aria-valuenow="{{ percentage }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                <small class="fw-bold">{{ "{:.1f}%".format(percentage) }}</small>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-1 text-primary"></i> 
                        Ph√¢n b·ªï theo Ng∆∞·ªùi thu
                    </h6>
                </div>
                <div class="card-body">
                    <div id="collectorChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded, initializing charts...');
    
    // Monthly Revenue Chart
    const monthlyRevenueChartData = {{ monthly_revenue_chart_json | tojson | safe }};
    console.log('Monthly revenue chart data:', monthlyRevenueChartData);
    
    if (monthlyRevenueChartData && 
        typeof monthlyRevenueChartData === 'object' && 
        Object.keys(monthlyRevenueChartData).length > 0 &&
        monthlyRevenueChartData.data && 
        monthlyRevenueChartData.layout) {
        try {
            Plotly.newPlot('monthlyRevenueChart', monthlyRevenueChartData.data, monthlyRevenueChartData.layout, {
                responsive: true,
                displayModeBar: false
            });
            console.log('Monthly revenue chart rendered successfully');
        } catch (error) {
            console.error('Error rendering monthly revenue chart:', error);
            document.getElementById('monthlyRevenueChart').innerHTML = 
                '<div class="alert alert-danger">L·ªói hi·ªÉn th·ªã bi·ªÉu ƒë·ªì: ' + error.message + '</div>';
        }
    } else {
        console.log('No monthly revenue chart data available');
        document.getElementById('monthlyRevenueChart').innerHTML = 
            '<div class="text-center py-5"><i class="fas fa-chart-line fa-3x text-muted mb-3"></i><p class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì</p></div>';
    }

    // Collector Revenue Pie Chart
    const collectorChartData = {{ collector_chart_json | tojson | safe }};
    console.log('Collector chart data:', collectorChartData);
    
    if (collectorChartData && 
        typeof collectorChartData === 'object' && 
        Object.keys(collectorChartData).length > 0 &&
        collectorChartData.data && 
        Array.isArray(collectorChartData.data) &&
        collectorChartData.data.length > 0 &&
        collectorChartData.data[0].values && 
        Array.isArray(collectorChartData.data[0].values) &&
        collectorChartData.data[0].values.length > 0 &&
        collectorChartData.layout) {
        try {
            Plotly.newPlot('collectorChart', collectorChartData.data, collectorChartData.layout, {
                responsive: true,
                displayModeBar: false
            });
            console.log('Collector chart rendered successfully');
        } catch (error) {
            console.error('Error rendering collector chart:', error);
            document.getElementById('collectorChart').innerHTML = 
                '<div class="alert alert-danger">L·ªói hi·ªÉn th·ªã bi·ªÉu ƒë·ªì: ' + error.message + '</div>';
        }
    } else {
        console.log('No collector chart data available or empty values');
        document.getElementById('collectorChart').innerHTML = 
            '<div class="text-center py-5"><i class="fas fa-chart-pie fa-3x text-muted mb-3"></i><p class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu ng∆∞·ªùi thu ti·ªÅn</p></div>';
    }
});

// Toggle more overdue guests
function toggleMoreOverdue() {
    const moreOverdue = document.getElementById('moreOverdueGuests');
    const button = event.target;
    
    if (moreOverdue.style.display === 'none') {
        moreOverdue.style.display = 'block';
        button.innerHTML = '<i class="fas fa-chevron-up me-1"></i> Thu g·ªçn';
    } else {
        moreOverdue.style.display = 'none';
        button.innerHTML = '<i class="fas fa-chevron-down me-1"></i> Xem th√™m {{ overdue_unpaid_guests|length - 3 if overdue_unpaid_guests else 0 }} kh√°ch';
    }
}
</script>
{% endblock %}