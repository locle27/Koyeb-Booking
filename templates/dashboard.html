{% extends "base.html" %}

{% block title %}Dashboard - Hotel Management{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">üìä Dashboard T·ªïng quan</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">T·ªïng quan v·ªÅ hi·ªáu su·∫•t kh√°ch s·∫°n</li>
    </ol>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter"></i>
            T√πy ch·ªânh kho·∫£ng th·ªùi gian
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('dashboard') }}" class="row g-3 align-items-center">
                <div class="col-md-5">
                    <label for="start_date" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-md-5">
                    <label for="end_date" class="form-label">Ng√†y k·∫øt th√∫c</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> L·ªçc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚ö†Ô∏è KH√ÅCH CH∆ØA THU TI·ªÄN QU√Å H·∫†N -->
    {% if overdue_unpaid_guests and overdue_unpaid_guests|length > 0 %}
    <div class="alert alert-danger border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h4 class="alert-heading text-white mb-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è KH√ÅCH CH∆ØA THU TI·ªÄN QU√Å H·∫†N
                </h4>
                <p class="text-white mb-0">{{ overdue_unpaid_guests|length }} kh√°ch ƒë√£ check-in nh∆∞ng ch∆∞a thu ti·ªÅn</p>
            </div>
            <div class="text-end">
                <div class="text-white">
                    <div class="h5 mb-0">{{ "{:,.0f}".format(overdue_total_amount if overdue_total_amount else 0) }}ƒë</div>
                    <small>T·ªïng ti·ªÅn ch∆∞a thu</small>
                </div>
            </div>
        </div>
        
        <hr class="text-white-50 my-3">
        
        <div class="row">
            {% for guest in overdue_unpaid_guests[:3] %}
            <div class="col-md-4 mb-2">
                <div class="card bg-white bg-opacity-90 border-0">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 text-dark">{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', 'N/A') }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    {% if guest.get('Check-in Date') %}
                                        {% if guest['Check-in Date'] is string %}
                                            {{ guest['Check-in Date'] }}
                                        {% else %}
                                            {{ guest['Check-in Date'].strftime('%d/%m/%Y') if guest['Check-in Date'] else 'N/A' }}
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                    <span class="ms-2 badge bg-danger">{{ guest.get('days_overdue', 0) }} ng√†y</span>
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-danger">{{ "{:,.0f}".format(guest.get('T·ªïng thanh to√°n', 0) if guest.get('T·ªïng thanh to√°n') else 0) }}ƒë</div>
                                <small class="text-muted">ID: {{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', 'N/A') }}</small>
                                <button class="btn btn-success btn-sm mt-1 w-100" 
                                        onclick="openCollectModal('{{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', '') }}', '{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', '') }}', {{ guest.get('T·ªïng thanh to√°n', 0) }}, {{ guest.get('Hoa h·ªìng', 0) }})">
                                    <i class="fas fa-money-bill-wave me-1"></i>Thu ti·ªÅn
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if overdue_unpaid_guests|length > 3 %}
        <div class="text-center mt-3">
            <button class="btn btn-outline-light" onclick="toggleMoreOverdue()">
                <i class="fas fa-chevron-down me-1"></i> Xem th√™m {{ overdue_unpaid_guests|length - 3 }} kh√°ch
            </button>
        </div>
        <div id="moreOverdueGuests" style="display: none;" class="mt-3">
            <div class="row">
                {% for guest in overdue_unpaid_guests[3:] %}
                <div class="col-md-4 mb-2">
                    <div class="card bg-white bg-opacity-90 border-0">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1 text-dark">{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', 'N/A') }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {% if guest.get('Check-in Date') %}
                                            {% if guest['Check-in Date'] is string %}
                                                {{ guest['Check-in Date'] }}
                                            {% else %}
                                                {{ guest['Check-in Date'].strftime('%d/%m/%Y') if guest['Check-in Date'] else 'N/A' }}
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                        <span class="ms-2 badge bg-danger">{{ guest.get('days_overdue', 0) }} ng√†y</span>
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-danger">{{ "{:,.0f}".format(guest.get('T·ªïng thanh to√°n', 0) if guest.get('T·ªïng thanh to√°n') else 0) }}ƒë</div>
                                    <small class="text-muted">ID: {{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', 'N/A') }}</small>
                                    <button class="btn btn-success btn-sm mt-1 w-100" 
                                            onclick="openCollectModal('{{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', '') }}', '{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', '') }}', {{ guest.get('T·ªïng thanh to√°n', 0) }}, {{ guest.get('Hoa h·ªìng', 0) }})">
                                        <i class="fas fa-money-bill-wave me-1"></i>Thu ti·ªÅn
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Reminder Notifications Area -->
    <div id="reminderNotifications" class="alert alert-warning border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%); display: none;">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h4 class="alert-heading text-white mb-2">
                    <i class="fas fa-bell me-2"></i>üîî NH·∫ÆC H·∫∏N
                </h4>
                <p class="text-white mb-0" id="reminderMessage">B·∫°n c√≥ nh·∫Øc h·∫πn m·ªõi</p>
            </div>
            <div class="text-end">
                <button class="btn btn-light btn-sm" onclick="dismissReminder()">
                    <i class="fas fa-times"></i> ƒê√≥ng
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Reminder Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <h6 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Nh·∫Øc H·∫πn Nhanh
                    </h6>
                </div>
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <input type="text" id="reminderText" class="form-control" placeholder="Nh·∫≠p n·ªôi dung nh·∫Øc h·∫πn..." maxlength="100">
                        </div>
                        <div class="col-md-3">
                            <input type="datetime-local" id="reminderDateTime" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <select id="reminderPriority" class="form-select">
                                <option value="normal">üîµ B√¨nh th∆∞·ªùng</option>
                                <option value="important">üü° Quan tr·ªçng</option>
                                <option value="urgent">üî¥ Kh·∫©n c·∫•p</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="addReminder()">
                                <i class="fas fa-plus me-1"></i>Th√™m
                            </button>
                        </div>
                    </div>
                    
                    <!-- Active Reminders List -->
                    <div id="activeReminders" class="mt-3" style="display: none;">
                        <hr>
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-list me-1"></i>Danh s√°ch nh·∫Øc h·∫πn ƒëang ho·∫°t ƒë·ªông:
                        </h6>
                        <div id="remindersList" class="row"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">Doanh thu</div>
                            <div class="fs-3 fw-bold">{{ "{:,.0f}".format(total_revenue) }}ƒë</div>
                        </div>
                        <i class="fas fa-coins fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">L∆∞·ª£ng kh√°ch</div>
                            <div class="fs-3 fw-bold">{{ total_guests }}</div>
                        </div>
                        <i class="fas fa-users fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- More metrics can be added here -->
    </div>

    <!-- Charts -->
    <!-- Bi·ªÉu ƒë·ªì doanh thu chuy√™n nghi·ªáp -->
    <div class="row">
        <div class="col-xl-12">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-line me-2"></i>
                            <span class="fw-bold">üìà Doanh thu theo th√°ng (T·∫•t c·∫£ th·ªùi gian)</span>
                        </div>
                        <div class="badge bg-light text-dark">Chi ti·∫øt ƒë·∫ßy ƒë·ªß</div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="monthlyRevenueChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- B·∫£ng chi ti·∫øt v√† ph√¢n t√≠ch -->
    {% if monthly_revenue_with_unpaid %}
    <div class="row">
        <div class="col-xl-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-1 text-primary"></i> 
                        Chi ti·∫øt Doanh thu theo th√°ng (Bao g·ªìm kh√°ch ch∆∞a thu ti·ªÅn)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="border-0">
                                        <i class="fas fa-calendar-alt me-1"></i>Th√°ng
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-check-circle me-1 text-success"></i>ƒê√£ thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-clock me-1 text-warning"></i>Ch∆∞a thu
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-users me-1 text-info"></i>Kh√°ch ch∆∞a thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-coins me-1 text-info"></i>T·ªïng c·ªông
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-percentage me-1 text-primary"></i>T·ª∑ l·ªá thu
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in monthly_revenue_with_unpaid %}
                                <tr class="border-bottom">
                                    <td>
                                        <div class="fw-bold text-primary">{{ row.get('Th√°ng', 'N/A') }}</div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-success">
                                            {{ "{:,.0f}".format(row.get('ƒê√£ thu', 0) | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-danger">
                                            {{ "{:,.0f}".format(row.get('Ch∆∞a thu', 0) | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set uncollected_count = row.get('S·ªë kh√°ch ch∆∞a thu', 0) %}
                                        {% if uncollected_count > 0 %}
                                        <span class="badge bg-warning text-dark">
                                            {{ uncollected_count }} kh√°ch
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> ƒê√£ thu h·∫øt
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% set total = (row.get('ƒê√£ thu', 0) | float) + (row.get('Ch∆∞a thu', 0) | float) %}
                                        <div class="fw-bold text-dark">
                                            {{ "{:,.0f}".format(total) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set collected = row.get('ƒê√£ thu', 0) | float %}
                                        {% set uncollected = row.get('Ch∆∞a thu', 0) | float %}
                                        {% set total = collected + uncollected %}
                                        {% set percentage = (collected / total * 100) if total > 0 else 0 %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if percentage >= 90 %}bg-success{% elif percentage >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ percentage }}%;" 
                                                 aria-valuenow="{{ percentage }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                <small class="fw-bold">{{ "{:.1f}%".format(percentage) }}</small>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-1 text-primary"></i> 
                        Ph√¢n b·ªï theo Ng∆∞·ªùi thu
                    </h6>
                </div>
                <div class="card-body">
                    <div id="collectorChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Thu Ti·ªÅn -->
<div class="modal fade" id="collectPaymentModal" tabindex="-1" aria-labelledby="collectPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="collectPaymentModalLabel">
                    <i class="fas fa-money-bill-wave me-2"></i>Thu Ti·ªÅn Kh√°ch H√†ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="collectPaymentForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n kh√°ch h√†ng:</label>
                        <div class="fw-bold text-primary" id="modalGuestName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ ƒë·∫∑t ph√≤ng:</label>
                        <div class="fw-bold text-muted" id="modalBookingId"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">T·ªïng s·ªë ti·ªÅn c·∫ßn thu:</label>
                        <div class="fw-bold text-danger fs-5" id="modalTotalAmount"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hoa h·ªìng d·ª± ki·∫øn:</label>
                        <div class="fw-bold text-warning fs-6" id="modalCommissionAmount">Ch∆∞a c√≥ th√¥ng tin</div>
                    </div>
                    <div class="mb-3">
                        <label for="collectedAmount" class="form-label">S·ªë ti·ªÅn th·ª±c thu (VND):</label>
                        <input type="number" class="form-control" id="collectedAmount" 
                               placeholder="Nh·∫≠p s·ªë ti·ªÅn ƒë√£ thu" min="0" step="1000">
                        <div class="form-text">C√≥ th·ªÉ thu m·ªôt ph·∫ßn ho·∫∑c to√†n b·ªô s·ªë ti·ªÅn</div>
                    </div>
                    <div class="mb-3">
                        <label for="collectorName" class="form-label">Ng∆∞·ªùi thu ti·ªÅn:</label>
                        <select class="form-select" id="collectorName" required>
                            <option value="">Ch·ªçn ng∆∞·ªùi thu ti·ªÅn</option>
                            <option value="LOC LE">LOC LE</option>
                            <option value="THAO LE">THAO LE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentNote" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn):</label>
                        <textarea class="form-control" id="paymentNote" rows="2" 
                                  placeholder="Ghi ch√∫ v·ªÅ vi·ªác thu ti·ªÅn..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" id="confirmCollectBtn" onclick="collectPayment()">
                    <i class="fas fa-check me-1"></i>X√°c nh·∫≠n thu ti·ªÅn
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// ==================== REMINDER FUNCTIONALITY ====================

// Global reminder storage (in-memory for this session)
let activeReminders = JSON.parse(localStorage.getItem('activeReminders') || '[]');
let reminderCheckInterval = null;

// Initialize reminder system on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded, initializing charts...');
    
    // Set default reminder time to 1 hour from now
    const now = new Date();
    now.setHours(now.getHours() + 1);
    const defaultTime = now.toISOString().slice(0, 16);
    document.getElementById('reminderDateTime').value = defaultTime;
    
    // Load existing reminders
    loadActiveReminders();
    
    // Start checking for due reminders
    startReminderChecker();
    
    // Monthly Revenue Chart (existing code continues...)
    const monthlyRevenueChartData = {{ monthly_revenue_chart_json | tojson | safe }};
    console.log('Monthly revenue chart data:', monthlyRevenueChartData);
    
    if (monthlyRevenueChartData && 
        typeof monthlyRevenueChartData === 'object' && 
        Object.keys(monthlyRevenueChartData).length > 0 &&
        monthlyRevenueChartData.data && 
        monthlyRevenueChartData.layout) {
        try {
            Plotly.newPlot('monthlyRevenueChart', monthlyRevenueChartData.data, monthlyRevenueChartData.layout, {
                responsive: true,
                displayModeBar: false
            });
            console.log('Monthly revenue chart rendered successfully');
        } catch (error) {
            console.error('Error rendering monthly revenue chart:', error);
            document.getElementById('monthlyRevenueChart').innerHTML = 
                '<div class="alert alert-danger">L·ªói hi·ªÉn th·ªã bi·ªÉu ƒë·ªì: ' + error.message + '</div>';
        }
    } else {
        console.log('No monthly revenue chart data available');
        document.getElementById('monthlyRevenueChart').innerHTML = 
            '<div class="text-center py-5"><i class="fas fa-chart-line fa-3x text-muted mb-3"></i><p class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì</p></div>';
    }

    // Collector Revenue Pie Chart
    const collectorChartData = {{ collector_chart_json | tojson | safe }};
    console.log('Collector chart data:', collectorChartData);
    
    if (collectorChartData && 
        typeof collectorChartData === 'object' && 
        Object.keys(collectorChartData).length > 0 &&
        collectorChartData.data && 
        Array.isArray(collectorChartData.data) &&
        collectorChartData.data.length > 0 &&
        collectorChartData.data[0].values && 
        Array.isArray(collectorChartData.data[0].values) &&
        collectorChartData.data[0].values.length > 0 &&
        collectorChartData.layout) {
        try {
            Plotly.newPlot('collectorChart', collectorChartData.data, collectorChartData.layout, {
                responsive: true,
                displayModeBar: false
            });
            console.log('Collector chart rendered successfully');
        } catch (error) {
            console.error('Error rendering collector chart:', error);
            document.getElementById('collectorChart').innerHTML = 
                '<div class="alert alert-danger">L·ªói hi·ªÉn th·ªã bi·ªÉu ƒë·ªì: ' + error.message + '</div>';
        }
    } else {
        console.log('No collector chart data available or empty values');
        document.getElementById('collectorChart').innerHTML = 
            '<div class="text-center py-5"><i class="fas fa-chart-pie fa-3x text-muted mb-3"></i><p class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu ng∆∞·ªùi thu ti·ªÅn</p></div>';
    }
});

// Toggle more overdue guests
function toggleMoreOverdue() {
    const moreOverdue = document.getElementById('moreOverdueGuests');
    const button = event.target;
    
    if (moreOverdue.style.display === 'none') {
        moreOverdue.style.display = 'block';
        button.innerHTML = '<i class="fas fa-chevron-up me-1"></i> Thu g·ªçn';
    } else {
        moreOverdue.style.display = 'none';
        button.innerHTML = '<i class="fas fa-chevron-down me-1"></i> Xem th√™m {{ overdue_unpaid_guests|length - 3 if overdue_unpaid_guests else 0 }} kh√°ch';
    }
}

// Global variables cho modal
let currentBookingId = '';
let currentTotalAmount = 0;
let currentCommission = 0;

// M·ªü modal thu ti·ªÅn
function openCollectModal(bookingId, guestName, totalAmount, commission = 0) {
    currentBookingId = bookingId;
    currentTotalAmount = totalAmount;
    currentCommission = commission || 0;
    
    // C·∫≠p nh·∫≠t th√¥ng tin modal
    document.getElementById('modalGuestName').textContent = guestName;
    document.getElementById('modalBookingId').textContent = bookingId;
    document.getElementById('modalTotalAmount').textContent = totalAmount.toLocaleString('vi-VN') + 'ƒë';
    
    // Hi·ªÉn th·ªã hoa h·ªìng
    const commissionElement = document.getElementById('modalCommissionAmount');
    if (currentCommission > 0) {
        commissionElement.textContent = currentCommission.toLocaleString('vi-VN') + 'ƒë';
        commissionElement.className = 'fw-bold text-warning fs-6';
    } else {
        commissionElement.textContent = 'Ch∆∞a c√≥ th√¥ng tin';
        commissionElement.className = 'text-muted fs-6';
    }
    
    // Reset form
    document.getElementById('collectedAmount').value = totalAmount;
    document.getElementById('collectorName').value = '';
    document.getElementById('paymentNote').value = '';
    
    // Hi·ªÉn th·ªã modal
    const modal = new bootstrap.Modal(document.getElementById('collectPaymentModal'));
    modal.show();
}

// X·ª≠ l√Ω thu ti·ªÅn
async function collectPayment() {
    const collectedAmount = parseInt(document.getElementById('collectedAmount').value) || 0;
    const collectorName = document.getElementById('collectorName').value;
    const paymentNote = document.getElementById('paymentNote').value;
    
    // Validate
    if (!collectorName) {
        alert('Vui l√≤ng ch·ªçn ng∆∞·ªùi thu ti·ªÅn!');
        return;
    }
    
    if (collectedAmount <= 0) {
        alert('Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn h·ª£p l·ªá!');
        return;
    }
    
    if (collectedAmount > currentTotalAmount) {
        if (!confirm(`S·ªë ti·ªÅn thu (${collectedAmount.toLocaleString('vi-VN')}ƒë) l·ªõn h∆°n s·ªë ti·ªÅn c·∫ßn thu (${currentTotalAmount.toLocaleString('vi-VN')}ƒë). B·∫°n c√≥ ch·∫Øc ch·∫Øn?`)) {
            return;
        }
    }
    
    // Hi·ªÉn th·ªã loading
    const confirmBtn = document.getElementById('confirmCollectBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...';
    confirmBtn.disabled = true;
    
    try {
        const response = await fetch('/api/collect_payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                booking_id: currentBookingId,
                collected_amount: collectedAmount,
                collector_name: collectorName,
                payment_note: paymentNote
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Th√†nh c√¥ng - ƒë√≥ng modal v√† reload trang
            const modal = bootstrap.Modal.getInstance(document.getElementById('collectPaymentModal'));
            modal.hide();
            
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            successAlert.innerHTML = `
                <strong>‚úÖ Thu ti·ªÅn th√†nh c√¥ng!</strong><br>
                ƒê√£ thu ${collectedAmount.toLocaleString('vi-VN')}ƒë t·ª´ kh√°ch ${document.getElementById('modalGuestName').textContent}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(successAlert);
            
            // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
            setTimeout(() => {
                if (successAlert.parentNode) {
                    successAlert.remove();
                }
            }, 5000);
            
            // Reload trang sau 2 gi√¢y ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            
        } else {
            alert('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ thu ti·ªÅn'));
        }
        
    } catch (error) {
        console.error('Payment collection error:', error);
        alert('L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i!');
    } finally {
        // Reset button
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    }
}

// ==================== REMINDER FUNCTIONS ====================

// Add new reminder
function addReminder() {
    const text = document.getElementById('reminderText').value.trim();
    const dateTime = document.getElementById('reminderDateTime').value;
    const priority = document.getElementById('reminderPriority').value;
    
    // Validate input
    if (!text) {
        alert('Vui l√≤ng nh·∫≠p n·ªôi dung nh·∫Øc h·∫πn!');
        return;
    }
    
    if (!dateTime) {
        alert('Vui l√≤ng ch·ªçn th·ªùi gian nh·∫Øc h·∫πn!');
        return;
    }
    
    const reminderTime = new Date(dateTime);
    const now = new Date();
    
    if (reminderTime <= now) {
        alert('Th·ªùi gian nh·∫Øc h·∫πn ph·∫£i l·ªõn h∆°n th·ªùi gian hi·ªán t·∫°i!');
        return;
    }
    
    // Create reminder object
    const reminder = {
        id: 'reminder_' + Date.now(),
        text: text,
        dateTime: dateTime,
        timestamp: reminderTime.getTime(),
        priority: priority,
        created: now.toISOString(),
        triggered: false
    };
    
    // Add to active reminders
    activeReminders.push(reminder);
    
    // Save to localStorage
    localStorage.setItem('activeReminders', JSON.stringify(activeReminders));
    
    // Clear form
    document.getElementById('reminderText').value = '';
    document.getElementById('reminderDateTime').value = '';
    document.getElementById('reminderPriority').value = 'normal';
    
    // Reload display
    loadActiveReminders();
    
    // Show success message
    showReminderSuccess(`ƒê√£ th√™m nh·∫Øc h·∫πn: "${text}" l√∫c ${formatDateTime(reminderTime)}`);
}

// Load and display active reminders
function loadActiveReminders() {
    const remindersList = document.getElementById('remindersList');
    const activeRemindersDiv = document.getElementById('activeReminders');
    
    // Filter out past reminders that weren't triggered (cleanup)
    const now = new Date().getTime();
    activeReminders = activeReminders.filter(reminder => 
        reminder.timestamp > (now - 3600000) || !reminder.triggered // Keep recent or not triggered
    );
    
    // Save cleaned list
    localStorage.setItem('activeReminders', JSON.stringify(activeReminders));
    
    if (activeReminders.length === 0) {
        activeRemindersDiv.style.display = 'none';
        return;
    }
    
    activeRemindersDiv.style.display = 'block';
    
    // Sort by time
    const sortedReminders = [...activeReminders].sort((a, b) => a.timestamp - b.timestamp);
    
    remindersList.innerHTML = '';
    
    sortedReminders.forEach(reminder => {
        const priorityColors = {
            normal: 'primary',
            important: 'warning', 
            urgent: 'danger'
        };
        
        const priorityIcons = {
            normal: 'üîµ',
            important: 'üü°',
            urgent: 'üî¥'
        };
        
        const timeRemaining = getTimeRemaining(reminder.timestamp);
        const isPastDue = reminder.timestamp < Date.now();
        
        const reminderCard = document.createElement('div');
        reminderCard.className = 'col-md-6 col-lg-4 mb-2';
        reminderCard.innerHTML = `
            <div class="card border-${priorityColors[reminder.priority]} ${isPastDue ? 'bg-light' : ''}">
                <div class="card-body py-2 px-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="me-1">${priorityIcons[reminder.priority]}</span>
                                <small class="text-muted">${formatDateTime(new Date(reminder.timestamp))}</small>
                            </div>
                            <div class="fw-bold ${isPastDue ? 'text-danger' : ''}" style="font-size: 0.9rem;">
                                ${reminder.text}
                            </div>
                            <small class="text-${isPastDue ? 'danger' : 'info'}">
                                ${isPastDue ? '‚è∞ ƒê√£ qu√° h·∫°n' : `‚è±Ô∏è ${timeRemaining}`}
                            </small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeReminder('${reminder.id}')" title="X√≥a nh·∫Øc h·∫πn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        remindersList.appendChild(reminderCard);
    });
}

// Remove reminder
function removeReminder(reminderId) {
    activeReminders = activeReminders.filter(reminder => reminder.id !== reminderId);
    localStorage.setItem('activeReminders', JSON.stringify(activeReminders));
    loadActiveReminders();
    showReminderSuccess('ƒê√£ x√≥a nh·∫Øc h·∫πn');
}

// Start checking for due reminders
function startReminderChecker() {
    // Clear existing interval
    if (reminderCheckInterval) {
        clearInterval(reminderCheckInterval);
    }
    
    // Check every 30 seconds
    reminderCheckInterval = setInterval(checkForDueReminders, 30000);
    
    // Also check immediately
    checkForDueReminders();
}

// Check for due reminders
function checkForDueReminders() {
    const now = Date.now();
    const dueReminders = activeReminders.filter(reminder => 
        reminder.timestamp <= now && !reminder.triggered
    );
    
    dueReminders.forEach(reminder => {
        // Mark as triggered
        reminder.triggered = true;
        
        // Show notification
        showReminderNotification(reminder);
        
        // Play notification sound (if possible)
        playNotificationSound();
    });
    
    if (dueReminders.length > 0) {
        // Save updated reminders
        localStorage.setItem('activeReminders', JSON.stringify(activeReminders));
        
        // Reload display
        loadActiveReminders();
    }
}

// Show reminder notification
function showReminderNotification(reminder) {
    const notificationDiv = document.getElementById('reminderNotifications');
    const messageDiv = document.getElementById('reminderMessage');
    
    const priorityIcons = {
        normal: 'üîµ',
        important: 'üü°', 
        urgent: 'üî¥'
    };
    
    messageDiv.innerHTML = `
        ${priorityIcons[reminder.priority]} <strong>${reminder.text}</strong><br>
        <small>Th·ªùi gian: ${formatDateTime(new Date(reminder.timestamp))}</small>
    `;
    
    notificationDiv.style.display = 'block';
    
    // Auto-hide after 10 seconds for normal priority
    if (reminder.priority === 'normal') {
        setTimeout(() => {
            dismissReminder();
        }, 10000);
    }
    
    // Scroll to top to ensure visibility
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Dismiss reminder notification
function dismissReminder() {
    document.getElementById('reminderNotifications').style.display = 'none';
}

// Play notification sound
function playNotificationSound() {
    try {
        // Create audio context for a simple beep
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800; // Hz
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    } catch (error) {
        console.log('Could not play notification sound:', error);
    }
}

// Utility functions
function formatDateTime(date) {
    return date.toLocaleString('vi-VN', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getTimeRemaining(timestamp) {
    const now = Date.now();
    const diff = timestamp - now;
    
    if (diff < 0) return 'ƒê√£ qu√° h·∫°n';
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) return `${days} ng√†y ${hours % 24} gi·ªù`;
    if (hours > 0) return `${hours} gi·ªù ${minutes % 60} ph√∫t`;
    return `${minutes} ph√∫t`;
}

function showReminderSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 end-0 m-3 alert alert-success alert-dismissible';
    toast.style.zIndex = '9999';
    toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}