{% extends "base.html" %}

{% block title %}Dashboard - Hotel Management{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- ‚ö†Ô∏è PIN NOTIFICATION CHO NG√ÄY QU√Å T·∫¢I (FIXED TOP) -->
    {% if overcrowded_days and overcrowded_days|length > 0 %}
    {% set urgent_days = overcrowded_days | selectattr('alert_level', 'equalto', 'urgent') | list %}
    {% set today_overcrowded = overcrowded_days | selectattr('is_today', 'equalto', true) | list %}
    
    <div class="alert alert-warning border-0 shadow-lg mb-0 fixed-top" 
         style="top: 0; z-index: 1050; border-radius: 0 0 10px 10px; background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-exclamation-triangle fa-2x text-white"></i>
                </div>
                <div class="text-white">
                    <div class="fw-bold fs-6 mb-1">
                        ‚ö†Ô∏è C·∫¢NH B√ÅO QU√Å T·∫¢I: {{ overcrowded_days|length }} ng√†y c√≥ >4 kh√°ch
                    </div>
                    <div class="small">
                        {% if today_overcrowded %}
                            <span class="badge bg-danger me-2">H√îM NAY: {{ today_overcrowded[0].guest_count }} kh√°ch</span>
                        {% endif %}
                        {% if urgent_days %}
                            <span class="badge bg-warning text-dark me-2">Kh·∫©n c·∫•p: {{ urgent_days|length }} ng√†y</span>
                        {% endif %}
                        <span class="text-white-75">T·ªëi ƒëa: 4 ph√≤ng c√≥ s·∫µn</span>
                    </div>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-light btn-sm me-2" onclick="scrollToOvercrowdedSection()">
                    <i class="fas fa-eye me-1"></i>Xem chi ti·∫øt
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="dismissPinNotification()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Spacer ƒë·ªÉ content kh√¥ng b·ªã che b·ªüi fixed notification -->
    <div style="height: 80px;"></div>
    {% endif %}

    <h1 class="mt-4">üìä Dashboard T·ªïng quan</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">T·ªïng quan v·ªÅ hi·ªáu su·∫•t kh√°ch s·∫°n</li>
    </ol>

    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter"></i>
            T√πy ch·ªânh kho·∫£ng th·ªùi gian
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('dashboard') }}" class="row g-3 align-items-center">
                <div class="col-md-5">
                    <label for="start_date" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                    <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date }}">
                </div>
                <div class="col-md-5">
                    <label for="end_date" class="form-label">Ng√†y k·∫øt th√∫c</label>
                    <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> L·ªçc
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Notes Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-header bg-transparent border-0 text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-sticky-note me-2"></i>üìù Quick Notes
                        </h5>
                        <div>
                            <a href="{{ url_for('quick_notes_page') }}" class="btn btn-light btn-sm me-2">
                                <i class="fas fa-plus me-1"></i>T·∫°o m·ªõi
                            </a>
                            <button class="btn btn-outline-light btn-sm" onclick="refreshQuickNotes()">
                                <i class="fas fa-sync-alt me-1"></i>L√†m m·ªõi
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body text-white">
                    <div id="quickNotesContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border text-light mb-2" role="status">
                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                            </div>
                            <p class="mb-0">ƒêang t·∫£i Quick Notes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ö†Ô∏è KH√ÅCH CH∆ØA THU TI·ªÄN QU√Å H·∫†N -->
    {% if overdue_unpaid_guests and overdue_unpaid_guests|length > 0 %}
    <div class="alert alert-danger border-0 shadow-lg mb-4" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h4 class="alert-heading text-white mb-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>‚ö†Ô∏è KH√ÅCH CH∆ØA THU TI·ªÄN QU√Å H·∫†N
                </h4>
                <p class="text-white mb-0">{{ overdue_unpaid_guests|length }} kh√°ch ƒë√£ check-in nh∆∞ng ch∆∞a thu ti·ªÅn</p>
            </div>
            <div class="text-end">
                <div class="text-white">
                    <div class="h5 mb-0">{{ "{:,.0f}".format(overdue_total_amount if overdue_total_amount else 0) }}ƒë</div>
                    <small>T·ªïng ti·ªÅn ch∆∞a thu</small>
                </div>
            </div>
        </div>
        
        <hr class="text-white-50 my-3">
        
        <div class="row">
            {% for guest in overdue_unpaid_guests[:3] %}
            <div class="col-md-4 mb-2">
                <div class="card bg-white bg-opacity-90 border-0">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1 text-dark">{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', 'N/A') }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar me-1"></i>
                                    {% if guest.get('Check-in Date') %}
                                        {% if guest['Check-in Date'] is string %}
                                            {{ guest['Check-in Date'] }}
                                        {% else %}
                                            {{ guest['Check-in Date'].strftime('%d/%m/%Y') if guest['Check-in Date'] else 'N/A' }}
                                        {% endif %}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                    <span class="ms-2 badge bg-danger">{{ guest.get('days_overdue', 0) }} ng√†y</span>
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-danger">{{ "{:,.0f}".format(guest.get('T·ªïng thanh to√°n', 0) if guest.get('T·ªïng thanh to√°n') else 0) }}ƒë</div>
                                <small class="text-muted">ID: {{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', 'N/A') }}</small>
                                <button class="btn btn-success btn-sm mt-1 w-100" 
                                        onclick="openCollectModal('{{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', '') }}', '{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', '') }}', {{ guest.get('T·ªïng thanh to√°n', 0) }}, {{ guest.get('Hoa h·ªìng', 0) }})">
                                    <i class="fas fa-money-bill-wave me-1"></i>Thu ti·ªÅn
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        {% if overdue_unpaid_guests|length > 3 %}
        <div class="text-center mt-3">
            <button class="btn btn-outline-light" onclick="toggleMoreOverdue()">
                <i class="fas fa-chevron-down me-1"></i> Xem th√™m {{ overdue_unpaid_guests|length - 3 }} kh√°ch
            </button>
        </div>
        <div id="moreOverdueGuests" style="display: none;" class="mt-3">
            <div class="row">
                {% for guest in overdue_unpaid_guests[3:] %}
                <div class="col-md-4 mb-2">
                    <div class="card bg-white bg-opacity-90 border-0">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1 text-dark">{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', 'N/A') }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        {% if guest.get('Check-in Date') %}
                                            {% if guest['Check-in Date'] is string %}
                                                {{ guest['Check-in Date'] }}
                                            {% else %}
                                                {{ guest['Check-in Date'].strftime('%d/%m/%Y') if guest['Check-in Date'] else 'N/A' }}
                                            {% endif %}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                        <span class="ms-2 badge bg-danger">{{ guest.get('days_overdue', 0) }} ng√†y</span>
                                    </small>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold text-danger">{{ "{:,.0f}".format(guest.get('T·ªïng thanh to√°n', 0) if guest.get('T·ªïng thanh to√°n') else 0) }}ƒë</div>
                                    <small class="text-muted">ID: {{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', 'N/A') }}</small>
                                    <button class="btn btn-success btn-sm mt-1 w-100" 
                                            onclick="openCollectModal('{{ guest.get('S·ªë ƒë·∫∑t ph√≤ng', '') }}', '{{ guest.get('T√™n ng∆∞·ªùi ƒë·∫∑t', '') }}', {{ guest.get('T·ªïng thanh to√°n', 0) }}, {{ guest.get('Hoa h·ªìng', 0) }})">
                                        <i class="fas fa-money-bill-wave me-1"></i>Thu ti·ªÅn
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ‚ö†Ô∏è C·∫¢NH B√ÅO NG√ÄY QU√Å T·∫¢I (QU√Å 4 KH√ÅCH) -->
    {% if overcrowded_days and overcrowded_days|length > 0 %}
    <div class="alert border-0 shadow-lg mb-4" id="overcrowdedSection" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h4 class="alert-heading text-white mb-2">
                    <i class="fas fa-users me-2"></i>‚ö†Ô∏è C·∫¢NH B√ÅO NG√ÄY QU√Å T·∫¢I
                </h4>
                <p class="text-white mb-0">{{ overcrowded_days|length }} ng√†y c√≥ h∆°n 4 kh√°ch check-in (T·ªëi ƒëa: 4 ph√≤ng)</p>
            </div>
            <div class="text-end">
                <button class="btn btn-light btn-sm" onclick="toggleOvercrowdedDetails()">
                    <i class="fas fa-eye me-1"></i><span id="overcrowdToggleText">Chi ti·∫øt</span>
                </button>
            </div>
        </div>
        
        <!-- Quick Summary -->
        <div class="row mt-3">
            {% set urgent_days = overcrowded_days | selectattr('alert_level', 'equalto', 'urgent') | list %}
            {% set warning_days = overcrowded_days | selectattr('alert_level', 'equalto', 'warning') | list %}
            {% set future_days = overcrowded_days | selectattr('is_future', 'equalto', true) | list %}
            
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ urgent_days|length }}</div>
                        <small class="text-white-75">Kh·∫©n c·∫•p (‚â§3 ng√†y)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ warning_days|length }}</div>
                        <small class="text-white-75">C·∫£nh b√°o (‚â§7 ng√†y)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white bg-opacity-20 border-0">
                    <div class="card-body py-2 px-3 text-center">
                        <div class="h5 mb-1 text-white">{{ future_days|length }}</div>
                        <small class="text-white-75">T∆∞∆°ng lai</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Detailed List (Initially Hidden) -->
        <div id="overcrowdedDetails" style="display: none;" class="mt-3">
            <hr class="text-white-50 my-3">
            <div class="row">
                {% for day in overcrowded_days[:6] %}
                <div class="col-md-6 col-lg-4 mb-2">
                    <div class="card bg-white border-0">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold text-dark">
                                        {% if day.date %}
                                            {{ day.date.strftime('%d/%m/%Y') if day.date.strftime else day.date }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                        
                                        {% if day.is_today %}
                                            <span class="badge bg-danger ms-1">H√îM NAY</span>
                                        {% elif day.days_from_today == 1 %}
                                            <span class="badge bg-warning ms-1">NG√ÄY MAI</span>
                                        {% elif day.days_from_today > 0 and day.days_from_today <= 3 %}
                                            <span class="badge bg-danger ms-1">{{ day.days_from_today }} NG√ÄY N·ªÆA</span>
                                        {% elif day.days_from_today > 0 %}
                                            <span class="badge bg-info ms-1">{{ day.days_from_today }} ng√†y</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-users me-1"></i>{{ day.guest_count }} kh√°ch check-in
                                        <span class="ms-2 badge bg-{{ day.alert_color }}">
                                            {% if day.guest_count > 6 %}
                                                NGHI√äM TR·ªåNG
                                            {% elif day.guest_count > 4 %}
                                                QU√Å T·∫¢I
                                            {% endif %}
                                        </span>
                                    </small>
                                </div>
                                <div class="text-end">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showDayDetails('{{ day.date }}', {{ day.guest_count }}, {{ day.guest_names|tojson }}, {{ day.booking_ids|tojson }})"
                                            title="Xem chi ti·∫øt kh√°ch">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% if overcrowded_days|length > 6 %}
            <div class="text-center mt-2">
                <small class="text-white-75">... v√† {{ overcrowded_days|length - 6 }} ng√†y kh√°c</small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Key Metrics -->
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">Doanh thu</div>
                            <div class="fs-3 fw-bold">{{ "{:,.0f}".format(total_revenue) }}ƒë</div>
                        </div>
                        <i class="fas fa-coins fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-5">L∆∞·ª£ng kh√°ch</div>
                            <div class="fs-3 fw-bold">{{ total_guests }}</div>
                        </div>
                        <i class="fas fa-users fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- More metrics can be added here -->
    </div>

    <!-- Charts -->
    <!-- Bi·ªÉu ƒë·ªì doanh thu chuy√™n nghi·ªáp -->
    <div class="row">
        <div class="col-xl-12">
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-chart-line me-2"></i>
                            <span class="fw-bold">üìà Doanh thu theo th√°ng (T·∫•t c·∫£ th·ªùi gian)</span>
                        </div>
                        <div class="badge bg-light text-dark">Chi ti·∫øt ƒë·∫ßy ƒë·ªß</div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="monthlyRevenueChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- B·∫£ng chi ti·∫øt v√† ph√¢n t√≠ch -->
    {% if monthly_revenue_with_unpaid %}
    <div class="row">
        <div class="col-xl-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-1 text-primary"></i> 
                        Chi ti·∫øt Doanh thu theo th√°ng (Bao g·ªìm kh√°ch ch∆∞a thu ti·ªÅn)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th class="border-0">
                                        <i class="fas fa-calendar-alt me-1"></i>Th√°ng
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-check-circle me-1 text-success"></i>ƒê√£ thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-clock me-1 text-warning"></i>Ch∆∞a thu
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-users me-1 text-info"></i>Kh√°ch ch∆∞a thu
                                    </th>
                                    <th class="text-end border-0">
                                        <i class="fas fa-coins me-1 text-info"></i>T·ªïng c·ªông
                                    </th>
                                    <th class="text-center border-0">
                                        <i class="fas fa-percentage me-1 text-primary"></i>T·ª∑ l·ªá thu
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in monthly_revenue_with_unpaid %}
                                <tr class="border-bottom">
                                    <td>
                                        <div class="fw-bold text-primary">{{ row.get('Th√°ng', 'N/A') }}</div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-success">
                                            {{ "{:,.0f}".format(row.get('ƒê√£ thu', 0) | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-danger">
                                            {{ "{:,.0f}".format(row.get('Ch∆∞a thu', 0) | float) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set uncollected_count = row.get('S·ªë kh√°ch ch∆∞a thu', 0) %}
                                        {% if uncollected_count > 0 %}
                                        <span class="badge bg-warning text-dark">
                                            {{ uncollected_count }} kh√°ch
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> ƒê√£ thu h·∫øt
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% set total = (row.get('ƒê√£ thu', 0) | float) + (row.get('Ch∆∞a thu', 0) | float) %}
                                        <div class="fw-bold text-dark">
                                            {{ "{:,.0f}".format(total) }}ƒë
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        {% set collected = row.get('ƒê√£ thu', 0) | float %}
                                        {% set uncollected = row.get('Ch∆∞a thu', 0) | float %}
                                        {% set total = collected + uncollected %}
                                        {% set percentage = (collected / total * 100) if total > 0 else 0 %}
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar {% if percentage >= 90 %}bg-success{% elif percentage >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ percentage }}%;" 
                                                 aria-valuenow="{{ percentage }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                <small class="fw-bold">{{ "{:.1f}%".format(percentage) }}</small>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-1 text-primary"></i> 
                        Ph√¢n b·ªï theo Ng∆∞·ªùi thu
                    </h6>
                </div>
                <div class="card-body">
                    <div id="collectorChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Thu Ti·ªÅn -->
<div class="modal fade" id="collectPaymentModal" tabindex="-1" aria-labelledby="collectPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="collectPaymentModalLabel">
                    <i class="fas fa-money-bill-wave me-2"></i>Thu Ti·ªÅn Kh√°ch H√†ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="collectPaymentForm">
                    <div class="mb-3">
                        <label class="form-label">T√™n kh√°ch h√†ng:</label>
                        <div class="fw-bold text-primary" id="modalGuestName"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√£ ƒë·∫∑t ph√≤ng:</label>
                        <div class="fw-bold text-muted" id="modalBookingId"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">T·ªïng s·ªë ti·ªÅn c·∫ßn thu:</label>
                        <div class="fw-bold text-danger fs-5" id="modalTotalAmount"></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Hoa h·ªìng d·ª± ki·∫øn:</label>
                        <div class="fw-bold text-warning fs-6" id="modalCommissionAmount">Ch∆∞a c√≥ th√¥ng tin</div>
                    </div>
                    <div class="mb-3">
                        <label for="collectedAmount" class="form-label">S·ªë ti·ªÅn th·ª±c thu (VND):</label>
                        <input type="number" class="form-control" id="collectedAmount" 
                               placeholder="Nh·∫≠p s·ªë ti·ªÅn ƒë√£ thu" min="0" step="1000">
                        <div class="form-text">C√≥ th·ªÉ thu m·ªôt ph·∫ßn ho·∫∑c to√†n b·ªô s·ªë ti·ªÅn</div>
                    </div>
                    <div class="mb-3">
                        <label for="collectorName" class="form-label">Ng∆∞·ªùi thu ti·ªÅn:</label>
                        <select class="form-select" id="collectorName" required>
                            <option value="">Ch·ªçn ng∆∞·ªùi thu ti·ªÅn</option>
                            <option value="LOC LE">LOC LE</option>
                            <option value="THAO LE">THAO LE</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="paymentNote" class="form-label">Ghi ch√∫ (tu·ª≥ ch·ªçn):</label>
                        <textarea class="form-control" id="paymentNote" rows="2" 
                                  placeholder="Ghi ch√∫ v·ªÅ vi·ªác thu ti·ªÅn..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" id="confirmCollectBtn" onclick="collectPayment()">
                    <i class="fas fa-check me-1"></i>X√°c nh·∫≠n thu ti·ªÅn
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Pass chart data from server to dashboard.js
const monthlyRevenueChartData = {{ monthly_revenue_chart_json | tojson | safe }};
const collectorChartData = {{ collector_chart_json | tojson | safe }};

// Quick Notes functionality
document.addEventListener('DOMContentLoaded', function() {
    loadQuickNotesOnDashboard();
});

function loadQuickNotesOnDashboard() {
    const container = document.getElementById('quickNotesContainer');
    const notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
    
    // Filter active notes (not completed)
    const activeNotes = notes.filter(note => !note.completed);
    
    if (activeNotes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-sticky-note fa-3x text-white-50 mb-3"></i>
                <p class="mb-2">Ch∆∞a c√≥ Quick Notes n√†o</p>
                <a href="{{ url_for('quick_notes_page') }}" class="btn btn-light btn-sm">
                    <i class="fas fa-plus me-1"></i>T·∫°o Note ƒë·∫ßu ti√™n
                </a>
            </div>
        `;
        return;
    }
    
    const typeIcons = {
        'thu-tien': 'fas fa-money-bill-wave',
        'huy-phong': 'fas fa-times-circle',
        'taxi': 'fas fa-taxi'
    };
    
    const typeNames = {
        'thu-tien': 'Thu ti·ªÅn l·∫°i',
        'huy-phong': 'H·ªßy ph√≤ng', 
        'taxi': 'Taxi'
    };
    
    const typeColors = {
        'thu-tien': 'success',
        'huy-phong': 'danger',
        'taxi': 'warning'
    };
    
    // Sort by reminder date/time
    activeNotes.sort((a, b) => {
        const dateA = new Date(`${a.date} ${a.time}`);
        const dateB = new Date(`${b.date} ${b.time}`);
        return dateA - dateB;
    });
    
    const notesHtml = activeNotes.slice(0, 6).map(note => {
        const reminderDate = new Date(`${note.date} ${note.time}`);
        const now = new Date();
        const isOverdue = reminderDate < now;
        const isToday = reminderDate.toDateString() === now.toDateString();
        
        let timeStatus = '';
        if (isOverdue) {
            timeStatus = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>Qu√° h·∫°n</span>';
        } else if (isToday) {
            timeStatus = '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>H√¥m nay</span>';
        } else {
            const diffTime = Math.abs(reminderDate - now);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            timeStatus = `<span class="badge bg-info">${diffDays} ng√†y n·ªØa</span>`;
        }
        
        return `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card bg-white bg-opacity-90 border-0 h-100">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <i class="${typeIcons[note.type]} text-${typeColors[note.type]} me-2"></i>
                                <strong class="text-dark">${typeNames[note.type]}</strong>
                            </div>
                            <div class="d-flex gap-1">
                                <button class="btn btn-success btn-sm" onclick="markNoteCompleted(${note.id})" title="ƒê√°nh d·∫•u ho√†n th√†nh">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="deleteNoteFromDashboard(${note.id})" title="X√≥a">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-dark mb-2 small">${note.content}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>${note.guestName}
                            </small>
                            <div>
                                <small class="text-muted d-block">
                                    <i class="fas fa-calendar me-1"></i>${note.date} ${note.time}
                                </small>
                                ${timeStatus}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="row">
            ${notesHtml}
        </div>
        ${activeNotes.length > 6 ? `
            <div class="text-center mt-3">
                <a href="{{ url_for('quick_notes_page') }}" class="btn btn-outline-light">
                    <i class="fas fa-eye me-1"></i>Xem t·∫•t c·∫£ ${activeNotes.length} notes
                </a>
            </div>
        ` : ''}
    `;
}

function markNoteCompleted(noteId) {
    let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
    const noteIndex = notes.findIndex(note => note.id === noteId);
    
    if (noteIndex !== -1) {
        notes[noteIndex].completed = true;
        notes[noteIndex].completedAt = new Date().toISOString();
        localStorage.setItem('quickNotes', JSON.stringify(notes));
        
        // Show success toast
        showDashboardToast('‚úÖ ƒê√£ ƒë√°nh d·∫•u note ho√†n th√†nh!', 'success');
        
        // Reload notes display
        loadQuickNotesOnDashboard();
    }
}

function deleteNoteFromDashboard(noteId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a note n√†y?')) {
        let notes = JSON.parse(localStorage.getItem('quickNotes') || '[]');
        notes = notes.filter(note => note.id !== noteId);
        localStorage.setItem('quickNotes', JSON.stringify(notes));
        
        showDashboardToast('üóëÔ∏è ƒê√£ x√≥a note!', 'info');
        loadQuickNotesOnDashboard();
    }
}

function refreshQuickNotes() {
    const refreshBtn = document.querySelector('button[onclick="refreshQuickNotes()"]');
    const originalHtml = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ƒêang t·∫£i...';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        loadQuickNotesOnDashboard();
        refreshBtn.innerHTML = originalHtml;
        refreshBtn.disabled = false;
        showDashboardToast('üîÑ ƒê√£ l√†m m·ªõi Quick Notes!', 'info');
    }, 500);
}

function showDashboardToast(message, type = 'success') {
    const colors = {
        success: 'bg-success',
        error: 'bg-danger', 
        info: 'bg-info',
        warning: 'bg-warning'
    };
    
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 end-0 m-3 p-3 ${colors[type]} text-white rounded`;
    toast.style.zIndex = '9999';
    toast.innerHTML = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ==================== PIN NOTIFICATION FUNCTIONS ====================
function scrollToOvercrowdedSection() {
    const section = document.getElementById('overcrowdedSection');
    if (section) {
        section.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        
        // Highlight the section briefly
        section.style.boxShadow = '0 0 20px rgba(255, 149, 0, 0.8)';
        setTimeout(() => {
            section.style.boxShadow = '';
        }, 2000);
    }
}

function dismissPinNotification() {
    const notification = document.querySelector('.fixed-top.alert-warning');
    const spacer = notification?.nextElementSibling;
    
    if (notification) {
        notification.style.transform = 'translateY(-100%)';
        setTimeout(() => {
            notification.remove();
            if (spacer && spacer.style.height === '80px') {
                spacer.remove();
            }
        }, 300);
        
        // Save dismiss state for this session
        sessionStorage.setItem('overcrowdedPinDismissed', 'true');
        showDashboardToast('‚ÑπÔ∏è Notification ƒë√£ ƒë∆∞·ª£c ·∫©n cho phi√™n n√†y', 'info');
    }
}

// Check if pin notification should be shown
document.addEventListener('DOMContentLoaded', function() {
    const dismissed = sessionStorage.getItem('overcrowdedPinDismissed');
    const pinNotification = document.querySelector('.fixed-top.alert-warning');
    
    if (dismissed === 'true' && pinNotification) {
        pinNotification.style.display = 'none';
        const spacer = pinNotification.nextElementSibling;
        if (spacer && spacer.style.height === '80px') {
            spacer.style.display = 'none';
        }
    }
});

// Toggle overcrowded details section
function toggleOvercrowdedDetails() {
    const details = document.getElementById('overcrowdedDetails');
    const toggleText = document.getElementById('overcrowdToggleText');
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        toggleText.textContent = '·∫®n chi ti·∫øt';
    } else {
        details.style.display = 'none';
        toggleText.textContent = 'Chi ti·∫øt';
    }
}

// Show day details modal
function showDayDetails(date, guestCount, guestNames, bookingIds) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        <i class="fas fa-users me-2"></i>Chi ti·∫øt ng√†y qu√° t·∫£i: ${date}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong><i class="fas fa-exclamation-triangle me-2"></i>C·∫£nh b√°o:</strong> 
                        Ng√†y n√†y c√≥ ${guestCount} kh√°ch check-in, v∆∞·ª£t qu√° s·ª©c ch·ª©a 4 ph√≤ng.
                    </div>
                    <h6><i class="fas fa-list me-2"></i>Danh s√°ch kh√°ch check-in:</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>STT</th>
                                    <th>T√™n kh√°ch</th>
                                    <th>M√£ booking</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${guestNames.map((name, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${name}</strong></td>
                                        <td><span class="badge bg-info">${bookingIds[index]}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <h6><i class="fas fa-lightbulb me-2"></i>ƒê·ªÅ xu·∫•t gi·∫£i ph√°p:</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i>Li√™n h·ªá kh√°ch ƒë·ªÉ s·∫Øp x·∫øp l·∫°i l·ªãch check-in</li>
                            <li><i class="fas fa-check text-success me-2"></i>T√¨m ph√≤ng tr·ªëng ·ªü kh√°ch s·∫°n kh√°c g·∫ßn ƒë√≥</li>
                            <li><i class="fas fa-check text-success me-2"></i>ƒê·ªÅ xu·∫•t upgrade ho·∫∑c early check-in ng√†y h√¥m tr∆∞·ªõc</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}